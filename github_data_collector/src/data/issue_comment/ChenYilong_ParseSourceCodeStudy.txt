 åœ¨void dispatch_async_limit(dispatch_queue_t queue,NSUInteger limitSemaphoreCount, dispatch_block_t block) è¿™ä¸ªæ–¹æ³•é‡Œ,å¦‚æœå°†limitSemaphoreCountæ”¹ä¸ºå¤§äº1ï¼Œæ˜¯å¦ç¨‹åºå°±å¯èƒ½å´©æºƒ?è¦æ˜¯åªèƒ½ç½®ä¸º1ï¼Œæ˜¯å¦å°±è·ŸåŒæ­¥é˜Ÿåˆ—æ¥åšæ˜¯ä¸€æ ·çš„(æ¯”å¦‚åœ¨è¿è¡Œæ•ˆç‡),å¦‚æœä¸ä¸€æ ·ï¼Œé‚£å„æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹å‘¢!
ç”±äºæ²¡æœ‰è®¾ç½®è·¯å¾„çš„è¯ï¼Œé»˜è®¤cacheä¼šè‡ªå®šæ¸…é™¤ç¼“å­˜ï¼Œå‡è®¾ç¬¬äºŒæ¬¡å‘èµ·æƒ…å†µçš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯è¿”å›çš„æ˜¯304ï¼Œä½†æ˜¯æ­¤æ—¶æœ¬åœ°å¯¹åº”çš„requestçš„cacheè¢«æ¸…é™¤ï¼Œé‚£ä¹ˆ é€šè¿‡  NSCachedURLResponse *cacheResponse =  [[NSURLCache sharedURLCache] cachedResponseForRequest:request];å–çš„NSCachedURLResponseä¸æ˜¯å°±æ˜¯ä¸ºniläº†å—ï¼Œé‚£è¿™æ ·çš„æƒ…å†µè¯¥æ€ä¹ˆå¤„ç†

ç”±äºä¸æŒ‡å®šè·¯å¾„çš„è¯ï¼Œcacheé»˜è®¤æ˜¯è‡ªåŠ¨æ¸…é™¤ç¼“å­˜çš„ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡å‘èµ·è¯·æ±‚çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯è¿”å›æ•°æ®æ²¡æœ‰æ›´æ–°ï¼Œè¿”å›çš„æ˜¯304ï¼Œé‚£ä¹ˆé€šè¿‡ NSCachedURLResponse *cacheResponse =  [[NSURLCache sharedURLCache]cachedResponseForRequest:request];å»å–NSCachedURLResponseï¼Œä¸åº”è¯¥æ˜¯ä¸ºnilå—ï¼Œè¿™æ ·çš„æƒ…å†µï¼Œæ€ä¹ˆå¤„ç†

æ€è€ƒä¸‹NSLogçš„æ‰“å°é¡ºåºä¸ºä»€ä¹ˆä¼šæ˜¯è¿™æ ·ï¼Ÿç­”ï¼šdispatch_suspendçš„ä½œç”¨ï¼

è¿™ä¸ªLogå’Œæ‰“å°é¡ºåºå’Œsuspendæ²¡æœ‰ä»»ä½•å…³ç³»ã€‚å’Œasyncæœ‰å…³ã€‚
- (void)viewDidLoad {
   [super viewDidLoad];
   //å› ä¸ºç”¨åˆ°äº†dispatch_barrier_asyncï¼Œè¯¥å‡½æ•°åªèƒ½æ­é…è‡ªå®šä¹‰å¹¶è¡Œé˜Ÿåˆ—dispatch_queue_tä½¿ç”¨ã€‚æ‰€ä»¥ä¸èƒ½ä½¿ç”¨ï¼šdispatch_get_global_queue
   dispatch_queue_t queue = dispatch_queue_create("com.ioschengxuyuan.gcd.ForBarrier", DISPATCH_QUEUE_CONCURRENT);
   /*
    *
    *ç”ŸæˆDispatch Semaphore
    Dispatch Semaphore çš„è®¡æ•°åˆå§‹å€¼è®¾å®šä¸ºâ€œ1â€
    (è¯¥åˆå§‹å€¼çš„1ä¸ä¸‹æ–‡ä¸­ä¸¤ä¸ªå‡½æ•°dispatch_semaphore_waitä¸dispatch_semaphore_signalè¿›è¡Œçš„å‡1ã€åŠ 1é‡Œçš„1æ²¡æœ‰å¿…ç„¶è”ç³»ã€‚
    
    å°±ç®—åˆå§‹å€¼æ˜¯100ï¼Œä¸¤ä¸ªå‡½æ•°dispatch_semaphore_waitä¸dispatch_semaphore_signalè¿˜æ˜¯ä¼šå‡â€œ1â€ã€åŠ â€œ1â€)ã€‚
    ä¿è¯å¯è®¿é—® NSMutableArray ç±»å¯¹è±¡çš„çº¿ç¨‹
    åŒæ—¶åªèƒ½æœ‰1ä¸ª
    *
    */
   dispatch_semaphore_t semaphore = dispatch_semaphore_create(1) ;
   NSMutableArray *array = [[NSMutableArray alloc] init];
   for(int i = 0; i< 100000; ++i) {
       dispatch_async(queue, ^{
           /*
            *
            *ç­‰å¾…Dispatch Semaphore
            *ä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°Dispatch Semaphoreçš„è®¡æ•°å€¼è¾¾åˆ°å¤§äºç­‰äº1
            */
           dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER) ;
           /*
            *ç”±äºDispatch Semaphoreçš„è®¡æ•°å€¼è¾¾åˆ°å¤§äºç­‰äº1
            *æ‰€ä»¥å°†Dispatch Semaphoreçš„è®¡æ•°å€¼å‡å»1
            *dispatch_semaphore_wait å‡½æ•°æ‰§è¡Œè¿”å›ã€‚
            *å³æ‰§è¡Œåˆ°æ­¤æ—¶çš„
            *Dispatch Semaphore çš„è®¡æ•°å€¼æ’ä¸º0
            *
            *ç”±äºå¯è®¿é—®NSMutaleArrayç±»å¯¹è±¡çš„çº¿ç¨‹
            *åªæœ‰ä¸€ä¸ª
            *å› æ­¤å¯å®‰å…¨åœ°è¿›è¡Œæ›´æ–°
            *
            */
           NSLog(@"ğŸ”´%@",[NSThread currentThread]);
           [array addObject:[NSNumber numberWithInt:i]];
           /*
            *
            *æ’ä»–æ§åˆ¶å¤„ç†ç»“æŸï¼Œ
            *æ‰€ä»¥é€šè¿‡dispatch_semaphore_signalå‡½æ•°
            *å°†Dispatch Semaphoreçš„è®¡æ•°å€¼åŠ 1
            *å¦‚æœæœ‰é€šè¿‡dispatch_semaphore_waitå‡½æ•°
            *ç­‰å¾…Dispatch Semaphoreçš„è®¡æ•°å€¼å¢åŠ çš„çº¿ç¨‹ï¼Œ
            â˜…å°±ç”±æœ€å…ˆç­‰å¾…çš„çº¿ç¨‹æ‰§è¡Œã€‚
            */
           dispatch_semaphore_signal(semaphore);
       });
   }
   /*
    *
    ç­‰ä¸ºæ•°ç»„éå†æ·»åŠ å…ƒç´ åï¼Œæ£€æŸ¥ä¸‹æ•°ç»„çš„æˆå‘˜ä¸ªæ•°æ˜¯å¦æ­£ç¡®
    *
    */
   dispatch_barrier_async(queue, ^{
       NSLog(@"ğŸ”´ç±»åä¸æ–¹æ³•åï¼š%sï¼ˆåœ¨ç¬¬%dè¡Œï¼‰ï¼Œæè¿°ï¼š%@", __PRETTY_FUNCTION__, __LINE__, @([array count]));
   });
}

ä¸Šé¢æ˜¯æ–‡ä¸­çš„ä»£ç ï¼Œå®é™…è¿è¡Œåå‘ç°ï¼Œä¸ä¼šè¿è¡Œdispatch_barrier_asyncæ–¹æ³•é‡Œé¢çš„ä»£ç ï¼Œåšå¦‚ä¸‹æ›´æ”¹æ‰å¯ä»¥ï¼š

æŠŠåŸæ–‡ä¸­çš„ä»£ç ï¼š
for(int i = 0; i< 100000; ++i) {
  dispatch_async(queue, ^{
           dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER) ;

æ”¹æˆï¼š
for(int i = 0; i< 100000; ++i) {
   dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER) ;
  dispatch_async(queue, ^{

æ‰å¯ä»¥ï¼Œæ¥¼ä¸»éªŒè¯ä¸‹çœ‹æ˜¯ä¸æ˜¯è¿™æ ·

æˆ‘æµ‹è¯•çš„æƒ…å†µæ¥çœ‹ [Demo_03_å¯¹DispatchQueueå®ç°å–æ¶ˆæ¢å¤æ“ä½œ_ç®€å•ç‰ˆ] ä¸­å°±ç®—æ²¡æœ‰ dispatch_suspend çš„æš‚åœå…¶å®ä¹Ÿä¼šå…ˆäº dispatch_async çš„ Logï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

![screenshot](https://cloud.githubusercontent.com/assets/2088605/26489895/cbdf175e-423b-11e7-9b2b-a76c7d48bc74.jpg)


æ‰€ä»¥è¿™ä¸ªä¾‹å­æ˜¯ä¸æ˜¯æœ‰ç‚¹ä¸å¤ªæ°å½“å‘¢
ä¸‹ä¸€ç¯‡ä»€ä¹ˆæ—¶å€™æ›´æ–°å•Š
åœ¨ç¬¬7ç¯‡è®²è¿°ä¿¡å·é‡çš„æ–‡ç« ä¸­è¯´é€šè¿‡dispatch_once æ¥ä¿è¯é¿å…çº¿ç¨‹çš„ç«äº‰ï¼Œå“ªé‡Œæœ‰ç«äº‰çš„åœ°æ–¹å•Šï¼Œæ²¡æœ‰çœ‹åˆ°åŒæ—¶æ“ä½œä»£ç å—çš„åœ°æ–¹ä¹Ÿæ²¡æœ‰è¯»å–åŒä¸€å—æ•°æ®çš„åœ°æ–¹ï¼Œå¤§ç¥è¯·è§£é‡Šä¸€ä¸‹
AFN èƒ½ç”¨ETag å—
