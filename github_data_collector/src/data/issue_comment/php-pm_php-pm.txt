I have worker process with sleep(2 sec). Option `max-execution-time` is 4 sec. I see error `Maximum execution time exceeded` sometime.

My config and extend log:
+---------------------+-----------------------------------------+
| bridge              | PHPPM\Bridges\Psr15Middleware           |
| host                | 0.0.0.0                                 |
| port                | 9001                                    |
| workers             | 1                                       |
| app-env             | production                              |
| debug               | 1                                       |
| logging             | 1                                       |
| bootstrap           | DdMonitoring\PmmAdapter                 |
| max-requests        | 20                                      |
| populate-server-var |                                         |
| max-execution-time  | 4                                       |
| memory-limit        | 24                                      |
| ttl                 | 3600                                    |
| reload-timeout      | 5                                       |
| static-directory    |                                         |
| socket-path         | .ppm/run/                               |
| pidfile             | .ppm/ppm.pid                            |
| cgi-path            | /usr/local/Cellar/php/7.4.0/bin/php-cgi |
+---------------------+-----------------------------------------+
Starting PHP-PM with 1 workers, using StreamSelectLoop ...
1 workers (starting at 5501) up and ready. Application is ready at http://0.0.0.0:9001/
Method RequestHandler::SlaveClose -> cancelTimer
[06/Dec/2019:07:06:45 +0000] 127.0.0.1 - - "GET /asterisk/connect/ HTTP/1.1" 200 291 "-"
Method RequestHandler::maxExecutionTimeExceeded
Maximum execution time of 4 seconds exceeded. Closing worker.
Method RequestHandler::SlaveClose -> cancelTimer
Method RequestHandler::maxExecutionTimeExceeded
Maximum execution time of 4 seconds exceeded. Closing worker.
Method RequestHandler::SlaveClose -> cancelTimer
Method RequestHandler::maxExecutionTimeExceeded
Maximum execution time of 4 seconds exceeded. Closing worker.
Method RequestHandler::SlaveClose -> cancelTimer
Method RequestHandler::maxExecutionTimeExceeded
Maximum execution time of 4 seconds exceeded. Closing worker.
Method RequestHandler::SlaveClose -> cancelTimer
Method RequestHandler::maxExecutionTimeExceeded
Maximum execution time of 4 seconds exceeded. Closing worker.
Method RequestHandler::SlaveClose -> cancelTimer
Method RequestHandler::maxExecutionTimeExceeded
Maximum execution time of 4 seconds exceeded. Closing worker.
Method RequestHandler::SlaveClose -> cancelTimer
Method RequestHandler::SlaveClose -> cancelTimer
[06/Dec/2019:07:07:09 +0000] 127.0.0.1 - - "GET /asterisk/connect/ HTTP/1.1" 200 291 "-"
Method RequestHandler::maxExecutionTimeExceeded
Maximum execution time of 4 seconds exceeded. Closing worker.
Method RequestHandler::SlaveClose -> cancelTimer
Method RequestHandler::maxExecutionTimeExceeded
Maximum execution time of 4 seconds exceeded. Closing worker.
Method RequestHandler::SlaveClose -> cancelTimer


Screenshot with response timers and status code from chrome network - https://www.dropbox.com/s/qikg27y9dwkqbep/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%202019-12-06%2010.07.55.png?dl=0


Please check it. I expected give response with status code is 200 for all request after ~2 sec delay. But I have 504 after 3ms - 1.62sec delay.

Add the possibility to provide the TCP context in the start process of ProcessManager, and gives the opportunity to build Secure Socket. Related #462 

Usage : This PR add ```--tcp-context``` option which accept an JSON array encoded.

Example : ```php bin/ppm start --tcp-context '{"tls":{"local_cert": "test.pem"}}'```

This is the first shot.

What do you think ? 

Also, I have some difficulty to make the ConfigTrait testable, if you have some ideas, I will take them.
If the main process receives an interruption signal, running requests are not returned to the user.
Reproduce using sleep() and ctrl+c.



I primarily use PPM to have all kinds of data ready for computation at runtime when a request is coming in. In order for that data to be fresh, i need to reload periodically. 
Because `ttl` only reloads after a request, i cannot be sure that my data is fresh.

Also, with this feature the worker does not get killed but only the method `refreshApplication()` will be fired on the bridge every `refresh-interval` seconds. 

Note: Only Â¼ of the workers in `ready` state and ready to refresh will be sent to refresh once every 5 seconds.

Good day.

I try to investigate a strange situation with PHP-PM, but probably I do something wrong.

Our test application based on

php-pm 2.0
httpkernel-adapter 2.0.2
PHP 7.3.6
Zend Engine v3.3.6, Copyright (c) 1998-2018 Zend Technologies
    with Zend OPcache v7.3.6, Copyright (c) 1999-2018, by Zend Technologies
    with Xdebug v2.7.2, Copyright (c) 2002-2019, by Derick Rethans
Laravel/framework 5.8    

It was started in same time on two different computers with same application docker images. And after running for two weeks application was crashed and looks like in same time. That is weird. Last week applications was mostly idle.
And I am already find something like that

https://github.com/php-pm/php-pm/commit/8e06951404da298729c80d655d939074309e9691

php-pm was started with
```
--bootstrap=laravel --static-directory=public --workers=8 --debug=1 --app-env=dev -vvv --max-execution-time=3600
```

that's my stacktrace:

```
No slaves available to handle the request and timeout 10 seconds
exceeded
No slaves available to handle the request and timeout 10 seconds
exceeded
No slaves available to handle the request and timeout 10 seconds
exceeded
No slaves available to handle the request and timeout 10 seconds
exceeded
No slaves available to handle the request and timeout 10 seconds
exceeded
No slaves available to handle the request and timeout 10 seconds
exceeded
No slaves available to handle the request and timeout 10 seconds
exceeded

In RequestHandler.php line 271:
                                                           
  [Symfony\Component\Debug\Exception\FatalThrowableError]  
  Call to a member function close() on null                
                                                           

Exception trace:
 () at /opt/ppm/vendor/php-pm/php-pm/src/RequestHandler.php:271
 PHPPM\RequestHandler->maxExecutionTimeExceeded() at
/opt/ppm/vendor/react/event-loop/src/Timer/Timers.php:96
 React\EventLoop\Timer\Timers->tick() at /opt/ppm/vendor/react/event-
loop/src/StreamSelectLoop.php:183
 React\EventLoop\StreamSelectLoop->run() at /opt/ppm/vendor/php-pm/php-
pm/src/ProcessManager.php:521
 PHPPM\ProcessManager->run() at /opt/ppm/vendor/php-pm/php-
pm/src/Commands/StartCommand.php:52
 PHPPM\Commands\StartCommand->execute() at
/opt/ppm/vendor/symfony/console/Command/Command.php:255
 Symfony\Component\Console\Command\Command->run() at
/opt/ppm/vendor/symfony/console/Application.php:921
 Symfony\Component\Console\Application->doRunCommand() at
/opt/ppm/vendor/symfony/console/Application.php:273
 Symfony\Component\Console\Application->doRun() at
/opt/ppm/vendor/symfony/console/Application.php:149
 Symfony\Component\Console\Application->run() at /opt/ppm/vendor/php-
pm/php-pm/bin/ppm:47

start [--bridge BRIDGE] [--host HOST] [--port PORT] [--workers WORKERS]
[--app-env APP-ENV] [--debug DEBUG] [--logging LOGGING] [--static-
directory STATIC-DIRECTORY] [--max-requests MAX-REQUESTS] [--max-
execution-time MAX-EXECUTION-TIME] [--memory-limit MEMORY-LIMIT] [--ttl
TTL] [--populate-server-var POPULATE-SERVER-VAR] [--bootstrap
BOOTSTRAP] [--cgi-path CGI-PATH] [--socket-path SOCKET-PATH] [--pidfile
PIDFILE] [--reload-timeout RELOAD-TIMEOUT] [-c|--config CONFIG] [--]
[<working-directory>]

Server is shutting down.
Stopping the process manager.
```

Probably you have some ideas what is wrong? Thank in advance. :-)
Hello,
I got:
```
HTTP/1.1 502 Bad Gateway
Server: nginx/1.16.1
Date: Mon, 07 Oct 2019 19:17:32 GMT
Content-Type: text/plain
Content-Length: 88
Connection: close

Slave returned an invalid HTTP response. Maybe the script has called exit() prematurely?
```
Instead of normal Symfony's error-500, that's caused by my error in the application. But just I don't know why php-pm died on that, cause that error was on the application/payload level. Here the log:

```
cdp-web-web           | --- Worker 5501 stderr ---
cdp-web-web           | An exception was thrown by the bridge. Forcing restart of the worker. The exception was: Error: Call to undefined method App\Entity\AccessToken::getUser() in /var/www/src/Security/AccessTokenAuthenticator.php:55
cdp-web-web           | Stack trace:
cdp-web-web           | #0 /var/www/vendor/symfony/security-guard/Provider/GuardAuthenticationProvider.php(101): App\Security\AccessTokenAuthenticator->getUser('ae7862e86dc110e...', Object(Symfony\Bridge\Doctrine\Security\User\EntityUserProvider))
cdp-web-web           | #1 /var/www/vendor/symfony/security-guard/Provider/GuardAuthenticationProvider.php(95): Symfony\Component\Security\Guard\Provider\GuardAuthenticationProvider->authenticateViaGuard(Object(App\Security\AccessTokenAuthenticator), Object(Symfony\Component\Security\Guard\Token\PreAuthenticationGuardToken))
cdp-web-web           | #2 /var/www/vendor/symfony/security-core/Authentication/AuthenticationProviderManager.php(80): Symfony\Component\Security\Guard\Provider\GuardAuthenticationProvider->authenticate(Object(Symfony\Component\Security\Guard\Token\PreAuthenticationGuardToken))
cdp-web-web           | #3 /var/www/vendor/symfony/security-guard/Firewall/GuardAuthenticationListener.php(135): Symfony\Component\Security\Core\Authentication\AuthenticationProviderManager->authenticate(Object(Symfony\Component\Security\Guard\Token\PreAuthenticationGuardToken))
cdp-web-web           | #4 /var/www/vendor/symfony/security-guard/Firewall/GuardAuthenticationListener.php(87): Symfony\Component\Security\Guard\Firewall\GuardAuthenticationListener->executeGuardAuthenticator('main_1', Object(App\Security\AccessTokenAuthenticator), Object(Symfony\Component\HttpKernel\Event\RequestEvent))
cdp-web-web           | #5 /var/www/vendor/symfony/security-http/Firewall.php(139): Symfony\Component\Security\Guard\Firewall\GuardAuthenticationListener->__invoke(Object(Symfony\Component\HttpKernel\Event\RequestEvent))
cdp-web-web           | #6 /var/www/vendor/symfony/security-http/Firewall.php(129): Symfony\Component\Security\Http\Firewall->handleRequest(Object(Symfony\Component\HttpKernel\Event\RequestEvent), Object(Generator))
cdp-web-web           | #7 /var/www/vendor/symfony/security-http/Firewall.php(97): Symfony\Component\Security\Http\Firewall->callListeners(Object(Symfony\Component\HttpKernel\Event\RequestEvent), Object(Generator))
cdp-web-web           | #8 /var/www/vendor/symfony/event-dispatcher/EventDispatcher.php(298): Symfony\Component\Security\Http\Firewall->onKernelRequest(Object(Symfony\Component\HttpKernel\Event\RequestEvent), 'kernel.request', Object(Symfony\Component\EventDispatcher\EventDispatcher))
cdp-web-web           | #9 /var/www/vendor/symfony/event-dispatcher/EventDispatcher.php(260): Symfony\Component\EventDispatcher\EventDispatcher::Symfony\Component\EventDispatcher\{closure}(Object(Symfony\Component\HttpKernel\Event\RequestEvent), 'kernel.request', Object(Symfony\Component\EventDispatcher\EventDispatcher))
cdp-web-web           | #10 /var/www/vendor/symfony/event-dispatcher/EventDispatcher.php(235): Symfony\Component\EventDispatcher\EventDispatcher->doDispatch(Array, 'kernel.request', Object(Symfony\Component\HttpKernel\Event\RequestEvent))
cdp-web-web           | #11 /var/www/vendor/symfony/event-dispatcher/EventDispatcher.php(73): Symfony\Component\EventDispatcher\EventDispatcher->callListeners(Array, 'kernel.request', Object(Symfony\Component\HttpKernel\Event\RequestEvent))
cdp-web-web           | #12 /var/www/vendor/symfony/http-kernel/HttpKernel.php(127): Symfony\Component\EventDispatcher\EventDispatcher->dispatch(Object(Symfony\Component\HttpKernel\Event\RequestEvent), 'kernel.request')
cdp-web-web           | #13 /var/www/vendor/symfony/http-kernel/HttpKernel.php(68): Symfony\Component\HttpKernel\HttpKernel->handleRaw(Object(Symfony\Component\HttpFoundation\Request), 1)
cdp-web-web           | #14 /var/www/vendor/symfony/http-kernel/Kernel.php(198): Symfony\Component\HttpKernel\HttpKernel->handle(Object(Symfony\Component\HttpFoundation\Request), 1, true)
cdp-web-web           | #15 /ppm/vendor/php-pm/httpkernel-adapter/Bridges/HttpKernel.php(87): Symfony\Component\HttpKernel\Kernel->handle(Object(Symfony\Component\HttpFoundation\Request))
cdp-web-web           | #16 /ppm/vendor/php-pm/php-pm/src/ProcessSlave.php(433): PHPPM\Bridges\HttpKernel->handle(Object(React\Http\Io\ServerRequest))
cdp-web-web           | #17 /ppm/vendor/php-pm/php-pm/src/ProcessSlave.php(397): PHPPM\ProcessSlave->handleRequest(Object(React\Http\Io\ServerRequest))
cdp-web-web           | #18 /ppm/vendor/react/http/src/Io/MiddlewareRunner.php(49): PHPPM\ProcessSlave->onRequest(Object(React\Http\Io\ServerRequest))
cdp-web-web           | #19 /ppm/vendor/react/http/src/Io/MiddlewareRunner.php(54): React\Http\Io\MiddlewareRunner->call(Object(React\Http\Io\ServerRequest), 3)
cdp-web-web           | #20 /ppm/vendor/react/http/src/Middleware/RequestBodyParserMiddleware.php(34): React\Http\Io\MiddlewareRunner->React\Http\Io\{closure}(Object(React\Http\Io\ServerRequest))
cdp-web-web           | #21 /ppm/vendor/react/http/src/Io/MiddlewareRunner.php(59): React\Http\Middleware\RequestBodyParserMiddleware->__invoke(Object(React\Http\Io\ServerRequest), Object(Closure))
cdp-web-web           | #22 /ppm/vendor/react/http/src/Io/MiddlewareRunner.php(54): React\Http\Io\MiddlewareRunner->call(Object(React\Http\Io\ServerRequest), 2)
cdp-web-web           | #23 /ppm/vendor/react/http/src/Middleware/RequestBodyBufferMiddleware.php(44): React\Http\Io\MiddlewareRunner->React\Http\Io\{closure}(Object(React\Http\Io\ServerRequest))
cdp-web-web           | #24 /ppm/vendor/react/http/src/Io/MiddlewareRunner.php(59): React\Http\Middleware\RequestBodyBufferMiddleware->__invoke(Object(React\Http\Io\ServerRequest), Object(Closure))
cdp-web-web           | #25 /ppm/vendor/react/http/src/Io/MiddlewareRunner.php(54): React\Http\Io\MiddlewareRunner->call(Object(React\Http\Io\ServerRequest), 1)
cdp-web-web           | #26 /ppm/vendor/react/http/src/Middleware/LimitConcurrentRequestsMiddleware.php(91): React\Http\Io\MiddlewareRunner->React\Http\Io\{closure}(Object(React\Http\Io\ServerRequest))
cdp-web-web           | #27 /ppm/vendor/react/http/src/Io/MiddlewareRunner.php(59): React\Http\Middleware\LimitConcurrentRequestsMiddleware->__invoke(Object(React\Http\Io\ServerRequest), Object(Closure))
cdp-web-web           | #28 /ppm/vendor/react/http/src/Io/MiddlewareRunner.php(40): React\Http\Io\MiddlewareRunner->call(Object(React\Http\Io\ServerRequest), 0)
cdp-web-web           | #29 /ppm/vendor/react/http/src/StreamingServer.php(239): React\Http\Io\MiddlewareRunner->__invoke(Object(React\Http\Io\ServerRequest))
cdp-web-web           | #30 /ppm/vendor/react/http/src/StreamingServer.php(176): React\Http\StreamingServer->handleRequest(Object(React\Socket\Connection), Object(React\Http\Io\ServerRequest))
cdp-web-web           | #31 /ppm/vendor/evenement/evenement/src/Evenement/EventEmitterTrait.php(123): React\Http\StreamingServer->React\Http\{closure}(Object(React\Http\Io\ServerRequest), '')
cdp-web-web           | #32 /ppm/vendor/react/http/src/Io/RequestHeaderParser.php(59): Evenement\EventEmitter->emit('headers', Array)
cdp-web-web           | #33 /ppm/vendor/react/http/src/Io/RequestHeaderParser.php(47): React\Http\Io\RequestHeaderParser->parseAndEmitRequest(463)
cdp-web-web           | #34 /ppm/vendor/evenement/evenement/src/Evenement/EventEmitterTrait.php(123): React\Http\Io\RequestHeaderParser->feed('GET /api/accoun...')
cdp-web-web           | #35 /ppm/vendor/react/stream/src/Util.php(71): Evenement\EventEmitter->emit('data', Array)
cdp-web-web           | #36 /ppm/vendor/evenement/evenement/src/Evenement/EventEmitterTrait.php(123): React\Stream\Util::React\Stream\{closure}('GET /api/accoun...')
cdp-web-web           | #37 /ppm/vendor/react/stream/src/DuplexResourceStream.php(193): Evenement\EventEmitter->emit('data', Array)
cdp-web-web           | #38 /ppm/vendor/react/event-loop/src/StreamSelectLoop.php(244): React\Stream\DuplexResourceStream->handleData(Resource id #393)
cdp-web-web           | #39 /ppm/vendor/react/event-loop/src/StreamSelectLoop.php(211): React\EventLoop\StreamSelectLoop->waitForStreamActivity(NULL)
cdp-web-web           | #40 /ppm/vendor/php-pm/php-pm/src/ProcessSlave.php(356): React\EventLoop\StreamSelectLoop->run()
cdp-web-web           | #41 /tmp/dbgJddOkp(36): PHPPM\ProcessSlave->run()
cdp-web-web           | #42 {main}
cdp-web-web           | Worker #5501 closed after 0 handled requests
cdp-web-web           | Start new worker #5501
cdp-web-web           | Script did not return a valid HTTP response. Maybe it has called exit() prematurely?
cdp-web-web           | Worker #5501 registered. Waiting for application bootstrap ... 
cdp-web-web           | Worker #5501 ready.
```

Environment:
```
php-pm/php-pm:2.0.1
php-pm/httpkernel-adapter:2.0.2
PHP 7.3.9
Symfony 4.3.4
Debug: 0
```
Might fix #467 and #470 
Hello,
I see workers dead permanently after I changed a file. Here is the log:

```
logs -f web
Attaching to cdp-web-web
cdp-web-web           | CMD: /ppm/vendor/bin/ppm start --ansi --port=8081 --socket-path=/ppm/run --pidfile=/ppm/ppm.pid --static-directory='' --bootstrap=symfony --debug=1 --app-env=dev --workers=3 --memory-limit=512M -vv
cdp-web-web           | PID: 24
cdp-web-web           | Checking if pid 24 is still running
cdp-web-web           | Waiting 24 to complete...
cdp-web-web           | /var/www
cdp-web-web           | +---------------------+-------------------+
cdp-web-web           | | bridge              | HttpKernel        |
cdp-web-web           | | host                | 127.0.0.1         |
cdp-web-web           | | port                | 8081              |
cdp-web-web           | | workers             | 3                 |
cdp-web-web           | | app-env             | dev               |
cdp-web-web           | | debug               | 1                 |
cdp-web-web           | | logging             | 1                 |
cdp-web-web           | | static-directory    | ''                |
cdp-web-web           | | bootstrap           | symfony           |
cdp-web-web           | | max-requests        | 1000              |
cdp-web-web           | | max-execution-time  | 30                |
cdp-web-web           | | memory-limit        | 512               |
cdp-web-web           | | ttl                 | 0                 |
cdp-web-web           | | populate-server-var | 1                 |
cdp-web-web           | | socket-path         | /ppm/run          |
cdp-web-web           | | pidfile             | /ppm/ppm.pid      |
cdp-web-web           | | reload-timeout      | 30                |
cdp-web-web           | | cgi-path            | /usr/bin/php-cgi7 |
cdp-web-web           | +---------------------+-------------------+
cdp-web-web           | Starting PHP-PM with 3 workers, using StreamSelectLoop ...
cdp-web-web           | Start new worker #5501
cdp-web-web           | Start new worker #5502
cdp-web-web           | Start new worker #5503
cdp-web-web           | Worker #5501 registered. Waiting for application bootstrap ... 
cdp-web-web           | Worker #5502 registered. Waiting for application bootstrap ... 
cdp-web-web           | Worker #5503 registered. Waiting for application bootstrap ... 
cdp-web-web           | Worker #5501 ready.
cdp-web-web           | Received 1238 new files from 5501. Stats collection cycle: 1236 files, 1426.331 ms
cdp-web-web           | Worker #5502 ready.
cdp-web-web           | Received 1 new files from 5502. Stats collection cycle: 1237 files, 0.316 ms
cdp-web-web           | Worker #5503 ready.
cdp-web-web           | 3 workers (starting at 5501) up and ready. Application is ready at http://127.0.0.1:8081/
cdp-web-web           | Received 1 new files from 5503. Stats collection cycle: 1238 files, 0.237 ms
cdp-web-web           | Received 228 new files from 5501. Stats collection cycle: 1466 files, 268.800 ms
cdp-web-web           | Current memory usage for worker 5501: 20.00 MB
cdp-web-web           | [07/Oct/2019:15:29:33 +0000] 127.0.0.1 - - "GET /api/account HTTP/1.0" 200 474 "-"
cdp-web-web           | Worker 5501 took abnormal 7.658 seconds for handling a connection
cdp-web-web           | Received 45 new files from 5501. Stats collection cycle: 1511 files, 49.411 ms
cdp-web-web           | Current memory usage for worker 5501: 20.00 MB
cdp-web-web           | [07/Oct/2019:15:30:27 +0000] 127.0.0.1 - - "POST /login HTTP/1.0" 200 502 "-"
cdp-web-web           | Worker 5501 took abnormal 6.461 seconds for handling a connection
cdp-web-web           | Current memory usage for worker 5501: 20.00 MB
cdp-web-web           | [07/Oct/2019:15:30:44 +0000] 127.0.0.1 - - "POST /login HTTP/1.0" 200 502 "-"
cdp-web-web           | Worker 5501 took abnormal 6.212 seconds for handling a connection
cdp-web-web           | Current memory usage for worker 5501: 20.00 MB
cdp-web-web           | [07/Oct/2019:15:31:07 +0000] 127.0.0.1 - - "GET /api/account HTTP/1.0" 200 448 "-"
cdp-web-web           | Worker 5501 took abnormal 7.175 seconds for handling a connection
```

Then I changed a file:

```
cdp-web-web           | [07/Oct/2019:15:31:26 +0000] File /var/www/src/Controller/AccountController.php has changed.
cdp-web-web           | [07/Oct/2019:15:31:26 +0000] At least one of 1511 known files was changed. Reloading workers.
cdp-web-web           | Changes detection cycle length = 458.966 ms
cdp-web-web           | Start new worker #5501
cdp-web-web           | Start new worker #5502
cdp-web-web           | Start new worker #5503
cdp-web-web           | Worker #5502 registered. Waiting for application bootstrap ... 
cdp-web-web           | Worker #5501 registered. Waiting for application bootstrap ... 
cdp-web-web           | Worker #5502 ready.
cdp-web-web           | Received 1 new files from 5502. Stats collection cycle: 1512 files, 0.226 ms
cdp-web-web           | Worker #5503 registered. Waiting for application bootstrap ... 
cdp-web-web           | Worker #5501 ready.
cdp-web-web           | Received 1 new files from 5501. Stats collection cycle: 1513 files, 0.192 ms
cdp-web-web           | Worker #5503 ready.
cdp-web-web           | Received 1 new files from 5503. Stats collection cycle: 1514 files, 0.231 ms
cdp-web-web           | [07/Oct/2019:15:31:46 +0000] File /var/www/var/cache/dev/UrlMatcher.php has changed.
cdp-web-web           | [07/Oct/2019:15:31:46 +0000] At least one of 1514 known files was changed. Reloading workers.
cdp-web-web           | Changes detection cycle length = 1500.104 ms
cdp-web-web           | Start new worker #5501
cdp-web-web           | Start new worker #5502
cdp-web-web           | Start new worker #5503
cdp-web-web           | [07/Oct/2019:15:31:48 +0000] File /var/www/var/cache/dev/UrlGenerator.php has changed.
cdp-web-web           | [07/Oct/2019:15:31:48 +0000] At least one of 1514 known files was changed. Reloading workers.
cdp-web-web           | Changes detection cycle length = 1606.775 ms
cdp-web-web           | Start new worker #5501
cdp-web-web           | Start new worker #5502
cdp-web-web           | Start new worker #5503
cdp-web-web           | Worker 5501 took abnormal 6.264 seconds for handling a connection
cdp-web-web           | Script did not return a valid HTTP response. Maybe it has called exit() prematurely?
cdp-web-web           | Worker #5501 registered. Waiting for application bootstrap ... 
cdp-web-web           | Worker #5503 registered. Waiting for application bootstrap ... 
cdp-web-web           | Worker #5501 ready.
cdp-web-web           | Received 1 new files from 5501. Stats collection cycle: 1515 files, 0.235 ms
cdp-web-web           | Worker #5502 registered. Waiting for application bootstrap ... 
cdp-web-web           | Worker #5503 ready.
cdp-web-web           | Received 1 new files from 5503. Stats collection cycle: 1516 files, 0.198 ms
cdp-web-web           | Worker #5502 wanted to register on master which was not expected.
cdp-web-web           | Worker permanently closed during PHP-PM bootstrap. Not so cool. Not your fault, please create a ticket at github.com/php-pm/php-pm with the output of `ppm start -vv`.
cdp-web-web           | Worker #5502 ready.
cdp-web-web           | Received 1 new files from 5502. Stats collection cycle: 1517 files, 0.170 ms
cdp-web-web           | Worker #5503 wanted to register on master which was not expected.
cdp-web-web           | Worker permanently closed during PHP-PM bootstrap. Not so cool. Not your fault, please create a ticket at github.com/php-pm/php-pm with the output of `ppm start -vv`.
cdp-web-web           | Worker #5501 wanted to register on master which was not expected.
cdp-web-web           | Worker permanently closed during PHP-PM bootstrap. Not so cool. Not your fault, please create a ticket at github.com/php-pm/php-pm with the output of `ppm start -vv`.
```

What this line is mean?
```
cdp-web-web           | Script did not return a valid HTTP response. Maybe it has called exit() prematurely?
```
In the file, I've just changed HTTP response code to 201 from 200 (purely for test how ppm handles files reloading in developer mode)

Next, I've sent that request again:

```
cdp-web-web           | Connection to worker 5501 failed. Try #1, took 0.001s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.672 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #2, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.747 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #3, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.376 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #4, took 0.001s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.447 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #5, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.494 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #6, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.541 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #7, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.439 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #8, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.758 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #9, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.407 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #10, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.356 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #11, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.334 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #12, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.465 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #13, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.193 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #14, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.219 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #15, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.207 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #16, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.340 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #17, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.343 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #18, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.560 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #19, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.751 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #20, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.735 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #21, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | took abnormal 1.688 seconds for choosing next free worker
cdp-web-web           | Connection to worker 5501 failed. Try #22, took 0.000s (timeout 10s). Error message: [111] Unable to connect to unix domain socket "unix:///ppm/run/5501.sock": Connection refused
cdp-web-web           | 
cdp-web-web           | In RequestHandler.php line 271:
cdp-web-web           |                                                             
cdp-web-web           |   [ErrorException]                                          
cdp-web-web           |   Notice: Undefined property: PHPPM\RequestHandler::$slave  
cdp-web-web           |                                                             
cdp-web-web           | 
cdp-web-web           | Exception trace:
cdp-web-web           |   at /ppm/vendor/php-pm/php-pm/src/RequestHandler.php:271
cdp-web-web           |  PHPPM\RequestHandler->maxExecutionTimeExceeded() at /ppm/vendor/react/event-loop/src/Timer/Timers.php:96
cdp-web-web           |  React\EventLoop\Timer\Timers->tick() at /ppm/vendor/react/event-loop/src/StreamSelectLoop.php:183
cdp-web-web           |  React\EventLoop\StreamSelectLoop->run() at /ppm/vendor/php-pm/php-pm/src/ProcessManager.php:521
cdp-web-web           |  PHPPM\ProcessManager->run() at /ppm/vendor/php-pm/php-pm/src/Commands/StartCommand.php:52
cdp-web-web           |  PHPPM\Commands\StartCommand->execute() at /ppm/vendor/symfony/console/Command/Command.php:255
cdp-web-web           |  Symfony\Component\Console\Command\Command->run() at /ppm/vendor/symfony/console/Application.php:915
cdp-web-web           |  Symfony\Component\Console\Application->doRunCommand() at /ppm/vendor/symfony/console/Application.php:272
cdp-web-web           |  Symfony\Component\Console\Application->doRun() at /ppm/vendor/symfony/console/Application.php:148
cdp-web-web           |  Symfony\Component\Console\Application->run() at /ppm/vendor/php-pm/php-pm/bin/ppm:47
cdp-web-web           | 
cdp-web-web           | start [--bridge BRIDGE] [--host HOST] [--port PORT] [--workers WORKERS] [--app-env APP-ENV] [--debug DEBUG] [--logging LOGGING] [--static-directory STATIC-DIRECTORY] [--max-requests MAX-REQUESTS] [--max-execution-time MAX-EXECUTION-TIME] [--memory-limit MEMORY-LIMIT] [--ttl TTL] [--populate-server-var POPULATE-SERVER-VAR] [--bootstrap BOOTSTRAP] [--cgi-path CGI-PATH] [--socket-path SOCKET-PATH] [--pidfile PIDFILE] [--reload-timeout RELOAD-TIMEOUT] [-c|--config CONFIG] [--] [<working-directory>]
cdp-web-web           | 
cdp-web-web           | Server is shutting down.
cdp-web-web           | Worker #5501 terminated, 2 more worker(s) to close.
cdp-web-web           | Worker #5502 terminated, 1 more worker(s) to close.
cdp-web-web           | Worker #5503 terminated, 0 more worker(s) to close.
cdp-web-web           | Stopping the process manager.
cdp-web-web           | PID   USER     TIME  COMMAND
cdp-web-web           |     1 root      0:00 /bin/bash /etc/app/run.sh --bootstrap=symfony --debug=1 --app-env=dev --workers=3 --memory-limit=512M -vv
cdp-web-web           |    17 root      0:00 nginx: master process nginx
cdp-web-web           |    18 nginx     0:00 nginx: worker process
cdp-web-web           |    19 nginx     0:00 nginx: worker process
cdp-web-web           |    20 nginx     0:00 nginx: worker process
cdp-web-web           |    21 nginx     0:00 nginx: worker process
cdp-web-web           |    45 root      0:00 ps ax
cdp-web-web           | /etc/app/run.sh: line 1: warning: run_pending_traps: bad value in trap_list[17]: 0x563771021dd3
cdp-web-web           | /etc/app/run.sh: line 1: kill: (24) - No such process
cdp-web-web           | Trapped CHLD. Sending signal CHLD to PID 24
cdp-web-web exited with code 1
```
This fixed: 

Test `ab -c 10 -n 500 "http://localhost:8080/abtesting/" & bash -c "sleep 5; ./vendor/bin/ppm reload --cgi-path=/usr/local/bin/php"`

Without the fix, I see errors in stderr ppm:
```
Current memory usage for worker 5505: 14.00 MB
[27/Aug/2019:10:05:25 +0300] 172.17.0.1 - - "GET /abtesting HTTP/1.0" 200 18323 "-"
Worker 5505 took abnormal 2.632 seconds for handling a connection
Marking locked worker #5505 as closed
Worker #5505 closed after 0 handled requests
Start new worker #5505
Worker #5505 has been closed, reloading.
Start new worker #5505

In SlavePool.php line 29:

  [Exception]
  Slave port 5505 already occupied.


Exception trace:
  at /var/www/html/vendor/php-pm/php-pm/src/SlavePool.php:29
 PHPPM\SlavePool->add() at /var/www/html/vendor/php-pm/php-pm/src/ProcessManager.php:1238
 PHPPM\ProcessManager->newSlaveInstance() at /var/www/html/vendor/php-pm/php-pm/src/ProcessManager.php:1024
 PHPPM\ProcessManager->PHPPM\{closure}() at /var/www/html/vendor/php-pm/php-pm/src/ProcessManager.php:1068
 PHPPM\ProcessManager->PHPPM\{closure}() at /var/www/html/vendor/evenement/evenement/src/Evenement/EventEmitterTrait.php:123
 Evenement\EventEmitter->emit() at /var/www/html/vendor/react/stream/src/Util.php:71
 React\Stream\Util::React\Stream\{closure}() at /var/www/html/vendor/evenement/evenement/src/Evenement/EventEmitterTrait.php:123
 Evenement\EventEmitter->emit() at /var/www/html/vendor/react/stream/src/DuplexResourceStream.php:138
 React\Stream\DuplexResourceStream->close() at /var/www/html/vendor/react/socket/src/Connection.php:118
 React\Socket\Connection->close() at /var/www/html/vendor/php-pm/php-pm/src/RequestHandler.php:301
 PHPPM\RequestHandler->slaveClosed() at /var/www/html/vendor/evenement/evenement/src/Evenement/EventEmitterTrait.php:123
 Evenement\EventEmitter->emit() at /var/www/html/vendor/react/stream/src/Util.php:71
 React\Stream\Util::React\Stream\{closure}() at /var/www/html/vendor/evenement/evenement/src/Evenement/EventEmitterTrait.php:123
 Evenement\EventEmitter->emit() at /var/www/html/vendor/react/stream/src/DuplexResourceStream.php:138
 React\Stream\DuplexResourceStream->close() at /var/www/html/vendor/react/stream/src/DuplexResourceStream.php:197
 React\Stream\DuplexResourceStream->handleData() at /var/www/html/vendor/react/event-loop/src/StreamSelectLoop.php:244
 React\EventLoop\StreamSelectLoop->waitForStreamActivity() at /var/www/html/vendor/react/event-loop/src/StreamSelectLoop.php:211
 React\EventLoop\StreamSelectLoop->run() at /var/www/html/vendor/php-pm/php-pm/src/ProcessManager.php:521
 PHPPM\ProcessManager->run() at /var/www/html/vendor/php-pm/php-pm/src/Commands/StartCommand.php:52
 PHPPM\Commands\StartCommand->execute() at /var/www/html/vendor/symfony/console/Command/Command.php:255
 Symfony\Component\Console\Command\Command->run() at /var/www/html/vendor/symfony/console/Application.php:915
 Symfony\Component\Console\Application->doRunCommand() at /var/www/html/vendor/symfony/console/Application.php:272
 Symfony\Component\Console\Application->doRun() at /var/www/html/vendor/symfony/console/Application.php:148
 Symfony\Component\Console\Application->run() at /var/www/html/vendor/php-pm/php-pm/bin/ppm:47

start [--bridge BRIDGE] [--host HOST] [--port PORT] [--workers WORKERS] [--app-env APP-ENV] [--debug DEBUG] [--logging LOGGING] [--static-directory STATIC-DIRECTORY] [--max-requests MAX-REQUESTS] [--max-execution-time MAX-EXECUTION-TIME] [--memory-limit MEMORY-LIMIT] [--ttl TTL] [--populate-server-var POPULATE-SERVER-VAR] [--bootstrap BOOTSTRAP] [--cgi-path CGI-PATH] [--socket-path SOCKET-PATH] [--pidfile PIDFILE] [--reload-timeout RELOAD-TIMEOUT] [-c|--config CONFIG] [--] [<working-directory>]

Server is shutting down.
Stopping the process manager.
2019-08-27 07:05:28,563 INFO exited: php-ppm (exit status 1; not expected)
2019-08-27 07:05:28,576 INFO spawned: 'php-ppm' with pid 179
/var/www/html
+---------------------+-------------------------------+
| bridge              | \RMS\RestApi\PhpPM\SlimBridge |
| host                | 0.0.0.0                       |
| port                | 8080                          |
| workers             | 8                             |
| app-env             | prod                          |
| debug               | 0                             |
| logging             | 1                             |
| static-directory    |                               |
| bootstrap           | \RMS\RestApi\PhpPM\Bootstrap  |
| max-requests        | 1000                          |
| max-execution-time  | 30                            |
| memory-limit        | 192                           |
| ttl                 | 0                             |
| populate-server-var | 1                             |
| socket-path         | .ppm/run/                     |
| pidfile             | .ppm/ppm.pid                  |
| reload-timeout      | 30                            |
| cgi-path            | /usr/local/bin/php            |
+---------------------+-------------------------------+

In TcpServer.php line 164:

  [RuntimeException]
  Failed to listen on "tcp://0.0.0.0:8080": Address in use


Exception trace:
  at /var/www/html/vendor/react/socket/src/TcpServer.php:164
 React\Socket\TcpServer->__construct() at /var/www/html/vendor/react/socket/src/Server.php:36
 React\Socket\Server->__construct() at /var/www/html/vendor/php-pm/php-pm/src/ProcessManager.php:499
 PHPPM\ProcessManager->run() at /var/www/html/vendor/php-pm/php-pm/src/Commands/StartCommand.php:52
 PHPPM\Commands\StartCommand->execute() at /var/www/html/vendor/symfony/console/Command/Command.php:255
 Symfony\Component\Console\Command\Command->run() at /var/www/html/vendor/symfony/console/Application.php:915
 Symfony\Component\Console\Application->doRunCommand() at /var/www/html/vendor/symfony/console/Application.php:272
 Symfony\Component\Console\Application->doRun() at /var/www/html/vendor/symfony/console/Application.php:148
 Symfony\Component\Console\Application->run() at /var/www/html/vendor/php-pm/php-pm/bin/ppm:47

start [--bridge BRIDGE] [--host HOST] [--port PORT] [--workers WORKERS] [--app-env APP-ENV] [--debug DEBUG] [--logging LOGGING] [--static-directory STATIC-DIRECTORY] [--max-requests MAX-REQUESTS] [--max-execution-time MAX-EXECUTION-TIME] [--memory-limit MEMORY-LIMIT] [--ttl TTL] [--populate-server-var POPULATE-SERVER-VAR] [--bootstrap BOOTSTRAP] [--cgi-path CGI-PATH] [--socket-path SOCKET-PATH] [--pidfile PIDFILE] [--reload-timeout RELOAD-TIMEOUT] [-c|--config CONFIG] [--] [<working-directory>]

Server is shutting down.
Stopping the process manager.
PHP Fatal error:  Uncaught ErrorException: Warning: unlink(.ppm/ppm.pid): No such file or directory in /var/www/html/vendor/php-pm/php-pm/src/ProcessManager.php:306
Stack trace:
#0 /var/www/html/vendor/php-pm/php-pm/src/ProcessManager.php(263): PHPPM\ProcessManager->quit()
#1 [internal function]: PHPPM\ProcessManager->shutdown()
#2 {main}
  thrown in /var/www/html/vendor/php-pm/php-pm/src/ProcessManager.php on line 306
PHP Stack trace:
PHP   1. {main}() /var/www/html/vendor/php-pm/php-pm/bin/ppm:0
PHP   2. Symfony\Component\Console\Application->run() /var/www/html/vendor/php-pm/php-pm/bin/ppm:47
2019-08-27 07:05:29,450 INFO exited: php-ppm (exit status 1; not expected)
^C2019-08-27 07:05:29,786 WARN received SIGINT indicating exit request
2019-08-27 07:05:29,786 INFO waiting for processes, php-ppm, statsd_exporter, confd to die
2019-08-27 07:05:29,788 INFO stopped: statsd_exporter (terminated by SIGTERM)
2019-08-27T07:05:29Z 00ab0492ec00 /usr/local/sbin/confd[89]: INFO Captured terminated. Exiting...
2019-08-27 07:05:29,794 INFO stopped: confd (exit status 0)
^C2019-08-27 07:05:30,712 WARN received SIGINT indicating exit request
2019-08-27 07:05:30,714 INFO stopped: processes (terminated by SIGTERM)
```

One of the things php-pm allows to do, which simple php-fpm doesn't, is to share the state between the requests. Of course, this shouldn't be overused, but is caching things in-memory is quite possible use-case, and is fastest approach possible (faster than using external storage, like Redis or Memcached).
One thing which could be improved over straight-forward implementation is cache invalidation. This could be done using one of React libraries, like predis-async or RabbitMQ integration â it does not add any latency to the requests and cache is invalidated in all the workers as soon as this is needed.

What's missing to implement this properly with current core is ability to access the event-loop that's used by php-pm. It's inside `ProcessSlave` class, which is not configurable, and is not passed anyhow to the bridge.

Implementing this is possible, but quite hackish. Currently the `ProcessSlave` instance creation is hard-coded inside local variable in quite long method body (`\PHPPM\ProcessManager::newSlaveInstance`). So, it's possible to extend `ProcessManager`, overwrite the method, copy the contents and change only that single place (classname of `ProcessSlave`), but this makes it quite hard to maintain with the base code if anything would change in the core. Also it needs quite many copy-paste from `ProcessSlave`, as `run` method needs to be changed, which calls 2 other private methods, which in turn have to also be copy-pasted. Well, you get the drill.

A bit simpler (but probably even more hackish) approach is to get `ProcessSlave::$slave` and get `$loop` by using reflection and making it public.

I assume there could be several approaches how to achieve this:
1. Make `ProcessSlave` class configurable (noted in #216, but not followed upon). This would also need some protected method for a hook to bind the `$this->loop` inside `run` method.
2. Change `\PHPPM\ProcessSlave::run` method to call some outside class to store the `$loop` inside, let's say, static publicly accessible variable.
3. Expose the `$loop` variable with public function. It could be accessed by calling `ProcessSlave::$slave->getLoop()`.

Current PoC I have set up locally:
```php
class ProcessSlave
{
    // ...
    public function run()
    {
        $this->loop = Factory::create();

        $this->errorLogger = BufferingLogger::create();
        ErrorHandler::register(new ErrorHandler($this->errorLogger));

        \EventLoopProvider::registerLoop($this->loop); // this line was added

        $this->tryConnect();
        $this->loop->run();
    }
    // ...
}
```

This is just a wrapper to avoid using static context in various places. Expected to be service in Symfony DIC. Could also provide methods for getting if we're even running in the php-pm context.
```php
class EventLoopProvider
{
    private static $staticEventLoop;
    private $eventLoop;

    public function __construct()
    {
        $this->eventLoop = self::$staticEventLoop;
    }

    public static function registerLoop(LoopInterface $eventLoop)
    {
        self::$staticEventLoop = $eventLoop;
    }

    public function getEventLoop()
    {
        return $this->eventLoop;
    }
}
```

Example of storage with automatic cache invalidation. Expects for message to be published, but could also use [Keyspace notifications](https://redis.io/topics/notifications) if enabled.
```php
class RedisStorage
{
    private $client;
    private $asyncClient;

    private $values = [];

    public function __construct(EventLoopProvider $eventLoopProvider)
    {
        $this->client = new \Predis\Client('tcp://redis:6379');
        $this->asyncClient = new \Predis\Async\Client('tcp://redis:6379', $eventLoopProvider->getEventLoop());
    }

    public function get(string $key)
    {
        if (!isset($this->values[$key])) {
            $this->loadValue($key);
        }

        return $this->values[$key];
    }

    private function loadValue(string $key)
    {
        $value = $this->client->get($key);
        $this->values[$key] = $value;

        if (!$this->asyncClient->isConnected()) {
            $this->asyncClient->connect(function () use ($key) {
                $this->subscribe($key);
            });
        } else {
            $this->subscribe($key);
        }
    }

    private function subscribe(string $key)
    {
        $this->asyncClient->pubSubLoop('changed:' . $key, function () {
            unset($this->values[$key]);
        });
    }
}
```

Is this something you would consider to make available? I could make a pull-request, but I wanted to check the preferred approach, if any of them makes sense.