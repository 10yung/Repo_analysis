I use zuul 、oauth and jwt  to  construct  a sso system,  An error was reported when requesting the application interface

**zuul  config:**


spring:
  application:
    name: zuul-server



server:
  port: 5555
  use-forward-headers: true


eureka:
  client:
    serviceUrl:
      defaultZone: "http://admin:epxing@${eureka.host:127.0.0.1}:${eureka.port:8761}/eureka"
  instance:
    prefer-ip-address: true



zuul:
  routes:
    client-a:
      path: /demo/**
      serviceId: client-demo
    auth-server:
      path: /auth/**
      serviceId: auth-server
      stripPrefix: true
  sensitive-headers: Cookie,Set-Cookie



security:
  oauth2:
    client:
      access-token-uri: http://localhost:7777/auth/oauth/token
      user-authorization-uri: http://localhost:7777/auth/oauth/authorize
      client-id: epxing-auth
      client-secret: epxing
#      grant-type: password
      grant-type: authorization_code
    resource:
      jwt:
        key-value: epxing
    sso:
      login-path: /auth-server/auth/login
    authorization:
      check-token-access:  http://localhost:7777/auth/oauth/check_token



logging:
  level:
    org.springframework.security: debug
    com.netflix: DEBUG


# logback日志配置,日志环境类型，服务名，级别
log.env.profile: dev
log.env.module: epxing-zuul
log.env.logger.level: info


WebSecurityConfigurerAdapter   config:

@Configuration
@Order(1)
@EnableWebSecurity
@EnableOAuth2Sso
public class ZuulWebSecurityConfigurerAdapter extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .authorizeRequests()
                .antMatchers(BaseConstants.LOGIN_URL,"/auth-server/auth/**")
                .permitAll()
                .anyRequest()
                .authenticated()
                .and()
                .csrf()
                .disable()
                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and()
                // 退出的URL是/logout
                .logout().logoutUrl(BaseConstants.LOGOUT_URL).permitAll()
                // 退出成功后，跳转到/路径。
                .logoutSuccessUrl(BaseConstants.LOGIN_URL).permitAll();
    }

}

ERROR:
2020-01-18 11:19:57.973 DEBUG 17284 --- [nio-5555-exec-5] o.s.s.w.a.ExceptionTranslationFilter     : Calling Authentication entry point.
2020-01-18 11:19:57.973 DEBUG 17284 --- [nio-5555-exec-5] o.s.s.w.a.Http403ForbiddenEntryPoint     : Pre-authenticated entry point called. Rejecting access
2020-01-18 11:19:57.973 DEBUG 17284 --- [nio-5555-exec-5] o.s.s.w.header.writers.HstsHeaderWriter  : Not injecting HSTS header since it did not match the requestMatcher org.springframework.security.web.header.writers.HstsHeaderWriter$SecureRequestMatcher@67b2fa23
2020-01-18 11:19:57.973 DEBUG 17284 --- [nio-5555-exec-5] s.s.w.c.SecurityContextPersistenceFilter : SecurityContextHolder now cleared, as request processing completed
2020-01-18 11:19:57.974 DEBUG 17284 --- [nio-5555-exec-5] o.s.security.web.FilterChainProxy        : /error at position 1 of 10 in additional filter chain; firing Filter: 'WebAsyncManagerIntegrationFilter'
2020-01-18 11:19:57.974 DEBUG 17284 --- [nio-5555-exec-5] o.s.security.web.FilterChainProxy        : /error at position 2 of 10 in additional filter chain; firing Filter: 'SecurityContextPersistenceFilter'
2020-01-18 11:19:57.974 DEBUG 17284 --- [nio-5555-exec-5] o.s.security.web.FilterChainProxy        : /error at position 3 of 10 in additional filter chain; firing Filter: 'HeaderWriterFilter'
2020-01-18 11:19:57.974 DEBUG 17284 --- [nio-5555-exec-5] o.s.security.web.FilterChainProxy        : /error at position 4 of 10 in additional filter chain; firing Filter: 'LogoutFilter'
2020-01-18 11:19:57.974 DEBUG 17284 --- [nio-5555-exec-5] o.s.s.web.util.matcher.OrRequestMatcher  : Trying to match using Ant [pattern='/auth-server/auth/logout', GET]
2020-01-18 11:19:57.974 DEBUG 17284 --- [nio-5555-exec-5] o.s.s.w.u.matcher.AntPathRequestMatcher  : Checking match of request : '/error'; against '/auth-server/auth/logout'
2020-01-18 11:19:57.974 DEBUG 17284 --- [nio-5555-exec-5] o.s.s.web.util.matcher.OrRequestMatcher  : Trying to match using Ant [pattern='/auth-server/auth/logout', POST]
2020-01-18 11:19:57.974 DEBUG 17284 --- [nio-5555-exec-5] o.s.s.w.u.matcher.AntPathRequestMatcher  : Request 'GET /error' doesn't match 'POST /auth-server/auth/logout
2020-01-18 11:19:57.974 DEBUG 17284 --- [nio-5555-exec-5] o.s.s.web.util.matcher.OrRequestMatcher  : Trying to match using Ant [pattern='/auth-server/auth/logout', PUT]
2020-01-18 11:19:57.975 DEBUG 17284 --- [nio-5555-exec-5] o.s.s.w.u.matcher.AntPathRequestMatcher  : Request 'GET /error' doesn't match 'PUT /auth-server/auth/logout
2020-01-18 11:19:57.975 DEBUG 17284 --- [nio-5555-exec-5] o.s.s.web.util.matcher.OrRequestMatcher  : Trying to match using Ant [pattern='/auth-server/auth/logout', DELETE]
2020-01-18 11:19:57.975 DEBUG 17284 --- [nio-5555-exec-5] o.s.s.w.u.matcher.AntPathRequestMatcher  : Request 'GET /error' doesn't match 'DELETE /auth-server/auth/logout
2020-01-18 11:19:57.976 DEBUG 17284 --- [nio-5555-exec-5] o.s.s.web.util.matcher.OrRequestMatcher  : No matches found
2020-01-18 11:19:57.976 DEBUG 17284 --- [nio-5555-exec-5] o.s.security.web.FilterChainProxy        : /error at position 5 of 10 in additional filter chain; firing Filter: 'RequestCacheAwareFilter'
2020-01-18 11:19:57.976 DEBUG 17284 --- [nio-5555-exec-5] o.s.security.web.FilterChainProxy        : /error at position 6 of 10 in additional filter chain; firing Filter: 'SecurityContextHolderAwareRequestFilter'
2020-01-18 11:19:57.976 DEBUG 17284 --- [nio-5555-exec-5] o.s.security.web.FilterChainProxy        : /error at position 7 of 10 in additional filter chain; firing Filter: 'AnonymousAuthenticationFilter'
2020-01-18 11:19:57.976 DEBUG 17284 --- [nio-5555-exec-5] o.s.s.w.a.AnonymousAuthenticationFilter  : Populated SecurityContextHolder with anonymous token: 'org.springframework.security.authentication.AnonymousAuthenticationToken@4cf514ec: Principal: anonymousUser; Credentials: [PROTECTED]; Authenticated: true; Details: org.springframework.security.web.authentication.WebAuthenticationDetails@fffde5d4: RemoteIpAddress: 0:0:0:0:0:0:0:1; SessionId: CB34F498A8C8BD410F1866FC2DCAECE9; Granted Authorities: ROLE_ANONYMOUS'
2020-01-18 11:19:57.976 DEBUG 17284 --- [nio-5555-exec-5] o.s.security.web.FilterChainProxy        : /error at position 8 of 10 in additional filter chain; firing Filter: 'SessionManagementFilter'
2020-01-18 11:19:57.976 DEBUG 17284 --- [nio-5555-exec-5] o.s.security.web.FilterChainProxy        : /error at position 9 of 10 in additional filter chain; firing Filter: 'ExceptionTranslationFilter'
2020-01-18 11:19:57.976 DEBUG 17284 --- [nio-5555-exec-5] o.s.security.web.FilterChainProxy        : /error at position 10 of 10 in additional filter chain; firing Filter: 'FilterSecurityInterceptor'
2020-01-18 11:19:57.976 DEBUG 17284 --- [nio-5555-exec-5] o.s.security.web.FilterChainProxy        : /error reached end of additional filter chain; proceeding with original chain
2020-01-18 11:19:57.979 DEBUG 17284 --- [nio-5555-exec-5] o.s.s.w.a.ExceptionTranslationFilter     : Chain processed normally
2020-01-18 11:19:57.980 DEBUG 17284 --- [nio-5555-exec-5] s.s.w.c.SecurityContextPersistenceFilter : SecurityContextHolder now cleared, as request processing completed
2020-01-18 11:19:58.982 DEBUG 17284 --- [nio-5555-exec-6] o.s.security.web.FilterChainProxy        : /client-demo/api/product/1 at position 1 of 10 in additional filter chain; firing Filter: 'WebAsyncManagerIntegrationFilter'
2020-01-18 11:19:58.983 DEBUG 17284 --- [nio-5555-exec-6] o.s.security.web.FilterChainProxy        : /client-demo/api/product/1 at position 2 of 10 in additional filter chain; firing Filter: 'SecurityContextPersistenceFilter'
2020-01-18 11:19:58.983 DEBUG 17284 --- [nio-5555-exec-6] o.s.security.web.FilterChainProxy        : /client-demo/api/product/1 at position 3 of 10 in additional filter chain; firing Filter: 'HeaderWriterFilter'
2020-01-18 11:19:58.983 DEBUG 17284 --- [nio-5555-exec-6] o.s.security.web.FilterChainProxy        : /client-demo/api/product/1 at position 4 of 10 in additional filter chain; firing Filter: 'LogoutFilter'
2020-01-18 11:19:58.983 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.web.util.matcher.OrRequestMatcher  : Trying to match using Ant [pattern='/auth-server/auth/logout', GET]
2020-01-18 11:19:58.983 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.w.u.matcher.AntPathRequestMatcher  : Checking match of request : '/client-demo/api/product/1'; against '/auth-server/auth/logout'
2020-01-18 11:19:58.983 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.web.util.matcher.OrRequestMatcher  : Trying to match using Ant [pattern='/auth-server/auth/logout', POST]
2020-01-18 11:19:58.983 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.w.u.matcher.AntPathRequestMatcher  : Request 'GET /client-demo/api/product/1' doesn't match 'POST /auth-server/auth/logout
2020-01-18 11:19:58.983 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.web.util.matcher.OrRequestMatcher  : Trying to match using Ant [pattern='/auth-server/auth/logout', PUT]
2020-01-18 11:19:58.983 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.w.u.matcher.AntPathRequestMatcher  : Request 'GET /client-demo/api/product/1' doesn't match 'PUT /auth-server/auth/logout
2020-01-18 11:19:58.983 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.web.util.matcher.OrRequestMatcher  : Trying to match using Ant [pattern='/auth-server/auth/logout', DELETE]
2020-01-18 11:19:58.983 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.w.u.matcher.AntPathRequestMatcher  : Request 'GET /client-demo/api/product/1' doesn't match 'DELETE /auth-server/auth/logout
2020-01-18 11:19:58.983 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.web.util.matcher.OrRequestMatcher  : No matches found
2020-01-18 11:19:58.983 DEBUG 17284 --- [nio-5555-exec-6] o.s.security.web.FilterChainProxy        : /client-demo/api/product/1 at position 5 of 10 in additional filter chain; firing Filter: 'RequestCacheAwareFilter'
2020-01-18 11:19:58.983 DEBUG 17284 --- [nio-5555-exec-6] o.s.security.web.FilterChainProxy        : /client-demo/api/product/1 at position 6 of 10 in additional filter chain; firing Filter: 'SecurityContextHolderAwareRequestFilter'
2020-01-18 11:19:58.984 DEBUG 17284 --- [nio-5555-exec-6] o.s.security.web.FilterChainProxy        : /client-demo/api/product/1 at position 7 of 10 in additional filter chain; firing Filter: 'AnonymousAuthenticationFilter'
2020-01-18 11:19:58.984 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.w.a.AnonymousAuthenticationFilter  : Populated SecurityContextHolder with anonymous token: 'org.springframework.security.authentication.AnonymousAuthenticationToken@4cf514ec: Principal: anonymousUser; Credentials: [PROTECTED]; Authenticated: true; Details: org.springframework.security.web.authentication.WebAuthenticationDetails@fffde5d4: RemoteIpAddress: 0:0:0:0:0:0:0:1; SessionId: CB34F498A8C8BD410F1866FC2DCAECE9; Granted Authorities: ROLE_ANONYMOUS'
2020-01-18 11:19:58.984 DEBUG 17284 --- [nio-5555-exec-6] o.s.security.web.FilterChainProxy        : /client-demo/api/product/1 at position 8 of 10 in additional filter chain; firing Filter: 'SessionManagementFilter'
2020-01-18 11:19:58.984 DEBUG 17284 --- [nio-5555-exec-6] o.s.security.web.FilterChainProxy        : /client-demo/api/product/1 at position 9 of 10 in additional filter chain; firing Filter: 'ExceptionTranslationFilter'
2020-01-18 11:19:58.984 DEBUG 17284 --- [nio-5555-exec-6] o.s.security.web.FilterChainProxy        : /client-demo/api/product/1 at position 10 of 10 in additional filter chain; firing Filter: 'FilterSecurityInterceptor'
2020-01-18 11:19:58.985 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.web.util.matcher.OrRequestMatcher  : Trying to match using Ant [pattern='/auth-server/auth/logout', GET]
2020-01-18 11:19:58.985 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.w.u.matcher.AntPathRequestMatcher  : Checking match of request : '/client-demo/api/product/1'; against '/auth-server/auth/logout'
2020-01-18 11:19:58.985 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.web.util.matcher.OrRequestMatcher  : Trying to match using Ant [pattern='/auth-server/auth/logout', POST]
2020-01-18 11:19:58.985 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.w.u.matcher.AntPathRequestMatcher  : Request 'GET /client-demo/api/product/1' doesn't match 'POST /auth-server/auth/logout
2020-01-18 11:19:58.985 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.web.util.matcher.OrRequestMatcher  : Trying to match using Ant [pattern='/auth-server/auth/logout', PUT]
2020-01-18 11:19:58.985 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.w.u.matcher.AntPathRequestMatcher  : Request 'GET /client-demo/api/product/1' doesn't match 'PUT /auth-server/auth/logout
2020-01-18 11:19:58.985 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.web.util.matcher.OrRequestMatcher  : Trying to match using Ant [pattern='/auth-server/auth/logout', DELETE]
2020-01-18 11:19:58.985 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.w.u.matcher.AntPathRequestMatcher  : Request 'GET /client-demo/api/product/1' doesn't match 'DELETE /auth-server/auth/logout
2020-01-18 11:19:58.985 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.web.util.matcher.OrRequestMatcher  : No matches found
2020-01-18 11:19:58.985 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.w.u.matcher.AntPathRequestMatcher  : Checking match of request : '/client-demo/api/product/1'; against '/auth-server/auth/login'
2020-01-18 11:19:58.985 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.w.u.matcher.AntPathRequestMatcher  : Checking match of request : '/client-demo/api/product/1'; against '/auth-server/auth/**'
2020-01-18 11:19:58.985 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.w.u.matcher.AntPathRequestMatcher  : Checking match of request : '/client-demo/api/product/1'; against '/auth-server/auth/oauth/token'
2020-01-18 11:19:58.985 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.w.a.i.FilterSecurityInterceptor    : Secure object: FilterInvocation: URL: /client-demo/api/product/1; Attributes: [authenticated]
2020-01-18 11:19:58.985 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.w.a.i.FilterSecurityInterceptor    : Previously Authenticated: org.springframework.security.authentication.AnonymousAuthenticationToken@4cf514ec: Principal: anonymousUser; Credentials: [PROTECTED]; Authenticated: true; Details: org.springframework.security.web.authentication.WebAuthenticationDetails@fffde5d4: RemoteIpAddress: 0:0:0:0:0:0:0:1; SessionId: CB34F498A8C8BD410F1866FC2DCAECE9; Granted Authorities: ROLE_ANONYMOUS
2020-01-18 11:19:58.985 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.access.vote.AffirmativeBased       : Voter: org.springframework.security.web.access.expression.WebExpressionVoter@97e3295, returned: -1
2020-01-18 11:19:58.986 DEBUG 17284 --- [nio-5555-exec-6] o.s.s.w.a.ExceptionTranslationFilter     : Access is denied (user is anonymous); redirecting to authentication entry point

org.springframework.security.access.AccessDeniedException: Access is denied
	at org.springframework.security.access.vote.AffirmativeBased.decide(AffirmativeBased.java:84)
	at org.springframework.security.access.intercept.AbstractSecurityInterceptor.beforeInvocation(AbstractSecurityInterceptor.java:233)
	at org.springframework.security.web.access.intercept.FilterSecurityInterceptor.invoke(FilterSecurityInterceptor.java:124)
	at org.springframework.security.web.access.intercept.FilterSecurityInterceptor.doFilter(FilterSecurityInterceptor.java:91)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:119)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:137)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:111)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:170)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:116)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:66)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
	at org.springframework.security.web.context.SecurityContextPersistenceFilter.doFilter(SecurityContextPersistenceFilter.java:105)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:56)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:215)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:178)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:357)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:270)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:99)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.springframework.security.oauth2.client.filter.OAuth2ClientContextFilter.doFilter(OAuth2ClientContextFilter.java:60)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.springframework.web.filter.HttpPutFormContentFilter.doFilterInternal(HttpPutFormContentFilter.java:109)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.springframework.web.filter.HiddenHttpMethodFilter.doFilterInternal(HiddenHttpMethodFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.filterAndRecordMetrics(WebMvcMetricsFilter.java:155)
	at org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.filterAndRecordMetrics(WebMvcMetricsFilter.java:123)
	at org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.doFilterInternal(WebMvcMetricsFilter.java:108)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:200)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:198)
	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:96)
	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:493)
	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:140)
	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:81)
	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:87)
	at org.apache.catalina.valves.RemoteIpValve.invoke(RemoteIpValve.java:685)
	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:342)
	at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:800)
	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66)
	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:806)
	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1498)
	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)
	at java.lang.Thread.run(Thread.java:748)


Request with token，postman back info:

{
    "timestamp": "2020-01-18T03:28:31.127+0000",
    "status": 403,
    "error": "Forbidden",
    "message": "Access Denied",
    "path": "/client-demo/api/product/1"
}




Since there is no longer a tag 2.1 in the repo all links in the wiki broke unintentionally. If Github allowed PRs to wikis (benefit of having all .md files within the repo instead of the built in Wiki IMO) I would have created a PR to fix this issue (instead below is a diff of what I think fixes this).

https://github.com/Netflix/zuul/tree/2.1/zuul-core no longer resolves to source code and instead should be https://github.com/Netflix/zuul/tree/master/zuul-core.

Attached is a git diff replacing all 2.1 links with master.
[update-2.1-links.patch.zip](https://github.com/Netflix/zuul/files/4077691/update-2.1-links.patch.zip)

How does websocket connect to the back-end cluster through zuul2.1.0, I tried a lot of online configurations but found that they are not available. There are too few examples of zuul2.1.0 configuration to support websocket, can you help me
See: https://github.com/gradle/wrapper-validation-action
NOTE: not sure if this is a bug or a misuse of the zuul server.

**Affected Version**: 
com.netflix.zuul:zuul-core:2.1.6

**Context**:
Running instances of zuul server part of integration tests (using Junit).

**Steps**:
* Create an integration test that creates a new instance of a Zuul server at the beginning of each test and tears it down at the end of each test. 
* Make sure that there are at least two tests method in the test class, so that there will be two zuul instances created (one after the other).
* Run the test class

**Expected Result**:
No errors (same behavior as with version 2.1.3)

**What happened instead ?**
Using version 2.1.6, the following PassportStateServerHandler `spectator` related `precondition exception` is now thrown when the second test method is executed (i.e. when the second zuul server is started):
```
2020-01-07 16:17:33,000 WARN  io.netty.channel.ChannelInitializer [Salamander-ClientToZuulWorker-0] Failed to initialize a channel. Closing: [id: 0x0dc14a75, L:/127.0.0.1:57176 - R:/127.0.0.1:57191]
java.lang.IllegalStateException: registry already set
	at com.google.common.base.Preconditions.checkState(Preconditions.java:508)
	at com.netflix.zuul.netty.insights.PassportStateServerHandler.setRegistry(PassportStateServerHandler.java:52)
	at com.netflix.zuul.netty.server.BaseZuulChannelInitializer.addPassportHandler(BaseZuulChannelInitializer.java:226)
	at com.netflix.zuul.netty.server.ZuulServerChannelInitializer.initChannel(ZuulServerChannelInitializer.java:59)
	at io.netty.channel.ChannelInitializer.initChannel(ChannelInitializer.java:129)
	at io.netty.channel.ChannelInitializer.handlerAdded(ChannelInitializer.java:112)
	at io.netty.channel.AbstractChannelHandlerContext.callHandlerAdded(AbstractChannelHandlerContext.java:964)
	at io.netty.channel.DefaultChannelPipeline.callHandlerAdded0(DefaultChannelPipeline.java:613)
	at io.netty.channel.DefaultChannelPipeline.access$100(DefaultChannelPipeline.java:46)
	at io.netty.channel.DefaultChannelPipeline$PendingHandlerAddedTask.execute(DefaultChannelPipeline.java:1475)
	at io.netty.channel.DefaultChannelPipeline.callHandlerAddedForAllHandlers(DefaultChannelPipeline.java:1127)
	at io.netty.channel.DefaultChannelPipeline.invokeHandlerAddedIfNeeded(DefaultChannelPipeline.java:654)
	at io.netty.channel.AbstractChannel$AbstractUnsafe.register0(AbstractChannel.java:503)
	at io.netty.channel.AbstractChannel$AbstractUnsafe.access$200(AbstractChannel.java:416)
	at io.netty.channel.AbstractChannel$AbstractUnsafe$1.run(AbstractChannel.java:475)
	at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:163)
	at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:510)
	at io.netty.channel.kqueue.KQueueEventLoop.run(KQueueEventLoop.java:293)
	at io.netty.util.concurrent.SingleThreadEventExecutor$6.run(SingleThreadEventExecutor.java:1050)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.Thread.run(Thread.java:748)
```

**Analysis**:
The exception seems to be thrown by a precondition related to a `static registry` field used for analytics purposes (i.e. spectator).
So, this new check makes it impossible to instantiate multiple zuul servers within the same JVM instance. Not sure if it ever was. May be, it is just not supported.

I was wondering if you had any workaround to suggest for running zuul instances in the context of integration tests? 
I am thinking of using reflection to reset the registry to null at the beginning of each test, since spectator is not really important in my integration test anyway. Any thoughts ?

I have three services. A front-end service B Gateway Service C back-end websocket service. When B service is not used, a and C can be connected by websocket. After B service is added, a connection B can not be forwarded to C.
Zuul doesn't support this? Or is there a problem with the configuration?

Page error reporting
chat1:27 WebSocket connection to 'ws://172.20.12.31:20047/xiyiwebsocket/callPhone?id=1001' failed: Error during WebSocket handshake: Unexpected response code: 400

```
//A：front-end service
//ws = new WebSocket("ws://172.20.12.31:20204/callPhone?id=" + id); C background service websocket address
ws = new WebSocket("ws://172.20.12.31:20047/xiyiwebsocket/callPhone?id=" + id); //B gateway service address
ws.onopen = function () {
    // Web Socket 已连接上，使用 send() 方法发送数据
    console.log("建立连接1001");
    //ws.send("1001");
};
```  


```
//B: Gateway Service
#zuul 配置
zuul:
  routes:
  #websocket网关
      zhineng-websocket:
        path: /xiyiwebsocket/**
        serviceId: zhineng-websocket-local


@Component
@Slf4j
public class AdminAuthorizationPreFilter extends ZuulFilter {
    @Override
    public String filterType() {
        return "pre";
    }
    @Override
    public int filterOrder() {
        return 0;
    }
    @Override
    public boolean shouldFilter() {
        return true;
    }
    @Override
    public Object run() {
        RequestContext context = RequestContext.getCurrentContext();
        try {
            HttpServletRequest request = context.getRequest();
            String upgradeHeader = request.getHeader("Upgrade");
            if (null == upgradeHeader) {
                upgradeHeader = request.getHeader("upgrade");
            }
            if (null != upgradeHeader && "websocket".equalsIgnoreCase(upgradeHeader)) {
                context.addZuulRequestHeader("connection", "Upgrade");
            }
        } catch (Exception e) {
            log.error("", e);
        }
        return null;
    }
}
```  

```
//C 

@WebSockerServer("/callPhone")
public class CallPhoneWebSocketService extends TextWebSocketHandler {

    /**
     * 建立连接后触发的回调
     */
    public void afterConnectionEstablished(WebSocketSession session) {
        System.out.println("建立连接");
    }

    /**
     * 收到消息时触发的回调
     */
    public void handleMessage(WebSocketSession session, WebSocketMessage<?> message) throws IOException {
        String msg = message.getPayload().toString();
        System.out.println("收到消息" + msg);
    }
}

```
We're noticing that these errors are showing up in our logs quite frequently:

> 19-Dec-2019 12:15:43.402 SEVERE [ContainerBackgroundProcessor[StandardEngine[Catalina]]] org.apache.catalina.loader.WebappClassLoaderBase.checkThreadLocalMapForLeaks The web application [***] created a ThreadLocal with key of type [com.netflix.zuul.context.RequestContext$1] (value [com.netflix.zuul.context.RequestContext$1@5f541b2b]) and a value of type [com.netflix.zuul.context.RequestContext] (value [{}]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to try and avoid a probable memory leak.

I found this issue on GitHub https://github.com/spring-cloud/spring-cloud-netflix/issues/3538 but the spring-cloud-netflix project says it should be fixed in this project. I couldn't find a related issue on this project so I opened this issue.

Our operations team has reported that whenever they see these errors, Tomcat decides to restart on its own which may prevent an `OutOfMemoryError` but it would not be an ideal 
solution.

We're using `org.springframework.cloud:spring-cloud-starter-netflix-zuul:2.1.3.RELEASE`, if that helps.
We miss a question. We are using spring cloud in Greenwich.RC2. When The service is runing, the Zuul occur connection reset exception. I need help. Exceptions are as follows.

Spring cloud version: Greenwich.RC2

Zuul: spring-cloud-starter-netflix-zuul:2.1.0.RC3


```
com.netflix.zuul.exception.ZuulException: Forwarding error
    	at org.springframework.cloud.netflix.zuul.filters.route.RibbonRoutingFilter.handleException(RibbonRoutingFilter.java:191)
    	at org.springframework.cloud.netflix.zuul.filters.route.RibbonRoutingFilter.forward(RibbonRoutingFilter.java:166)
    	at org.springframework.cloud.netflix.zuul.filters.route.RibbonRoutingFilter.run(RibbonRoutingFilter.java:114)
    	at com.netflix.zuul.ZuulFilter.runFilter(ZuulFilter.java:117)
    	at com.netflix.zuul.FilterProcessor.processZuulFilter(FilterProcessor.java:193)
    	at com.netflix.zuul.FilterProcessor.runFilters(FilterProcessor.java:157)
    	at com.netflix.zuul.FilterProcessor.route(FilterProcessor.java:118)
    	at com.netflix.zuul.ZuulRunner.route(ZuulRunner.java:96)
    	at com.netflix.zuul.http.ZuulServlet.route(ZuulServlet.java:116)
    	at com.netflix.zuul.http.ZuulServlet.service(ZuulServlet.java:81)
    	at org.springframework.web.servlet.mvc.ServletWrappingController.handleRequestInternal(ServletWrappingController.java:165)
    	at org.springframework.cloud.netflix.zuul.web.ZuulController.handleRequest(ZuulController.java:44)
    	at org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter.handle(SimpleControllerHandlerAdapter.java:52)
    	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1038)
    	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:942)
    	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1005)
    	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:897)
    	at javax.servlet.http.HttpServlet.service(HttpServlet.java:635)
    	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:882)
    	at javax.servlet.http.HttpServlet.service(HttpServlet.java:742)
    	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:231)
    	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
    	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)
    	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
    	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
    	at org.springframework.web.filter.CorsFilter.doFilterInternal(CorsFilter.java:96)
    	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
    	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
    	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
    	at com.inhope.container.filter.UserAuthorizeFilter.doFilter(UserAuthorizeFilter.java:48)
    	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
    	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
    	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)
    	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
    	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
    	at org.springframework.boot.actuate.web.trace.servlet.HttpTraceFilter.doFilterInternal(HttpTraceFilter.java:90)
    	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
    	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
    	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
    	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:320)
    	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:119)
    	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
    	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:137)
    	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
    	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:111)
    	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
    	at org.springframework.security.web.authentication.rememberme.RememberMeAuthenticationFilter.doFilter(RememberMeAuthenticationFilter.java:150)
    	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
    	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:170)
    	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
    	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)
    	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
    	at com.inhope.container.filter.JwtAuthenticationTokenFilter.doFilterInternal(JwtAuthenticationTokenFilter.java:63)
    	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
    	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
    	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:116)
    	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
    	at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:74)
    	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
    	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
    	at org.springframework.security.web.context.SecurityContextPersistenceFilter.doFilter(SecurityContextPersistenceFilter.java:105)
    	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
    	at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:56)
    	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
    	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)
    	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:215)
    	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:178)
    	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:357)
    	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:270)
    	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
    	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
    	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:99)
    	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
    	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
    	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
    	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:92)
    	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
    	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
    	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
    	at org.springframework.web.filter.HiddenHttpMethodFilter.doFilterInternal(HiddenHttpMethodFilter.java:93)
    	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
    	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
    	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
    	at org.springframework.cloud.sleuth.instrument.web.ExceptionLoggingFilter.doFilter(ExceptionLoggingFilter.java:50)
    	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
    	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
    	at brave.servlet.TracingFilter.doFilter(TracingFilter.java:86)
    	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
    	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
    	at org.springframework.boot.web.servlet.support.ErrorPageFilter.doFilter(ErrorPageFilter.java:130)
    	at org.springframework.boot.web.servlet.support.ErrorPageFilter.access$000(ErrorPageFilter.java:66)
    	at org.springframework.boot.web.servlet.support.ErrorPageFilter$1.doFilterInternal(ErrorPageFilter.java:105)
    	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
    	at org.springframework.boot.web.servlet.support.ErrorPageFilter.doFilter(ErrorPageFilter.java:123)
    	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
    	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
    	at org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.filterAndRecordMetrics(WebMvcMetricsFilter.java:117)
    	at org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.doFilterInternal(WebMvcMetricsFilter.java:106)
    	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
    	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
    	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
    	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:200)
    	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
    	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
    	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
    	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:198)
    	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:96)
    	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:478)
    	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:140)
    	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:80)
    	at org.apache.catalina.valves.AbstractAccessLogValve.invoke(AbstractAccessLogValve.java:624)
    	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:87)
    	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:342)
    	at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:799)
    	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66)
    	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:861)
    	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1455)
    	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)
    	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
    	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
    	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)
    	at java.lang.Thread.run(Thread.java:748)
    Caused by: com.netflix.client.ClientException: null
    	at com.netflix.client.AbstractLoadBalancerAwareClient.executeWithLoadBalancer(AbstractLoadBalancerAwareClient.java:118)
    	at org.springframework.cloud.netflix.zuul.filters.route.support.AbstractRibbonCommand.run(AbstractRibbonCommand.java:186)
    	at org.springframework.cloud.netflix.zuul.filters.route.support.AbstractRibbonCommand.run(AbstractRibbonCommand.java:51)
    	at com.netflix.hystrix.HystrixCommand$2.call(HystrixCommand.java:302)
    	at com.netflix.hystrix.HystrixCommand$2.call(HystrixCommand.java:298)
    	at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:46)
    	at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:35)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30)
    	at rx.Observable.unsafeSubscribe(Observable.java:10327)
    	at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:51)
    	at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:35)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30)
    	at rx.Observable.unsafeSubscribe(Observable.java:10327)
    	at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:41)
    	at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:30)
    	at rx.Observable.unsafeSubscribe(Observable.java:10327)
    	at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:41)
    	at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:30)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30)
    	at rx.Observable.unsafeSubscribe(Observable.java:10327)
    	at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:41)
    	at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:30)
    	at rx.Observable.unsafeSubscribe(Observable.java:10327)
    	at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:41)
    	at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:30)
    	at rx.Observable.unsafeSubscribe(Observable.java:10327)
    	at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:41)
    	at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:30)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30)
    	at rx.Observable.unsafeSubscribe(Observable.java:10327)
    	at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:51)
    	at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:35)
    	at rx.Observable.unsafeSubscribe(Observable.java:10327)
    	at rx.internal.operators.OnSubscribeMap.call(OnSubscribeMap.java:48)
    	at rx.internal.operators.OnSubscribeMap.call(OnSubscribeMap.java:33)
    	at rx.Observable.unsafeSubscribe(Observable.java:10327)
    	at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:41)
    	at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:30)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30)
    	at rx.Observable.unsafeSubscribe(Observable.java:10327)
    	at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:41)
    	at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:30)
    	at rx.Observable.unsafeSubscribe(Observable.java:10327)
    	at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:51)
    	at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:35)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30)
    	at rx.Observable.subscribe(Observable.java:10423)
    	at rx.Observable.subscribe(Observable.java:10390)
    	at rx.internal.operators.BlockingOperatorToFuture.toFuture(BlockingOperatorToFuture.java:51)
    	at rx.observables.BlockingObservable.toFuture(BlockingObservable.java:410)
    	at com.netflix.hystrix.HystrixCommand.queue(HystrixCommand.java:378)
    	at com.netflix.hystrix.HystrixCommand.execute(HystrixCommand.java:344)
    	at org.springframework.cloud.netflix.zuul.filters.route.RibbonRoutingFilter.forward(RibbonRoutingFilter.java:161)
    	... 120 common frames omitted
    Caused by: java.lang.RuntimeException: java.net.SocketException: Connection reset
    	at rx.exceptions.Exceptions.propagate(Exceptions.java:57)
    	at rx.observables.BlockingObservable.blockForSingle(BlockingObservable.java:463)
    	at rx.observables.BlockingObservable.single(BlockingObservable.java:340)
    	at com.netflix.client.AbstractLoadBalancerAwareClient.executeWithLoadBalancer(AbstractLoadBalancerAwareClient.java:112)
    	... 182 common frames omitted
    Caused by: java.net.SocketException: Connection reset
    	at java.net.SocketInputStream.read(SocketInputStream.java:210)
    	at java.net.SocketInputStream.read(SocketInputStream.java:141)
    	at org.apache.http.impl.io.SessionInputBufferImpl.streamRead(SessionInputBufferImpl.java:137)
    	at org.apache.http.impl.io.SessionInputBufferImpl.fillBuffer(SessionInputBufferImpl.java:153)
    	at org.apache.http.impl.io.SessionInputBufferImpl.readLine(SessionInputBufferImpl.java:282)
    	at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:138)
    	at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:56)
    	at org.apache.http.impl.io.AbstractMessageParser.parse(AbstractMessageParser.java:259)
    	at org.apache.http.impl.DefaultBHttpClientConnection.receiveResponseHeader(DefaultBHttpClientConnection.java:163)
    	at org.apache.http.impl.conn.CPoolProxy.receiveResponseHeader(CPoolProxy.java:165)
    	at org.apache.http.protocol.HttpRequestExecutor.doReceiveResponse(HttpRequestExecutor.java:273)
    	at org.apache.http.protocol.HttpRequestExecutor.execute(HttpRequestExecutor.java:125)
    	at org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:272)
    	at brave.httpclient.TracingMainExec.execute(TracingMainExec.java:55)
    	at org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:185)
    	at brave.httpclient.TracingProtocolExec.execute(TracingProtocolExec.java:41)
    	at org.apache.http.impl.execchain.RetryExec.execute(RetryExec.java:89)
    	at org.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:185)
    	at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:83)
    	at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:108)
    	at org.springframework.cloud.netflix.ribbon.apache.RibbonLoadBalancingHttpClient.execute(RibbonLoadBalancingHttpClient.java:82)
    	at org.springframework.cloud.netflix.ribbon.apache.RibbonLoadBalancingHttpClient.execute(RibbonLoadBalancingHttpClient.java:44)
    	at com.netflix.client.AbstractLoadBalancerAwareClient$1.call(AbstractLoadBalancerAwareClient.java:104)
    	at com.netflix.loadbalancer.reactive.LoadBalancerCommand$3$1.call(LoadBalancerCommand.java:303)
    	at com.netflix.loadbalancer.reactive.LoadBalancerCommand$3$1.call(LoadBalancerCommand.java:287)
    	at rx.internal.util.ScalarSynchronousObservable$3.call(ScalarSynchronousObservable.java:231)
    	at rx.internal.util.ScalarSynchronousObservable$3.call(ScalarSynchronousObservable.java:228)
    	at rx.Observable.unsafeSubscribe(Observable.java:10327)
    	at rx.internal.operators.OnSubscribeConcatMap$ConcatMapSubscriber.drain(OnSubscribeConcatMap.java:286)
    	at rx.internal.operators.OnSubscribeConcatMap$ConcatMapSubscriber.onNext(OnSubscribeConcatMap.java:144)
    	at com.netflix.loadbalancer.reactive.LoadBalancerCommand$1.call(LoadBalancerCommand.java:185)
    	at com.netflix.loadbalancer.reactive.LoadBalancerCommand$1.call(LoadBalancerCommand.java:180)
    	at rx.Observable.unsafeSubscribe(Observable.java:10327)
    	at rx.internal.operators.OnSubscribeConcatMap.call(OnSubscribeConcatMap.java:94)
    	at rx.internal.operators.OnSubscribeConcatMap.call(OnSubscribeConcatMap.java:42)
    	at rx.Observable.unsafeSubscribe(Observable.java:10327)
    	at rx.internal.operators.OperatorRetryWithPredicate$SourceSubscriber$1.call(OperatorRetryWithPredicate.java:127)
    	at rx.internal.schedulers.TrampolineScheduler$InnerCurrentThreadScheduler.enqueue(TrampolineScheduler.java:73)
    	at rx.internal.schedulers.TrampolineScheduler$InnerCurrentThreadScheduler.schedule(TrampolineScheduler.java:52)
    	at rx.internal.operators.OperatorRetryWithPredicate$SourceSubscriber.onNext(OperatorRetryWithPredicate.java:79)
    	at rx.internal.operators.OperatorRetryWithPredicate$SourceSubscriber.onNext(OperatorRetryWithPredicate.java:45)
    	at rx.internal.util.ScalarSynchronousObservable$WeakSingleProducer.request(ScalarSynchronousObservable.java:276)
    	at rx.Subscriber.setProducer(Subscriber.java:209)
    	at rx.internal.util.ScalarSynchronousObservable$JustOnSubscribe.call(ScalarSynchronousObservable.java:138)
    	at rx.internal.util.ScalarSynchronousObservable$JustOnSubscribe.call(ScalarSynchronousObservable.java:129)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48)
    	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30)
    	at rx.Observable.subscribe(Observable.java:10423)
    	at rx.Observable.subscribe(Observable.java:10390)
    	at rx.observables.BlockingObservable.blockForSingle(BlockingObservable.java:443)
    	... 184 common frames omitted
```
Does zuul Request Context provide any methods to get and set path variables of the request?

e.g. :

The original request url is
http://my.domain/uri/acctNbr/balance

From this url, I want to get value of acctNbr (ex- 123456), manipulate/encrypt it and set back (as ex- abcgy0-=gyz-yubhgyt45-0==), into request url.
I use Zuul Proxy in our platform. Spring Cloud gateway uses Zuul Proxy.
Our platform has a service written in python 3.6 and it runs as uWSGI application. 

Problem is that every second request fails.  My college mentions it here
https://stackoverflow.com/questions/57714898/uwsgi-and-zuul-every-other-request-fails

I checked with wireshark and found out that (I do not know why) after first request was successfully routed and responsed, Zuul would close the connection, so when client makes another HTTP request, Zuul proxy tries to forward it and get error

```
com.netflix.zuul.exception.ZuulException: Forwarding error
...
Caused by: com.netflix.client.ClientException: null
...
Caused by: java.lang.RuntimeException: org.apache.http.NoHttpResponseException: localhost:8080 failed to respond
```

However, if we have nginx between Zuul and uWSGI, it works. Alternatively, if we run our python application (it uses Flast framework) **without uWSGI server, there is no problem**!

Meanwhile, I am going to make a test project to demonstrate you this problem.