This PR aims to improve the existing Async Workers using C++17 features

For the time being, only AsyncProgressQueueWorker was improved.

The improvements include
- Memory management using smart pointers (i.e. `unique_ptr`) to prevent memory leaks in case of exceptions
- Modern memory management techniques, i.e. `std::aligned_alloc` and `std::uninitialized_copy`, which remove the necessity of the MessageStruct being default constructible
- Better locking of critical sections (i.e. `std::mutex` instead of libuv's mutexes and lock_guard to prevent locking forever in case of error)
- A new API which allows progress messages to be put into the queue without being copies (using `std::unique_ptr`)
- Fast paths if the legacy API is used and the progress message class is trivially copyable

As mentioned above, the legacy API `SendProgress_(const T * const messages, const size_t nMessages)` is still supported (but marked as deprecated). Therefore, this works as a drop-in replacement even for C++17.
Additionally, the unmodified legacy workers are still there and used if the C++ version is below C++17.


This is not ready to merged yet for some reasons:
- It is entirely untested at the moment
- It's not possible to test it with the current configuration. The node headers force the usage of `-std=gnu++1y`, but C++17 is required for this
- An `std::bad_alloc` exception should be thrown in case of error, but the node headers force `-fno-exceptions`
- Documentation is missing
The last signed version I was able to find was https://github.com/nodejs/nan/releases/tag/v1.5.1 the latest tag is not signed https://github.com/nodejs/nan/releases/tag/v2.14.0.
This PR adds `Nan::New<v8::String>(std::string_view)`, which makes it easier to handle compile time known strings.

In order to maintan backwards compatibility to C++11, a `NAN_HAS_CPLUSPLUS_17` macro is added (which will also be needed for my next PRs), the code is wrapped into `NAN_ENABLE_STRING_VIEW` guards. If the user wishes to disable the usage of string_view, it can be disabled via adding a define `-DNAN_ENABLE_STRING_VIEW=false`, otherwise it is automatically enabled if it's supported by the C++ runtime (C++17 and up)
There are a few issues around GCC warnings appearing that NAN can't fix because the warnings are generated in the Node headers themselves.  This patch disables the warnings for GCC and re-enables them again before leaving `nan.h`, hiding the warnings that can't be fixed by NAN, while at the same time leaving them enabled in code belonging to anyone using the library.

In my opinion this is better than adjusting the compiler flags, which will hide the warnings from user code as well.

There is already code for MSVC that does a similar thing, so hopefully adding some for GCC as well will be ok.
Hi,

Due to the following line:
`T *new_data = new T[count];`
in the AsyncProgress(Queue)Worker class `T` (your progress class) is required to have a default constructor.

I have prepared a patch which makes use of C++17 (`std::aligned_alloc` and `std::uninitialized_copy`) features and removes the necessity of the progress struct having a default constructor.

Should I wrap the patch in a feature guard (`__cplusplus` macro check) and file a merge request?


There is a dev dependency in `package.json` - `"request": "=2.81.0"`, but I don't see it's used anywhere.
<!--
Thank you for reporting an issue. The more information you can give us, the
better the chance we can fix your problem.

This issue tracker is for issues with node-gyp,
if you have an issue installing a specific module, please file an issue on
that module's issue tracker (`npm issues modulename`).
-->

* **Node Version and npm version and tsc version**:  `v10.13.0` and `6.10.3` and `3.6.3`
* **Platform**: Darwin mac19 18.7.0 Darwin Kernel Version 18.7.0: Tue Aug 20 16:57:14 PDT 2019; root:xnu-4903.271.2~2/RELEASE_X86_64 x86_64
* **Compiler**: Apple LLVM version 10.0.1 (clang-1001.0.46.4)
Target: x86_64-apple-darwin18.7.0
Thread model: posix
InstalledDir: /Library/Developer/CommandLineTools/usr/bin
* **Module**: `npm ci` or `npm install` for my project . ( could be an issue in bunyan or dtrace which is not a direct dependency in my project )
* **Os version**  : 10.14.6 macOS Mojave

<details><summary>Verbose output (from npm or node-gyp):</summary>

```
machine: src_code$ npm install

> dtrace-provider@0.8.7 install /Users/mm99468/SourceCode/cdm-founders/node_modules/dtrace-provider
> node-gyp rebuild || node suppress-error.js

  LD_LIBRARY_PATH=/Users/mm99468/SourceCode/cdm-founders/node_modules/dtrace-provider/build/Release/lib.host:/Users/mm99468/SourceCode/cdm-founders/node_modules/dtrace-provider/build/Release/lib.target:$LD_LIBRARY_PATH; export LD_LIBRARY_PATH; cd ../.; bash build.sh
+ buildUSDT
+ [[ -z '' ]]
+ [[ -z /Users/mm99468/SourceCode/cdm-founders ]]
+ unset MAKEFLAGS
++ node -e 'console.log(process.arch === '\''x64'\'' ? '\''x86_64'\'' : '\''i386'\'')'
+ export ARCH=x86_64
+ ARCH=x86_64
+ echo 'Building libusdt for x86_64'
Building libusdt for x86_64
+ [[ -z '' ]]
++ which gmake
+ MAKE=
+ [[ -z '' ]]
+ MAKE=make
+ make -C libusdt clean all
rm -f *.gch
rm -f *.o
rm -f libusdt.a
rm -f test_usdt
rm -f test_usdt32
rm -f test_usdt64
rm -f test_mem_usage
gcc -O2 -Wall -arch x86_64   -c -o usdt.o usdt.c
gcc -O2 -Wall -arch x86_64   -c -o usdt_dof_file.o usdt_dof_file.c
gcc -arch x86_64 -o usdt_tracepoints.o -c usdt_tracepoints_x86_64.s
gcc -O2 -Wall -arch x86_64   -c -o usdt_probe.o usdt_probe.c
gcc -O2 -Wall -arch x86_64   -c -o usdt_dof.o usdt_dof.c
gcc -O2 -Wall -arch x86_64   -c -o usdt_dof_sections.o usdt_dof_sections.c
rm -f libusdt.a
ar cru libusdt.a usdt.o usdt_dof_file.o usdt_tracepoints.o usdt_probe.o usdt_dof.o usdt_dof_sections.o
ranlib libusdt.a
+ LIBUSDT_STATUS=0
+ [[ 0 -ne 0 ]]
+ buildNDTP
+ [[ -z '' ]]
+ [[ -z /Users/mm99468/SourceCode/cdm-founders ]]
+ node-gyp rebuild -C src
  c++ '-DNODE_GYP_MODULE_NAME=DTraceProviderBindings' '-DUSING_UV_SHARED=1' '-DUSING_V8_SHARED=1' '-DV8_DEPRECATION_WARNINGS=1' '-DV8_DEPRECATION_WARNINGS' '-DV8_IMMINENT_DEPRECATION_WARNINGS' '-D_DARWIN_USE_64_BIT_INODE=1' '-D_LARGEFILE_SOURCE' '-D_FILE_OFFSET_BITS=64' '-DOPENSSL_NO_PINSHARED' '-DOPENSSL_THREADS' '-DBUILDING_NODE_EXTENSION' -I/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node -I/Users/mm99468/Library/Caches/node-gyp/12.10.0/src -I/Users/mm99468/Library/Caches/node-gyp/12.10.0/deps/openssl/config -I/Users/mm99468/Library/Caches/node-gyp/12.10.0/deps/openssl/openssl/include -I/Users/mm99468/Library/Caches/node-gyp/12.10.0/deps/uv/include -I/Users/mm99468/Library/Caches/node-gyp/12.10.0/deps/zlib -I/Users/mm99468/Library/Caches/node-gyp/12.10.0/deps/v8/include -I../../libusdt -I../../../nan  -Os -gdwarf-2 -mmacosx-version-min=10.10 -arch x86_64 -Wall -Wendif-labels -W -Wno-unused-parameter -std=gnu++1y -stdlib=libc++ -fno-rtti -fno-exceptions -fno-strict-aliasing -MMD -MF ./Release/.deps/Release/obj.target/DTraceProviderBindings/dtrace_provider.o.d.raw   -c -o Release/obj.target/DTraceProviderBindings/dtrace_provider.o ../dtrace_provider.cc
In file included from ../dtrace_provider.cc:1:
In file included from ../dtrace_provider.h:1:
In file included from ../../../nan/nan.h:222:
In file included from ../../../nan/nan_converters.h:67:
../../../nan/nan_converters_43_inl.h:22:1: warning: 'ToBoolean' is deprecated: ToBoolean can never throw. Use Local version. [-Wdeprecated-declarations]
X(Boolean)
^
../../../nan/nan_converters_43_inl.h:18:12: note: expanded from macro 'X'
      val->To ## TYPE(isolate->GetCurrentContext())                            \
           ^
<scratch space>:208:1: note: expanded from here
ToBoolean
^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2536:3: note: 'ToBoolean' has been explicitly marked deprecated here
  V8_DEPRECATED("ToBoolean can never throw. Use Local version.",
  ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8config.h:311:29: note: expanded from macro 'V8_DEPRECATED'
  declarator __attribute__((deprecated(message)))
                            ^
In file included from ../dtrace_provider.cc:1:
In file included from ../dtrace_provider.h:1:
In file included from ../../../nan/nan.h:222:
In file included from ../../../nan/nan_converters.h:67:
../../../nan/nan_converters_43_inl.h:40:1: warning: 'BooleanValue' is deprecated: BooleanValue can never throw. Use Isolate version. [-Wdeprecated-declarations]
X(bool, Boolean)
^
../../../nan/nan_converters_43_inl.h:37:15: note: expanded from macro 'X'
  return val->NAME ## Value(isolate->GetCurrentContext());                     \
              ^
<scratch space>:215:1: note: expanded from here
BooleanValue
^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2574:3: note: 'BooleanValue' has been explicitly marked deprecated here
  V8_DEPRECATED("BooleanValue can never throw. Use Isolate version.",
  ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8config.h:311:29: note: expanded from macro 'V8_DEPRECATED'
  declarator __attribute__((deprecated(message)))
                            ^
In file included from ../dtrace_provider.cc:1:
In file included from ../dtrace_provider.h:1:
In file included from ../../../nan/nan.h:223:
In file included from ../../../nan/nan_new.h:189:
../../../nan/nan_implementation_12_inl.h:356:37: error: too few arguments to function call, expected 2, have 1
  return v8::StringObject::New(value).As<v8::StringObject>();
         ~~~~~~~~~~~~~~~~~~~~~      ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:5394:3: note: 'New' declared here
  static Local<Value> New(Isolate* isolate, Local<String> value);
  ^
In file included from ../dtrace_provider.cc:1:
In file included from ../dtrace_provider.h:1:
In file included from ../../../nan/nan.h:223:
In file included from ../../../nan/nan_new.h:189:
../../../nan/nan_implementation_12_inl.h:356:58: error: expected '(' for function-style cast or type construction
  return v8::StringObject::New(value).As<v8::StringObject>();
                                         ~~~~~~~~~~~~~~~~^
../../../nan/nan_implementation_12_inl.h:356:60: error: expected expression
  return v8::StringObject::New(value).As<v8::StringObject>();
                                                           ^
In file included from ../dtrace_provider.cc:1:
In file included from ../dtrace_provider.h:1:
In file included from ../../../nan/nan.h:2722:
../../../nan/nan_object_wrap.h:24:25: error: no member named 'IsNearDeath' in 'Nan::Persistent<v8::Object, v8::NonCopyablePersistentTraits<v8::Object> >'
    assert(persistent().IsNearDeath());
           ~~~~~~~~~~~~ ^
/Library/Developer/CommandLineTools/SDKs/MacOSX10.14.sdk/usr/include/assert.h:93:25: note: expanded from macro 'assert'
    (__builtin_expect(!(e), 0) ? __assert_rtn(__func__, __FILE__, __LINE__, #e) : (void)0)
                        ^
In file included from ../dtrace_provider.cc:1:
In file included from ../dtrace_provider.h:1:
In file included from ../../../nan/nan.h:2722:
../../../nan/nan_object_wrap.h:127:26: error: no member named 'IsNearDeath' in 'Nan::Persistent<v8::Object, v8::NonCopyablePersistentTraits<v8::Object> >'
    assert(wrap->handle_.IsNearDeath());
           ~~~~~~~~~~~~~ ^
/Library/Developer/CommandLineTools/SDKs/MacOSX10.14.sdk/usr/include/assert.h:93:25: note: expanded from macro 'assert'
    (__builtin_expect(!(e), 0) ? __assert_rtn(__func__, __FILE__, __LINE__, #e) : (void)0)
                        ^
../dtrace_provider.cc:35:85: error: too few arguments to function call, single argument 'context' was not specified
    target->Set(Nan::New<String>("DTraceProvider").ToLocalChecked(), t->GetFunction());
                                                                     ~~~~~~~~~~~~~~ ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:5961:3: note: 'GetFunction' declared here
  V8_WARN_UNUSED_RESULT MaybeLocal<Function> GetFunction(
  ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8config.h:351:31: note: expanded from macro 'V8_WARN_UNUSED_RESULT'
#define V8_WARN_UNUSED_RESULT __attribute__((warn_unused_result))
                              ^
../dtrace_provider.cc:52:37: error: no matching member function for call to 'ToString'
    String::Utf8Value name(info[0]->ToString());
                           ~~~~~~~~~^~~~~~~~
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2541:44: note: candidate function not viable: requires single argument 'context', but no arguments were
      provided
  V8_WARN_UNUSED_RESULT MaybeLocal<String> ToString(
                                           ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2557:31: note: candidate function not viable: requires single argument 'isolate', but no arguments were
      provided
                Local<String> ToString(Isolate* isolate) const);
                              ^
../dtrace_provider.cc:60:38: error: no matching member function for call to 'ToString'
      String::Utf8Value mod(info[1]->ToString());
                            ~~~~~~~~~^~~~~~~~
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2541:44: note: candidate function not viable: requires single argument 'context', but no arguments were
      provided
  V8_WARN_UNUSED_RESULT MaybeLocal<String> ToString(
                                           ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2557:31: note: candidate function not viable: requires single argument 'isolate', but no arguments were
      provided
                Local<String> ToString(Isolate* isolate) const);
                              ^
../dtrace_provider.cc:88:84: error: too few arguments to function call, single argument 'context' was not specified
        Nan::New<FunctionTemplate>(DTraceProbe::constructor_template)->GetFunction();
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:5961:3: note: 'GetFunction' declared here
  V8_WARN_UNUSED_RESULT MaybeLocal<Function> GetFunction(
  ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8config.h:351:31: note: expanded from macro 'V8_WARN_UNUSED_RESULT'
#define V8_WARN_UNUSED_RESULT __attribute__((warn_unused_result))
                              ^
../dtrace_provider.cc:92:67: error: no matching member function for call to 'ToObject'
    DTraceProbe *probe = Nan::ObjectWrap::Unwrap<DTraceProbe>(pd->ToObject());
                                                              ~~~~^~~~~~~~
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2545:44: note: candidate function not viable: requires single argument 'context', but no arguments were
      provided
  V8_WARN_UNUSED_RESULT MaybeLocal<Object> ToObject(
                                           ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2559:31: note: candidate function not viable: requires single argument 'isolate', but no arguments were
      provided
                Local<Object> ToObject(Isolate* isolate) const);
                              ^
../dtrace_provider.cc:93:23: error: no matching member function for call to 'ToString'
    obj->Set(info[0]->ToString(), pd);
             ~~~~~~~~~^~~~~~~~
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2541:44: note: candidate function not viable: requires single argument 'context', but no arguments were
      provided
  V8_WARN_UNUSED_RESULT MaybeLocal<String> ToString(
                                           ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2557:31: note: candidate function not viable: requires single argument 'isolate', but no arguments were
      provided
                Local<String> ToString(Isolate* isolate) const);
                              ^
../dtrace_provider.cc:96:10: warning: 'ForceSet' is deprecated [-Wdeprecated-declarations]
    Nan::ForceSet(pd, Nan::New<String>("__prov__").ToLocalChecked(), obj,
         ^
../../../nan/nan_maybe_43_inl.h:130:1: note: 'ForceSet' has been explicitly marked deprecated here
NAN_DEPRECATED inline Maybe<bool> ForceSet(
^
../../../nan/nan.h:103:40: note: expanded from macro 'NAN_DEPRECATED'
# define NAN_DEPRECATED __attribute__((deprecated))
                                       ^
../dtrace_provider.cc:102:45: error: no matching member function for call to 'ToString'
        String::Utf8Value type(info[i + 1]->ToString());
                               ~~~~~~~~~~~~~^~~~~~~~
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2541:44: note: candidate function not viable: requires single argument 'context', but no arguments were
      provided
  V8_WARN_UNUSED_RESULT MaybeLocal<String> ToString(
                                           ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2557:31: note: candidate function not viable: requires single argument 'isolate', but no arguments were
      provided
                Local<String> ToString(Isolate* isolate) const);
                              ^
../dtrace_provider.cc:118:37: error: no matching member function for call to 'ToString'
    String::Utf8Value name(info[0]->ToString());
                           ~~~~~~~~~^~~~~~~~
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2541:44: note: candidate function not viable: requires single argument 'context', but no arguments were
      provided
  V8_WARN_UNUSED_RESULT MaybeLocal<String> ToString(
                                           ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2557:31: note: candidate function not viable: requires single argument 'isolate', but no arguments were
      provided
                Local<String> ToString(Isolate* isolate) const);
                              ^
../dtrace_provider.cc:140:19: error: no matching member function for call to 'Delete'
    provider_obj->Delete(name);
    ~~~~~~~~~~~~~~^~~~~~
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:3465:37: note: candidate function not viable: requires 2 arguments, but 1 was provided
  V8_WARN_UNUSED_RESULT Maybe<bool> Delete(Local<Context> context,
                                    ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:3470:37: note: candidate function not viable: requires 2 arguments, but 1 was provided
  V8_WARN_UNUSED_RESULT Maybe<bool> Delete(Local<Context> context,
                                    ^
3 warnings and 14 errors generated.
make[1]: *** [Release/obj.target/DTraceProviderBindings/dtrace_provider.o] Error 1
gyp ERR! build error
gyp ERR! stack Error: `make` failed with exit code: 2
gyp ERR! stack     at ChildProcess.onExit (/usr/local/lib/node_modules/npm/node_modules/node-gyp/lib/build.js:196:23)
gyp ERR! stack     at ChildProcess.emit (events.js:209:13)
gyp ERR! stack     at Process.ChildProcess._handle.onexit (internal/child_process.js:272:12)
gyp ERR! System Darwin 18.7.0
gyp ERR! command "/usr/local/bin/node" "/usr/local/lib/node_modules/npm/node_modules/node-gyp/bin/node-gyp.js" "rebuild" "-C" "src"
gyp ERR! cwd /Users/mm99468/SourceCode/cdm-founders/node_modules/dtrace-provider/src
gyp ERR! node -v v12.10.0
gyp ERR! node-gyp -v v5.0.3
gyp ERR! not ok
+ NODE_GYP_STATUS=1
+ [[ 1 -ne 0 ]]
+ fail 1
+ [[ -z '' ]]
+ [[ -z /Users/mm99468/SourceCode/cdm-founders ]]
+ [[ '' == \h\a\r\d ]]
+ exit 0
  touch Release/obj.target/ndtp.stamp
added 879 packages from 1151 contributors and audited 5367 packages in 12.108s
found 60 vulnerabilities (1 low, 59 high)
  run `npm audit fix` to fix them, or `npm audit` for details
MM99468M3:cdm-founders mm99468$ rm -rf node_modules/
MM99468M3:cdm-founders mm99468$ npm ci

> dtrace-provider@0.8.7 install /Users/mm99468/SourceCode/cdm-founders/node_modules/dtrace-provider
> node-gyp rebuild || node suppress-error.js

gyp info it worked if it ends with ok
gyp info using node-gyp@5.0.3
gyp info using node@12.10.0 | darwin | x64
gyp info find Python using Python version 2.7.10 found at "/usr/bin/python"
gyp info spawn /usr/bin/python
gyp info spawn args [
gyp info spawn args   '/usr/local/lib/node_modules/npm/node_modules/node-gyp/gyp/gyp_main.py',
gyp info spawn args   'binding.gyp',
gyp info spawn args   '-f',
gyp info spawn args   'make',
gyp info spawn args   '-I',
gyp info spawn args   '/Users/mm99468/SourceCode/cdm-founders/node_modules/dtrace-provider/build/config.gypi',
gyp info spawn args   '-I',
gyp info spawn args   '/usr/local/lib/node_modules/npm/node_modules/node-gyp/addon.gypi',
gyp info spawn args   '-I',
gyp info spawn args   '/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/common.gypi',
gyp info spawn args   '-Dlibrary=shared_library',
gyp info spawn args   '-Dvisibility=default',
gyp info spawn args   '-Dnode_root_dir=/Users/mm99468/Library/Caches/node-gyp/12.10.0',
gyp info spawn args   '-Dnode_gyp_dir=/usr/local/lib/node_modules/npm/node_modules/node-gyp',
gyp info spawn args   '-Dnode_lib_file=/Users/mm99468/Library/Caches/node-gyp/12.10.0/<(target_arch)/node.lib',
gyp info spawn args   '-Dmodule_root_dir=/Users/mm99468/SourceCode/cdm-founders/node_modules/dtrace-provider',
gyp info spawn args   '-Dnode_engine=v8',
gyp info spawn args   '--depth=.',
gyp info spawn args   '--no-parallel',
gyp info spawn args   '--generator-output',
gyp info spawn args   'build',
gyp info spawn args   '-Goutput_dir=.'
gyp info spawn args ]
gyp info spawn make
gyp info spawn args [ 'BUILDTYPE=Release', '-C', 'build' ]
  LD_LIBRARY_PATH=/Users/mm99468/SourceCode/cdm-founders/node_modules/dtrace-provider/build/Release/lib.host:/Users/mm99468/SourceCode/cdm-founders/node_modules/dtrace-provider/build/Release/lib.target:$LD_LIBRARY_PATH; export LD_LIBRARY_PATH; cd ../.; bash build.sh
+ buildUSDT
+ [[ -z '' ]]
+ [[ -z /Users/mm99468/SourceCode/cdm-founders ]]
+ unset MAKEFLAGS
++ node -e 'console.log(process.arch === '\''x64'\'' ? '\''x86_64'\'' : '\''i386'\'')'
+ export ARCH=x86_64
+ ARCH=x86_64
+ echo 'Building libusdt for x86_64'
Building libusdt for x86_64
+ [[ -z '' ]]
++ which gmake
+ MAKE=
+ [[ -z '' ]]
+ MAKE=make
+ make -C libusdt clean all
rm -f *.gch
rm -f *.o
rm -f libusdt.a
rm -f test_usdt
rm -f test_usdt32
rm -f test_usdt64
rm -f test_mem_usage
gcc -O2 -Wall -arch x86_64   -c -o usdt.o usdt.c
gcc -O2 -Wall -arch x86_64   -c -o usdt_dof_file.o usdt_dof_file.c
gcc -arch x86_64 -o usdt_tracepoints.o -c usdt_tracepoints_x86_64.s
gcc -O2 -Wall -arch x86_64   -c -o usdt_probe.o usdt_probe.c
gcc -O2 -Wall -arch x86_64   -c -o usdt_dof.o usdt_dof.c
gcc -O2 -Wall -arch x86_64   -c -o usdt_dof_sections.o usdt_dof_sections.c
rm -f libusdt.a
ar cru libusdt.a usdt.o usdt_dof_file.o usdt_tracepoints.o usdt_probe.o usdt_dof.o usdt_dof_sections.o
ranlib libusdt.a
+ LIBUSDT_STATUS=0
+ [[ 0 -ne 0 ]]
+ buildNDTP
+ [[ -z '' ]]
+ [[ -z /Users/mm99468/SourceCode/cdm-founders ]]
+ node-gyp rebuild -C src
gyp info it worked if it ends with ok
gyp info using node-gyp@5.0.3
gyp info using node@12.10.0 | darwin | x64
gyp info chdir src
gyp info find Python using Python version 2.7.10 found at "/usr/bin/python"
gyp info spawn /usr/bin/python
gyp info spawn args [
gyp info spawn args   '/usr/local/lib/node_modules/npm/node_modules/node-gyp/gyp/gyp_main.py',
gyp info spawn args   'binding.gyp',
gyp info spawn args   '-f',
gyp info spawn args   'make',
gyp info spawn args   '-I',
gyp info spawn args   '/Users/mm99468/SourceCode/cdm-founders/node_modules/dtrace-provider/src/build/config.gypi',
gyp info spawn args   '-I',
gyp info spawn args   '/usr/local/lib/node_modules/npm/node_modules/node-gyp/addon.gypi',
gyp info spawn args   '-I',
gyp info spawn args   '/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/common.gypi',
gyp info spawn args   '-Dlibrary=shared_library',
gyp info spawn args   '-Dvisibility=default',
gyp info spawn args   '-Dnode_root_dir=/Users/mm99468/Library/Caches/node-gyp/12.10.0',
gyp info spawn args   '-Dnode_gyp_dir=/usr/local/lib/node_modules/npm/node_modules/node-gyp',
gyp info spawn args   '-Dnode_lib_file=/Users/mm99468/Library/Caches/node-gyp/12.10.0/<(target_arch)/node.lib',
gyp info spawn args   '-Dmodule_root_dir=/Users/mm99468/SourceCode/cdm-founders/node_modules/dtrace-provider/src',
gyp info spawn args   '-Dnode_engine=v8',
gyp info spawn args   '--depth=.',
gyp info spawn args   '--no-parallel',
gyp info spawn args   '--generator-output',
gyp info spawn args   'build',
gyp info spawn args   '-Goutput_dir=.'
gyp info spawn args ]
gyp info spawn make
gyp info spawn args [ 'BUILDTYPE=Release', '-C', 'build' ]
  c++ '-DNODE_GYP_MODULE_NAME=DTraceProviderBindings' '-DUSING_UV_SHARED=1' '-DUSING_V8_SHARED=1' '-DV8_DEPRECATION_WARNINGS=1' '-DV8_DEPRECATION_WARNINGS' '-DV8_IMMINENT_DEPRECATION_WARNINGS' '-D_DARWIN_USE_64_BIT_INODE=1' '-D_LARGEFILE_SOURCE' '-D_FILE_OFFSET_BITS=64' '-DOPENSSL_NO_PINSHARED' '-DOPENSSL_THREADS' '-DBUILDING_NODE_EXTENSION' -I/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node -I/Users/mm99468/Library/Caches/node-gyp/12.10.0/src -I/Users/mm99468/Library/Caches/node-gyp/12.10.0/deps/openssl/config -I/Users/mm99468/Library/Caches/node-gyp/12.10.0/deps/openssl/openssl/include -I/Users/mm99468/Library/Caches/node-gyp/12.10.0/deps/uv/include -I/Users/mm99468/Library/Caches/node-gyp/12.10.0/deps/zlib -I/Users/mm99468/Library/Caches/node-gyp/12.10.0/deps/v8/include -I../../libusdt -I../../../nan  -Os -gdwarf-2 -mmacosx-version-min=10.10 -arch x86_64 -Wall -Wendif-labels -W -Wno-unused-parameter -std=gnu++1y -stdlib=libc++ -fno-rtti -fno-exceptions -fno-strict-aliasing -MMD -MF ./Release/.deps/Release/obj.target/DTraceProviderBindings/dtrace_provider.o.d.raw   -c -o Release/obj.target/DTraceProviderBindings/dtrace_provider.o ../dtrace_provider.cc
In file included from ../dtrace_provider.cc:1:
In file included from ../dtrace_provider.h:1:
In file included from ../../../nan/nan.h:222:
In file included from ../../../nan/nan_converters.h:67:
../../../nan/nan_converters_43_inl.h:22:1: warning: 'ToBoolean' is deprecated: ToBoolean can never throw. Use Local version. [-Wdeprecated-declarations]
X(Boolean)
^
../../../nan/nan_converters_43_inl.h:18:12: note: expanded from macro 'X'
      val->To ## TYPE(isolate->GetCurrentContext())                            \
           ^
<scratch space>:208:1: note: expanded from here
ToBoolean
^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2536:3: note: 'ToBoolean' has been explicitly marked deprecated here
  V8_DEPRECATED("ToBoolean can never throw. Use Local version.",
  ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8config.h:311:29: note: expanded from macro 'V8_DEPRECATED'
  declarator __attribute__((deprecated(message)))
                            ^
In file included from ../dtrace_provider.cc:1:
In file included from ../dtrace_provider.h:1:
In file included from ../../../nan/nan.h:222:
In file included from ../../../nan/nan_converters.h:67:
../../../nan/nan_converters_43_inl.h:40:1: warning: 'BooleanValue' is deprecated: BooleanValue can never throw. Use Isolate version. [-Wdeprecated-declarations]
X(bool, Boolean)
^
../../../nan/nan_converters_43_inl.h:37:15: note: expanded from macro 'X'
  return val->NAME ## Value(isolate->GetCurrentContext());                     \
              ^
<scratch space>:215:1: note: expanded from here
BooleanValue
^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2574:3: note: 'BooleanValue' has been explicitly marked deprecated here
  V8_DEPRECATED("BooleanValue can never throw. Use Isolate version.",
  ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8config.h:311:29: note: expanded from macro 'V8_DEPRECATED'
  declarator __attribute__((deprecated(message)))
                            ^
In file included from ../dtrace_provider.cc:1:
In file included from ../dtrace_provider.h:1:
In file included from ../../../nan/nan.h:223:
In file included from ../../../nan/nan_new.h:189:
../../../nan/nan_implementation_12_inl.h:356:37: error: too few arguments to function call, expected 2, have 1
  return v8::StringObject::New(value).As<v8::StringObject>();
         ~~~~~~~~~~~~~~~~~~~~~      ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:5394:3: note: 'New' declared here
  static Local<Value> New(Isolate* isolate, Local<String> value);
  ^
In file included from ../dtrace_provider.cc:1:
In file included from ../dtrace_provider.h:1:
In file included from ../../../nan/nan.h:223:
In file included from ../../../nan/nan_new.h:189:
../../../nan/nan_implementation_12_inl.h:356:58: error: expected '(' for function-style cast or type construction
  return v8::StringObject::New(value).As<v8::StringObject>();
                                         ~~~~~~~~~~~~~~~~^
../../../nan/nan_implementation_12_inl.h:356:60: error: expected expression
  return v8::StringObject::New(value).As<v8::StringObject>();
                                                           ^
In file included from ../dtrace_provider.cc:1:
In file included from ../dtrace_provider.h:1:
In file included from ../../../nan/nan.h:2722:
../../../nan/nan_object_wrap.h:24:25: error: no member named 'IsNearDeath' in 'Nan::Persistent<v8::Object, v8::NonCopyablePersistentTraits<v8::Object> >'
    assert(persistent().IsNearDeath());
           ~~~~~~~~~~~~ ^
/Library/Developer/CommandLineTools/SDKs/MacOSX10.14.sdk/usr/include/assert.h:93:25: note: expanded from macro 'assert'
    (__builtin_expect(!(e), 0) ? __assert_rtn(__func__, __FILE__, __LINE__, #e) : (void)0)
                        ^
In file included from ../dtrace_provider.cc:1:
In file included from ../dtrace_provider.h:1:
In file included from ../../../nan/nan.h:2722:
../../../nan/nan_object_wrap.h:127:26: error: no member named 'IsNearDeath' in 'Nan::Persistent<v8::Object, v8::NonCopyablePersistentTraits<v8::Object> >'
    assert(wrap->handle_.IsNearDeath());
           ~~~~~~~~~~~~~ ^
/Library/Developer/CommandLineTools/SDKs/MacOSX10.14.sdk/usr/include/assert.h:93:25: note: expanded from macro 'assert'
    (__builtin_expect(!(e), 0) ? __assert_rtn(__func__, __FILE__, __LINE__, #e) : (void)0)
                        ^
../dtrace_provider.cc:35:85: error: too few arguments to function call, single argument 'context' was not specified
    target->Set(Nan::New<String>("DTraceProvider").ToLocalChecked(), t->GetFunction());
                                                                     ~~~~~~~~~~~~~~ ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:5961:3: note: 'GetFunction' declared here
  V8_WARN_UNUSED_RESULT MaybeLocal<Function> GetFunction(
  ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8config.h:351:31: note: expanded from macro 'V8_WARN_UNUSED_RESULT'
#define V8_WARN_UNUSED_RESULT __attribute__((warn_unused_result))
                              ^
../dtrace_provider.cc:52:37: error: no matching member function for call to 'ToString'
    String::Utf8Value name(info[0]->ToString());
                           ~~~~~~~~~^~~~~~~~
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2541:44: note: candidate function not viable: requires single argument 'context', but no arguments were
      provided
  V8_WARN_UNUSED_RESULT MaybeLocal<String> ToString(
                                           ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2557:31: note: candidate function not viable: requires single argument 'isolate', but no arguments were
      provided
                Local<String> ToString(Isolate* isolate) const);
                              ^
../dtrace_provider.cc:60:38: error: no matching member function for call to 'ToString'
      String::Utf8Value mod(info[1]->ToString());
                            ~~~~~~~~~^~~~~~~~
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2541:44: note: candidate function not viable: requires single argument 'context', but no arguments were
      provided
  V8_WARN_UNUSED_RESULT MaybeLocal<String> ToString(
                                           ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2557:31: note: candidate function not viable: requires single argument 'isolate', but no arguments were
      provided
                Local<String> ToString(Isolate* isolate) const);
                              ^
../dtrace_provider.cc:88:84: error: too few arguments to function call, single argument 'context' was not specified
        Nan::New<FunctionTemplate>(DTraceProbe::constructor_template)->GetFunction();
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:5961:3: note: 'GetFunction' declared here
  V8_WARN_UNUSED_RESULT MaybeLocal<Function> GetFunction(
  ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8config.h:351:31: note: expanded from macro 'V8_WARN_UNUSED_RESULT'
#define V8_WARN_UNUSED_RESULT __attribute__((warn_unused_result))
                              ^
../dtrace_provider.cc:92:67: error: no matching member function for call to 'ToObject'
    DTraceProbe *probe = Nan::ObjectWrap::Unwrap<DTraceProbe>(pd->ToObject());
                                                              ~~~~^~~~~~~~
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2545:44: note: candidate function not viable: requires single argument 'context', but no arguments were
      provided
  V8_WARN_UNUSED_RESULT MaybeLocal<Object> ToObject(
                                           ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2559:31: note: candidate function not viable: requires single argument 'isolate', but no arguments were
      provided
                Local<Object> ToObject(Isolate* isolate) const);
                              ^
../dtrace_provider.cc:93:23: error: no matching member function for call to 'ToString'
    obj->Set(info[0]->ToString(), pd);
             ~~~~~~~~~^~~~~~~~
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2541:44: note: candidate function not viable: requires single argument 'context', but no arguments were
      provided
  V8_WARN_UNUSED_RESULT MaybeLocal<String> ToString(
                                           ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2557:31: note: candidate function not viable: requires single argument 'isolate', but no arguments were
      provided
                Local<String> ToString(Isolate* isolate) const);
                              ^
../dtrace_provider.cc:96:10: warning: 'ForceSet' is deprecated [-Wdeprecated-declarations]
    Nan::ForceSet(pd, Nan::New<String>("__prov__").ToLocalChecked(), obj,
         ^
../../../nan/nan_maybe_43_inl.h:130:1: note: 'ForceSet' has been explicitly marked deprecated here
NAN_DEPRECATED inline Maybe<bool> ForceSet(
^
../../../nan/nan.h:103:40: note: expanded from macro 'NAN_DEPRECATED'
# define NAN_DEPRECATED __attribute__((deprecated))
                                       ^
../dtrace_provider.cc:102:45: error: no matching member function for call to 'ToString'
        String::Utf8Value type(info[i + 1]->ToString());
                               ~~~~~~~~~~~~~^~~~~~~~
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2541:44: note: candidate function not viable: requires single argument 'context', but no arguments were
      provided
  V8_WARN_UNUSED_RESULT MaybeLocal<String> ToString(
                                           ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2557:31: note: candidate function not viable: requires single argument 'isolate', but no arguments were
      provided
                Local<String> ToString(Isolate* isolate) const);
                              ^
../dtrace_provider.cc:118:37: error: no matching member function for call to 'ToString'
    String::Utf8Value name(info[0]->ToString());
                           ~~~~~~~~~^~~~~~~~
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2541:44: note: candidate function not viable: requires single argument 'context', but no arguments were
      provided
  V8_WARN_UNUSED_RESULT MaybeLocal<String> ToString(
                                           ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:2557:31: note: candidate function not viable: requires single argument 'isolate', but no arguments were
      provided
                Local<String> ToString(Isolate* isolate) const);
                              ^
../dtrace_provider.cc:140:19: error: no matching member function for call to 'Delete'
    provider_obj->Delete(name);
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:3465:37: note: candidate function not viable: requires 2 arguments, but 1 was provided
  V8_WARN_UNUSED_RESULT Maybe<bool> Delete(Local<Context> context,
                                    ^
/Users/mm99468/Library/Caches/node-gyp/12.10.0/include/node/v8.h:3470:37: note: candidate function not viable: requires 2 arguments, but 1 was provided
  V8_WARN_UNUSED_RESULT Maybe<bool> Delete(Local<Context> context,
                                    ^
3 warnings and 14 errors generated.
make[1]: *** [Release/obj.target/DTraceProviderBindings/dtrace_provider.o] Error 1
gyp ERR! build error
gyp ERR! stack Error: `make` failed with exit code: 2
gyp ERR! stack     at ChildProcess.onExit (/usr/local/lib/node_modules/npm/node_modules/node-gyp/lib/build.js:196:23)
gyp ERR! stack     at ChildProcess.emit (events.js:209:13)
gyp ERR! stack     at Process.ChildProcess._handle.onexit (internal/child_process.js:272:12)
gyp ERR! System Darwin 18.7.0
gyp ERR! command "/usr/local/bin/node" "/usr/local/lib/node_modules/npm/node_modules/node-gyp/bin/node-gyp.js" "rebuild" "-C" "src"
gyp ERR! cwd /Users/mm99468/SourceCode/cdm-founders/node_modules/dtrace-provider/src
gyp ERR! node -v v12.10.0
gyp ERR! node-gyp -v v5.0.3
gyp ERR! not ok
+ NODE_GYP_STATUS=1
+ [[ 1 -ne 0 ]]
+ fail 1
+ [[ -z '' ]]
+ [[ -z /Users/mm99468/SourceCode/cdm-founders ]]
+ [[ '' == \h\a\r\d ]]
+ exit 0
  touch Release/obj.target/ndtp.stamp
gyp info ok
added 879 packages in 7.924s
```

</details>

Build with this throws the following error
```
> src_code@2.6.1 build:compile <path>
> tsc -p tsconfig.json

error TS2688: Cannot find type definition file for 'bunyan'.

error TS2688: Cannot find type definition file for 'restify'.

error TS2688: Cannot find type definition file for 'spdy'.

error TS2688: Cannot find type definition file for 'validator'.
```
Package-lock of secondary and tertiary dependency of `dtrace-provider` and `NAN` respectively looks like 
``` "dtrace-provider": {
      "version": "0.8.7",
      "resolved": "https://registry.npmjs.org/dtrace-provider/-/dtrace-provider-0.8.7.tgz",
      "integrity": "sha1-3JObTT4GIM/gwc2APQ0tftBP/QQ=",
      "optional": true,
      "requires": {
        "nan": "^2.10.0"
      }
    },
```

``` 
"nan": {
      "version": "2.12.1",
      "resolved": "https://registry.npmjs.org/nan/-/nan-2.12.1.tgz",
      "integrity": "sha512-JY7V6lRkStKcKTvHO5NVSQRv+RV+FIL5pvDoLiAtSL9pKlC5x9PKQcZDsq7m4FO4d57mkhC6Z+QhAh3Jdk5JFw==",
      "optional": true
    },
```

I discovered this while running the `nan` test suite against Electron on our CI (we run tests with DCHECKs enabled).  Just to cover my bases I ran the same nan tests against a `Debug` build of node and the same DCHECKs were hit.

```
#
# Fatal error in ../deps/v8/src/api-inl.h, line 126
# Debug check failed: allow_empty_handle || that != nullptr.
#
#
#
#FailureMessage Object: 0x7ffeefbfc2a0not ok test/js/nannew-test.js ......................... 22/23
    Command: "/Users/sattard/projects/nodejs/node/out/Debug/node nannew-test.js"
    TAP version 13
    ok 1 ../cpp/nannew.cpp:61: New<Array>()->Length() == 0
    ok 2 ../cpp/nannew.cpp:62: New<Array>(7)->Length() == 7
    ok 3 ../cpp/nannew.cpp:63: assertType<Array>(New<Array>(7))
    ok 4 ../cpp/nannew.cpp:73: New<Boolean>(true)->Value() == true
    ok 5 ../cpp/nannew.cpp:74: New<Boolean>(false)->Value() == false
    ok 6 ../cpp/nannew.cpp:75: assertType<Boolean>( New<Boolean>(true))
    ok 7 ../cpp/nannew.cpp:77: New(true)->Value() == true
    ok 8 ../cpp/nannew.cpp:78: New(false)->Value() == false
    ok 9 ../cpp/nannew.cpp:79: assertType<Boolean>( New(true))
    ok 10 ../cpp/nannew.cpp:94: assertType<BooleanObject>( New<BooleanObject>(true))
    ok 11 ../cpp/nannew.cpp:95: New<BooleanObject>(true)->ValueOf() == true
    ok 12 ../cpp/nannew.cpp:96: New<BooleanObject>(false)->ValueOf() == false
    ok 13 ../cpp/nannew.cpp:106: assertType<Context>( New<Context>())
    ok 14 ../cpp/nannew.cpp:108: assertType<Context>( New<Context>(&extensions))
    ok 15 ../cpp/nannew.cpp:111: assertType<Context>( New<Context>(static_cast<ExtensionConfiguration *>(__null) , Local<ObjectTemplate>()))
    ok 16 ../cpp/nannew.cpp:113: assertType<Context>( New<Context>(&extensions, Local<ObjectTemplate>()))
    ok 17 ../cpp/nannew.cpp:116: assertType<Context>( New<Context>(&extensions , Local<ObjectTemplate>(), Local<Value>()))
    ok 18 ../cpp/nannew.cpp:127: assertType<Date>( New<Date>(static_cast<double>(time(__null))).ToLocalChecked())
    ok 19 ../cpp/nannew.cpp:139: New<External>(&ttt)->Value() == &ttt
    ok 20 ../cpp/nannew.cpp:140: assertType<External>(New<External>(&ttt))
    ok 21 ../cpp/nannew.cpp:149: assertType<Function>(New<Function>(testFunction))
    ok 22 ../cpp/nannew.cpp:151: assertType<Function>(New<Function>(testFunction, data))
    not ok 23 test/js/nannew-test.js
      ---
        exit:    ~
        signal:  SIGILL
        stderr:  |
          #
          # Fatal error in ../deps/v8/src/api-inl.h, line 126
          # Debug check failed: allow_empty_handle || that != nullptr.
          #
          #
          #
          #FailureMessage Object: 0x7ffeefbfc2a0
        command: "/Users/sattard/projects/nodejs/node/out/Debug/node nannew-test.js"
      ...

    1..23
    # tests 23
    # pass  22
    # fail  1
```

The same tests pass in Release builds (as DCHECKs are disabled) but I think some time should be spent figuring out what is going wrong here as V8 clearly isn't happy with what is happening 🤔 

To reproduce with a local build of node with a directory structure of

```
nodejs
  / node
  / nan
```

```bash
# Build node + headers
cd nodejs/node
./configure --debug
make -j4
make tar-headers
tar -xzf node-v13.0.0-headers.tar.gz

cd ../nan
# Build nan test modules with right headers
npm_config_nodedir=$(pwd)/../node/node-v13.0.0 npx node-gyp rebuild --directory test
# Run nan tests with built version of node
../node/out/Debug/node node_modules/.bin/tap test/js/*-test.js
```

Note that although the example above uses `HEAD` of node (v13) I have reproed with v12 as well (which is what Electron currently ships)
In my c++ library I have the following:

```c++
typedef void (update_callback)(LibClass *data);
void setCallback(update_callback *callback) {
  this->callback = callback;
}
```

Using nan, I am assigning the persistent function to be called from js using a setUpdateCallback function e.g.:
```js
myClass.setUpdateCallback(function() { console.log("Hello"); })
```

setUpdateCallback calls this nan function:
```c++
void MyClass::SetUpdateCallback(const Nan::FunctionCallbackInfo<v8::Value>& info) {

  // get the object
  MyClass *obj = ObjectWrap::Unwrap<MyClass>(info.Holder());

  // I have tried a million combinations, this one is the latest try
  v8::Isolate *isolate = v8::Isolate::GetCurrent();
  v8::Handle<v8::Function> callback = v8::Handle<v8::Function>::Cast(info[0]);
  v8::Persistent<v8::Function> callback_persistent(isolate, callback);
  obj->cb = callback_persistent;

  // assign the callback, lib here is the custom class that the Nan::ObjectWrap contains as a variable
  obj->lib->setCallback(MyClass::Update);

  // return the class, this can be ommited
  info.GetReturnValue().Set(info.This());

}
```

And the MyClass::Update does the followng:

```c++
void MyClass::Update(LibClass *libClass) {

  // get the obj related to the current LibClass
  // libs here is a map with pair<LibClass *, MyClass *>
  MyClass *parent = libs.at(libClass);

  // create callback
  v8::Isolate *isolate = v8::Isolate::GetCurrent();
  v8::HandleScope scope(isolate);
  v8::Local<v8::Function> callback = v8::Local<v8::Function>::New(isolate, parent->cb);

  Nan::Call(callback, Nan::GetCurrentContext()->Global(), 0, NULL);
  // calling the callback twice works successfully
  Nan::Call(callback, Nan::GetCurrentContext()->Global(), 0, NULL);

}
```

The libClass does not produce a callback, MyClass should set the callback function to call, and throughout the program's execution, libClass will call the update function at random times based on some data.

So what I want to do is to set that callback function in javascript and be able to call it whenever I want from the libClass but it never works. It works on initialization and after that it seems that it is being called by the garbage collector even though it's a persistent function.

I am new to both C++ and Nan and none of the solutions found on the internet were helpful, they were all implementations of callbacks, so am I missing something ?
Node 10 added [Context-aware addons](https://nodejs.org/api/addons.html#addons_context_aware_addons), using the `NODE_MODULE_INITIALIZER`. To be able to make such an addon with compatibility with older versions we need a corresponding macro in nan.