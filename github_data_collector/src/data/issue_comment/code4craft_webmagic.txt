åœ¨ xpath ä¸­ ä½¿ç”¨not contains è¯­æ³•ä¸æ”¯æŒ ä¸çŸ¥é“æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•è§£å†³,åœ¨xsoup 0.3.1ç‰ˆæœ¬ä¸­çš„æºç ä¸­ ä¸æ”¯æŒ,å¯ä»¥æ·»åŠ æ”¯æŒæˆ–è€…æœ‰å…¶ä»–æ–¹æ³•å—
eg:
xpath 
"//*[@class='mod-play-list']/li[not(contains(@class,'item-hold')]/a"


org.jsoup.select.Selector$SelectorParseException: Could not parse query 'li[not(contains(@class,'item-hold')]': unexpected token at 'not(contains(@class,'item-hold')'
	at us.codecraft.xsoup.xevaluator.XPathParser.byFunction(XPathParser.java:260)
	at us.codecraft.xsoup.xevaluator.XPathParser.consumePredicates(XPathParser.java:231)
	at us.codecraft.xsoup.xevaluator.XPathParser.findElements(XPathParser.java:163)
	at us.codecraft.xsoup.xevaluator.XPathParser.parse(XPathParser.java:76)
	at us.codecraft.xsoup.xevaluator.XPathParser.parse(XPathParser.java:408)
	at us.codecraft.xsoup.xevaluator.XPathParser.combinator(XPathParser.java:110)
	at us.codecraft.xsoup.xevaluator.XPathParser.parse(XPathParser.java:74)
	at us.codecraft.xsoup.xevaluator.XPathParser.parse(XPathParser.java:408)
	at us.codecraft.xsoup.Xsoup.compile(Xsoup.java:25)
	at us.codecraft.webmagic.selector.XpathSelector.<init>(XpathSelector.java:21)
	at us.codecraft.webmagic.selector.Selectors.xpath(Selectors.java:32)
	at us.codecraft.webmagic.selector.HtmlNode.xpath(HtmlNode.java:42)
	at com.example.videoparse.spider.yk.YoukuParse.process(YoukuParse.java:37)
	at us.codecraft.webmagic.Spider.onDownloadSuccess(Spider.java:414)
	at us.codecraft.webmagic.Spider.processRequest(Spider.java:406)
	at us.codecraft.webmagic.Spider.access$000(Spider.java:61)
	at us.codecraft.webmagic.Spider$1.run(Spider.java:320)
	at us.codecraft.webmagic.thread.CountableThreadPool$1.run(CountableThreadPool.java:74)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)

--------
``` java
    private static final Map<String, FunctionEvaluator> FUNCTION_MAPPING = new HashMap<String, FunctionEvaluator>();
    static {
        FUNCTION_MAPPING.put("contains", new FunctionEvaluator() {
            @Override
            public Evaluator call(String... param) {
                Validate.isTrue(param.length == 2, String.format("Error argument of %s", "contains"));
                return new Evaluator.AttributeWithValueContaining(param[0], param[1]);
            }
        });
        FUNCTION_MAPPING.put("starts-with", new FunctionEvaluator() {
            @Override
            public Evaluator call(String... param) {
                Validate.isTrue(param.length == 2, String.format("Error argument of %s", "starts-with"));
                return new Evaluator.AttributeWithValueStarting(param[0], param[1]);
            }
        });
        FUNCTION_MAPPING.put("ends-with", new FunctionEvaluator() {
            @Override
            public Evaluator call(String... param) {
                Validate.isTrue(param.length == 2, String.format("Error argument of %s", "ends-with"));
                return new Evaluator.AttributeWithValueEnding(param[0], param[1]);
            }
        });
    }
```


<h3>Snyk has created this PR to fix one or more vulnerable packages in the `maven` dependencies of this project.</h3>

#### Changes included in this PR

- Changes to the following files to upgrade the vulnerable dependencies to a fixed version:
    - pom.xml


#### Vulnerabilities that will be fixed
##### With an upgrade:
  - `pom.xml`
      - `com.github.dreamhead:moco-core@0.11.0 > com.github.dreamhead:moco-core@1.0.0` 
          - [Deserialization of Untrusted Data](https://snyk.io/vuln/SNYK-JAVA-COMFASTERXMLJACKSONCORE-540500)



Check the changes in this PR to ensure they won't cause issues with your project.



------------



**Note:** *You are seeing this because you or someone else with access to this repository has authorized Snyk to open fix PRs.*

For more information:

ğŸ§ [View latest project report](https://app.snyk.io/org/code4craft/project/16c1dcc7-fc11-4cdd-9361-83a5b862fd43)

ğŸ›  [Adjust project settings](https://app.snyk.io/org/code4craft/project/16c1dcc7-fc11-4cdd-9361-83a5b862fd43/settings)

ğŸ“š [Read more about Snyk's upgrade and patch logic](https://snyk.io/docs/fixing-vulnerabilities/)

[//]: # (snyk:metadata:{"dependencies":[{"name":"com.github.dreamhead:moco-core","from":"0.11.0","to":"1.0.0"}],"packageManager":"maven","projectPublicId":"16c1dcc7-fc11-4cdd-9361-83a5b862fd43","type":"auto","patch":[],"vulns":["SNYK-JAVA-COMFASTERXMLJACKSONCORE-540500"],"upgrade":["SNYK-JAVA-COMFASTERXMLJACKSONCORE-540500"],"isBreakingChange":true,"env":"prod","prType":"fix"})

æœŸæœ›ï¼šè¿”å›æ­£ç¡®çš„rawtext æ•°æ® ã€‚
å®é™…ï¼šè¿”å›ä¸è¯·æ±‚é“¾æ¥é¡µé¢ä¸åŒ¹é…çš„æ•°æ®ã€‚
å¤ç°æ­¥éª¤ï¼š 
Spider.create(new DemoProcessor()).addUrl("http://www.fortunechina.com/global500/3/2019").run();
 ä¸€ä¸ªç®€å•çš„è¯·æ±‚è·å–å…¨çƒäº”ç™¾å¼ºç¬¬ä¸€æ¡æ•°æ® ï¼ˆæ²ƒå°”ç›ï¼‰  è¿”å›çš„ page é‡Œçš„ rawtext æ˜¯ã€Œ
<html><head><title>æ²¡æœ‰æŸ¥æ‰¾åˆ°å…¬å¸èµ„æ–™</title></head><body><div>æ²¡æœ‰æŸ¥åˆ°è¯¥å…¬å¸çš„èµ„æ–™ï¼Œè¯·è¿”å›ä¸Šçº§é¡µé¢ã€‚</div></body></html>ã€

å®é™…ä¸Šè¿™ä¸ªç½‘é¡µæ‰“å¼€ä»¥åæ˜¯æœ‰æ•°æ®çš„  å½“url é“¾æ¥æ”¹ä¸ºã€Œhttp://www.fortunechina.com/global500/3000/2019ã€æ—¶ æ‰åº”è¯¥è¿”å› æ²¡æœ‰æŸ¥åˆ°èµ„æ–™ å› ä¸ºè¿™æ˜¯500å¼ºé¡µé¢ æ²¡æœ‰ç¬¬3000æ¡æ•°æ®
  

### å¼‚å¸¸

```2019-11-26 17:15:56 [pool-1-thread-1:856713] - [ERROR] process request Request{url=*********} error
java.lang.NullPointerException
	at us.codecraft.webmagic.downloader.HttpClientDownloader.handleResponse(HttpClientDownloader.java:111)
	at us.codecraft.webmagic.downloader.HttpClientDownloader.download(HttpClientDownloader.java:86)
	at us.codecraft.webmagic.Spider.processRequest(Spider.java:404)
	at us.codecraft.webmagic.Spider.access$000(Spider.java:61)
	at us.codecraft.webmagic.Spider$1.run(Spider.java:320)
	at us.codecraft.webmagic.thread.CountableThreadPool$1.run(CountableThreadPool.java:74)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.Thread.run(Thread.java:748)
```

ç»è¿‡è°ƒè¯•å‘ç°ï¼š
httpResponse.getEntity()è¿”å›å€¼ä¸ºnullï¼Œå¯¼è‡´è°ƒç”¨getContentçš„æ—¶å€™å‡ºé”™ã€‚
å¯ä»¥é€šè¿‡é›†æˆäºHttpClientDownloaderé‡è½½handleResponseæ–¹å¼è§£å†³é—®é¢˜ã€‚
```
protected Page handleResponse(Request request, String charset, HttpResponse httpResponse, Task task) throws IOException {
        byte[] bytes = IOUtils.toByteArray(httpResponse.getEntity().getContent());
        String contentType = httpResponse.getEntity().getContentType() == null ? "" : httpResponse.getEntity().getContentType().getValue();
        Page page = new Page();
        page.setBytes(bytes);
        if (!request.isBinaryContent()){
            if (charset == null) {
                charset = getHtmlCharset(contentType, bytes);
            }
            page.setCharset(charset);
            page.setRawText(new String(bytes, charset));
        }
        page.setUrl(new PlainText(request.getUrl()));
        page.setRequest(request);
        page.setStatusCode(httpResponse.getStatusLine().getStatusCode());
        page.setDownloadSuccess(true);
        if (responseHeader) {
            page.setHeaders(HttpClientUtils.convertHeaders(httpResponse.getAllHeaders()));
        }
        return page;
    }
```
åœ¨ä½¿ç”¨RedisSchedulerçš„æ—¶å€™ï¼ŒæŸä¸ªæœºå™¨ä¼šå‘ç°redisä¸­æ²¡æœ‰Urläº†ï¼Œç„¶åç»“æŸäº†æœ¬æ¬¡é‡‡é›†
spider.isExitWhenComplete()ï¼›ä½ è¯•è¯•è¿™ä¸ª

_Originally posted by @Jratil in https://github.com/code4craft/webmagic/issues/848#issuecomment-461790734_
è¿™ä¸ªæ–¹æ³•çš„æ„æ€æ˜¯æ˜¯å¦åœ¨ç»“æŸåé€€å‡º
å¤åˆ¶ç¬¬ä¸€ä¸ªçˆ¬è™«é¡¹ç›®ï¼Œç›´æ¥è¿è¡Œã€‚ç›´æ¥æŠ¥sslç‰ˆæœ¬ä¸å¯¹ã€‚æ— è¯­äº†
è¯·é—®é¡¹ç›®è¿˜ç»´æŠ¤å—ï¼Ÿæœ€åä¸€æ¬¡æäº¤éƒ½æ˜¯ä¸¤å¹´å‰çš„äº†ã€‚ã€‚ã€‚ã€‚
#### Description
This PR fixes one or more vulnerable packages in the `maven` dependencies of this project.
See the [Snyk test report](https://app.snyk.io/org/code4craft/test/github/16c1dcc7-fc11-4cdd-9361-83a5b862fd43/master..snyk-fix-858549a4b6d8c4cb61600052a08ab66d) for more details.

#### Snyk Project: [code4craft/webmagic:webmagic-core/pom.xml](https://app.snyk.io/org/code4craft/project/16c1dcc7-fc11-4cdd-9361-83a5b862fd43)
#### Snyk Organization: [code4craft](https://app.snyk.io/org/code4craft)


#### Changes included in this PR

- Changes to the following files to upgrade the vulnerable dependencies to a fixed version:
    - pom.xml


#### Vulnerabilities that will be fixed
##### With an upgrade:
  - `pom.xml`
      - `com.github.dreamhead:moco-core@0.11.0 > com.github.dreamhead:moco-core@1.0.0` 
          - [Deserialization of Untrusted Data](https://snyk.io/vuln/SNYK-JAVA-COMFASTERXMLJACKSONCORE-472980)



You can read more about Snyk's upgrade and patch logic in [Snyk's documentation](https://snyk.io/docs/using-snyk/).

Check the changes in this PR to ensure they won't cause issues with your project.

Stay secure,
The Snyk team

_**Note**: You are seeing this because you or someone else with access to this repository has authorised Snyk to open Fix PRs. To review the settings for this Snyk project please go to the [project settings page](https://app.snyk.io/org/code4craft/project/16c1dcc7-fc11-4cdd-9361-83a5b862fd43/settings)._

[//]: # (snyk:metadata:{"type":"auto","packageManager":"maven","vulns":["SNYK-JAVA-COMFASTERXMLJACKSONCORE-472980"],"patch":[],"upgrade":["SNYK-JAVA-COMFASTERXMLJACKSONCORE-472980"],"isBreakingChange":true,"env":"prod","dependencies":[{"name":"com.github.dreamhead:moco-core","from":"0.11.0","to":"1.0.0"}],"prType":"fix"})
