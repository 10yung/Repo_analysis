Fix underscores in S object metadata keys fixes Were using an old version of boto through moto to detect the available regions for Lambda and other APIs We should switch from boto to the newer boto library which includes the uptodate endpoints codelocalstacklocalstackservicescloudformationcloudformationstarterpy line in Lambdacreatefromcloudformationjson return Lambdacreatefromcloudformationjsonorigresourcename cloudformationjson regionname File optcodelocalstackvenvlibpython sitepackagesmotoawslambdamodelspy line in createfromcloudformationjson backend lambdabackends regionname KeyError euwest While trying to trigger a lambda written in Java using DynamoDB stream I am receiving the following error localstack Exception in thread main javalangNoSuchMethodError comamazonawsserviceslambdaruntimeeventsDynamodbEventDynamodbStreamRecordsetUserIdentityLcomamazonawsservicesdynamodbv modelIdentityV localstack at cloudlocalstacklambdaDDBEventParserparseDDBEventParserjava localstack at cloudlocalstackLambdaExecutormainLambdaExecutorjava In the cloud formation template this is how the DynamoDB table has been configured MyTable Type AWSDynamoDBTable Properties TableName Sub Envmytablename AttributeDefinitions AttributeName id AttributeType N AttributeName version AttributeType N KeySchema AttributeName id KeyType HASH AttributeName version KeyType RANGE ProvisionedThroughput ReadCapacityUnits WriteCapacityUnits StreamSpecification StreamViewType NEWIMAGE TimeToLiveSpecification AttributeName ttl Enabled TRUE And the event source is configured as given below FunctionEventSource Type AWSLambdaEventSourceMapping Properties Enabled true StartingPosition LATEST EventSourceArn GetAtt MyTableStreamArn FunctionName Ref JavaFunction And the java function is configured as JavaFunction Type AWSServerlessFunction Properties FunctionName Sub ServiceEnv AutoPublishAlias LIVE DeploymentPreference Type GlobalsDEPLOYSTRATEGY Handler comxyzEventLocalHandler Runtime java Timeout MemorySize Tracing Active CodeUri Bucket mybucket Key mylambdazip Environment Variables ENV Sub Env All the services are up and running in Localstack I can see the table put value into the DB and this in turn triggers the lambda without any errors One warning that appears in the log is given below localstack T WARNINGlocalstackservicescloudformationcloudformationstarter Unable to determine physicalresourceid for resource class motodynamodb modelsTable I am not sure whether this will cause any problem After searching online I found that Localstack is trying read userIdentity attribute present in Recordjava object However I am not sure how we can explicitly set this value In the real AWS world it is not necessary to set this value in the cloud formation script Still the event in DynamoDB stream triggers the lambda and gets processed successfully This only happens in Localstack Request your advice on this Edited I am using version of aws sdk Localstack is using x versions That could be why this problem is occurring I will troubleshoot this Were using localstack and are running into issues when creating a Cloudwatch event rule using the AWS terraform provider We have the following event rule defined in terraform resource awscloudwatcheventrule everyfiveseconds name everyfiveseconds description Fires every five seconds scheduleexpression rate seconds When we run terraform apply against our local Cloudwatch Events it just hangs with Still creating On inspecting the localstack logs we can see the following NotImplementedError localstack API Error on request localstack Traceback most recent call last localstack File optcodelocalstackvenvlibpython sitepackageswerkzeugservingpy line in runwsgi localstack executeselfserverapp localstack File optcodelocalstackvenvlibpython sitepackageswerkzeugservingpy line in execute localstack applicationiter appenviron startresponse localstack File optcodelocalstackvenvlibpython sitepackagesmotoserverpy line in call localstack return backendappenviron startresponse localstack File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in call localstack return selfwsgiappenviron startresponse localstack File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in wsgiapp localstack response selfhandleexceptione localstack File optcodelocalstackvenvlibpython sitepackagesflaskcorsextensionpy line in wrappedfunction localstack return corsafterrequestappmakeresponsefargs kwargs localstack File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in handleexception localstack reraiseexctype excvalue tb localstack File optcodelocalstackvenvlibpython sitepackagesflaskcompatpy line in reraise localstack raise value localstack File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in wsgiapp localstack response selffulldispatchrequest localstack File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in fulldispatchrequest localstack rv selfhandleuserexceptione localstack File optcodelocalstackvenvlibpython sitepackagesflaskcorsextensionpy line in wrappedfunction localstack return corsafterrequestappmakeresponsefargs kwargs localstack File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in handleuserexception localstack reraiseexctype excvalue tb localstack File optcodelocalstackvenvlibpython sitepackagesflaskcompatpy line in reraise localstack raise value localstack File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in fulldispatchrequest localstack rv selfdispatchrequest localstack File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in dispatchrequest localstack return selfviewfunctions ruleendpoint reqviewargs localstack File optcodelocalstackvenvlibpython sitepackagesmotocoreutilspy line in call localstack result selfcallbackrequest requesturl localstack File optcodelocalstackvenvlibpython sitepackagesmotocoreresponsespy line in dispatch localstack return clsdispatchargs kwargs localstack File optcodelocalstackvenvlibpython sitepackagesmotocoreresponsespy line in dispatch localstack return selfcallaction localstack File optcodelocalstackvenvlibpython sitepackagesmotocoreresponsespy line in callaction localstack The action has not been implementedformataction localstack NotImplementedError The listtagsforresource action has not been implemented Using the AWS CLI to create the event rule works fine just not when using a Terraform awscloudwatcheventrule resource Hi guys consistently getting error responses when trying to update a new API Gateway Rest API with a Swagger spec Im orchestrating with Pulumi using the pulumiawsx package to build out a test API gateway with no routes The package constructs an API Gateway with a Swagger spec and performs aws api calls via terraform providers underneath Heres the call sequence to replicate the issue captured via proxying with mitmproxy Create a RestAPI curl H UserAgentawssdkgo go darwin amd APN HashiCorp Terraform compatible H ContentLength H Acceptapplicationjson H AuthorizationAWS HMACSHA CredentialmockAccessKey useast apigatewayaws request SignedHeadersacceptcontentlengthcontenttypehostxamzdatexamzsecuritytoken Signature ee e dc c b ccc eb cefe a d d b dd b d c H ContentTypeapplicationjson H XAmzDate T Z H XAmzSecurityTokennothing H AcceptEncodinggzip H Connectionclose X POST databinary apiKeySourceHEADERbinaryMediaTypes namehelloworld Update API with Swagger definition body note replace the rest api id bmtiorrlv below with the id of the api created in first call curl i H UserAgentawssdkgo go darwin amd APN HashiCorp Terraform compatible H ContentLength H Acceptapplicationjson H AuthorizationAWS HMACSHA CredentialmockAccessKey useast apigatewayaws request SignedHeadersacceptcontentlengthhostxamzdatexamzsecuritytoken Signaturee b cf b c e dde a d a e cee ac H XAmzDate T Z H XAmzSecurityTokennothing H AcceptEncodinggzip H Connectionclose X PUT databinary swagger infotitlehelloworldversion pathsxamazonapigatewaybinarymediatypes xamazonapigatewaygatewayresponsesMISSINGAUTHENTICATIONTOKENstatusCode responseTemplatesapplicationjson message Not found ACCESSDENIEDstatusCode responseTemplatesapplicationjson message Not found xamazonapigatewayapikeysourceHEADER Response HTTP Internal Server Error Server BaseHTTP Python Date Fri Jan GMT ContentType texthtml ContentLength AccessControlAllowOrigin AccessControlAllowMethods HEADGETPUTPOSTDELETEOPTIONSPATCH AccessControlAllowHeaders authorizationcontenttypecontentmd cachecontrolxamzcontentsha xamzdatexamzsecuritytokenxamzuseragentxamztargetxamzaclxamzversionidxlocalstacktargetxamztagging AccessControlExposeHeaders xamzversionid DOCTYPE HTML PUBLIC W CDTD HTML FinalEN title Internal Server Errortitle h Internal Server Errorh pThe server encountered an internal error and was unable to complete your request Either the server is overloaded or there is an error in the applicationp Localstack container logs started via dockercompose localstackmain API Error on request localstackmain Traceback most recent call last localstackmain File optcodelocalstackvenvlibpython sitepackageswerkzeugservingpy line in runwsgi localstackmain executeselfserverapp localstackmain File optcodelocalstackvenvlibpython sitepackageswerkzeugservingpy line in execute localstackmain applicationiter appenviron startresponse localstackmain File optcodelocalstackvenvlibpython sitepackagesmotoserverpy line in call localstackmain return backendappenviron startresponse localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in call localstackmain return selfwsgiappenviron startresponse localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in wsgiapp localstackmain response selfhandleexceptione localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskcorsextensionpy line in wrappedfunction localstackmain return corsafterrequestappmakeresponsefargs kwargs localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in handleexception localstackmain reraiseexctype excvalue tb localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskcompatpy line in reraise localstackmain raise value localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in wsgiapp localstackmain response selffulldispatchrequest localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in fulldispatchrequest localstackmain rv selfhandleuserexceptione localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskcorsextensionpy line in wrappedfunction localstackmain return corsafterrequestappmakeresponsefargs kwargs localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in handleuserexception localstackmain reraiseexctype excvalue tb localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskcompatpy line in reraise localstackmain raise value localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in fulldispatchrequest localstackmain rv selfdispatchrequest localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in dispatchrequest localstackmain return selfviewfunctions ruleendpoint reqviewargs localstackmain File optcodelocalstackvenvlibpython sitepackagesmotocoreutilspy line in call localstackmain if lenresult localstackmain TypeError object of type NoneType has no len localstackmain API Error on request localstackmain Traceback most recent call last localstackmain File optcodelocalstackvenvlibpython sitepackageswerkzeugservingpy line in runwsgi localstackmain executeselfserverapp localstackmain File optcodelocalstackvenvlibpython sitepackageswerkzeugservingpy line in execute localstackmain applicationiter appenviron startresponse localstackmain File optcodelocalstackvenvlibpython sitepackagesmotoserverpy line in call localstackmain return backendappenviron startresponse localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in call localstackmain return selfwsgiappenviron startresponse localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in wsgiapp localstackmain response selfhandleexceptione localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskcorsextensionpy line in wrappedfunction localstackmain return corsafterrequestappmakeresponsefargs kwargs localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in handleexception localstackmain reraiseexctype excvalue tb localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskcompatpy line in reraise localstackmain raise value localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in wsgiapp localstackmain response selffulldispatchrequest localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in fulldispatchrequest localstackmain rv selfhandleuserexceptione localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskcorsextensionpy line in wrappedfunction localstackmain return corsafterrequestappmakeresponsefargs kwargs localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in handleuserexception localstackmain reraiseexctype excvalue tb localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskcompatpy line in reraise localstackmain raise value localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in fulldispatchrequest localstackmain rv selfdispatchrequest localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in dispatchrequest localstackmain return selfviewfunctions ruleendpoint reqviewargs localstackmain File optcodelocalstackvenvlibpython sitepackagesmotocoreutilspy line in call localstackmain if lenresult localstackmain TypeError object of type NoneType has no len localstackmain API Error on request localstackmain Traceback most recent call last localstackmain File optcodelocalstackvenvlibpython sitepackageswerkzeugservingpy line in runwsgi localstackmain executeselfserverapp localstackmain File optcodelocalstackvenvlibpython sitepackageswerkzeugservingpy line in execute localstackmain applicationiter appenviron startresponse localstackmain File optcodelocalstackvenvlibpython sitepackagesmotoserverpy line in call localstackmain return backendappenviron startresponse localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in call localstackmain return selfwsgiappenviron startresponse localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in wsgiapp localstackmain response selfhandleexceptione localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskcorsextensionpy line in wrappedfunction localstackmain return corsafterrequestappmakeresponsefargs kwargs localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in handleexception localstackmain reraiseexctype excvalue tb localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskcompatpy line in reraise localstackmain raise value localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in wsgiapp localstackmain response selffulldispatchrequest localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in fulldispatchrequest localstackmain rv selfhandleuserexceptione localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskcorsextensionpy line in wrappedfunction localstackmain return corsafterrequestappmakeresponsefargs kwargs localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in handleuserexception localstackmain reraiseexctype excvalue tb localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskcompatpy line in reraise localstackmain raise value localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in fulldispatchrequest localstackmain rv selfdispatchrequest localstackmain File optcodelocalstackvenvlibpython sitepackagesflaskapppy line in dispatchrequest localstackmain return selfviewfunctions ruleendpoint reqviewargs localstackmain File optcodelocalstackvenvlibpython sitepackagesmotocoreutilspy line in call localstackmain if lenresult localstackmain TypeError object of type NoneType has no len Localstack docker image latest Digest sha cece cd df b c c ffb bb a e dockercomposeyml version services localstack containername LOCALSTACKDOCKERNAMElocalstackmain image localstacklocalstacklatest ports environment STARTWEB SERVICESSERVICES DEBUG DATADIRDATADIR LAMBDAEXECUTORLAMBDAEXECUTOR docker LAMBDAREMOTEDOCKERLAMBDAREMOTEDOCKER KINESISERRORPROBABILITYKINESISERRORPROBABILITY DOCKERHOSTunixvarrundockersock volumes TMPDIRtmplocalstacktmplocalstack varrundockersockvarrundockersock Thanks guys Let me know if you need any more info on anything While trying to subscribe to a SNS topic via Java AWS client localstack throws error Even though exception is thrown it is actually creating the subscription Please find below the stacktrace I received for the issue T ERRORlocalstackservicesgenericproxy Error forwarding request arnawssnsuseast proxylocal Traceback most recent call last localstackdemo File optcodelocalstacklocalstackservicesgenericproxypy line in forward localstackdemo updatedresponse selfproxyupdatelistenerreturnresponsekwargs localstackdemo File optcodelocalstacklocalstackservicessnssnslistenerpy line in returnresponse localstackdemo filterpolicy localstackdemo File optcodelocalstacklocalstackservicessnssnslistenerpy line in dosubscribe localstackdemo SNSSUBSCRIPTIONS topicarn appendsubscription localstackdemo KeyError arnawssnsuseast proxylocal I tried with version and it is working fine Basically this issue happen in latest versions when request is sent as a POST and the parameterscommands are sent as request bodyas opposed to query parameters which is what the Java AWS client does If commands are sent as query parameters using GETPOST it works fine Off the back of Ive dug a little deeper and believe this might be related to how the tags are being handled This gist demonstrates the awscli commands working as expected when using the upstream localkms docker image directly Below shows my results when using the localstack endpoint installed versions Package Version awscli awsclilocal localstack localstackclient localstackext localstack seems to start with one key already created aws kms listkeys endpointurl Keys KeyArn arnawskmsuseast key f c a c c f cb eea KeyId f c a c c f cb eea create a basic key to show key creation works as intended aws kms createkey endpoint KeyMetadata Origin AWSKMS KeyId d f ed d bacb a bf ee d Description KeyManager CUSTOMER Enabled true KeyUsage ENCRYPTDECRYPT KeyState Enabled CreationDate Arn arnawskmsuseast keyd f ed d bacb a bf ee d AWSAccountId list keys to confirm new key exists aws kms listkeys endpointurl Keys KeyArn arnawskmsuseast key f c a c c f cb eea KeyId f c a c c f cb eea KeyArn arnawskmsuseast keyd f ed d bacb a bf ee d KeyId d f ed d bacb a bf ee d create a key with two tags aws kms createkey tags TagKeyTag TagValueTest TagKeyTag TagValueTwo endpoint KeyMetadata Origin AWSKMS KeyId b c b a a ad e f ada c Description KeyManager CUSTOMER Enabled true KeyUsage ENCRYPTDECRYPT KeyState Enabled CreationDate Arn arnawskmsuseast keyb c b a a ad e f ada c AWSAccountId list keys to show resulting keys which includes two phantom entries aws kms listkeys endpointurl Keys KeyArn arnawskmsuseast key f c a c c f cb eea KeyId f c a c c f cb eea KeyArn arnawskmsuseast keyb c b a a ad e f ada c KeyId b c b a a ad e f ada c KeyArn KeyId KeyArn KeyId KeyArn arnawskmsuseast keyd f ed d bacb a bf ee d KeyId d f ed d bacb a bf ee d Below are logs taken from localstack running in debug mode during the above operations INFO keys listed INFO New key created arnawskmsuseast keyd f ed d bacb a bf ee d INFO keys listed INFO New key created arnawskmsuseast keyb c b a a ad e f ada c INFO New tag created Tag Test INFO New tag created Tag Two INFO keys listed As shown in the logs above I start with one key create a second then create a third with two tags the resulting total should be but I end up with Im not sure how to dig deeper to determine why these two additional key entries are being created I am dubbing them s and while they dont harm normal operations they do seem to mess up the pagination The same results are seen when using awslocal Including the Range header on S requests triggers a Bad Gateway when localstack is run with SSL Sample test that demonstrates the issue python import logging import io import os import boto loggingbasicConfiglevelloggingINFO def testranges s boto clients endpointurl usesslTrue verifyFalse bucket localstacks range objname samplebin s createbucketBucketbucket chunksize with ioBytesIO as data datawriteosurandomchunksize logginginfoUploading object sized datagetbuffernbytes dataseek s uploadfileobjdata bucket objname rangeheader fbytes chunksize logginginfoDownloading using Range header s rangeheader this will raise an exception botocoreexceptionsClientError An error occurred when calling the GetObject operation reached max retries Bad Gateway resp s getobjectBucketbucket Keyobjname Rangerangeheader content resp Body read assert lencontent chunksize This is a fairly recent regression Running against localstacklocalstacklatest will fail using SSL but pass without SSL Running against localstacklocalstack will pass using SSL as well as without SSL I am guessing changes from either or broke this since those were related to Range functionality but have not bisected to be sure Im attempting to connect using awscli to the localstack SSM but it throws An error occurred when calling the ListDocuments operation reached max retries DOCTYPE HTML PUBLIC W CDTD HTML FinalEN title Internal Server Errortitle h Internal Server Errorh pThe server encountered an internal error and was unable to complete your request Either the server is overloaded or there is an error in the applicationp My env uses dockercompose version services localstack image localstacklocalstack containername localstackaoms hostname localstack ports PORTWEBUI PORTWEBUI expose environment SERVICES sqs sns dynamodb apigateway s cloudformation iam ssm DEFAULTREGIONuseast AWSXRAYSDKENABLEDtrue DEBUG DATADIRtmplocalstackdata PORTWEBUIPORTWEBUI LAMBDAEXECUTORlocal LAMBDAREMOTEDOCKERfalse DOCKERHOSTunixvarrundockersock HOSTNAMEEXTERNALlocalstack These are your alks creds Were going to fake it with them AWSACCESSKEYIDAWSACCESSKEYID AWSSECRETACCESSKEYAWSSECRETACCESSKEY AWSSESSIONTOKENAWSSESSIONTOKEN volumes localstacktmplocalstack varrundockersockvarrundockersock privileged true user localstack networks net host node build containername node workingdir src privileged true volumes src tty true user node environment AWSACCESSKEYIDAWSACCESSKEYID AWSSECRETACCESSKEYAWSSECRETACCESSKEY AWSSESSIONTOKENAWSSESSIONTOKEN GEMHOMEusrlocalbundle PATHGEMHOMEbinGEMHOMEgemsbinPATH TFLOGtrace TFLOGPATHloglog NVMDIRnvm s NVMDIRnvmsh NVMDIRnvmsh NODEVERSION PROFILEbashprofile envfile env networks net host networks net driver bridge host I attempt to connect to the service from the node container using aws endpointurl ssm listdocuments My other localstack services run just fine This is only one giving me issue Note Novice localstack level Hello Is support for MediaStore on the current roadmap Cheers