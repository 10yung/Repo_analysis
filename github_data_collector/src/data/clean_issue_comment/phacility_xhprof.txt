Recently I started getting segmentation faults when using certain PHP libraries such as caxyphphtmldiff I noticed that the faults only occur when the xhprof php extension is enabled If I disable it the segfaults disappear So I surmise that either xhprof is causing the segfaults or the problem is perhaps with memory allocation and xhprof just happened to be the extension to trigger the problem Either way Id appreciate some help Heres the backtrace from the core dump Heres the full background on the issue I originally thought it was a problem with the caxyphphtmldiff library I tried using instead of specifying register r but for some reason kept getting errors like homeu xhprofextensionxhprofc In function hpmodehierbeginfncb homeu xhprofextensionxhprofc error unknown register name in asm asm volatile also added toplevel Makefile for the impatient and added a few clues to the README there are a lot of errors compiling under PHP many functions now use different numbers of args If the xhprof extension is not installed iniget doesnt work but getcfgvar still return the value php printrinigetxhprofoutputdir php printrgetcfgvarxhprofoutputdir test This allow to use the UI with tideways for instance or on a separate server Fix I faced this problem while using xhprof and phpfpm on centos If you use phpfpm daemon configured to use private tmp directory set to true by default in centos and set xhprofoutputdir as subdirectory of tmp you probably notice than reports files cant be saved to that dir In that case you get the following message PHP Warning fopentmpxhprof ed f dxhproftestingxhprof failed to open stream No such file or directory in usrsharepearxhproflibutilsxhprofrunsphp on line This happens because of phpfpm service cleans up tmp directory each time the service startedrestarted So you have to create all subdirectories into tmp each time you restart phpfpm Example cat etcphpdxhprofini xhprof extensionxhprofso xhprofoutputdirtmpxhprof cat usrlibsystemdsystemphpfpmservice grep PrivateTmp PrivateTmptrue sudo ls tmpsystemdprivateb cfb c b a dphpfpmservicelP PdFtmpxhprof f bd xhproftestingxhprof sudo systemctl restart phpfpm sudo ls tmpsystemdprivateb cfb c b a dphpfpmserviceEqBde tmpxhprof ls cannot access tmpsystemdprivateb cfb c b a dphpfpmserviceEqBde tmpxhprof No such file or directory php v PHP xhprof v run code to Reproduce bug php xhprofenable class Index public function index return public function test return echo method test class Index echo inarraystrtolowermethodarraymapstrtolowergetclassmethodsclassTRUE data xhprofdisable vardumpdata make binsh cygdrivecwamp wwwtestwebsitexhprofextensionlibtool modecompile cc I Icygdrivecwamp wwwtestwebsitexhprofextension DPHPATOMINC Icygdrivecwamp wwwtestwebsitexhprofextensioninclude Icygdrivecwamp wwwtestwebsitexhprofextensionmain Icygdrivecwamp wwwtestwebsitexhprofextension Iusrincludephp Iusrincludephpmain IusrincludephpTSRM IusrincludephpZend Iusrincludephpext Iusrincludephpextdatelib DHAVECONFIGH g O c cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc o xhproflo libtool compile cc I Icygdrivecwamp wwwtestwebsitexhprofextension DPHPATOMINC Icygdrivecwamp wwwtestwebsitexhprofextensioninclude Icygdrivecwamp wwwtestwebsitexhprofextensionmain Icygdrivecwamp wwwtestwebsitexhprofextension Iusrincludephp Iusrincludephpmain IusrincludephpTSRM IusrincludephpZend Iusrincludephpext Iusrincludephpextdatelib DHAVECONFIGH g O c cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc DDLLEXPORT DPIC o libsxhprofo cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error unknown type name cpusett cpusett prevmask cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error unknown type name cpusett int restorecpuaffinitycpusett prevmask cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc In function zmstartupxhprof cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning implicit declaration of function schedgetaffinity Wimplicitfunctiondeclaration define GETAFFINITYpid size mask schedgetaffinity size mask cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc note in expansion of macro GETAFFINITY if GETAFFINITY sizeofcpusett hpglobalsprevmask cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error cpusett undeclared first use in this function if GETAFFINITY sizeofcpusett hpglobalsprevmask cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc note in definition of macro GETAFFINITY define GETAFFINITYpid size mask schedgetaffinity size mask cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc note each undeclared identifier is reported only once for each function it appears in if GETAFFINITY sizeofcpusett hpglobalsprevmask cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc note in definition of macro GETAFFINITY define GETAFFINITYpid size mask schedgetaffinity size mask cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc In function hpinitprofilerstate cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning implicit declaration of function FREEZVAL Wimplicitfunctiondeclaration FREEZVALhpglobalsstatscount cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning implicit declaration of function MAKESTDZVAL Wimplicitfunctiondeclaration MAKESTDZVALhpglobalsstatscount cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning implicit declaration of function restorecpuaffinity Wimplicitfunctiondeclaration restorecpuaffinity hpglobalsprevmask cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc In function hpgetfunctionname cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error zendexecutedata aka struct zendexecutedata has no member named functionstate currfunc datafunctionstatefunction cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning assignment from incompatible pointer type Wincompatiblepointertypes func currfunccommonfunctionname cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning assignment from incompatible pointer type Wincompatiblepointertypes cls currfunccommonscopename cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error zendexecutedata aka struct zendexecutedata has no member named object else if dataobject In file included from usrincludephpZendzendh from usrincludephpmainphph from cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error zendexecutedata aka struct zendexecutedata has no member named object cls ZOBJCEdataobjectname usrincludephpZendzendtypesh note in definition of macro ZOBJ define ZOBJzval zvalvalueobj cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc note in expansion of macro ZOBJCE cls ZOBJCEdataobjectname cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning passing argument of hpgetbasefilename from incompatible pointer type Wincompatiblepointertypes filename hpgetbasefilenamecurrfuncoparrayfilename cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc note expected const char but argument is of type zendstring aka struct zendstring static const char hpgetbasefilenameconst char filename cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc In function hpinccount cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning passing argument of zendhashfind from incompatible pointer type Wincompatiblepointertypes if zendhashfindht name strlenname data SUCCESS In file included from usrincludephpZendzendh from usrincludephpmainphph from cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc usrincludephpZendzendhashh note expected zendstring aka struct zendstring but argument is of type char ZENDAPI zval ZENDFASTCALL zendhashfindconst HashTable ht zendstring key cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error too many arguments to function zendhashfind if zendhashfindht name strlenname data SUCCESS In file included from usrincludephpZendzendh from usrincludephpmainphph from cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc usrincludephpZendzendhashh note declared here ZENDAPI zval ZENDFASTCALL zendhashfindconst HashTable ht zendstring key In file included from usrincludephpZendzendh from usrincludephpmainphph from cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning implicit declaration of function ZLVALPP Wimplicitfunctiondeclaration ZVALLONGzvaldata ZLVALPPzvaldata count usrincludephpZendzendtypesh note in definition of macro ZVALLONG ZLVALPz l cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc In function hphashlookup cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning passing argument of zendhashfind from incompatible pointer type Wincompatiblepointertypes if zendhashfindht symbol strlensymbol data SUCCESS In file included from usrincludephpZendzendh from usrincludephpmainphph from cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc usrincludephpZendzendhashh note expected zendstring aka struct zendstring but argument is of type char ZENDAPI zval ZENDFASTCALL zendhashfindconst HashTable ht zendstring key cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error too many arguments to function zendhashfind if zendhashfindht symbol strlensymbol data SUCCESS In file included from usrincludephpZendzendh from usrincludephpmainphph from cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc usrincludephpZendzendhashh note declared here ZENDAPI zval ZENDFASTCALL zendhashfindconst HashTable ht zendstring key cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc In function hpsamplestack cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error macro addassocstring passed arguments but takes just cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error addassocstring undeclared first use in this function addassocstringhpglobalsstatscount cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc In function bindtocpu cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error unknown type name cpusett cpusett newmask cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning implicit declaration of function CPUZERO Wimplicitfunctiondeclaration CPUZERO newmask cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning implicit declaration of function CPUSET Wimplicitfunctiondeclaration CPUSETcpuid newmask cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning implicit declaration of function schedsetaffinity Wimplicitfunctiondeclaration define SETAFFINITYpid size mask schedsetaffinity size mask cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc note in expansion of macro SETAFFINITY if SETAFFINITY sizeofcpusett newmask cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error cpusett undeclared first use in this function if SETAFFINITY sizeofcpusett newmask cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc note in definition of macro SETAFFINITY define SETAFFINITYpid size mask schedsetaffinity size mask cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc At top level cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error unknown type name cpusett int restorecpuaffinitycpusett prevmask cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc In function hpexecuteex cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error zendexecutedata aka struct zendexecutedata has no member named oparray zendoparray ops executedataoparray cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc In function hpexecuteinternal cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error zendexecutedata aka struct zendexecutedata has no member named oparray func hpgetfunctionnamecurrentdataoparray TSRMLSCC cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error zendexecutedata aka struct zendexecutedata has no member named functionstate zendinternalfunction executedatafunctionstatefunctionhandler cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error struct zendfcallinfo has no member named retvalptrptr fciretvalptrptr cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error struct zendfcallinfo has no member named retvalptrptr fciretvalptrptr cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error struct zendfcallinfo has no member named objectptr fciobjectptr cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning implicit declaration of function EXTMPVAR Wimplicitfunctiondeclaration zval returnvalueptr EXTMPVARexecutedata executedataoplineresultvarvarptr cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error invalid type argument of have int zval returnvalueptr EXTMPVARexecutedata executedataoplineresultvarvarptr cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error zendexecutedata aka struct zendexecutedata has no member named functionstate zendinternalfunction executedatafunctionstatefunctionhandler cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error zendexecutedata aka struct zendexecutedata has no member named functionstate executedatafunctionstatefunctioncommonfnflags ZENDACCRETURNREFERENCE cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error zendexecutedata aka struct zendexecutedata has no member named object executedataobject cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc In function hpbegin cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning assignment from incompatible pointer type Wincompatiblepointertypes zendexecuteinternal zendexecuteinternal cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning assignment from incompatible pointer type Wincompatiblepointertypes zendexecuteinternal hpexecuteinternal cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc In function hpstop cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning assignment from incompatible pointer type Wincompatiblepointertypes zendexecuteinternal zendexecuteinternal cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc In function hpzvalatkey cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error zval aka struct zvalstruct has no member named type if valuestype ISARRAY cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning passing argument of zendhashfind from incompatible pointer type Wincompatiblepointertypes if zendhashfindht key len void value SUCCESS In file included from usrincludephpZendzendh from usrincludephpmainphph from cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc usrincludephpZendzendhashh note expected zendstring aka struct zendstring but argument is of type char ZENDAPI zval ZENDFASTCALL zendhashfindconst HashTable ht zendstring key cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error too many arguments to function zendhashfind if zendhashfindht key len void value SUCCESS In file included from usrincludephpZendzendh from usrincludephpmainphph from cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc usrincludephpZendzendhashh note declared here ZENDAPI zval ZENDFASTCALL zendhashfindconst HashTable ht zendstring key cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc In function hpstringsinzval cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error zval aka struct zvalstruct has no member named type if valuestype ISARRAY cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning passing argument of zendhashgetcurrentkeyex from incompatible pointer type Wincompatiblepointertypes type zendhashgetcurrentkeyexht str len idx NULL In file included from usrincludephpZendzendh from usrincludephpmainphph from cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc usrincludephpZendzendhashh note expected zendstring aka struct zendstring but argument is of type char ZENDAPI int ZENDFASTCALL zendhashgetcurrentkeyexconst HashTable ht zendstring strindex zendulong numindex HashPosit cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning passing argument of zendhashgetcurrentkeyex from incompatible pointer type Wincompatiblepointertypes type zendhashgetcurrentkeyexht str len idx NULL In file included from usrincludephpZendzendh from usrincludephpmainphph from cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc usrincludephpZendzendhashh note expected zendulong aka long unsigned int but argument is of type uint aka unsigned int ZENDAPI int ZENDFASTCALL zendhashgetcurrentkeyexconst HashTable ht zendstring strindex zendulong numindex HashPosit cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning passing argument of zendhashgetcurrentkeyex from incompatible pointer type Wincompatiblepointertypes type zendhashgetcurrentkeyexht str len idx NULL In file included from usrincludephpZendzendh from usrincludephpmainphph from cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc usrincludephpZendzendhashh note expected HashPosition aka unsigned int but argument is of type ulong aka long unsigned int ZENDAPI int ZENDFASTCALL zendhashgetcurrentkeyexconst HashTable ht zendstring strindex zendulong numindex HashPosit cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error too many arguments to function zendhashgetcurrentkeyex type zendhashgetcurrentkeyexht str len idx NULL In file included from usrincludephpZendzendh from usrincludephpmainphph from cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc usrincludephpZendzendhashh note declared here ZENDAPI int ZENDFASTCALL zendhashgetcurrentkeyexconst HashTable ht zendstring strindex zendulong numindex HashPosit cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error macro zendhashgetcurrentdata passed arguments but takes just if zendhashgetcurrentdataht void data SUCCESS cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error zendhashgetcurrentdata undeclared first use in this function if zendhashgetcurrentdataht void data SUCCESS cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning implicit declaration of function ZTYPEPP Wimplicitfunctiondeclaration ZTYPEPPdata ISSTRING cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning implicit declaration of function ZSTRVALPP Wimplicitfunctiondeclaration strcmpZSTRVALPPdata ROOTSYMBOL do not ignore main cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc warning passing argument of strcmp makes pointer from integer without a cast Wintconversion In file included from usrincludestdlibh from usrincludephpmainphpconfigh from usrincludephpZendzendconfigh from usrincludephpZendzendportabilityh from usrincludephpZendzendtypesh from usrincludephpZendzendh from usrincludephpmainphph from cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc usrincludestringh note expected const char but argument is of type int int EXFUNstrcmpconst char const char In file included from usrincludephpZendzendh from usrincludephpmainphph from cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc usrincludephpZendzendalloch warning passing argument of estrdup makes pointer from integer without a cast Wintconversion define estrdups estrdups ZENDFILELINECC ZENDFILELINEEMPTYCC cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc note in expansion of macro estrdup result ix estrdupZSTRVALPPdata In file included from usrincludephpZendzendh from usrincludephpmainphph from cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc usrincludephpZendzendalloch note expected const char but argument is of type int ZENDAPI char ZENDFASTCALL estrdupconst char s ZENDFILELINEDC ZENDFILELINEORIGDC ZENDATTRIBUTEMALLOC cygdrivecwamp wwwtestwebsitexhprofextensionxhprofc error zval aka struct zvalstruct has no member named type else ifvaluestype ISSTRING make Makefile xhproflo Error uname a CYGWINNT hostname x Cygwin php version PHP cli built Dec NTS Copyright c The PHP Group Zend Engine v Copyright c Zend Technologies with Zend OPcache v Copyright c by Zend Technologies with Xdebug v Copyright c by Derick Rethans Segfaults in PHP openSUSE Fix based on PHP bug Hi Im having php installed via src and am trying to install xhprof extension from RustJason php branch but unable to build it While running make command am getting this error optxhprofxhprofextensionxhprofc error zendexecutedata aka struct zendexecutedata has no member named calledscope if executedata calledscope NULL func NULL optxhprofxhprofextensionxhprofc error zendexecutedata aka struct zendexecutedata has no member named calledscope zendstring classname executedatacalledscopename Makefile recipe for target xhproflo failed make xhproflo Error On further investing I found that with php in structure zendexecutedata have zendclassentry calledscope which is not present in php So is there any way to build xhprof with php One solution is downgrade php to which is not possible So please help me out in this 