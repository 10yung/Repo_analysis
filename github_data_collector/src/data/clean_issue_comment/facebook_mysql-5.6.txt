In cases when Facebook MySQL Server is compiled from a source tree that was not retrieved from git or just does not have the git directory MYSQLGITHASH and MYSQLGITDATE CMake options can be defined to skip some calls to git executable that identifies current revision This used to work fine until RocksDB storage engine code was merged Now git executable is unconditionally executed to determine revision of the rocksdb submodule Fixed by passing rocksdbgithashROCKSDBGITHASH and rocksdbgitdateROCKSDBGITDATE to githashpl script as in Reference patch facebookmysql c ced Summary The COMRESETCONNECTION command is not currently respecting the CLIENTINTERACTIVE flag The CLIENTINTERACTIVE flag is tied to the connection rather than the session When COMRESETCONNECTION resets session state its expected that waittimeout will be set to interactivetimeout when CLIENTINTERACTIVE is set Reference Patch facebookmysql de b Originally Reviewed By jkedgar porting notes The init call in the THD constructor is delayed until client capabilities are set Summary mrriter must be initialized before using in skiprecord scenario otherwise mysqld will crash during bkarangeseqskiprecord point to a null call stack bkarangeseqskiprecord myrocksharocksdbmultirangereadnext JOINCACHEBKAjoinmatchingrecords JOINCACHEjoinrecords Test Plan MTR Reviewers Subscribers Tasks Tags Summary Fix If the following sequence of events happen then binlog trimming will leave some extraneous gtid in the binlog Binlog file is rotated A few transactions successfully flushes to binlog file but not yet commited to engine mysqld crashes On crash recovery engine will point to the position in the old binlog file Which means extraneous trxs in the current binlog file will not be trimmed and gtidexecuted will contain these trxs This is not an ideal scenario The diff fixes it by taking into account the file name stored in engine and the current binlog file name being recovered If both file names are the same then trimming is based solely on the position If file names are different and the file stored in engine is older as noticed by the index of the file name then we trim the current binlog file to the begining position of the first gtid event ie all transactions in the current binlog file are trimmed Note that this does not handle the case of file names wrapping around and this can be a rare scenario which can be fixed by instance replacements Fix Binlog rotation is considered a sync point for existing transactions to flush This is achieved by making binlog rotation block until all prepared transactions are committed However the trxs that do not generate XID are not considered prepared and hence binlog rotation is not blocked by such transactionsThis could cause some extraneous GTID to be present in a previously rotated binlog file which never got committed This diff fixes the problem by making binlog rotation to block on transactions without xid Reference Patch Originally Reviewed By abhinav sharma fbshipitsourceid c d f introduced changes that require newer versions of liblz and libzstd This causes compilation errors with older libs eg for Ubuntu Bionic which has liblz dev and libzstddev More information at This patch solves the issues with the following changes Check minimal required version of liblz and libzstd Update bundled liblz to Add bundled libzstd Summary The time information from show processlist and in informationschemaprocesslist is at the granularity of a second This diff provides an override system variable to display the time at the granularity of a microsecond eg The variable is session settable Reference patch fbshipitsourceid d e e TO DO Please rerecord mysqltesttallpersistedvariablestest with let totalpersistentvarsXXX a new variable Summary Change the buffer size to M so it can show the full stats fbshipitsourceid d dca b Summary The innodbstatsonmetadata is not correct for partitioned tables For partitioned tables the infoHASTATUSCONST call is only done on the largest partition while for most other flags including HASTATUSVARIABLE the call is done for all partitions in a loop The issue is that innodbstatsonmetadata implicitly converts infoHASTATUSVARIABLE calls into infoHASTATUSVARIABLE HASTATUSCONST calls Since this is done in a loop it means that were calculating index stats for just the last partition giving inaccurate statistics Theres no good way to fix it because we either need InnoDB to understand partitions or ther other way around The latter approach was chosen so innodbstatsonmetadata is made a server session variable and hapartition will do the correct thing if it detects the variable is on and InnoDB tables are used Because MySQL has native partitions this is a not an issue there as the native partition code has access to both the innodbstatsonmetadata variable and the algorithm for processing info for partitioned tables Originally Reviewed By luqun fbshipitsourceid cfdeefcf ae porting notes As said earlier in the original description InnoDB in has native partitions As only the largest partition is used for the recperkey calculation the issue is already resolved in the branch Summary Since it may take some time for smc for propagate new master info people use readonlymsgextra to get new master info from old master However we still have a check for active master info in mysqld And update active master info may take a few seconds This might cause a downtime even a new master is kind of ready Current promotemaster command can specifically set new master info during the promotion Its actually fine to skip the active master info check For compatibility lets add a new sys var to pass the active master info check now Reference Patch Originally Reviewed By yoshinorim fbshipitsourceid b e TO DO Please rerecord mysqltesttallpersistedvariablestest with let totalpersistentvarsXXX a new variable Summary If opttrimbinlog is set then mysqld could trim the latest binlog file to match the enginecommited position This diff makes mysqld copy the binlog file to tmpdir as set in sysvar tmpdir for debugging and safety purpose Reference Patch Originally Reviewed By yoshinorim fbshipitsourceid c d 