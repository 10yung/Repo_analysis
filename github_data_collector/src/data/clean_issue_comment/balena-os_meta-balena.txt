Fixes Changetype patch Changelogentry Improve systemd service restart policy for some services Signedoffby Zubair Lutfullah Kakakhel zubairbalenaio Contributor checklist For completed items change to x Changes have been tested x Changetype present on at least one commit x Signedoffby is present x The PR complies with the Open Embedded Commit Patch Message Guidelines optional Changelogentry present on at least one commit if you want to set the changelog entry manually Reviewer Guidelines When submitting a review please pick Approve if this change would be acceptable in the codebase even if there are minor or cosmetic tweaks that could be improved Request Changes if this change would not be acceptable in our codebase eg bugs changes that will make development harder in future securityperformance issues etc Comment if you dont feel you have enough information to decide either way eg if you have major questions or you dont understand the context of the change sufficiently to fully review yourself but want to make a comment rootbalena systemctl show osconfigdev grep Restart Restartno This is to improve overall robustness Will catch cases like the ones addressed by this PR osconfigdevicekey failed and crashed with a panic as it didnt correctly block on a getrandom call No random no key no connected device on pi w Contributor checklist For completed items change to x x Changes have been tested x Changetype present on at least one commit x Signedoffby is present x The PR complies with the Open Embedded Commit Patch Message Guidelines optional Changelogentry present on at least one commit if you want to set the changelog entry manually Reviewer Guidelines When submitting a review please pick Approve if this change would be acceptable in the codebase even if there are minor or cosmetic tweaks that could be improved Request Changes if this change would not be acceptable in our codebase eg bugs changes that will make development harder in future securityperformance issues etc Comment if you dont feel you have enough information to decide either way eg if you have major questions or you dont understand the context of the change sufficiently to fully review yourself but want to make a comment HUPed an RPI from v rev to rev root d b hostappupdate i resinresinosstaging rev raspberrypi INFO Checking if boot partition can accommodate the new update success INFO Deploying mntbootsplashresinlogopngfile blacklisted Ignoring A solution needs to be adopted to replace the old resin logo with the new balena one only if it has not been replaced by the customer with his own company or product image This will allow the supervisor to do interesting things like disable splash screen serial getty ModemManager Has boot time implications baseline memory usage implications overall a nice feature Needs thinking about how to architect it Some discussion Discussion There should be an easily implementable way to capture good triggers of reboot reboot command is the same as systemctl reboot which is what the supervisor triggers via dbus when clicking reboot via dashboard root fc ls al sbinreboot lrwxrwxrwx root root Nov sbinreboot binsystemctl root fc All these ask systemd to change the state of the OS from its current taget multiusertarget into reboottarget or shutdownpowerofftarget We can have a service that triggers as soon as a request to enter reboottarget comes That can curl the api and say im rebootingpowering off eg This is not the same as knowing exactly what caused the reboot But this is a low hanging fruit that definitely improves the overall experience compared to what we have now figuring out exactly what caused the reboot can be step Both the metabalenagenericx and metabalenaraspberrypi apply a patch that avoids a coredump for bits platforms This should be moved to metabalena does this on boot we should do it periodically instead perhaps something like once a day should be fine The metabalenaraspberrypi integration layer increases the default initramfs size in To avoid this change spreading across integration layers move it to metabalena