condvarnotifyone is called without holding the tail mutex causing the notification to be lost and leaving the sender waiting This is a partial fix for Motivation now the example echo cannot run with cargo cargo run example echo will stop with error bash error cargo run can run at most one executable but multiple were specified and there are two echo target in the example list examplesechors tokiotlsexamplesechors bash cargo run example error example takes one argument Available examples chat connect downloadrustlang echo echo echoudp helloworld printeachpacket proxy tinydb tinyhttp udpclient udpcodec Solution rename tokiotlsexamplesechors to tokiotlsexamplestlsechors Version tokio Platform All platforms Description It looks like tokiosyncboardcastRecvError and tokiosyncboardcastSendError dont implement stdformatError I feel like this is a potential oversight what would be the best way to have this rectified Motivation As discussed on discord with interest and suggestions on how to proceed from Carl The parkinglot crates Mutex and Condvar still best libstd in benchmarks From Amanieuparkinglot and linked rustlang PR it does not appear AFAICT that replacing libstds current implementations with parkinglot inspired types is particularly close to being accepted When that does happen and in MSRV this PR should be easy enough to revert So far I havent found a case in the current codebase where tokio attempts to recover from a poisoned Mutex Since parkinglot doesnt poison this could possibly mean less panics in some heretofore unknown edgecase OK thats a bit hypothetical Solution To help simplify working with both primitive APIs I added an IdentityUnwrap extension trait for parkinglots MutexGuard That handles the simple acquire lock with unwrap case see above note on poisoning For Condvar the API differences are a bit more significant so its so far done as a combination of feature gated code blocks and some creative use of match TODO This will start as just a draft proof of concept eg rather unlikely to pass CI on first go but I would appreciate any feedback on the approach before polishing it further Not all references to Mutex and Condvar in the tree go through the loom module It may or may not make sense to replace all of these cases including in tests txt git grep n E useMutex grep v loom grep v tokiosync grep v srcloom srcprocessunixorphanrs use stdsyncMutex srcsignalregistryrs use stdsyncMutex srcsyncbarrierrs use stdsyncMutex srcsyncmodrs pub use mutexMutex MutexGuard srcsyncwatchrs use stdsyncArc Mutex RwLock RwLockReadGuard Weak srctaskerrorrs use stdsyncMutex srctestsloomschedulers use stdsyncMutex srctestsmockschedulers use stdsyncMutex srctimeclockrs use stdsyncArc Mutex testsfsdirrs use stdsyncArc Mutex testsiodriverrs use stdsyncmpsc Arc Mutex testssupportmockfilers use stdsyncArc Mutex Im also wondering if for convenience and hygiene there should be some more top level preludelike import path for these types not going through loom For example rust use tokiosyncro This way Id introduce fewer import lines not needing to conditionally import IdentityUnwrap which without parkinglot becomes an unused warning Thoughts Motivation Based on a URLO thread and discord conversation with hawkw and Matthias I learned a great deal about what tokiotaskyieldnow does noticing that the rustdoc for that method can be improved Solution rustdoco impl AsyncRead for RedisTcpStream unsafe fn prepareuninitializedbuffer self mut MaybeUninitu bool false fn pollread self Pin mut Self cx mut ContextA buf mut u PollioResultusize tokio srcnettcpstream pollreadpriv function must make to pub selfsocketlockunwrappollreadprivcx buf impl AsyncWrite for RedisTcpStream fn pollwrite self Pin mut Self cx mut ContextA buf u PollioResultusize tokio srcnettcpstream pollwritepriv function must make to pub selfsocketlockunwrappollwriteprivcx buf fn pollwritebufB Buf self Pin mut Self cx mut ContextA buf mut B PollioResultusize tokio srcnettcpstream pollwritebufpriv function must make to pub selfsocketlockunwrappollwritebufprivcx buf Thank you for your Pull Request Please provide a description above and review the requirements below Bug fixes and new features should include tests Contributors guide Motivation Currently its not possible to configure the buffer size when creating a BufStream Im using BufStream to wrap a TcpStream and having totokioiosplit it and pass each half to BufReaderwithcapacity and BufWriterwithcapacity seems suboptimal Solution This PR adds a BufStreamwithcapacity method that takes as input both the capacity of the read buffer and the capacity of the write buffer Not sure if this is the best API but it seemed more flexible than having a single capacity as input API docs are out of sync right now with website API docs have been fixed but website has broken links and out of date content See for a stopgap fix of the website and Version Description At minimum we should have a note in the code here for docs that are duplicated on the website Ideally the website would pull content from the API docs and maybe some of the narrative docs which are getting very long should be migrated to the website It would be good to keep the jumping backandforth and cross linking to a minimum It would be awesome to have an autogenerated list of links to API docs referenced in the guides and create some kind of build errors when they get out of sync We might even consider having the guides in this repo to make it easier to keep them in sync and then CI with doc tests would enforce updating examples whenever APIs changes Version tokio Description I am having some issues trying to use syncbroadcast Sometimes I receive lagged with a wrapped around value near followed shortly after by closed even though there are still senders Related to this I also got this panic calling syncbroadcastReceiverrecv thread tokioruntimeworker panicked at attempt to add with overflow bazelredactedpwdexternalrazetokio srcsyncbroadcastrs stack backtrace thread tokioruntimeworker panicked at attempt to add with overflow bazelredactedpwdexternalrazetokio srcsyncbroadcastrs x baa b backtracebacktracelibunwindtraceh d cb b at cargoregistrysrcgithubcom ecc db ec backtrace srcbacktracelibunwindrs x baa b backtracebacktracetraceunsynchronizedhd f d ec a at cargoregistrysrcgithubcom ecc db ec backtrace srcbacktracemodrs x baa b stdsyscommonbacktraceprintfmth a b c at srclibstdsyscommonbacktracers x baa b stdsyscommonbacktraceprintDisplayBacktrace as corefmtDisplayfmth df d f at srclibstdsyscommonbacktracers x baa a ffc corefmtwriteh f f eb c at srclibcorefmtmodrs x baa a stdioWritewritefmth d ef at srclibstdiomodrs x baa d e stdsyscommonbacktraceprinth a df fa d af at srclibstdsyscommonbacktracers x baa d e stdsyscommonbacktraceprinth f b e at srclibstdsyscommonbacktracers x baa d e stdpanickingdefaulthookclosureh d a bd dd at srclibstdpanickingrs x baa d stdpanickingdefaulthookh d a aecb efac at srclibstdpanickingrs x baa dc b stdpanickingrustpanicwithhookhbe a d at srclibstdpanickingrs x baa d e stdpanickingcontinuepanicfmth d dad accf at srclibstdpanickingrs x baa d f rustbeginunwind at srclibstdpanickingrs x baa a be corepanickingpanicfmthdeb ab at srclibcorepanickingrs x baa a a corepanickingpanichb daa c c fc at srclibcorepanickingrs x baa acf d tokiosyncbroadcastSlotTtryrxlockhec b c bb at bazelredactedpwdexternalrazetokio srcsyncbroadcastrs x baa ad a tokiosyncbroadcastReceiverTrecvrefh b c eba at bazelredactedpwdexternalrazetokio srcsyncbroadcastrs x baa ad e tokiosyncbroadcastReceiverTtryrecvhcd e f at bazelredactedpwdexternalrazetokio srcsyncbroadcastrs x baa ad e tokiosyncbroadcastReceiverTpollrecvhff e a d e at bazelredactedpwdexternalrazetokio srcsyncbroadcastrs x baa ad b tokiosyncbroadcastReceiverTrecvclosureclosurehc ae c e a at bazelredactedpwdexternalrazetokio srcsyncbroadcastrs x baa b tokiofuturepollfnPollFnF as corefuturefutureFuturepollhfe e bf a at bazelredactedpwdexternalrazetokio srcfuturepollfnrs x baa aab stdfuturepollwithtlscontextclosurehe e cb f d at rustc e aae f a ffa a ac f c cf srclibstdfuturers x baa aa c stdfuturegettaskcontexthacb e fe c at rustc e aae f a ffa a ac f c cf srclibstdfuturers x baa aaa stdfuturepollwithtlscontexth b f e a a at rustc e aae f a ffa a ac f c cf srclibstdfuturers x baa ad a tokiosyncbroadcastReceiverTrecvclosureha a a da c at bazelredactedpwdexternalrazetokio srcsyncbroadcastrs x baa abbfd stdfutureGenFutureT as corefuturefutureFuturepollclosureh c b b c at rustc e aae f a ffa a ac f c cf srclibstdfuturers x baa aa f stdfuturesettaskcontexth ba e ec at rustc e aae f a ffa a ac f c cf srclibstdfuturers x baa ab c stdfutureGenFutureT as corefuturefutureFuturepollh edae df at rustc e aae f a ffa a ac f c cf srclibstdfuturers x baa aaaed stdfuturepollwithtlscontextclosurehb e aedee f at rustc e aae f a ffa a ac f c cf srclibstdfuturers x baa aa stdfuturegettaskcontexthbd c f f a at rustc e aae f a ffa a ac f c cf srclibstdfuturers x baa aaa f stdfuturepollwithtlscontexth a eb a d at rustc e aae f a ffa a ac f c cf srclibstdfuturers x baa c imagemuxseriesSeriesSenderrunclosureh a bfdb d af f at daqimagemuxsrcseriesrs x baa abd c stdfutureGenFutureT as corefuturefutureFuturepollclosurehfc d aba b at rustc e aae f a ffa a ac f c cf srclibstdfuturers x baa aa ed stdfuturesettaskcontexth f e e ceca ab at rustc e aae f a ffa a ac f c cf srclibstdfuturers x baa ab stdfutureGenFutureT as corefuturefutureFuturepollh a e f at rustc e aae f a ffa a ac f c cf srclibstdfuturers x baa aaabce stdfuturepollwithtlscontextclosureh fe fa c at rustc e aae f a ffa a ac f c cf srclibstdfuturers x baa aa stdfuturegettaskcontexth ec e c c at rustc e aae f a ffa a ac f c cf srclibstdfuturers x baa aaa ae stdfuturepollwithtlscontexth dcc b ac e at rustc e aae f a ffa a ac f c cf srclibstdfuturers x baa bf imagemuxServicenewclosureh bf d a at daqimagemuxsrclibrs x baa aba b stdfutureGenFutureT as corefuturefutureFuturepollclosureh f b cfe at rustc e aae f a ffa a ac f c cf srclibstdfuturers x baa aa c stdfuturesettaskcontexthcfadf d e e be at rustc e aae f a ffa a ac f c cf srclibstdfuturers x baa ab stdfutureGenFutureT as corefuturefutureFuturepollh d ebb f at rustc e aae f a ffa a ac f c cf srclibstdfuturers x baa ab tokiotaskcoreCoreTpollhc f b c e at bazelredactedpwdexternalrazetokio srctaskcorers x baa c da tokiotaskharnessHarnessTSpollclosureclosureha b a c at bazelredactedpwdexternalrazetokio srctaskharnessrs x baa b fa c coreopsfunctionFnOncecallonceh d c c a at rustc e aae f a ffa a ac f c cf srclibcoreopsfunctionrs x baa c d e stdpanicAssertUnwindSafeF as coreopsfunctionFnOncecallonceh d f af at rustc e aae f a ffa a ac f c cf srclibstdpanicrs x baa b da stdpanickingtrydocallh cd d d add d at rustc e aae f a ffa a ac f c cf srclibstdpanickingrs x baa f a rustmaybecatchpanic at srclibpanicunwindlibrs x baa b d b stdpanickingtryh b be b e b at rustc e aae f a ffa a ac f c cf srclibstdpanickingrs x baa c c stdpaniccatchunwindh cf f f be at rustc e aae f a ffa a ac f c cf srclibstdpanicrs x baa c d tokiotaskharnessHarnessTSpollclosurehed a db e cc c at bazelredactedpwdexternalrazetokio srctaskharnessrs x baa be f tokioloomstdcausalcellCausalCellTwithmuth aaae d e at bazelredactedpwdexternalrazetokio srcloomstdcausalcellrs x baa c c tokiotaskharnessHarnessTSpollhe df b fe f at bazelredactedpwdexternalrazetokio srctaskharnessrs x baa c tokiotaskrawpollhec a dc da b at bazelredactedpwdexternalrazetokio srctaskrawrs x baa e tokiotaskrawRawTaskpollh c f b c a at externalrazetokio srctaskrawrs x baa e c fc tokiotaskTaskSrunhfb d f dac a at externalrazetokio srctaskmodrs x baa e fb tokioruntimethreadpoolworkerGenerationGuardruntaskh fe fd bd a at externalrazetokio srcruntimethreadpoolworkerrs x baa e f tokioruntimethreadpoolworkerGenerationGuardprocessavailableworkh ecc dddb ab c at externalrazetokio srcruntimethreadpoolworkerrs x baa e ef tokioruntimethreadpoolworkerGenerationGuardrunhca b fadcfd ed at externalrazetokio srcruntimethreadpoolworkerrs x baa e ea tokioruntimethreadpoolworkerWorkerrunclosureclosureh fc f bb ae at externalrazetokio srcruntimethreadpoolworkerrs x baa e c b stdthreadlocalLocalKeyTtrywithh ceb b f at rustc e aae f a ffa a ac f c cf srclibstdthreadlocalrs x baa e stdthreadlocalLocalKeyTwithh cf a b d c at rustc e aae f a ffa a ac f c cf srclibstdthreadlocalrs x baa e eb e tokioruntimethreadpoolworkerWorkerrunclosureh e f e a f at externalrazetokio srcruntimethreadpoolworkerrs x baa e c c tokioruntimethreadpoolcurrentsetclosureh b cc a a at externalrazetokio srcruntimethreadpoolcurrentrs x baa e stdthreadlocalLocalKeyTtrywithh b cddf at rustc e aae f a ffa a ac f c cf srclibstdthreadlocalrs x baa e dc stdthreadlocalLocalKeyTwithh ea bea fcafacd at rustc e aae f a ffa a ac f c cf srclibstdthreadlocalrs x baa e b tokioruntimethreadpoolcurrentseth a b at externalrazetokio srcruntimethreadpoolcurrentrs x baa e e c tokioruntimethreadpoolworkerWorkerrunhea c e e e at externalrazetokio srcruntimethreadpoolworkerrs x baa e eee tokioruntimethreadpoolworkerWorkerblockinplaceclosurehf bde c c b at externalrazetokio srcruntimethreadpoolworkerrs x baa e a a tokioruntimeblockingtaskBlockingTaskT as corefuturefutureFuturepollhedd e c at externalrazetokio srcruntimeblockingtaskrs x baa e cb tokiotaskcoreCoreTpollh f bdba e at externalrazetokio srctaskcorers x baa eaf c tokiotaskharnessHarnessTSpollclosureclosureh d c ca dac at externalrazetokio srctaskharnessrs x baa e f coreopsfunctionFnOncecalloncehe c a d c d at rustc e aae f a ffa a ac f c cf srclibcoreopsfunctionrs x baa e e stdpanicAssertUnwindSafeF as coreopsfunctionFnOncecalloncehb f eb f f at rustc e aae f a ffa a ac f c cf srclibstdpanicrs x baa e d stdpanickingtrydocallh f cb e ff at rustc e aae f a ffa a ac f c cf srclibstdpanickingrs x baa f a rustmaybecatchpanic at srclibpanicunwindlibrs x baa e d d stdpanickingtryhb da c at rustc e aae f a ffa a ac f c cf srclibstdpanickingrs x baa e b stdpaniccatchunwindh c bd a at rustc e aae f a ffa a ac f c cf srclibstdpanicrs x baa eaf tokiotaskharnessHarnessTSpollclosureh ac c bb dfd at externalrazetokio srctaskharnessrs x baa e f f tokioloomstdcausalcellCausalCellTwithmuth eb ce f d at externalrazetokio srcloomstdcausalcellrs x baa eae tokiotaskharnessHarnessTSpollh d a eb at externalrazetokio srctaskharnessrs x baa e ae tokiotaskrawpollhc d e ae at externalrazetokio srctaskrawrs x baa e tokiotaskrawRawTaskpollh c f b c a at externalrazetokio srctaskrawrs x baa e c c tokiotaskTaskSrunh eb c b b at externalrazetokio srctaskmodrs x baa e d tokioruntimeblockingpoolruntaskhd b fa ee at externalrazetokio srcruntimeblockingpoolrs x baa e tokioruntimeblockingpoolInnerrunhfa fe beb at externalrazetokio srcruntimeblockingpoolrs x baa e e tokioruntimeblockingpoolSpawnerspawnthreadclosureclosurehe b d d at externalrazetokio srcruntimeblockingpoolrs x baa e d a tokioruntimecontextenterh edf f ec d a at externalrazetokio srcruntimecontextrs x baa e db tokioruntimehandleHandleenterheec ffe c c c at externalrazetokio srcruntimehandlers x baa e tokioruntimeblockingpoolSpawnerspawnthreadclosureh f bfa d fa at externalrazetokio srcruntimeblockingpoolrs x baa e cba stdsyscommonbacktracerustbeginshortbacktraceh c e c cfe c at rustc e aae f a ffa a ac f c cf srclibstdsyscommonbacktracers x baa e a c stdthreadBuilderspawnuncheckedclosureclosurehdde a c d at rustc e aae f a ffa a ac f c cf srclibstdthreadmodrs x baa e f stdpanicAssertUnwindSafeF as coreopsfunctionFnOncecallonceh e c fc d at rustc e aae f a ffa a ac f c cf srclibstdpanicrs x baa e d ce stdpanickingtrydocallha aa e f at rustc e aae f a ffa a ac f c cf srclibstdpanickingrs x baa f a rustmaybecatchpanic at srclibpanicunwindlibrs x baa e cc stdpanickingtryh d e d ea a at rustc e aae f a ffa a ac f c cf srclibstdpanickingrs x baa e af stdpaniccatchunwindh a a a at rustc e aae f a ffa a ac f c cf srclibstdpanicrs x baa e a b stdthreadBuilderspawnuncheckedclosureh a a ef at rustc e aae f a ffa a ac f c cf srclibstdthreadmodrs x baa e coreopsfunctionFnOncecalloncevtableshimh dafab bcc at rustc e aae f a ffa a ac f c cf srclibcoreopsfunctionrs x baa def allocboxedBoxF as coreopsfunctionFnOnceAcallonceh c b c at rustc e aae f a ffa a ac f c cf srcliballocboxedrs x baa c allocboxedBoxF as coreopsfunctionFnOnceAcallonceh c a ece at rustc e aae f a ffa a ac f c cf srcliballocboxedrs x baa c stdsyscommonthreadstartthreadh ac d d d at srclibstdsyscommonthreadrs x baa c stdsysunixthreadThreadnewthreadstarth c ef f c at srclibstdsysunixthreadrs x ff f a aa startthread x ff f ba f clone x unknown 