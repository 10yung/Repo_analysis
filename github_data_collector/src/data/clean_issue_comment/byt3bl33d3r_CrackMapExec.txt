 Steps to reproduce Running a PowerShell command on both Windows and Windows Command string used crackmapexec smb u admin H hash omitted execmethod wmiexec X echo PowerShell test CME verbose output using the verbose flag DEBUG domain None wdigest None verbose True sam False credid moduleoptions faillimit None share C lusers False module None smbport showoptions False ridbrute None uac False ufaillimit None passpol False regex None listmodules False nooutput False pattern None lsa False forceps False shares False content False serverhost wmi None excludedirs serverport None wminamespace rootcimv gfaillimit None mssqlquery None username admin hash hash omitted users False sessions False execmethod wmiexec spider None psexecute echo PowerShell test threads mssqlport password mssql False mssqlauth windows ntdspwdLastSet False execute None target ntdshistory False disks False ntds None server https depth localauth False timeout CME LIB Windows Build nameLIB domainWORKGROUP CME LIB WORKGROUP admin hash omitted Pwn d DEBUG Unincoded command NetServicePointManager ServerCertificateValidationCallback true try Ref AssemblyGetTypeSystemManagementAutomationAmsiUtilsGetFieldamsiInitFailed NonPublicStaticSetValuenull true catch echo PowerShell test DEBUG Target system is and isFDQN is False DEBUG StringBinding LIB PIPE atsvc DEBUG StringBinding LIB DEBUG StringBinding LIB PIPE srvsvc DEBUG StringBinding LIB PIPE browser DEBUG StringBinding chosen None DEBUG Error executing command via wmiexec traceback DEBUG Traceback most recent call last File usrlibpython distpackagescmeconnectionpy line in execute execmethod WMIEXECselfhost selfusername selfpassword selfdomain selfconn selfhash selfargsshare File usrlibpython distpackagescmeexecmethodswmiexecpy line in init iWbemServices iWbemLevel LoginNTLMLoginrootcimv NULL NULL File buildbdistlinuxarmv leggimpacketdcerpcv dcomwmipy line in NTLMLogin resp selfrequestrequest iid selfiid uuid selfgetiPid File buildbdistlinuxarmv leggimpacketdcerpcv dcomrtpy line in request selfconnectiid File buildbdistlinuxarmv leggimpacketdcerpcv dcomrtpy line in connect raise ExceptionCan t find a valid stringBinding to connect Exception Cant find a valid stringBinding to connect Traceback most recent call last File srcgeventgreenletpy line in geventgreenletGreenletrun File usrlibpython distpackagescmeconnectionpy line in init getattrself k File usrlibpython distpackagescmeconnectionpy line in decorator return funcself args kwargs File usrlibpython distpackagescmeconnectionpy line in psexecute return selfexecutecreatepscommandpayload getoutput methods File usrlibpython distpackagescmeconnectionpy line in decorator return funcself args kwargs File usrlibpython distpackagescmeconnectionpy line in execute output uformatexecmethodexecutepayload getoutputstripdecodeutf UnboundLocalError local variable execmethod referenced before assignment T Z Greenlet at x e ConnectionNamespacecontentFalse credid depth dis cmedatabaseCMEDatabase instance at x fb None None failed with UnboundLocalError KTHXBYE CME Version cme version both Smidge and dev Bug Pr n OS kalirolling on a Raspberry Pi Target OS Both Windows and Windows produce the same issue Detailed issue explanation For some reason when attempting to run any PowerShell commands Ive found that both Windows and Windows machines give this output Ive tried running the command on a Windows Server machine on the same network and it executed fine I cant seem to determine the problem Does anyone here have any ideas The logger tell you LSA secrets are dump in a file named xxxlsa SMB xxxx host Dumped LSA secrets to homenorajcmelogshostxxxx lsa and homenorajcmelogshostxxxx cached But in reality they are logged in xxxscrets So just fixing the extension showed by the logger Traceback most recent call last File usrlibpython distpackagespkgresourcesinitpy line in buildmaster wsrequirerequires File usrlibpython distpackagespkgresourcesinitpy line in require needed selfresolveparserequirementsrequirements File usrlibpython distpackagespkgresourcesinitpy line in resolve raise VersionConflictdist reqwithcontextdependentreq pkgresourcesVersionConflict crackmapexec dev usrlocallibpython distpackagescrackmapexec dev py egg Requirementparsecrackmapexec During handling of the above exception another exception occurred installing CME on Kali by aptget install Traceback most recent call last File usrbincrackmapexec line in module from pkgresources import loadentrypoint File usrlibpython distpackagespkgresourcesinitpy line in module callaside File usrlibpython distpackagespkgresourcesinitpy line in callaside fargs kwargs File usrlibpython distpackagespkgresourcesinitpy line in initializemasterworkingset workingset WorkingSetbuildmaster File usrlibpython distpackagespkgresourcesinitpy line in buildmaster return clsbuildfromrequirementsrequires File usrlibpython distpackagespkgresourcesinitpy line in buildfromrequirements dists wsresolvereqs Environment File usrlibpython distpackagespkgresourcesinitpy line in resolve raise DistributionNotFoundreq requirers pkgresourcesDistributionNotFound The crackmapexec distribution was not found and is required by the application IF install pip install crackmapexec it installs the version pip install crackmapexec can not find a package This PR adds initial support for SSH keyfile authentication It also fixes an OpSec issue with the default paramiko behavior of trying all keys loaded in sshagent and all keys in ssh by disallowing agent and key discovery I marked the PR as a work in progress because currently there is no keyfile support for the credential database but it would probably be nice to have CME copy the key to the database and allow keyfile identities to be used as credentials Let me know what you think Cheers Alex Added the DNS full domain name to the hosts SMB result This will be used later when a full domain name is necessary in order to proceed delDont merge anything yet this PR is just here to keep you informate of the progressdel Progression x shares x sessions x disks x loggedonusers x users x ridbrute x groups x localgroups x passpol local x passpol domain x x whoami x X PSVersionTable x sam x H ntlmhash x u usertxt p passwordtxt x genrelaylist x d domainlocal x localauth x lsa x ntds x delntdshistorydel option already deprecated in CME v python x delntdspwdLastSedel option already deprecated in CME v python x wmi execmethod smbexec not working but I got same result on CME v python x execmethod atexec x execmethod wmiexec x nooutput x cmedb x spider error from impacket lib issue delopendel fixed x module Mimikatz x module Bloodhound Modules modules based on Empire project should be removed since the Empire project is dead and dev in python I didnt test them hope it makes sense x migrate pywerview to python x pull request to pywerview repo waiting for the merge delSo far I migrate the wmiexecpy file and lot of other stuff just to test how hard it will be to migrate del I will continue the work over this week How to use this PR with pipenv git clone recursive cd CrackMapExec git checkout python git submodule update recursive pipenv python install pipenv shell python setuppy install cme On latest Kali git clone recursive cd CrackMapExec git checkout python git submodule update recursive python setuppy install cme Couple of things byt bl d r wants to take care of before merging this Get rid of all of the submodules This also would mean getting Pywerview on Pypi Replace Gevent with Asyncio Package CME as a Zipapp with Shiv so people dont have to worry about installing cme in a virtualenv anymore Steps to reproduce OS Kali python Target OS in the output tried to reinstall have all requirments crackmapexec smb u SVCTGS p somepasshere M gpppassword verbose DEBUG domain None wdigest None verbose True sam False credid moduleoptions faillimit None share C lusers False module gpppassword smbport showoptions False ridbrute None uac False ufaillimit None passpol False regex None listmodules False nooutput False pattern None lsa False forceps False shares False content False serverhost wmi None excludedirs serverport None wminamespace rootcimv gfaillimit None mssqlquery None username SVCTGS hash users False sessions False execmethod None spider None psexecute None threads mssqlport password GPPstillStandingStrong k mssql False mssqlauth windows ntdspwdLastSet False execute None target smb ntdshistory False disks False ntds None server https depth localauth False timeout CME DC Windows Build nameDC domainACTIVE Segmentation fault Steps to reproduce cme smb dc stormctf u userstxt p welcome continueonsuccess Id post the output but its of a clients network continueonsuccess has never worked for me but I could really use it Steps to reproduce Ran the command against DC After dumping few hashes it throws this error message Command string used crackmapexec u username p Pssword d COMPANYDOMAIN ntds vss CME verbose output using the verbose flag DEBUG Trying to fetch page x f DEBUG Multivalue detected in column ATTc returning raw results DEBUG Multivalue detected in column ATTc returning raw results DEBUG Multivalue detected in column ATTc returning raw results DEBUG Multivalue detected in column ATTc returning raw results DEBUG Multivalue detected in column ATTc returning raw results DEBUG Trying to fetch page x f DEBUG Multivalue detected in column ATTc returning raw results DEBUG Decrypting hash for user ABCD CME ABCD companydomaincom abcd aad b b eeaad b b ee a dab c c bb bd DEBUG Multivalue detected in column ATTc returning raw results DEBUG Multivalue detected in column ATTc returning raw results DEBUG Multivalue detected in column ATTc returning raw results DEBUG Multivalue detected in column ATTc returning raw results DEBUG Cleaning up DEBUG Stopping service RemoteRegistry Traceback most recent call last File srcgeventgreenletpy line in geventgreenletGreenletrun File usrlibpython distpackagescmeconnectionpy line in init getattrself k File usrlibpython distpackagescmeconnectionpy line in decorator return funcself args kwargs File usrlibpython distpackagescmeconnectionpy line in ntds DumpSecretsselfNTDSdumpselfargsntds selfargsntdspwdLastSet selfargsntdshistory File usrlibpython distpackagescmecredentialssecretsdumppy line in NTDSdump selfcleanup File usrlibpython distpackagescmecredentialssecretsdumppy line in cleanup selfremoteOpsfinish File usrlibpython distpackagescmeremoteoperationspy line in finish selfrestore File usrlibpython distpackagescmeremoteoperationspy line in restore scmrhRControlServiceselfscmr selfserviceHandle scmrSERVICECONTROLSTOP File usrlibpython distpackagesimpacketdcerpcv scmrpy line in hRControlService return dcerequestrequest File usrlibpython distpackagesimpacketdcerpcv rpcrtpy line in request raise exception DCERPCSessionError SCMR SessionError code x b ERRORDEPENDENTSERVICESRUNNING A stop control has been sent to a service that other running services are dependent on T Z Greenlet Greenlet at x f f dfaf ConnectionNamespacecontentFalse credid depth dis cmedatabaseCMEDatabase instance at x f f bad None None failed with DCERPCSessionError CME Version cme version rootkali crackmapexec v Smidge OS Kali Linux Target OS Windows Build Windows Server R Detailed issue explanation See above Getting the below issue where it looks like the I can connect and and authenticate but dont get a return back Also i dont get the pwd thing eitherversion or does the same thing Oddly if i run a passpol i get info back crackmapexec smb u user p pasword execmethod wmiexec x dir CME xxxx WINH J OM BIU Windows Build nameWINH J OM BIU domainWINH J OM BIU CME xxxx WINH J OM BIU WINH J OM BIU userpassword CME WINH J OM BIU Enumerating active sessions KTHXBYE but i get nothing back 