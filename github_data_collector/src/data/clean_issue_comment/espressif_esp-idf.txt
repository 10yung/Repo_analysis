void spisendbytesttsuint t data uint t len SPI spitransactiont t if len return no need to send anything memset t sizeoft Zero out the transaction trxlength tflagsSPITRANSMODEDIOQIOADDR while len if len ttxbuffer data tuser void DC needs to be set to tlength Len is in bytes transaction length is in bits tflags SPITRANSUSETXDATA spidevicequeuetransspitts tportMAXDELAY Transmit assertretESPOK Should have had no issues len data else tlength len Len is in bytes transaction length is in bits spidevicepollingtransmitspitts t Transmit assertretESPOK Should have had no issues len gpiosetlevelPINNUMDC EXITCRITICAL how can it work faster stably I was adding AVRCP absolute volume commands facing an error while trying to increase volume using absolute volume commands as passthrough volume commands are not supporter by android i was able to PLAY and PAUSE music using passthrough commands cant change volume with the same I want to increase or decrease the music volume in Phone using buttons connected to Board espavrcctsendsetabsolutevolumecmd This command should mute the sound on Phoneandroid but the following error arises W BTBTC handlercmetamsgrsp code error x Board ESP ESPIDF version Thanks Tarun Narain Environment Development Kit NA but Im using Hiletgo Module or chip used ESP WROOM S IDF version v dev gca fac Build System idfpy Compiler version xtensaesp elfgccexe crosstoolNG esp r Operating System Windows Windows only environment type PowerShell Using an IDE VSCode Power Supply USB Problem Description btcblegattcgetattrcount takes a uint t for count It in turn calls BTAGATTCGetDBSizeByType and casts as an int As an int is bits and uint is the result overwrites part of the stack by bytes This code change in fixes the issue for me diff git acomponentsbthostbluedroidbtcprofilestdgattbtcgattcc bcomponentsbthostbluedroidbtcprofilestdgattbtcgattcc index a df a a c acomponentsbthostbluedroidbtcprofilestdgattbtcgattcc bcomponentsbthostbluedroidbtcprofilestdgattbtcgattcc uint t charhandle uint t count int c count if type ESPGATTDBALL BTAGATTCGetDBSizeconnid starthandle endhandle int count BTAGATTCGetDBSizeconnid starthandle endhandle int c else BTAGATTCGetDBSizeByTypeconnid type starthandle endhandle charhandle int count BTAGATTCGetDBSizeByTypeconnid type starthandle endhandle charhandle int c count c return ESPGATTOK Expected Behavior A call to btcblegattcgetattrcount should not affect local variables Actual Behavior When I called btcblegattcgetattrcount it would overwrite a local variable on the stack Similar to the gattcmulticonnect example I would set notifyen In some cases the value would be reset to when btcblegattcgetattrcount is called Steps to reproduce Debug gattcmulticonnect into BTAGATTCGetDBSizeByType and see how the stack is overwritten Code to reproduce this issue You can use gattcmulticonnect and debug into btcblegattcgetattrcount in the case ESPGATTCREGFORNOTIFYEVT Problem Description The provided docker image contains the wrong CMake version Expected version compare Actual version compare docker run it espressifidfreleasev cmake version Expected Behavior It is expected that all provided build environments utilize the exact same tools Actual Behavior Docker container uses a version of cmake which is deviated from the given toolsjson file Steps to reproduce docker run it espressifidfreleasev cmake version Environment Module or chip used ESP WROOM D IDF version v beta g a a Build System Make Compiler version Operating System Linux Power Supply external V Problem Description Calling espmqttdestroyclient leaks a lot of memory of memory because outbox is not correctly freed The leak is generated inside outboxcleanup function which dequeues only messages that have been tagged with the pending state CONFIRMED The application wil leak an amount of bytes tied to the queued message length Expected Behavior When mqtt client is destroyed all resources allocated by the outbox should be freed Actual Behavior Steps to reproduce connect to mqtt broker publish on some topics stop mqtt client after message has been published destroy client loop Code to reproduce this issue cpp esperrt outboxcleanupoutboxhandlet outbox int maxsize outbox size is byte while outboxgetsizeoutbox maxsize THIS LINE WILL DEQUEUE ONLY MESSAGES IN CONFIRMED STATE outboxitemhandlet item outboxdequeueoutbox CONFIRMED NULL Item is always NULL if item NULL printfItem NULL LEAK r n return ESPFAIL STAILQREMOVEoutbox item outboxitem next freeitembuffer freeitem return ESPOK Debug Logs cpp DEQUEUE OUTBOX SIZE Item NULL LEAK bytes x ffdbc c allocated CPU ccount x d bb caller x x f d x e x e ad x outboxenqueue at mediapaoloDataworkingFWesp espidfcomponentsmqttespmqttlibmqttoutboxc x f d mqttenqueue at mediapaoloDataworkingFWesp espidfcomponentsmqttespmqttmqttclientc x e espmqttclientpublish at mediapaoloDataworkingFWesp espidfcomponentsmqttespmqttmqttclientc x e ad MQTTDRVPublish at mediapaoloDataworkingFWesp fwwifiesp v wifiesp prjcomponentsMqttMqttDrvc bytes x ffdc c allocated CPU ccount x d a caller x c x f d x e x e ad x c outboxenqueue at mediapaoloDataworkingFWesp espidfcomponentsmqttespmqttlibmqttoutboxc discriminator x f d mqttenqueue at mediapaoloDataworkingFWesp espidfcomponentsmqttespmqttmqttclientc x e espmqttclientpublish at mediapaoloDataworkingFWesp espidfcomponentsmqttespmqttmqttclientc x e ad MQTTDRVPublish at mediapaoloDataworkingFWesp fwwifiesp v wifiesp prjcomponentsMqttMqttDrvc bytes x ffdbcb allocated CPU ccount x b c caller x x f d x e x e ad x outboxenqueue at mediapaoloDataworkingFWesp espidfcomponentsmqttespmqttlibmqttoutboxc x f d mqttenqueue at mediapaoloDataworkingFWesp espidfcomponentsmqttespmqttmqttclientc x e espmqttclientpublish at mediapaoloDataworkingFWesp espidfcomponentsmqttespmqttmqttclientc x e ad MQTTDRVPublish at mediapaoloDataworkingFWesp fwwifiesp v wifiesp prjcomponentsMqttMqttDrvc bytes x ffdca allocated CPU ccount x ba caller x c x f d x e x e ad x c outboxenqueue at mediapaoloDataworkingFWesp espidfcomponentsmqttespmqttlibmqttoutboxc discriminator x f d mqttenqueue at mediapaoloDataworkingFWesp espidfcomponentsmqttespmqttmqttclientc x e espmqttclientpublish at mediapaoloDataworkingFWesp espidfcomponentsmqttespmqttmqttclientc x e ad MQTTDRVPublish at mediapaoloDataworkingFWesp fwwifiesp v wifiesp prjcomponentsMqttMqttDrvc bytes leaked in trace allocations total allocations total frees When library users call espstopppp it is expected that the PPP link is closed and the DCE is moved into command mode If the STOP event is not posted into the event loop then the PPP stack would not be turned off resulting in the impossibility to switch into command mode as the modem is still sending PPP binary data Signedoffby Francesco Giancane francescogiancaneaccenturecom Environment Development Kit Adafruit HUZZAH Module or chip used ESP WROOM IDF version v beta Build System CMake Compiler version Operating System Linux Using an IDE Yes Eclipse with Espressif IDF Plugins Power Supply USB Problem Description When using the spimaster driver with two devices on the same bus one halfduplex and one fullduplex the driver seems to drive the SPI device for longer than expected When sending a first transaction to the halfduplex device and then sending a second transaction to the fullduplex device the driver holds SCK low for longer than expected on the second transaction It seems like it treats the second transaction as halfduplex even though the device is configured as fullduplex To reproduce the issue no actual SPI device has to be connected to the bus since it is reproducible without any external device interaction I reported this before on the forums but got no response Expected Behavior The second transaction should be treated as a proper fullduplex one In the code below the second transaction should only last for a length of three bytes one address byte and two data bytes tlength Actual Behavior The second transaction looks like a halfduplex one In the code below it lasts for bytes One address byte two bytes of proper data and presumably the extra two bytes for the response trxlength The following shows the two transactions on the bus from the example code below on a logic analyzer esp spibug Steps to reproduce Change the TESTPIN defines in the example code below to match the board config Compile and flash the minimal example code below No actual SPI devices need to be connected to reproduce the behavior Watch the SCK and MOSI lines on the SPI bus Code to reproduce this issue Minimal example here Debug Logs I boot ESPIDF v beta dirty nd stage bootloader I boot compile time I boot Enabling RNG early entropy source I boot SPI Speed MHz I boot SPI Mode DIO I boot SPI Flash Size MB I boot Partition Table I boot Label Usage Type ST Offset Length I boot nvs WiFi data I boot phyinit RF data f I boot factory factory app I boot End of partition table I espimage segment paddr x vaddr x f size x c map I espimage segment paddr x a vaddr x ffb size x c load I espimage segment paddr x vaddr x size x load x WindowOverflow at optespidfcomponentsfreertosxtensavectorsS I espimage segment paddr x vaddr x size x e load I espimage segment paddr x vaddr x d size x map x d stext at I espimage segment paddr x vaddr x de size x aa load x de rtcclkcpufreqgetconfig at optespidfcomponentssocesp rtcclkc I boot Loaded app from partition at offset x I boot Disabling RNG early entropy source I cpustart Pro cpu up I cpustart Application information I cpustart Project name apptemplate I cpustart App version I cpustart Compile time Jan I cpustart ELF file SHA fef c db f I cpustart ESPIDF v beta dirty I cpustart Starting app cpu entry point is x a x a callstartcpu at optespidfcomponentsesp cpustartc I cpustart App cpu up I heapinit Initializing RAM available for dynamic allocation I heapinit At FFAE E len KiB DRAM I heapinit At FFB A len CF KiB DRAM I heapinit At FFE len AE KiB DIRAM I heapinit At FFE len BCB KiB DIRAM I heapinit At A len KiB IRAM I cpustart Pro cpu start user code I spiflash detected chip generic I spiflash flash io dio W spiflash Detected size k larger than the size in the binary image header k Using the size in the binary image header I cpustart Chip Revision W cpustart Chip revision is higher than the one configured in menuconfig Suggest to upgrade it I cpustart Starting scheduler on PRO CPU I cpustart Starting scheduler on APP CPU Starting in s No further logs are generated In particular there are no errors or warnings about the SPI transactions esp runs normally without error prompts However the server cannot receive the message reported by esp It is normal for the server to test with other tools Fix that the server can receive the message and can return it But it cant be displayed I wonder if there are any properties set by the esp library that caused the server to fail to display Other test tools test the server the server can display the message normally but the esp cant display it There is no error message on the ESP side The sending procedure is as follows char data int i while if espwebsocketclientisconnectedclient int len sprintfdata hello d i ESPLOGITAG Sendings data int err espwebsocketclientsendbinclient data len portMAXDELAY if err ESPFAIL printfESPFAIL r n else printflend r nerr vTaskDelay portTICKRATEMS ESP side running log is as follows W usermain Receivedkkjk W usermain Total payload length datalen current payload offset I usermain WEBSOCKETEVENTDATA I usermain Received opcode W usermain Receivedkkjk W usermain Total payload length datalen current payload offset I usermain Sendinghello len I usermain Sendinghello len The serverside operation log is as follows ws connectionUpgrade host secwebsocketkeyHudC xAIDs v lNg CDdg secwebsocketversion upgradewebsocket useragentESP Websocket Client kkjk kkjk kkjk Add NETIFPPPAUTHTYPENONE to espnetifauthtypet and allow espnetifpppsetauth to set authtype with NETIFPPPAUTHTYPENONE Environment Development Kit ESP DevKitC Kit version for WroverKitPicoKitDevKitC v Module or chip used ESP WROOM D IDF version run git describe tags to find it v dev g a c Build System idfpy Compiler version run xtensaesp elfgcc version to find it xtensaesp elfgcc crosstoolNG esp r Operating System Linux Using an IDE Visual Studio Code Power Supply USB Problem Description BLE module causes abort was called at PC x ea on core x ea lockacquiregeneric at homejonhunterkingespespidfcomponentsnewliblocksc when I read values from my flash This happens after case completes If I do not call BLE init I do not have this issue Code to reproduce this issue Please note that not all the code from each of my files is posted here Its thousands of lines This is just the relevant code So if you think you need more let me know MAIN CODE cpp void appmain esploglevelsetTAG ESPLOGDEBUG createWifiStruct bleInit xTaskCreate maintask MAIN NULL NULL void maintaskvoid params uint t sleepTime int x uint t i char ssid VENTURES char password yardTypecolumn int flashStatus bool calibrationStatus false bool bleStatus false char ssidtest char passwordtest whiletrue printfOto state is d n x printfIn Main task n switchx case ESPLOGITAG Sending Indiciation bleindicateTwoi i if i i calibrationStatus returnStatus if calibrationStatus ESPLOGITAG Calibration Complete x vTaskDelay portTICKPERIODMS break case ESPLOGITAG Asking for password and SSID ssidtest returnSSID passwordtest returnPassword printfReturned SSID is s n ssidtest printfReturned Password is s n passwordtest x vTaskDelay portTICKPERIODMS break case whilewifiInitssidtest passwordtest ESPLOGITAG Waiting for wifi to initialize updateStatus x break case pollServer ESPLOGITAG Polling Server vTaskDelay portTICKPERIODMS bleStatus returnBLEStatus if bleStatus printfBLE Reconnected n x else printfBLE is not connected n x break case Initialize Flash Storage ESPLOGITAG Checking if flash storage is initialized initFlash vTaskDelay portTICKPERIODMS x break case Check status flashStatus returnFlashStatus if flashStatus ESPLOGITAG Wifi credentials have not been saved x else ESPLOGITAG Wifi credentials have already been saved x break case Save structure savestructTestSSID TestPassword vTaskDelay portTICKPERIODMS x break case Return SSID and Password from flash storage ssidtest returnFlashSSID passwordtest returnFlashPassword printfReturned values s s p s n ssidtest passwordtest x vTaskDelay portTICKPERIODMS break case sleep inithibernationsleepTime printfGoing to sleep n espdeepsleepstart break default break FLASH CODE cpp char returnFlashSSIDvoid sizet sizessid char key flashkey flashstorage store vTaskDelay portTICKPERIODMS ESPERRORCHECKnvsflashinitpartitionMyNvs nvshandle handlessid ESPERRORCHECKnvsopenfrompartitionMyNvs store NVSREADONLY handlessid esperrt resultssid nvsgetblobhandlessid key void store sizessid switch resultssid case ESPOK ESPLOGITAG SSID sstoressid memsetoutssid strlenoutssid for int i i sizeofstoressid i outssid i char storessid i break default ESPLOGETAG Error s opening NVS handle n esperrtonameresultssid break nvsclosehandlessid return outssid char returnFlashPasswordvoid sizet sizepassword char key flashkey flashstorage store vTaskDelay portTICKPERIODMS ESPERRORCHECKnvsflashinitpartitionMyNvs nvshandle handlepassword ESPERRORCHECKnvsopenfrompartitionMyNvs store NVSREADONLY handlepassword esperrt resultpassword nvsgetblobhandlepassword key void store sizepassword switch resultpassword case ESPOK ESPLOGITAG Password sstorepassword memsetoutpassword strlenoutpassword for int i i sizeofstorepassword i outpassword i char storepassword i break default ESPLOGETAG Error s opening NVS handle n esperrtonameresultpassword break nvsclosehandlepassword return outpassword BLE CODE cpp void bleInit esperrt ret Initialize NVS ret nvsflashinit if ret ESPERRNVSNOFREEPAGES ESPERRORCHECKnvsflasherase ret nvsflashinit ESPERRORCHECK ret ESPERRORCHECKespbtcontrollermemreleaseESPBTMODECLASSICBT espbtcontrollerconfigt btcfg BTCONTROLLERINITCONFIGDEFAULT ret espbtcontrollerinit btcfg if ret ESPLOGEGATTSTAG s initialize controller failed n func return ret espbtcontrollerenableESPBTMODEBLE if ret ESPLOGEGATTSTAG s enable controller failed n func return ret espbluedroidinit if ret ESPLOGEGATTSTAG s init bluetooth failed n func return ret espbluedroidenable if ret ESPLOGEGATTSTAG s enable bluetooth failed n func return ret espblegattsregistercallbackgattseventhandler if ret ESPLOGEGATTSTAG gatts register error error code x ret return ret espblegapregistercallbackgapeventhandler if ret ESPLOGEGATTSTAG gap register error error code x ret return ret espblegattsappregisterPROFILEAAPPID if ret ESPLOGEGATTSTAG gatts app register error error code x ret return ret espblegattsappregisterPROFILEBAPPID if ret ESPLOGEGATTSTAG gatts app register error error code x ret return esperrt localmturet espblegattsetlocalmtu if localmturet ESPLOGEGATTSTAG set local MTU failed error code x localmturet Debug Logs abort was called at PC x ea on core x ea lockacquiregeneric at homejonhunterkingespespidfcomponentsnewliblocksc ELF file SHA a b af ae d e c a d c ab c c ee e fee c e faf Backtrace x ed x ffb b x a x ffb d x ea x ffb f x fc x ffb a x b x ffb a x fe x ffb d x f x ffb d x abb x ffb d x d b c x ffb da x df x ffb dc x df x ffb df x e b x ffb e x af x ffb e x x ffb e x ed invokeabort at homejonhunterkingespespidfcomponentsesp panicc x a abort at homejonhunterkingespespidfcomponentsesp panicc x ea lockacquiregeneric at homejonhunterkingespespidfcomponentsnewliblocksc x fc lockacquirerecursive at homejonhunterkingespespidfcomponentsnewliblocksc x b vfiprintfr at buildsidfcrosstoolNGbuildxtensaesp elfsrcnewlibnewliblibcstdiovfprintfc discriminator x fe fiprintf at buildsidfcrosstoolNGbuildxtensaesp elfsrcnewlibnewliblibcstdiofiprintfc x f assertfunc at buildsidfcrosstoolNGbuildxtensaesp elfsrcnewlibnewliblibcstdlibassertc discriminator x abb vPortCPUAcquireMutexIntsDisabledInternal at homejonhunterkingespespidfcomponentsfreertosportmuximplinch inlined by vPortCPUAcquireMutexIntsDisabled at homejonhunterkingespespidfcomponentsfreertosportmuximplh inlined by vTaskEnterCritical at homejonhunterkingespespidfcomponentsfreertostasksc x d b c periphmoduleenable at homejonhunterkingespespidfcomponentsdriverperiphctrlc discriminator x df espphyrfinit at homejonhunterkingespespidfcomponentsespwifisrcphyinitc x df espmodemsleepexit at homejonhunterkingespespidfcomponentsespwifisrcphyinitc x e b btdmsleepexitphase wrapper at homejonhunterkingespespidfcomponentsbtcontrollerbtc x af btdmcontrollertask at x vPortTaskWrapper at homejonhunterkingespespidfcomponentsfreertosportc 