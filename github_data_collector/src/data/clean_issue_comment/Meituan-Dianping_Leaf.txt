 leafsnowflakeenabletrue leafsnowflakezkaddress leafsnowflakeport mvn springbootrun leaf id id leaf MAXSTEP current segment next segment current segment leaf segment Leaf Leaf Leaf leaf LOGO LOGO leafmeituancom Buffer public Result getIdFromSegmentBufferfinal SegmentBuffer buffer while true bufferrLocklock try final Segment segment buffergetCurrent if bufferisNextReady segmentgetIdle segmentgetStep buffergetThreadRunningcompareAndSetfalse true serviceexecutenew Runnable Override public void run if a b if a if a b if workerID IntegerparseIntnodeKey leafname workerID IntegerparseIntnodeKey nodeKeylength ListString dbTags daogetAllTags if dbTags null dbTagsisEmpty return ListString cacheTags new ArrayListStringcachekeySet ListString insertTags new ArrayListStringdbTags ListString removeTags new ArrayListStringcacheTags db tags cache insertTagsremoveAllcacheTags for String tag insertTags SegmentBuffer buffer new SegmentBuffer buffersetKeytag Segment segment buffergetCurrent segmentsetValuenew AtomicLong segmentsetMax segmentsetStep cacheputtag buffer loggerinfoAdd tag from db to IdCache SegmentBuffer tag buffer cache tags cache removeTagsremoveAlldbTags for String tag removeTags cacheremovetag loggerinfoRemove tag from IdCache tag removeAll nm hashmap hashset value ListString dbTags daogetAllTags if dbTags null dbTagsisEmpty return ListString cacheTags new ArrayListStringcachekeySet SetString insertTagsSet new HashSetdbTags SetString removeTagsSet new HashSetcacheTags db tags cache forint i i cacheTagssize i String tmp cacheTagsgeti ifinsertTagsSetcontainstmp insertTagsSetremovetmp for String tag insertTagsSet SegmentBuffer buffer new SegmentBuffer buffersetKeytag Segment segment buffergetCurrent segmentsetValuenew AtomicLong segmentsetMax segmentsetStep cacheputtag buffer loggerinfoAdd tag from db to IdCache SegmentBuffer tag buffer cache tags cache forint i i dbTagssize i String tmp dbTagsgeti ifremoveTagsSetcontainstmp removeTagsSetremovetmp for String tag removeTagsSet cacheremovetag loggerinfoRemove tag from IdCache tag insertTags hashmap tag hashmap O dbTags removeAll O nm 