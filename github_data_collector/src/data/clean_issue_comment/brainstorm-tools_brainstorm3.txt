Hey all In this thread we will discuss and finalize the integration of the FEM computation of the forward problem We have finished the compilation of Duneuro on the main platforms Windows Linux and MAC and we have integrated all in one package We have also developed a whole Matlab toolbox named bstduneurotoolbox to test duneuro and to interface it to brainstorm with a minimal change on the main bst code We have tested and validated the EEG computation MEG is in progress and the other methods will be added later seeg ecog ftadel I checked how bst call openmeeg via Gain errMsg bstopenmeegOPTIONS then I wrote a similar function for fem Gain errMsg bstduneuroOPTIONS bstduneurotxt This function will use the same argument OPTIONS and it uses the bstduneurotoolbox However some fields are missing in the OPTIONS and we need to add them For this release the most important is the path to the fem head model But there are some other steps that we need to modify mainly related to the GUI For now I identified these functions processheadmodel panelheadmodel bstget panelduneuro as panelopenmeeg bstduneuro as bstopenmeeeg There are some parameters for the FEM that should be tuned from the GUI panel and we will set to the default value the others Maybe we could discuss these points next meeting Kind regards Takfarinas Dec Sept DICS source normalization Connectivity for unconstrained sources August Min norm Connectivity for unconstrained sources Statistics July Min norm May Granger spectral February Dipole scanning October LCMV SNR August Connectivity for unconstrained sources jcmosher suggested we change the scaling factor applied in two functions Dipole scanning Factor sqrtDataMatPLeff sResultPLeff Replaced with Factor sqrtsResultPLeff Problem When testing with the introduction tutorials the goodness of fit of the dipoles drops to very small values example for standard condition at ms Leff Current code top vs Johns suggestions bottom Whitened recordings Factor sqrtDataMatLeff ResultsMatLeff Replaced with Factor sqrtsResultPLeff This looks more reasonable but do we want to see Z here Below figures obtained by rightclicking on the MN source link for the standard condition Leff Model evaluation Save whitened data topbefore bottomafter modification jcmosher dimitriospantazis please validate whether this is what you want to obtain The raster plot shows the spiking activity of each neuron There is a problem though with the visualization of this activity Since the raster plots are not binned no temporal smoothing the xaxis time dimension is a much larger vector than the yaxis number of trials This creates a rendering problem when the figure is scaled as shown on the next two figures Maybe a visualization with dots would be appropriate For example it does not run on Matlab versions before R b missing function histcounts used in the scilearnlab library Either see if such instances can be replaced or add warning to process Adding a callback to import convert a timefreqmat file obtain from fieldtrip This is a first attempt if is ok I will add some additional options and create a channelmat to allow the topographic display Identify the programs that would be interesting and not too complicated to interface with Brainstorm Find advanced users of these programs to define how to convert data structures Write online tutorials for each program Improvements Used to give an error if number of channels didnt match It now deals properly with varying channels matches them by name with the options of keeping either all channels default only common channels or those from the first file similarly to bstavgfiles Averaging locations caused shrinkage towards origin Now MEG channels are averaged based on the dewarnative transformations separately averaging the brain origins based on the cortex surface if available and the head orientations EEG channel locations are still simply averaged but with a correction to avoid shrinkage There was a bug in averaging orientations they were not normalized Fixed Following this processaverage should also be modified to always match channels by name This is only an option why and only for files that contain RowNames tf and matrix types I think this can easily lead to errors in group averaging There should at the very least be a warning or error if channels dont match and the code cant deal with it Now it just averages by channel index Additions modifications or alterations both in Simbio orand Brainstorm toolboxes to make these two work together A long time ago I did a study of various sphere fitting methods for MEG forward modelling I remembered that this approximation adds on the order of error to the forward solution so I switched to using Noltes method when using Fieldtrip some years ago its called single shell in FT I just looked back at my paper and saw this comment which I had forgotten Other variations of these methods were tested but produced similar or worse results and are not shown here For example the NC method variation implemented in Brainstorm with had mean field error and mm mean localization bias as opposed to and mm respectively for the version with So I think its worth considering changing the sphere fitting method used in Brainstorm It might also be a good idea to rethink the recommended method for MEG We can discuss at our next video meeting