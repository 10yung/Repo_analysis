Stata SEs dont agree in the below case with twoway fixed effects when I expected them to If this is expected feel free to close Data is RDS saved from R from repldta read in via code below replRDSzip Agrees wo fixed effects use repldta reg conflict dlpilev robust clusterccode Linear regression Number of obs F Prob F Rsquared Root MSE Std Err adjusted for clusters in ccode Robust conflict Coef Std Err t Pt Conf Interval dlpilev cons repl havenreaddtarepldta lmrobustconflict dlpilev clusters ccode setype stata data repl Estimate Std Error t value Prt CI Lower CI Upper DF Intercept e dlpilev e Does not agree when we add two way FE tsset ccode year xtreg conflict dlpilev yr fe robust clusterccode note yr omitted because of collinearity Fixedeffects within regression Number of obs Group variable ccode Number of groups Rsq Obs per group within min between avg overall max F corrui Xb Prob F Std Err adjusted for clusters in ccode Robust conflict Coef Std Err t Pt Conf Interval dlpilev year FE omitted cons sigmau sigmae rho fraction of variance due to ui lmrobustconflict dlpilev fixedeffects year ccode clusters ccode setype stata data repl Estimate Std Error t value Prt CI Lower CI Upper DF dlpilev In differenceinmeans weve been having this problem where If all blocks have min obs in each arm we use neyman variance in each block then average the SEs together to get an overall SE for the ATE estimate If all blocks have obs in each arm eg a matched pairs design we use the Imai variance estimator if some but not all blocks have obs in at least one arm we error out Our wacky intuition was to do something like for all the big blocks and something like for all the small blocks and then average together as in treating the small blocks estimate like a single block We didnt implement this because it seemed like a hack and we wanted someone to have figured out the math And I just met someone who did Nicole Pashley and Luke Miratrix have this problem and more complicated variants worked out mostly in line with our intuition Take a look here This is a feature request but I think a relatively high priority one Nicole said shed be willing to share some code that we could check against at least Its common to see the coefficients from the firststage regression regression in a SLS regression table For example see discussion here estimatrivrobust does not currently support this AFAIK Although it does return some overall diagnostic results from the firststage if the diagnostics T argument is used Would it be possible add the firststage to the model return object FWIW lfefelm supports this with a stage return object Heres a reprex r libraryAER only for Cigarettes dataset suppressPackageStartupMessageslibrarydplyr suppressPackageStartupMessageslibrarylfe Get the data dataCigarettesSW package AER Create a new data frame with some modified variables cigs CigarettesSW mutate rprice pricecpi rincome incomepopulationcpi rtax taxcpi tdiff taxs taxcpi Run the iv regression in felm with tdiff and rtax instrumenting the endogenous variable logrprice ivfelm felm logpacks logrincome year state FEs logrprice tdiff rtax Endog variable and instruments data cigs Shown first stage result summaryivfelmstage Call NULL Residuals Min Q Median Q Max Coefficients Estimate Std Error t value Prt logrincome tdiff e rtax e Signif codes Residual standard error on degrees of freedom Multiple Rsquaredfull model Adjusted Rsquared Multiple Rsquaredproj model Adjusted Rsquared Fstatisticfull model on and DF pvalue e Fstatisticproj model on and DF pvalue e Fstatisticexcl instr on and DF pvalue e supCreated on by the reprex package v sup From Solaris on v Running the tests in teststestthatR failed Complete output librarytestthat libraryestimatr testcheckestimatr Failure Handle perfect fits appropriately testlmrobustfesR tidyrfo rfoterm X not equivalent to tidyro roterm X Component stderror isNA value mismatch in current in target Component statistic isNA value mismatch in current in target Component pvalue isNA value mismatch in current in target Component conflow isNA value mismatch in current in target Component confhigh isNA value mismatch in current in target testthat results OK SKIPPED WARNINGS FAILED Failure Handle perfect fits appropriately testlmrobustfesR Error testthat unit tests failed Execution halted Waiting until gt is on CRAN then will change travisyml accordingly tracking From a user Since version or earlier I found that the joint hypothesis test is not performed with lhrobust but it only performs single hypotheses In the manual pp Example it writes The linear hypothesis argument can be specified equivalently as lhrobusty x z data dat linearhypothesis z x lhrobusty x z data dat linearhypothesis cz x but actually they perform different hypothesis tests The former is the test of z x but the latter only performs the ttest of z and x respectively but not the joint test of z AND x In the carlinearHypothesis function the same specification performs the joint test and returns the result of Ftest I think that lhrobust used to returns the same result as linearHypothesis probably version 