Is there an easy way to get a scope of roots sorted by number of descendants Thank you Switching to squish keeps log output on a single line Before Page Load ms SELECT pages FROM pages INNER JOIN SELECT descendantid MAXgenerations as depth FROM pagehierarchies GROUP BY descendantid AS generationdepth ON pagesid generationdepthdescendantid ORDER BY generationdepthdepth position After Page Load ms SELECT pages FROM pages INNER JOIN SELECT descendantid MAXgenerations as depth FROM pagehierarchies GROUP BY descendantid AS generationdepth ON pagesid generationdepthdescendantid ORDER BY generationdepthdepth position in the auto generated migration for adding hierarchy table we added timestamps but on creating a new node it is giving a irbmain FactoryBotcreateteam parentteamid ms BEGIN Team Exists ms SELECT AS one FROM teams WHERE teamsname LIMIT name teamac LIMIT SQL ms INSERT INTO teams name createdat updatedat parentteamid VALUES RETURNING id name teamac createdat updatedat parentteamid Team Load ms SELECT teams FROM teams WHERE teamsid LIMIT id LIMIT ms SELECT pgtryadvisorylock AS ta a a afc a bcaeecb a a acedd a b deb dd e SQL ms INSERT INTO teamhierarchies ancestorid descendantid generations createdat updatedat VALUES ancestorid descendantid generations createdat updatedat ms INSERT INTO teamhierarchies ancestorid descendantid generations SELECT xancestorid xgenerations FROM teamhierarchies x WHERE xdescendantid ms SELECT pgadvisoryunlock AS t c fa f a c d ebfc a a acedd a b deb dd e ms ROLLBACK ms SELECT pgadvisoryunlock AS ta a f a aef ed fb a a acedd a b deb dd e ms BEGIN ms ROLLBACK Traceback most recent call last from irb ActiveRecordNotNullViolation PGNotNullViolation ERROR null value in column createdat violates notnull constraint DETAIL Failing row contains null null INSERT INTO teamhierarchies ancestorid descendantid generations SELECT xancestorid xgenerations FROM teamhierarchies x WHERE xdescendantid the library is not passing timestamps How do we go about this Hello While testing how closuretree is handling deep nesting for a project I noticed that at some point it started to issue an unreasonably large number of SQL queries Looking at the maxjointables currently I assumed that for levels of nesting there will be something like queries and not I tracked down the issue to the use of ingroups which splits the path array in the given number of groups and replaced it with ingroupsof which would rather split in groups of the given size Check out the updated spec example SQL output before queries sql maxjointables path name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name subpath name name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p name AND p parentid IS NULL ORDER BY tagsid ASC LIMIT subpath name name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT and after the change queries sql maxjointables path name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name name subpath name name name name name name name name name name name name name name name name name name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p parentid IS NULL ORDER BY tagsid ASC LIMIT subpath name name name name name name name name name name name name name name name name name name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name name name name name name name name name name name name name name name name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT subpath name name name name name name name name name name SELECT tags FROM tags INNER JOIN tags AS p ON p id tagsparentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid INNER JOIN tags AS p ON p id p parentid WHERE tagsname AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p name AND p parentid ORDER BY tagsid ASC LIMIT Trying to integrate Closure Tree with Ruby Serverless application based on Jets Framework The issue is the moment I put hasclosuretree method inside the model it starts throwing weird errors Error connectionpool ActiveRecordConnectionNotEstablished ActiveRecordConnectionNotEstablished Traceback Traceback most recent call last from Usersrahulrvmgemsruby jetsgemsetbinrubyexecutablehooks in main from Usersrahulrvmgemsruby jetsgemsetbinrubyexecutablehooks in eval from Usersrahulrvmgemsruby jetsgemsetbinjets in main from Usersrahulrvmgemsruby jetsgemsetbinjets in load from Usersrahulrvmgemsruby jetsgemsetgemsjets exejets in top required from Usersrahulrvmgemsruby jetsgemsetgemsjets libjetsclirb in start from Usersrahulrvmgemsruby jetsgemsetgemsjets libjetsclirb in start from Usersrahulrvmgemsruby jetsgemsetgemsjets libjetsclirb in bootjets from Usersrahulrvmgemsruby jetsgemsetgemsjets libjetscorerb in boot from Usersrahulrvmgemsruby jetsgemsetgemsjets libjetsbooterrb in boot from Usersrahulrvmgemsruby jetsgemsetgemsjets libjetsbooterrb in eagerloadapp from Usersrahulrvmgemsruby jetsgemsetgemsjets libjetsbooterrb in select from Usersrahulrvmgemsruby jetsgemsetgemsjets libjetsbooterrb in block in eagerloadapp from Usersrahulrvmgemsruby jetsgemsetgemsactivesupport libactivesupportcoreextstringinflectionsrb in constantize from Usersrahulrvmgemsruby jetsgemsetgemsactivesupport libactivesupportinflectormethodsrb in constantize from Usersrahulrvmgemsruby jetsgemsetgemsactivesupport libactivesupportinflectormethodsrb in inject from Usersrahulrvmgemsruby jetsgemsetgemsactivesupport libactivesupportinflectormethodsrb in each from Usersrahulrvmgemsruby jetsgemsetgemsactivesupport libactivesupportinflectormethodsrb in block in constantize from Usersrahulrvmgemsruby jetsgemsetgemsactivesupport libactivesupportinflectormethodsrb in constget from Usersrahulrvmgemsruby jetsgemsetgemsactivesupport libactivesupportdependenciesrb in constmissing from Usersrahulrvmgemsruby jetsgemsetgemsactivesupport libactivesupportdependenciesrb in loadmissingconstant from Usersrahulrvmgemsruby jetsgemsetgemsactivesupport libactivesupportdependenciesrb in requireorload from Usersrahulrvmgemsruby jetsgemsetgemsactivesupport libactivesupportdependenciesrb in loadinterlock from Usersrahulrvmgemsruby jetsgemsetgemsactivesupport libactivesupportdependenciesinterlockrb in loading from Usersrahulrvmgemsruby jetsgemsetgemsactivesupport libactivesupportconcurrencysharelockrb in exclusive from Usersrahulrvmgemsruby jetsgemsetgemsactivesupport libactivesupportdependenciesinterlockrb in block in loading from Usersrahulrvmgemsruby jetsgemsetgemsactivesupport libactivesupportdependenciesrb in block in loadinterlock from Usersrahulrvmgemsruby jetsgemsetgemsactivesupport libactivesupportdependenciesrb in block in requireorload from Usersrahulrvmgemsruby jetsgemsetgemsactivesupport libactivesupportdependenciesrb in loadfile from Usersrahulrvmgemsruby jetsgemsetgemsactivesupport libactivesupportdependenciesrb in newconstantsin from Usersrahulrvmgemsruby jetsgemsetgemsactivesupport libactivesupportdependenciesrb in block in loadfile from Usersrahulrvmgemsruby jetsgemsetgemsactivesupport libactivesupportdependenciesrb in load from Usersrahulinstantsystemsdmsprojectsdmsbackendapiappmodelsdocumentrb in top required from Usersrahulinstantsystemsdmsprojectsdmsbackendapiappmodelsdocumentrb in classDocument from Usersrahulrvmgemsruby jetsgemsetgemsclosuretree libclosuretreehasclosuretreerb in hasclosuretree Usersrahulrvmgemsruby jetsgemsetgemsactiverecord libactiverecordconnectionhandlingrb in connectionpool ActiveRecordConnectionNotEstablished ActiveRecordConnectionNotEstablished The error occurs when I run jets console It disappears the moment I remove hasclosuretree method from my model EDIT connectionpoolreleaseconnection inside hasclosuretree method is causing the issue with jets Based on Adds ability to set databasetype in initializersclosuretreeconfigrb ruby ClosureTreeconfigure do config configdatabasetype mysql end The type will be used across all the closure tree models in the applicationbr This solves problems with numeric ordering and dbcreate delete FROM fclocationhierarchies WHERE descendantid IN SELECT DISTINCT descendantid FROM SELECT descendantid FROM fclocationhierarchies WHERE ancestorid OR descendantid AS x Query OK rows affected sec this query runs when updating the closure tree hierarchy Its taking a while on mysql ms with no matching hierarchy rows to delete and less than k rows in the hierarchies table I made a mysqlspecific query here that speeds up the update of the hierarchy tree from ms to under ms Thoughts Obviously this would mean that we would have different SQL for different databases but the performance was bad enough on mysql that we had to fork Were using msyql Hey Sorry I dont know how to go further here i found uuid support in the changelog but yet byebug parenttaskchildrencreateuserid parenttaskuserid workflowid parenttaskworkflowid ActiveRecordStatementInvalid Exception PGUndefinedFunction ERROR operator does not exist uuid integer LINE WHERE xdescendantid HINT No operator matches the given name and argument types You might need to add explicit type casts INSERT INTO taskhierarchies ancestorid descendantid generations SELECT xancestorid cd eac c d a cf eead xgenerations FROM taskhierarchies x WHERE xdescendantid rails closuretree I will appreciate every help very much or the variable is assigned nil and its always false While the rails maintainers decide whether its a good idea I found this because out of curiosity I ran our test suite with ApplicationRecordpresent raising in our projects Reviving under a different organization and on the latest version of master The call to releaseconnection added in might release a connection that was opened outside of hasclosuretree if the caller is loaded dynamically in the middle of some other operation This is especially problematic if the connection has an ongoing transaction as that transaction will be lost This PR changes hasclosuretree to use withconnection instead which only releases a connection if it was acquired If a connection already existed prior to the call to hasclosuretree it wont be released seuros made a comment on the previous version of this PR about Databaseless setup which I didnt understand If someone could point me at a docreadmewhatever Ill gladly add the necessary tests