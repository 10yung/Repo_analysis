This is a followup pull request to I included lashus commit from the original PR in a e e ee eb beb adb d ea b cd This prevents the GMagick error No encode delegate for this image format See When creating a GIF more than MB is spent and the PHP process freezes and gives a error What is the reason for this And how to fix it The total size of all frames in base is only mb where from so much memory consumption imagine new Imagine Imagick Imagine image foreach framesBase as frame data explode frame decoded base decodedata ifimage image imagineloaddecoded else imagelayersaddimagineloaddecoded gifdata imagegetgif array animated true animateddelay delay in ms animatedloops number of loops means infinite echo base encodegifdata Issue description Imagine wont save a jpeg file with jfif extension although the library is able to crop the file What version of Imagine are you using Whats the PHP version you are using Whats the imaging library you are using gdimagickgmagickany gd Whats the imaging library configuration GD Support enabled GD headers Version GD library Version Minimal PHP code to reproduce the error Example file imagetesttargz its tar gz as github doesnt accept jfif images php stream fopenfilename r imagine new Imagine Gd Imagine image imaginereadstream manipulator imagecopy box new Box manipulator manipulatorthumbnailbox manipulatorsaveDIR altered basenamefilename Proposed solution Replace Imagine Gd ImagenormalizeFormat by php private function normalizeFormatformat format strtolowerformat if jpg format pjpeg format jfif format format jpeg return format Kindly help solve this issue Im trying to upload a profile pic it brings this error kindly assist Im using yii Class Imagine Gd Imagine not found the code is this ext png generate a unique file name to prevent duplicate filenames modeluserphoto Yiiappuseridentityusername ppicext YiiappsecuritygenerateRandomStringext the path to save file you can set an uploadPath in Yiiappparams as used in example below Yiiappparams uploadPath uploadsuserimage path Yiiappparams uploadPath modeluserphoto imagesaveAspath imagine new Imagine photo imagineopenpath photothumbnailnew Box savepath quality if modelsave YiiappsessionsetUserImage modeluserphoto return thisredirect profile YiiappsessionsetFlashsuccess Profile updated successfully return thisredirectYiiapprequestreferrer thisgoHome I use imagine new Imagine fontContent imaginefontfontPathContent palettecolor image imagineopenYiigetAliascommonfilestemplates png imagedrawtextvalue fontContent positionContent Flatten does accidently reset the format to gif and so it need to be set after thisflatten Ive changed the cropping behaviour as written in Not sure though how to test it and also without using distort and SRT we are changing the image size in GD that doesnt happen Not sure how to refactor it other way though as with using image distortion with SRT its hard to rotate it in same way using same point Issue description Gd and Imagick drivers leave the image in a different state after rotation What version of Imagine are you using dev Whats the PHP version you are using PHP Whats the imaging library you are using gdimagickgmagickany Imagick Gd Minimal PHP code to reproduce the error php size imagegetSize imagerotate imagecropnew Point size Output by Gd driver Gdoutput Output by Imagick driver Imagickoutput The problem is that Imagick does not update image geometry after the rotation I think a similar issue is described here Output from Gd seems to be the correct one The solution would be to call setImagePage inside Imagick driver after the rotation Created applyMask fix for 