 Add documentation in how to setup autocompletion for Velero CLI fixes Instructions tested on x Linux Ubuntu bash x Linux Ubuntu zsh x macOS Catalina bash x macOS Catalina zsh Signedoffby Steve Kriss krisssvmwarecom closes Old techdebt issue that can finally be cleaned up I also added a comment about why we unfortunately still need the thirdparty copy of the shortcut expander xref Basic testing looks good confirmed the relevant shortcuts work plus no performance regression but would like to do a little more before merging How do I use Velero to backup and restore rancher catalog apps I backed up a namespace and restored it fine but the app did not show up on the apps page This initial design only covers the reorganizationcreation of commands Addressing changes thatll be required in the system is still WIPto be added Signedoffby Carlisia carlisiavmwarecom Signedoffby Steve Kriss krisssvmwarecom closes cc dymurray Basic validation on this looks good but Id like to do some more testing before merging so leaving in draft status What steps did you take and what happened Were using velero to back up our EKS cluster and some EFS PVs The velero service account is using AWSs eksamazonawscomrolearn annotation to attach a role to it This works fine for backing up data from velero however restic does not seem to support pulling the AWS token properly with that mechanism and it is using anonymous authentication and failing to store data in S What did you expect to happen Restic should be able to back up using the same credentials velero uses The output of the following commands will help us better understand whats going on Pasting long output into a GitHub gist or other pastebin is fine Error message from backup logs time T Z levelerror msgError backing up item backupveleroinfratestefsbackupforrealz errorrestic repository is not ready error running commandrestic init repos s useast amazonawscomveleroplatformv backuprestickubesystem passwordfiletmpveleroresticcredentialskubesystem cachedirscratchcacherestic stdout stderrFatal create key in repository at s s useast amazonawscomveleroplatformv backuprestickubesystem failed clientPutObject Access Denied n n exit status errorfilegosrcgithubcomvmwaretanzuveleropkgresticrepositoryensurergo errorfunctiongithubcomvmwaretanzuveleropkgresticrepositoryEnsurerEnsureRepo groupv logSourcepkgbackupresourcebackuppergo nametestpod namespace resourcepods Restic pod logs time T Z levelinfo msgSetting loglevel to INFO time T Z levelinfo msgStarting Velero restic server v d bbf d e da a d a ca c c logSourcepkgcmdcliresticservergo time T Z levelinfo msgStarting controllers logSourcepkgcmdcliresticservergo time T Z levelinfo msgStarting controller controllerpodvolumebackup logSourcepkgcontrollergenericcontrollergo time T Z levelinfo msgWaiting for caches to sync controllerpodvolumebackup logSourcepkgcontrollergenericcontrollergo time T Z levelinfo msgControllers started successfully logSourcepkgcmdcliresticservergo time T Z levelinfo msgStarting controller controllerpodvolumerestore logSourcepkgcontrollergenericcontrollergo time T Z levelinfo msgWaiting for caches to sync controllerpodvolumerestore logSourcepkgcontrollergenericcontrollergo time T Z levelinfo msgCaches are synced controllerpodvolumebackup logSourcepkgcontrollergenericcontrollergo time T Z levelinfo msgCaches are synced controllerpodvolumerestore logSourcepkgcontrollergenericcontrollergo W reflectorgo githubcomvmwaretanzuveleropkgcmdcliresticservergo watch of v Secret ended with too old resource version W reflectorgo githubcomvmwaretanzuveleropkgcmdcliresticservergo watch of v Secret ended with too old resource version AWS Error message recipientAccountId REDACTED userIdentity type AWSAccount principalId accountId ANONYMOUSPRINCIPAL responseElements null errorMessage Access Denied requestID REDACTED managementEvent false eventID REDACTED userAgent Minio linux amd miniogov eventName PutObject resources type AWSS Object ARN REDACTEDrestickubesystemkeys c f fd d c a c c bd ed a a a b aa type AWSS Bucket ARN REDACTED accountId REDACTED readOnly false eventVersion eventTime T Z vpcEndpointId REDACTED requestParameters key restickubesystemkeys c f fd d c a c c bd ed a a a b aa bucketName REDACTED Host REDACTED awsRegion useast eventSource s amazonawscom sharedEventID REDACTED additionalEventData CipherSuite ECDHERSAAES GCMSHA bytesTransferredOut bytesTransferredIn xamzid REDACTED sourceIPAddress REDACTED errorCode AccessDenied eventType AwsApiCall Anything else you would like to add This was an issue for us last fall with velero The solution was to update the AWS SDK to the latest version and things magically worked afterwards Not sure what might be needed since restic is using minio though Looks like the latest version of restic uses minio so maybe updating to that is enough For more info on the serviceaccount IAM role stuff Environment Velero version use velero version Velero features use velero client config get features NOT SET Kubernetes version use kubectl version Kubernetes installer version EKS Cloud provider or hardware configuration AWS OS eg from etcosrelease amazonlinux Partial fix for Using this patch moves the restore issues beyond version mismatches however if CRDs in the backup have SpecPreserveUnknownFields True in the backup whether they were v beta or v they will see these errors if only this change is applied Errors Velero none Cluster error restoring customresourcedefinitionsapiextensionsk siodeletebackuprequestsveleroio CustomResourceDefinitionapiextensionsk sio deletebackuprequestsveleroio is invalid specpreserveUnknownFields Invalid value true cannot set to true set xpreserveunknownfields to true in specversions schema instead error restoring customresourcedefinitionsapiextensionsk siodownloadrequestsveleroio CustomResourceDefinitionapiextensionsk sio downloadrequestsveleroio is invalid specpreserveUnknownFields Invalid value true cannot set to true set xpreserveunknownfields to true in specversions schema instead error restoring customresourcedefinitionsapiextensionsk siopodvolumebackupsveleroio CustomResourceDefinitionapiextensionsk sio podvolumebackupsveleroio is invalid specpreserveUnknownFields Invalid value true cannot set to true set xpreserveunknownfields to true in specversions schema instead error restoring customresourcedefinitionsapiextensionsk siopodvolumerestoresveleroio CustomResourceDefinitionapiextensionsk sio podvolumerestoresveleroio is invalid specpreserveUnknownFields Invalid value true cannot set to true set xpreserveunknownfields to true in specversions schema instead error restoring customresourcedefinitionsapiextensionsk sioresticrepositoriesveleroio CustomResourceDefinitionapiextensionsk sio resticrepositoriesveleroio is invalid specpreserveUnknownFields Invalid value true cannot set to true set xpreserveunknownfields to true in specversions schema instead error restoring customresourcedefinitionsapiextensionsk siorestoresveleroio CustomResourceDefinitionapiextensionsk sio restoresveleroio is invalid specpreserveUnknownFields Invalid value true cannot set to true set xpreserveunknownfields to true in specversions schema instead error restoring customresourcedefinitionsapiextensionsk sioschedulesveleroio CustomResourceDefinitionapiextensionsk sio schedulesveleroio is invalid specpreserveUnknownFields Invalid value true cannot set to true set xpreserveunknownfields to true in specversions schema instead error restoring customresourcedefinitionsapiextensionsk sioserverstatusrequestsveleroio CustomResourceDefinitionapiextensionsk sio serverstatusrequestsveleroio is invalid specpreserveUnknownFields Invalid value true cannot set to true set xpreserveunknownfields to true in specversions schema instead Signedoffby Nolan Brubaker brubakernvmwarecom Signedoffby Steve Kriss krisssvmwarecom closes Open to moving this code around per but this seems like the simplest approach to me and is consistent with how existing gauge metrics are reconstructed Did some basic testing and confirmed the metrics repopulate after a server restart Auto Deployment minio velero This script is created to automatically install velero on Kubernetes First it deploys minio as deployment and service on Kubernetes Then it deploys velero server by executing velero CLI install Tested environment ubuntu LTS Kubernetes v Docker Usage Install velerosh i Uninstall velerosh u What steps did you take and what happened I deleted multiple backups velero backup delete toolsbgitlabbackuppr toolsbgitlabbackuppr toolsbgitlabbackuppr One was deleted successfuly and the two others are stucks toolsbgitlabbackuppr Deleting CET d default none toolsbgitlabbackuppr Deleting CET d default none velero backup describe toolsbgitlabbackuppr Deletion Attempts failed CET Processed Errors restic repository is not ready error running commandrestic snapshots repos passwordfiletmpveleroresticcredentialsok gitlabpr cachedirscratchcacherestic last stdout stderrFatal unable to create lock in backend repository is already locked exclusively by PID on velero cbwb by UID GID lock was created at s ago storage ID a exit status restic repository is not ready error running commandrestic snapshots repos passwordfiletmpveleroresticcredentialsok gitlabpr cachedirscratchcacherestic last stdout stderrFatal unable to create lock in backend repository is already locked exclusively by PID on velero cbwb by UID GID lock was created at s ago storage ID a exit status Theses locks happens very often Most of the time I need to wait for the lock to be deleted around mins each time 