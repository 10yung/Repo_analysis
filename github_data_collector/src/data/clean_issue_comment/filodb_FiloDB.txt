Pull Request checklist x The commits messages follows the contribution guidelines CONTRIBUTINGmd Tests for the changes have been added for bug fixes features Docs have been added updated for bug fixes features Current behavior link exiting issues here An NPE is thrown if a query happens to hit a partitiontime series with a schema ID that is not known to FiloDB In theory this should not be possible as both ingestion and the indexpartkey recovery process skips partitions with unknown schema IDs New behavior Unknown schemas will result in a new specific UnknownSchemaQueryErr Upon seeing this error operators need to truncate the data tables as this should only occur when an existing schema is changed which is extremely rare Pull Request checklist x The commits messages follows the contribution guidelines CONTRIBUTINGmd x Tests for the changes have been added for bug fixes features Docs have been added updated for bug fixes features This PR revolves around refresh of Downsampled Lucene Index using part key data startend time mutations from raw dataset Once the downsample cluster loads the initial lucene index it needs to do a periodic fetch of all recent mutations that have occurred We keep track of mutations in new Cass table partitionkeysbyupdatetime that will allow for spark migration job and downsample filo cluster to query index data by update time Downsample Filo Cluster now refreshes index using this table E E Unit test that performs query on Downsample Filo Cluster Caveat When index refresh is done the reverse lookup from partKey to partId on the lucene index can be slow If this gets out of hand we may have to figure out other ways to achieve the lookup faster Pull Request checklist x The commits messages follows the contribution guidelines CONTRIBUTINGmd x Tests for the changes have been added for bug fixes features Docs have been added updated for bug fixes features Support for Prometheus timestamp function Pull Request checklist x The commits messages follows the contribution guidelines CONTRIBUTINGmd x Tests for the changes have been added for bug fixes features Docs have been added updated for bug fixes features This PR is still WIP Sending it out to get some feedback from team on the rough direction for cardinality control via rate limiting Pull Request checklist x The commits messages follows the contribution guidelines CONTRIBUTINGmd x Tests for the changes have been added for bug fixes features x Docs have been added updated for bug fixes features Related Issue Changes x Introducing buildsbt Since FlioBuild is defining the project it should be organized in buildsbt according to the new sbt reqs FiloSettings can be kept in the scala files because it contains objects that FiloBuild needs x Some of the common setting things like scalaVersion and organization can move to ThisBuild x see x Tracking all the dependencies in one file Challenges Got this error not found value scalastyleFailOnError scalastyleFailOnError true in projectFiloSettingsscala at line using sbt I went through scalastyle doc Seems like scalastyleFailOnError filed still exists Currently trying to find out what is wrong Also in scalastyle doc linked above It says that scalastyle should use testScalastyle scalastyleinTesttoTaskvalue compare to scalastyle testScalastyle orgscalastylesbtScalastylePluginscalastyleinTesttoTaskvalue I changed the code accordingly But still got not found value scalastyle This might be nontrivial due to our use of projectFiloBuildSettingsscala but will be worth it for the new features It brings Perfect for a Scala dev whos new to the project Branch version commit OS and Environment JVM version Scala version Kafka and Cassandra versions and setup Spark version if used Deployed mode clientcluster on Spark StandaloneYARNMesosEMR or default Actual wrong behavior Steps to reproduce Logs some log or as attached file see below Unused parts of this template should be removed including this line Branch version commit OS and Environment JVM version Scala version Kafka and Cassandra versions and setup Spark version if used Deployed mode clientcluster on Spark StandaloneYARNMesosEMR or default Actual wrong behavior Steps to reproduce Logs some log or as attached file see below Unused parts of this template should be removed including this line Branch version commit OS and Environment CentOS Linux JVM version JDK Scala version Scala version Kafka and Cassandra versions and setup Cassandra version Spark version if used Spark Deployed mode clientcluster on Spark StandaloneYARNMesosEMR or default Standalone Actual wrong behavior scala dfResultwriteformatfilodbsparkoptiondataset flowrawoptionrowkeys exportMsoptionpartitionkeys protocolIdmodeSaveModeAppendsave INFO main StatsDExtensionakkakamon Starting the KamonStatsD extension Stage A fatal error has been detected by the Java Runtime Environment SIGSEGV xb at pc x f acf pid tid x f dca JRE version OpenJDK Runtime Environment b build b Java VM OpenJDK Bit Server VM b mixed mode linuxamd compressed oops Problematic frame J C orgvelviafiloZeroCopyBinaryclasscachedHash LorgvelviafiloZeroCopyBinaryJ bytes x f acf x f acf xa Failed to write core dump Core dumps have been disabled To enable core dumping try ulimit c unlimited before starting Java again An error report file with more information is saved as rootspark binhadoop hserrpid log If you would like to submit a bug report please visit binsparkshell line Aborted core dumped SPARKHOMEbinsparksubmit class orgapachesparkreplMain name Spark shell scala dfResult writeformatfilodbsparkoptiondataset flowrawoptionrowkeys exportMsoptionpartitionkeys protocolIdmodeSaveModeAppendsave ERROR OneForOneStrategy javalangNullPointerException at orgvelviafiloZeroCopyBinaryclasscachedHash ZeroCopyBinaryscala at orgvelviafiloZeroCopyUTF StringcachedHash ZeroCopyBinaryscala at orgvelviafiloZeroCopyBinaryclasshashCodeZeroCopyBinaryscala at orgvelviafiloZeroCopyUTF StringhashCodeZeroCopyBinaryscala at javautilHashMaphashHashMapjava at javautilHashMapputIfAbsentHashMapjava at orgvelviafilovectorsDictUTF VectorshouldMakeDictDictUTF Vectorscala at orgvelviafilovectorsUTF PtrAppendableoptimizedVectorUTF Vectorscala at orgvelviafilovectorsUTF PtrAppendablesuboptimizeUTF Vectorscala at orgvelviafilovectorsObjectVectoroptimizeObjectVectorscala Steps to reproduce scala val filesSeqfilerootparquetfilesfragment datfilerootparquetfilesfragment dat scala val sqlContext new orgapachesparksqlSQLContextsc scala val parDFsqlContextreadparquetfiles scala parDF count res Long val dfResult parDFwithColumnexporterIp inetToStringparDFexporterIpwithColumnsrcIp inetToStringparDFsrcIpwithColumndstIp inetToStringparDFdstIpwithColumnnextHopIp inetToStringparDFnextHopIpwithColumnbgpNextHopIp inetToStringparDFbgpNextHopIpwithColumnappId inetToStringparDFappIdwithColumnpolicyQosClassificationHierarchy inetToStringparDFpolicyQosClassificationHierarchywithColumnprotocolId parDFprotocolIdcastIntegerTypewithColumnsrcTos parDFsrcToscastIntegerTypewithColumndstTos parDFdstToscastIntegerTypewithColumnsrcMask parDFsrcMaskcastStringTypewithColumndstMask parDFdstMaskcastStringTypewithColumndirection parDFdirectioncastStringType dfResultwriteformatfilodbsparkoptiondataset flowmetricrawnewoptionrowkeys exportMsoptionpartitionkeys protocolIdmodeSaveModeAppendsave It throws either JVM errors or null pointer exceptions Logs some log or as attached file see below Unused parts of this template should be removed including this line Branch version commit OS and Environment Red Hat Enterprise Linux Server release Maipo JVM version java version java version JavaTM SE Runtime Environment build b Java HotSpotTM Bit Server VM build b mixed mode Scala version Scala version Kafka and Cassandra versions and setup apachecassandra Spark version if used Deployed mode clientcluster on Spark StandaloneYARNMesosEMR or default Spark Standalone Actual wrong behavior parDFnewwriteformatfilodbspark optiondataset parDFNF optionrowkeys appId optionpartitionkeys exportMs modeSaveModeOverwritesave Stage ERROR DatasetCoordinatorActor Error in reprojection task filodbparDFNF javalangNullPointerException at orgvelviafilovectorsUTF PtrAppendableaddDataUTF Vectorscala at orgvelviafiloBinaryAppendableVectorclassaddVectorBinaryVectorscala at orgvelviafilovectorsObjectVectoraddVectorObjectVectorscala at orgvelviafiloGrowableVectoraddDataBinaryVectorscala at orgvelviafiloBinaryVectorBuilderaddDataBinaryVectorscala at orgvelviafiloVectorBuilderBaseclassaddVectorBuilderscala at orgvelviafiloBinaryVectorBuilderaddBinaryVectorscala at orgvelviafiloRowToVectorBuilderaddRowRowToVectorBuilderscala at filodbcorestoreChunkSetanonfun applyChunkSetInfoscala at filodbcorestoreChunkSetanonfun applyChunkSetInfoscala at scalacollectionIteratoranon nextIteratorscala at scalacollectionIteratorclassforeachIteratorscala at scalacollectionAbstractIteratorforeachIteratorscala at scalacollectiongenericGrowableclasspluspluseqGrowablescala at scalacollectionmutableArrayBufferpluspluseqArrayBufferscala at scalacollectionmutableArrayBufferpluspluseqArrayBufferscala at scalacollectionTraversableOnceclasstoTraversableOncescala at scalacollectionAbstractIteratortoIteratorscala at scalacollectionTraversableOnceclasstoBufferTraversableOncescala at scalacollectionAbstractIteratortoBufferIteratorscala at scalacollectionTraversableOnceclasstoArrayTraversableOncescala at scalacollectionAbstractIteratortoArrayIteratorscala at filodbcorestoreChunkSetapplyChunkSetInfoscala at filodbcorestoreChunkSetwithSkipsChunkSetInfoscala at filodbcorestoreChunkSetSegmentaddChunkSetSegmentscala at filodbcorereprojectorDefaultReprojectoranonfuntoSegments anonfunapply anonfunapply applymcVspReprojectorscala at filodbcorereprojectorDefaultReprojectoranonfuntoSegments anonfunapply anonfunapply applyReprojectorscala at filodbcorereprojectorDefaultReprojectoranonfuntoSegments anonfunapply anonfunapply applyReprojectorscala at kamontraceTraceContextclasswithNewSegmentTraceContextscala at kamontraceMetricsOnlyContextwithNewSegmentMetricsOnlyContextscala at filodbcorePerftoolssubtracePerftoolsscala at filodbcorereprojectorDefaultReprojectoranonfuntoSegments anonfunapply applyReprojectorscala at filodbcorereprojectorDefaultReprojectoranonfuntoSegments anonfunapply applyReprojectorscala at kamontraceTraceranonfunwithNewContext applyTracerModulescala at kamontraceTracerwithContextTracerModulescala at kamontraceTracerwithNewContextTracerModulescala at kamontraceTracerwithNewContextTracerModulescala at filodbcorereprojectorDefaultReprojectoranonfuntoSegments applyReprojectorscala at filodbcorereprojectorDefaultReprojectoranonfuntoSegments applyReprojectorscala at scalacollectionTraversableLikeanonfunmap applyTraversableLikescala at scalacollectionTraversableLikeanonfunmap applyTraversableLikescala at scalacollectionimmutableListforeachListscala at scalacollectionTraversableLikeclassmapTraversableLikescala at scalacollectionimmutableListmapListscala at filodbcorereprojectorDefaultReprojectortoSegmentsReprojectorscala at filodbcorereprojectorDefaultReprojectoranonfunreproject anonfunapply applyReprojectorscala at filodbcorereprojectorDefaultReprojectoranonfunreproject anonfunapply applyReprojectorscala at scalacollectionTraversableLikeanonfunmap applyTraversableLikescala at scalacollectionTraversableLikeanonfunmap applyTraversableLikescala at scalacollectionmutableResizableArrayclassforeachResizableArrayscala at scalacollectionmutableArrayBufferforeachArrayBufferscala at scalacollectionTraversableLikeclassmapTraversableLikescala at scalacollectionAbstractTraversablemapTraversablescala at filodbcorereprojectorDefaultReprojectoranonfunreproject applyReprojectorscala at filodbcorereprojectorDefaultReprojectoranonfunreproject applyReprojectorscala at scalaconcurrentimplFuturePromiseCompletingRunnableliftedTree Futurescala at scalaconcurrentimplFuturePromiseCompletingRunnablerunFuturescala at javautilconcurrentThreadPoolExecutorrunWorkerThreadPoolExecutorjava at javautilconcurrentThreadPoolExecutorWorkerrunThreadPoolExecutorjava at javalangThreadrunThreadjava ERROR OneForOneStrategy javalangNullPointerException at orgvelviafilovectorsUTF PtrAppendableaddDataUTF Vectorscala at orgvelviafiloBinaryAppendableVectorclassaddVectorBinaryVectorscala at orgvelviafilovectorsObjectVectoraddVectorObjectVectorscala at orgvelviafiloGrowableVectoraddDataBinaryVectorscala at orgvelviafiloBinaryVectorBuilderaddDataBinaryVectorscala at orgvelviafiloVectorBuilderBaseclassaddVectorBuilderscala at orgvelviafiloBinaryVectorBuilderaddBinaryVectorscala at orgvelviafiloRowToVectorBuilderaddRowRowToVectorBuilderscala at filodbcorestoreChunkSetanonfun applyChunkSetInfoscala at filodbcorestoreChunkSetanonfun applyChunkSetInfoscala at scalacollectionIteratoranon nextIteratorscala at scalacollectionIteratorclassforeachIteratorscala at scalacollectionAbstractIteratorforeachIteratorscala at scalacollectiongenericGrowableclasspluspluseqGrowablescala at scalacollectionmutableArrayBufferpluspluseqArrayBufferscala at scalacollectionmutableArrayBufferpluspluseqArrayBufferscala at scalacollectionTraversableOnceclasstoTraversableOncescala at scalacollectionAbstractIteratortoIteratorscala at scalacollectionTraversableOnceclasstoBufferTraversableOncescala at scalacollectionAbstractIteratortoBufferIteratorscala at scalacollectionTraversableOnceclasstoArrayTraversableOncescala at scalacollectionAbstractIteratortoArrayIteratorscala at filodbcorestoreChunkSetapplyChunkSetInfoscala at filodbcorestoreChunkSetwithSkipsChunkSetInfoscala at filodbcorestoreChunkSetSegmentaddChunkSetSegmentscala at filodbcorereprojectorDefaultReprojectoranonfuntoSegments anonfunapply anonfunapply applymcVspReprojectorscala at filodbcorereprojectorDefaultReprojectoranonfuntoSegments anonfunapply anonfunapply applyReprojectorscala at filodbcorereprojectorDefaultReprojectoranonfuntoSegments anonfunapply anonfunapply applyReprojectorscala at kamontraceTraceContextclasswithNewSegmentTraceContextscala at kamontraceMetricsOnlyContextwithNewSegmentMetricsOnlyContextscala at filodbcorePerftoolssubtracePerftoolsscala at filodbcorereprojectorDefaultReprojectoranonfuntoSegments anonfunapply applyReprojectorscala at filodbcorereprojectorDefaultReprojectoranonfuntoSegments anonfunapply applyReprojectorscala at kamontraceTraceranonfunwithNewContext applyTracerModulescala at kamontraceTracerwithContextTracerModulescala at kamontraceTracerwithNewContextTracerModulescala at kamontraceTracerwithNewContextTracerModulescala at filodbcorereprojectorDefaultReprojectoranonfuntoSegments applyReprojectorscala at filodbcorereprojectorDefaultReprojectoranonfuntoSegments applyReprojectorscala at scalacollectionTraversableLikeanonfunmap applyTraversableLikescala at scalacollectionTraversableLikeanonfunmap applyTraversableLikescala at scalacollectionimmutableListforeachListscala at scalacollectionTraversableLikeclassmapTraversableLikescala at scalacollectionimmutableListmapListscala at filodbcorereprojectorDefaultReprojectortoSegmentsReprojectorscala at filodbcorereprojectorDefaultReprojectoranonfunreproject anonfunapply applyReprojectorscala at filodbcorereprojectorDefaultReprojectoranonfunreproject anonfunapply applyReprojectorscala at scalacollectionTraversableLikeanonfunmap applyTraversableLikescala at scalacollectionTraversableLikeanonfunmap applyTraversableLikescala at scalacollectionmutableResizableArrayclassforeachResizableArrayscala at scalacollectionmutableArrayBufferforeachArrayBufferscala at scalacollectionTraversableLikeclassmapTraversableLikescala at scalacollectionAbstractTraversablemapTraversablescala at filodbcorereprojectorDefaultReprojectoranonfunreproject applyReprojectorscala at filodbcorereprojectorDefaultReprojectoranonfunreproject applyReprojectorscala at scalaconcurrentimplFuturePromiseCompletingRunnableliftedTree Futurescala at scalaconcurrentimplFuturePromiseCompletingRunnablerunFuturescala at javautilconcurrentThreadPoolExecutorrunWorkerThreadPoolExecutorjava at javautilconcurrentThreadPoolExecutorWorkerrunThreadPoolExecutorjava at javalangThreadrunThreadjava WARN NodeCoordinatorActor Actor Actor akkafilosparkusercoordinatordscoordparDFNF has terminated Ingestion for filodbparDFNF will stop WARN RddRowSourceActor filodbparDFNF No Acks received for last seconds WARN RddRowSourceActor filodbparDFNF No Acks received for last seconds Steps to reproduce scala val filesSeqrootFiloDBFiloDBparquetfilefragment datrootFiloDBFiloDBparquetfilefragment dat files Seq String ListrootFiloDBFiloDBparquetfilefragment dat rootFiloDBFiloDBparquetfilefragment dat scala val parDFsqlContextreadparquetfiles SLF J Failed to load class orgslf jimplStaticLoggerBinder SLF J Defaulting to nooperation NOP logger implementation SLF J See for further details WARN General Plugin Bundle orgdatanucleus is already registered Ensure you dont have multiple JAR versions of the same plugin in the classpath The URL filerootFiloDBspark binhadoop jarsdatanucleuscore jar is already registered and you are trying to register an identical plugin located at URL filerootFiloDBsparkjarsdatanucleuscore jar WARN General Plugin Bundle orgdatanucleusstorerdbms is already registered Ensure you dont have multiple JAR versions of the same plugin in the classpath The URL filerootFiloDBspark binhadoop jarsdatanucleusrdbms jar is already registered and you are trying to register an identical plugin located at URL filerootFiloDBsparkjarsdatanucleusrdbms jar WARN General Plugin Bundle orgdatanucleusapijdo is already registered Ensure you dont have multiple JAR versions of the same plugin in the classpath The URL filerootFiloDBspark binhadoop jarsdatanucleusapijdo jar is already registered and you are trying to register an identical plugin located at URL filerootFiloDBsparkjarsdatanucleusapijdo jar parDF orgapachesparksqlDataFrame epoch bigint rowNum bigint more fields scala val parDFnewparDFwithColumnexporterIp exporterIpcastStringwithColumnsrcIp srcIpcastStringwithColumndstIp dstIpcastStringwithColumnnextHopIp nextHopIpcastStringwithColumnbgpNextHopIp bgpNextHopIpcastStringwithColumnappId appIdcastStringwithColumnpolicyQosClassificationHierarchy policyQosClassificationHierarchycastStringwithColumnprotocolId protocolIdcastIntwithColumnsrcTos srcToscastIntwithColumndstTos dstToscastIntwithColumnsrcMask srcMaskcastIntwithColumndstMask dstMaskcastIntwithColumndirection directioncastStringselectepoch srcIp dstIp exporterIp rowNum exportMs pktSeqNum flowSeqNum protocolId srcTos dstTos srcMask dstMask tcpBits srcPort inIfId inIfEntityId inIfEnabled dstPort outIfId outIfEntityId outIfEnabled direction inOctets outOctets inPackets outPackets nextHopIp bgpSrcAsNum bgpDstAsNum bgpNextHopIp endMs startMs appId appName srcIpGroup dstIpGroup policyQosClassificationHierarchy policyQosQueueId workerId parDFnew orgapachesparksqlDataFrame epoch bigint srcIp string more fields parDFnewwriteformatfilodbspark optiondataset parDFNF optionrowkeys appId optionpartitionkeys exportMs modeSaveModeOverwritesave Logs some log or as attached file see below Unused parts of this template should be removed including this line dsespark branch For example select from loadtestfdbpartitiontestchunks where partition x and version This query gives me data when i run it against C But when i translate this query as a thrift query then no data returned select from fdbloadtestpartitiontest where field a and field b and field c and field d and field e and field f