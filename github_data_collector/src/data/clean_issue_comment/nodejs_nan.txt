This PR aims to improve the existing Async Workers using C features For the time being only AsyncProgressQueueWorker was improved The improvements include Memory management using smart pointers ie uniqueptr to prevent memory leaks in case of exceptions Modern memory management techniques ie stdalignedalloc and stduninitializedcopy which remove the necessity of the MessageStruct being default constructible Better locking of critical sections ie stdmutex instead of libuvs mutexes and lockguard to prevent locking forever in case of error A new API which allows progress messages to be put into the queue without being copies using stduniqueptr Fast paths if the legacy API is used and the progress message class is trivially copyable As mentioned above the legacy API SendProgressconst T const messages const sizet nMessages is still supported but marked as deprecated Therefore this works as a dropin replacement even for C Additionally the unmodified legacy workers are still there and used if the C version is below C This is not ready to merged yet for some reasons It is entirely untested at the moment Its not possible to test it with the current configuration The node headers force the usage of stdgnu y but C is required for this An stdbadalloc exception should be thrown in case of error but the node headers force fnoexceptions Documentation is missing The last signed version I was able to find was the latest tag is not signed This PR adds NanNewv Stringstdstringview which makes it easier to handle compile time known strings In order to maintan backwards compatibility to C a NANHASCPLUSPLUS macro is added which will also be needed for my next PRs the code is wrapped into NANENABLESTRINGVIEW guards If the user wishes to disable the usage of stringview it can be disabled via adding a define DNANENABLESTRINGVIEWfalse otherwise it is automatically enabled if its supported by the C runtime C and up There are a few issues around GCC warnings appearing that NAN cant fix because the warnings are generated in the Node headers themselves This patch disables the warnings for GCC and reenables them again before leaving nanh hiding the warnings that cant be fixed by NAN while at the same time leaving them enabled in code belonging to anyone using the library In my opinion this is better than adjusting the compiler flags which will hide the warnings from user code as well There is already code for MSVC that does a similar thing so hopefully adding some for GCC as well will be ok Hi Due to the following line T newdata new T count in the AsyncProgressQueueWorker class T your progress class is required to have a default constructor I have prepared a patch which makes use of C stdalignedalloc and stduninitializedcopy features and removes the necessity of the progress struct having a default constructor Should I wrap the patch in a feature guard cplusplus macro check and file a merge request There is a dev dependency in packagejson request but I dont see its used anywhere Thank you for reporting an issue The more information you can give us the better the chance we can fix your problem This issue tracker is for issues with nodegyp if you have an issue installing a specific module please file an issue on that modules issue tracker npm issues modulename Node Version and npm version and tsc version v and and Platform Darwin mac Darwin Kernel Version Tue Aug PDT rootxnu RELEASEX x Compiler Apple LLVM version clang Target x appledarwin Thread model posix InstalledDir LibraryDeveloperCommandLineToolsusrbin Module npm ci or npm install for my project could be an issue in bunyan or dtrace which is not a direct dependency in my project Os version macOS Mojave detailssummaryVerbose output from npm or nodegypsummary machine srccode npm install dtraceprovider install Usersmm SourceCodecdmfoundersnodemodulesdtraceprovider nodegyp rebuild node suppresserrorjs LDLIBRARYPATHUsersmm SourceCodecdmfoundersnodemodulesdtraceproviderbuildReleaselibhostUsersmm SourceCodecdmfoundersnodemodulesdtraceproviderbuildReleaselibtargetLDLIBRARYPATH export LDLIBRARYPATH cd bash buildsh buildUSDT z z Usersmm SourceCodecdmfounders unset MAKEFLAGS node e consolelogprocessarch x x i export ARCHx ARCHx echo Building libusdt for x Building libusdt for x z which gmake MAKE z MAKEmake make C libusdt clean all rm f gch rm f o rm f libusdta rm f testusdt rm f testusdt rm f testusdt rm f testmemusage gcc O Wall arch x c o usdto usdtc gcc O Wall arch x c o usdtdoffileo usdtdoffilec gcc arch x o usdttracepointso c usdttracepointsx s gcc O Wall arch x c o usdtprobeo usdtprobec gcc O Wall arch x c o usdtdofo usdtdofc gcc O Wall arch x c o usdtdofsectionso usdtdofsectionsc rm f libusdta ar cru libusdta usdto usdtdoffileo usdttracepointso usdtprobeo usdtdofo usdtdofsectionso ranlib libusdta LIBUSDTSTATUS ne buildNDTP z z Usersmm SourceCodecdmfounders nodegyp rebuild C src c DNODEGYPMODULENAMEDTraceProviderBindings DUSINGUVSHARED DUSINGV SHARED DV DEPRECATIONWARNINGS DV DEPRECATIONWARNINGS DV IMMINENTDEPRECATIONWARNINGS DDARWINUSE BITINODE DLARGEFILESOURCE DFILEOFFSETBITS DOPENSSLNOPINSHARED DOPENSSLTHREADS DBUILDINGNODEEXTENSION IUsersmm LibraryCachesnodegyp includenode IUsersmm LibraryCachesnodegyp src IUsersmm LibraryCachesnodegyp depsopensslconfig IUsersmm LibraryCachesnodegyp depsopensslopensslinclude IUsersmm LibraryCachesnodegyp depsuvinclude IUsersmm LibraryCachesnodegyp depszlib IUsersmm LibraryCachesnodegyp depsv include Ilibusdt Inan Os gdwarf mmacosxversionmin arch x Wall Wendiflabels W Wnounusedparameter stdgnu y stdliblibc fnortti fnoexceptions fnostrictaliasing MMD MF ReleasedepsReleaseobjtargetDTraceProviderBindingsdtraceproviderodraw c o ReleaseobjtargetDTraceProviderBindingsdtraceprovidero dtraceprovidercc In file included from dtraceprovidercc In file included from dtraceproviderh In file included from nannanh In file included from nannanconvertersh nannanconverters inlh warning ToBoolean is deprecated ToBoolean can never throw Use Local version Wdeprecateddeclarations XBoolean nannanconverters inlh note expanded from macro X valTo TYPEisolateGetCurrentContext scratch space note expanded from here ToBoolean Usersmm LibraryCachesnodegyp includenodev h note ToBoolean has been explicitly marked deprecated here V DEPRECATEDToBoolean can never throw Use Local version Usersmm LibraryCachesnodegyp includenodev configh note expanded from macro V DEPRECATED declarator attributedeprecatedmessage In file included from dtraceprovidercc In file included from dtraceproviderh In file included from nannanh In file included from nannanconvertersh nannanconverters inlh warning BooleanValue is deprecated BooleanValue can never throw Use Isolate version Wdeprecateddeclarations Xbool Boolean nannanconverters inlh note expanded from macro X return valNAME ValueisolateGetCurrentContext scratch space note expanded from here BooleanValue Usersmm LibraryCachesnodegyp includenodev h note BooleanValue has been explicitly marked deprecated here V DEPRECATEDBooleanValue can never throw Use Isolate version Usersmm LibraryCachesnodegyp includenodev configh note expanded from macro V DEPRECATED declarator attributedeprecatedmessage In file included from dtraceprovidercc In file included from dtraceproviderh In file included from nannanh In file included from nannannewh nannanimplementation inlh error too few arguments to function call expected have return v StringObjectNewvalueAsv StringObject Usersmm LibraryCachesnodegyp includenodev h note New declared here static LocalValue NewIsolate isolate LocalString value In file included from dtraceprovidercc In file included from dtraceproviderh In file included from nannanh In file included from nannannewh nannanimplementation inlh error expected for functionstyle cast or type construction return v StringObjectNewvalueAsv StringObject nannanimplementation inlh error expected expression return v StringObjectNewvalueAsv StringObject In file included from dtraceprovidercc In file included from dtraceproviderh In file included from nannanh nannanobjectwraph error no member named IsNearDeath in NanPersistentv Object v NonCopyablePersistentTraitsv Object assertpersistentIsNearDeath LibraryDeveloperCommandLineToolsSDKsMacOSX sdkusrincludeasserth note expanded from macro assert builtinexpecte assertrtnfunc FILE LINE e void In file included from dtraceprovidercc In file included from dtraceproviderh In file included from nannanh nannanobjectwraph error no member named IsNearDeath in NanPersistentv Object v NonCopyablePersistentTraitsv Object assertwraphandleIsNearDeath LibraryDeveloperCommandLineToolsSDKsMacOSX sdkusrincludeasserth note expanded from macro assert builtinexpecte assertrtnfunc FILE LINE e void dtraceprovidercc error too few arguments to function call single argument context was not specified targetSetNanNewStringDTraceProviderToLocalChecked tGetFunction Usersmm LibraryCachesnodegyp includenodev h note GetFunction declared here V WARNUNUSEDRESULT MaybeLocalFunction GetFunction Usersmm LibraryCachesnodegyp includenodev configh note expanded from macro V WARNUNUSEDRESULT define V WARNUNUSEDRESULT attributewarnunusedresult dtraceprovidercc error no matching member function for call to ToString StringUtf Value nameinfo ToString Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument context but no arguments were provided V WARNUNUSEDRESULT MaybeLocalString ToString Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument isolate but no arguments were provided LocalString ToStringIsolate isolate const dtraceprovidercc error no matching member function for call to ToString StringUtf Value modinfo ToString Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument context but no arguments were provided V WARNUNUSEDRESULT MaybeLocalString ToString Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument isolate but no arguments were provided LocalString ToStringIsolate isolate const dtraceprovidercc error too few arguments to function call single argument context was not specified NanNewFunctionTemplateDTraceProbeconstructortemplateGetFunction Usersmm LibraryCachesnodegyp includenodev h note GetFunction declared here V WARNUNUSEDRESULT MaybeLocalFunction GetFunction Usersmm LibraryCachesnodegyp includenodev configh note expanded from macro V WARNUNUSEDRESULT define V WARNUNUSEDRESULT attributewarnunusedresult dtraceprovidercc error no matching member function for call to ToObject DTraceProbe probe NanObjectWrapUnwrapDTraceProbepdToObject Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument context but no arguments were provided V WARNUNUSEDRESULT MaybeLocalObject ToObject Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument isolate but no arguments were provided LocalObject ToObjectIsolate isolate const dtraceprovidercc error no matching member function for call to ToString objSetinfo ToString pd Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument context but no arguments were provided V WARNUNUSEDRESULT MaybeLocalString ToString Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument isolate but no arguments were provided LocalString ToStringIsolate isolate const dtraceprovidercc warning ForceSet is deprecated Wdeprecateddeclarations NanForceSetpd NanNewStringprovToLocalChecked obj nannanmaybe inlh note ForceSet has been explicitly marked deprecated here NANDEPRECATED inline Maybebool ForceSet nannanh note expanded from macro NANDEPRECATED define NANDEPRECATED attributedeprecated dtraceprovidercc error no matching member function for call to ToString StringUtf Value typeinfo i ToString Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument context but no arguments were provided V WARNUNUSEDRESULT MaybeLocalString ToString Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument isolate but no arguments were provided LocalString ToStringIsolate isolate const dtraceprovidercc error no matching member function for call to ToString StringUtf Value nameinfo ToString Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument context but no arguments were provided V WARNUNUSEDRESULT MaybeLocalString ToString Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument isolate but no arguments were provided LocalString ToStringIsolate isolate const dtraceprovidercc error no matching member function for call to Delete providerobjDeletename Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires arguments but was provided V WARNUNUSEDRESULT Maybebool DeleteLocalContext context Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires arguments but was provided V WARNUNUSEDRESULT Maybebool DeleteLocalContext context warnings and errors generated make ReleaseobjtargetDTraceProviderBindingsdtraceprovidero Error gyp ERR build error gyp ERR stack Error make failed with exit code gyp ERR stack at ChildProcessonExit usrlocallibnodemodulesnpmnodemodulesnodegyplibbuildjs gyp ERR stack at ChildProcessemit eventsjs gyp ERR stack at ProcessChildProcesshandleonexit internalchildprocessjs gyp ERR System Darwin gyp ERR command usrlocalbinnode usrlocallibnodemodulesnpmnodemodulesnodegypbinnodegypjs rebuild C src gyp ERR cwd Usersmm SourceCodecdmfoundersnodemodulesdtraceprovidersrc gyp ERR node v v gyp ERR nodegyp v v gyp ERR not ok NODEGYPSTATUS ne fail z z Usersmm SourceCodecdmfounders h a r d exit touch Releaseobjtargetndtpstamp added packages from contributors and audited packages in s found vulnerabilities low high run npm audit fix to fix them or npm audit for details MM M cdmfounders mm rm rf nodemodules MM M cdmfounders mm npm ci dtraceprovider install Usersmm SourceCodecdmfoundersnodemodulesdtraceprovider nodegyp rebuild node suppresserrorjs gyp info it worked if it ends with ok gyp info using nodegyp gyp info using node darwin x gyp info find Python using Python version found at usrbinpython gyp info spawn usrbinpython gyp info spawn args gyp info spawn args usrlocallibnodemodulesnpmnodemodulesnodegypgypgypmainpy gyp info spawn args bindinggyp gyp info spawn args f gyp info spawn args make gyp info spawn args I gyp info spawn args Usersmm SourceCodecdmfoundersnodemodulesdtraceproviderbuildconfiggypi gyp info spawn args I gyp info spawn args usrlocallibnodemodulesnpmnodemodulesnodegypaddongypi gyp info spawn args I gyp info spawn args Usersmm LibraryCachesnodegyp includenodecommongypi gyp info spawn args Dlibrarysharedlibrary gyp info spawn args Dvisibilitydefault gyp info spawn args DnoderootdirUsersmm LibraryCachesnodegyp gyp info spawn args Dnodegypdirusrlocallibnodemodulesnpmnodemodulesnodegyp gyp info spawn args DnodelibfileUsersmm LibraryCachesnodegyp targetarchnodelib gyp info spawn args DmodulerootdirUsersmm SourceCodecdmfoundersnodemodulesdtraceprovider gyp info spawn args Dnodeenginev gyp info spawn args depth gyp info spawn args noparallel gyp info spawn args generatoroutput gyp info spawn args build gyp info spawn args Goutputdir gyp info spawn args gyp info spawn make gyp info spawn args BUILDTYPERelease C build LDLIBRARYPATHUsersmm SourceCodecdmfoundersnodemodulesdtraceproviderbuildReleaselibhostUsersmm SourceCodecdmfoundersnodemodulesdtraceproviderbuildReleaselibtargetLDLIBRARYPATH export LDLIBRARYPATH cd bash buildsh buildUSDT z z Usersmm SourceCodecdmfounders unset MAKEFLAGS node e consolelogprocessarch x x i export ARCHx ARCHx echo Building libusdt for x Building libusdt for x z which gmake MAKE z MAKEmake make C libusdt clean all rm f gch rm f o rm f libusdta rm f testusdt rm f testusdt rm f testusdt rm f testmemusage gcc O Wall arch x c o usdto usdtc gcc O Wall arch x c o usdtdoffileo usdtdoffilec gcc arch x o usdttracepointso c usdttracepointsx s gcc O Wall arch x c o usdtprobeo usdtprobec gcc O Wall arch x c o usdtdofo usdtdofc gcc O Wall arch x c o usdtdofsectionso usdtdofsectionsc rm f libusdta ar cru libusdta usdto usdtdoffileo usdttracepointso usdtprobeo usdtdofo usdtdofsectionso ranlib libusdta LIBUSDTSTATUS ne buildNDTP z z Usersmm SourceCodecdmfounders nodegyp rebuild C src gyp info it worked if it ends with ok gyp info using nodegyp gyp info using node darwin x gyp info chdir src gyp info find Python using Python version found at usrbinpython gyp info spawn usrbinpython gyp info spawn args gyp info spawn args usrlocallibnodemodulesnpmnodemodulesnodegypgypgypmainpy gyp info spawn args bindinggyp gyp info spawn args f gyp info spawn args make gyp info spawn args I gyp info spawn args Usersmm SourceCodecdmfoundersnodemodulesdtraceprovidersrcbuildconfiggypi gyp info spawn args I gyp info spawn args usrlocallibnodemodulesnpmnodemodulesnodegypaddongypi gyp info spawn args I gyp info spawn args Usersmm LibraryCachesnodegyp includenodecommongypi gyp info spawn args Dlibrarysharedlibrary gyp info spawn args Dvisibilitydefault gyp info spawn args DnoderootdirUsersmm LibraryCachesnodegyp gyp info spawn args Dnodegypdirusrlocallibnodemodulesnpmnodemodulesnodegyp gyp info spawn args DnodelibfileUsersmm LibraryCachesnodegyp targetarchnodelib gyp info spawn args DmodulerootdirUsersmm SourceCodecdmfoundersnodemodulesdtraceprovidersrc gyp info spawn args Dnodeenginev gyp info spawn args depth gyp info spawn args noparallel gyp info spawn args generatoroutput gyp info spawn args build gyp info spawn args Goutputdir gyp info spawn args gyp info spawn make gyp info spawn args BUILDTYPERelease C build c DNODEGYPMODULENAMEDTraceProviderBindings DUSINGUVSHARED DUSINGV SHARED DV DEPRECATIONWARNINGS DV DEPRECATIONWARNINGS DV IMMINENTDEPRECATIONWARNINGS DDARWINUSE BITINODE DLARGEFILESOURCE DFILEOFFSETBITS DOPENSSLNOPINSHARED DOPENSSLTHREADS DBUILDINGNODEEXTENSION IUsersmm LibraryCachesnodegyp includenode IUsersmm LibraryCachesnodegyp src IUsersmm LibraryCachesnodegyp depsopensslconfig IUsersmm LibraryCachesnodegyp depsopensslopensslinclude IUsersmm LibraryCachesnodegyp depsuvinclude IUsersmm LibraryCachesnodegyp depszlib IUsersmm LibraryCachesnodegyp depsv include Ilibusdt Inan Os gdwarf mmacosxversionmin arch x Wall Wendiflabels W Wnounusedparameter stdgnu y stdliblibc fnortti fnoexceptions fnostrictaliasing MMD MF ReleasedepsReleaseobjtargetDTraceProviderBindingsdtraceproviderodraw c o ReleaseobjtargetDTraceProviderBindingsdtraceprovidero dtraceprovidercc In file included from dtraceprovidercc In file included from dtraceproviderh In file included from nannanh In file included from nannanconvertersh nannanconverters inlh warning ToBoolean is deprecated ToBoolean can never throw Use Local version Wdeprecateddeclarations XBoolean nannanconverters inlh note expanded from macro X valTo TYPEisolateGetCurrentContext scratch space note expanded from here ToBoolean Usersmm LibraryCachesnodegyp includenodev h note ToBoolean has been explicitly marked deprecated here V DEPRECATEDToBoolean can never throw Use Local version Usersmm LibraryCachesnodegyp includenodev configh note expanded from macro V DEPRECATED declarator attributedeprecatedmessage In file included from dtraceprovidercc In file included from dtraceproviderh In file included from nannanh In file included from nannanconvertersh nannanconverters inlh warning BooleanValue is deprecated BooleanValue can never throw Use Isolate version Wdeprecateddeclarations Xbool Boolean nannanconverters inlh note expanded from macro X return valNAME ValueisolateGetCurrentContext scratch space note expanded from here BooleanValue Usersmm LibraryCachesnodegyp includenodev h note BooleanValue has been explicitly marked deprecated here V DEPRECATEDBooleanValue can never throw Use Isolate version Usersmm LibraryCachesnodegyp includenodev configh note expanded from macro V DEPRECATED declarator attributedeprecatedmessage In file included from dtraceprovidercc In file included from dtraceproviderh In file included from nannanh In file included from nannannewh nannanimplementation inlh error too few arguments to function call expected have return v StringObjectNewvalueAsv StringObject Usersmm LibraryCachesnodegyp includenodev h note New declared here static LocalValue NewIsolate isolate LocalString value In file included from dtraceprovidercc In file included from dtraceproviderh In file included from nannanh In file included from nannannewh nannanimplementation inlh error expected for functionstyle cast or type construction return v StringObjectNewvalueAsv StringObject nannanimplementation inlh error expected expression return v StringObjectNewvalueAsv StringObject In file included from dtraceprovidercc In file included from dtraceproviderh In file included from nannanh nannanobjectwraph error no member named IsNearDeath in NanPersistentv Object v NonCopyablePersistentTraitsv Object assertpersistentIsNearDeath LibraryDeveloperCommandLineToolsSDKsMacOSX sdkusrincludeasserth note expanded from macro assert builtinexpecte assertrtnfunc FILE LINE e void In file included from dtraceprovidercc In file included from dtraceproviderh In file included from nannanh nannanobjectwraph error no member named IsNearDeath in NanPersistentv Object v NonCopyablePersistentTraitsv Object assertwraphandleIsNearDeath LibraryDeveloperCommandLineToolsSDKsMacOSX sdkusrincludeasserth note expanded from macro assert builtinexpecte assertrtnfunc FILE LINE e void dtraceprovidercc error too few arguments to function call single argument context was not specified targetSetNanNewStringDTraceProviderToLocalChecked tGetFunction Usersmm LibraryCachesnodegyp includenodev h note GetFunction declared here V WARNUNUSEDRESULT MaybeLocalFunction GetFunction Usersmm LibraryCachesnodegyp includenodev configh note expanded from macro V WARNUNUSEDRESULT define V WARNUNUSEDRESULT attributewarnunusedresult dtraceprovidercc error no matching member function for call to ToString StringUtf Value nameinfo ToString Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument context but no arguments were provided V WARNUNUSEDRESULT MaybeLocalString ToString Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument isolate but no arguments were provided LocalString ToStringIsolate isolate const dtraceprovidercc error no matching member function for call to ToString StringUtf Value modinfo ToString Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument context but no arguments were provided V WARNUNUSEDRESULT MaybeLocalString ToString Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument isolate but no arguments were provided LocalString ToStringIsolate isolate const dtraceprovidercc error too few arguments to function call single argument context was not specified NanNewFunctionTemplateDTraceProbeconstructortemplateGetFunction Usersmm LibraryCachesnodegyp includenodev h note GetFunction declared here V WARNUNUSEDRESULT MaybeLocalFunction GetFunction Usersmm LibraryCachesnodegyp includenodev configh note expanded from macro V WARNUNUSEDRESULT define V WARNUNUSEDRESULT attributewarnunusedresult dtraceprovidercc error no matching member function for call to ToObject DTraceProbe probe NanObjectWrapUnwrapDTraceProbepdToObject Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument context but no arguments were provided V WARNUNUSEDRESULT MaybeLocalObject ToObject Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument isolate but no arguments were provided LocalObject ToObjectIsolate isolate const dtraceprovidercc error no matching member function for call to ToString objSetinfo ToString pd Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument context but no arguments were provided V WARNUNUSEDRESULT MaybeLocalString ToString Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument isolate but no arguments were provided LocalString ToStringIsolate isolate const dtraceprovidercc warning ForceSet is deprecated Wdeprecateddeclarations NanForceSetpd NanNewStringprovToLocalChecked obj nannanmaybe inlh note ForceSet has been explicitly marked deprecated here NANDEPRECATED inline Maybebool ForceSet nannanh note expanded from macro NANDEPRECATED define NANDEPRECATED attributedeprecated dtraceprovidercc error no matching member function for call to ToString StringUtf Value typeinfo i ToString Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument context but no arguments were provided V WARNUNUSEDRESULT MaybeLocalString ToString Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument isolate but no arguments were provided LocalString ToStringIsolate isolate const dtraceprovidercc error no matching member function for call to ToString StringUtf Value nameinfo ToString Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument context but no arguments were provided V WARNUNUSEDRESULT MaybeLocalString ToString Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires single argument isolate but no arguments were provided LocalString ToStringIsolate isolate const dtraceprovidercc error no matching member function for call to Delete providerobjDeletename Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires arguments but was provided V WARNUNUSEDRESULT Maybebool DeleteLocalContext context Usersmm LibraryCachesnodegyp includenodev h note candidate function not viable requires arguments but was provided V WARNUNUSEDRESULT Maybebool DeleteLocalContext context warnings and errors generated make ReleaseobjtargetDTraceProviderBindingsdtraceprovidero Error gyp ERR build error gyp ERR stack Error make failed with exit code gyp ERR stack at ChildProcessonExit usrlocallibnodemodulesnpmnodemodulesnodegyplibbuildjs gyp ERR stack at ChildProcessemit eventsjs gyp ERR stack at ProcessChildProcesshandleonexit internalchildprocessjs gyp ERR System Darwin gyp ERR command usrlocalbinnode usrlocallibnodemodulesnpmnodemodulesnodegypbinnodegypjs rebuild C src gyp ERR cwd Usersmm SourceCodecdmfoundersnodemodulesdtraceprovidersrc gyp ERR node v v gyp ERR nodegyp v v gyp ERR not ok NODEGYPSTATUS ne fail z z Usersmm SourceCodecdmfounders h a r d exit touch Releaseobjtargetndtpstamp gyp info ok added packages in s details Build with this throws the following error srccode buildcompile path tsc p tsconfigjson error TS Cannot find type definition file for bunyan error TS Cannot find type definition file for restify error TS Cannot find type definition file for spdy error TS Cannot find type definition file for validator Packagelock of secondary and tertiary dependency of dtraceprovider and NAN respectively looks like dtraceprovider version resolved integrity sha JObTT GIMgwc APQ tftBPQQ optional true requires nan nan version resolved integrity sha JY V lRkStKcKTvHO NVSQRvRVFIL pvDoLiAtSL pKlC x PKQcZDsq m FO d mkhC ZQhAh Jdk JFw optional true I discovered this while running the nan test suite against Electron on our CI we run tests with DCHECKs enabled Just to cover my bases I ran the same nan tests against a Debug build of node and the same DCHECKs were hit Fatal error in depsv srcapiinlh line Debug check failed allowemptyhandle that nullptr FailureMessage Object x ffeefbfc a not ok testjsnannewtestjs Command UserssattardprojectsnodejsnodeoutDebugnode nannewtestjs TAP version ok cppnannewcpp NewArrayLength ok cppnannewcpp NewArray Length ok cppnannewcpp assertTypeArrayNewArray ok cppnannewcpp NewBooleantrueValue true ok cppnannewcpp NewBooleanfalseValue false ok cppnannewcpp assertTypeBoolean NewBooleantrue ok cppnannewcpp NewtrueValue true ok cppnannewcpp NewfalseValue false ok cppnannewcpp assertTypeBoolean Newtrue ok cppnannewcpp assertTypeBooleanObject NewBooleanObjecttrue ok cppnannewcpp NewBooleanObjecttrueValueOf true ok cppnannewcpp NewBooleanObjectfalseValueOf false ok cppnannewcpp assertTypeContext NewContext ok cppnannewcpp assertTypeContext NewContext extensions ok cppnannewcpp assertTypeContext NewContextstaticcastExtensionConfiguration null LocalObjectTemplate ok cppnannewcpp assertTypeContext NewContext extensions LocalObjectTemplate ok cppnannewcpp assertTypeContext NewContext extensions LocalObjectTemplate LocalValue ok cppnannewcpp assertTypeDate NewDatestaticcastdoubletimenullToLocalChecked ok cppnannewcpp NewExternal tttValue ttt ok cppnannewcpp assertTypeExternalNewExternal ttt ok cppnannewcpp assertTypeFunctionNewFunctiontestFunction ok cppnannewcpp assertTypeFunctionNewFunctiontestFunction data not ok testjsnannewtestjs exit signal SIGILL stderr Fatal error in depsv srcapiinlh line Debug check failed allowemptyhandle that nullptr FailureMessage Object x ffeefbfc a command UserssattardprojectsnodejsnodeoutDebugnode nannewtestjs tests pass fail The same tests pass in Release builds as DCHECKs are disabled but I think some time should be spent figuring out what is going wrong here as V clearly isnt happy with what is happening To reproduce with a local build of node with a directory structure of nodejs node nan bash Build node headers cd nodejsnode configure debug make j make tarheaders tar xzf nodev headerstargz cd nan Build nan test modules with right headers npmconfignodedirpwdnodenodev npx nodegyp rebuild directory test Run nan tests with built version of node nodeoutDebugnode nodemodulesbintap testjstestjs Note that although the example above uses HEAD of node v I have reproed with v as well which is what Electron currently ships In my c library I have the following c typedef void updatecallbackLibClass data void setCallbackupdatecallback callback thiscallback callback Using nan I am assigning the persistent function to be called from js using a setUpdateCallback function eg js myClasssetUpdateCallbackfunction consolelogHello setUpdateCallback calls this nan function c void MyClassSetUpdateCallbackconst NanFunctionCallbackInfov Value info get the object MyClass obj ObjectWrapUnwrapMyClassinfoHolder I have tried a million combinations this one is the latest try v Isolate isolate v IsolateGetCurrent v Handlev Function callback v Handlev FunctionCastinfo v Persistentv Function callbackpersistentisolate callback objcb callbackpersistent assign the callback lib here is the custom class that the NanObjectWrap contains as a variable objlibsetCallbackMyClassUpdate return the class this can be ommited infoGetReturnValueSetinfoThis And the MyClassUpdate does the followng c void MyClassUpdateLibClass libClass get the obj related to the current LibClass libs here is a map with pairLibClass MyClass MyClass parent libsatlibClass create callback v Isolate isolate v IsolateGetCurrent v HandleScope scopeisolate v Localv Function callback v Localv FunctionNewisolate parentcb NanCallcallback NanGetCurrentContextGlobal NULL calling the callback twice works successfully NanCallcallback NanGetCurrentContextGlobal NULL The libClass does not produce a callback MyClass should set the callback function to call and throughout the programs execution libClass will call the update function at random times based on some data So what I want to do is to set that callback function in javascript and be able to call it whenever I want from the libClass but it never works It works on initialization and after that it seems that it is being called by the garbage collector even though its a persistent function I am new to both C and Nan and none of the solutions found on the internet were helpful they were all implementations of callbacks so am I missing something Node added Contextaware addons using the NODEMODULEINITIALIZER To be able to make such an addon with compatibility with older versions we need a corresponding macro in nan