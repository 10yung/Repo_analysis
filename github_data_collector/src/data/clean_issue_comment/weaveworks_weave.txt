Is there a chance to use weave CNI plugin with podman I tried to start weaveexec with sudo podman loglevel debug run rm privileged net host pid host v host e HOSTROOThost e DOCKERHUBUSERweaveworks e WEAVEVERSION e WEAVEDEBUG e WEAVEDOCKERARGS e WEAVEPASSWORD e WEAVEPORT e WEAVEHTTPADDR e WEAVESTATUSADDR e WEAVECONTAINERNAME e WEAVEMTU e WEAVENOFASTDP e WEAVENOBRIDGEDFASTDP e DOCKERBRIDGE e DOCKERCLIENTHOST e DOCKERCLIENTARGS e PROXYHOST e COVERAGE e CHECKPOINTDISABLE e AWSVPC weaveworksweaveexec local launch Got Failed to get netdev for docker bridge Link not found Here an excerpt of the debug log bash INFO Running conmon under slice machineslice and unitName libpodconmon a eac f ed d e cb bc f dce a ce fa aa descope DEBU Received INFO Got Conmon PID as DEBU Created container a eac f ed d e cb bc f dce a ce fa aa de in OCI runtime DEBU Attaching to container a eac f ed d e cb bc f dce a ce fa aa de DEBU connecting to socket varrunlibpodsocket a eac f ed d e cb bc f dce a ce fa aa deattach DEBU Starting container a eac f ed d e cb bc f dce a ce fa aa de with command homeweavesigproxy homeweaveweave local launch DEBU Started container a eac f ed d e cb bc f dce a ce fa aa de DEBU Enabling signal proxying Failed to get netdev for docker bridge Link not found DEBU Cleaning up container a eac f ed d e cb bc f dce a ce fa aa de DEBU Network is already cleaned up skipping DEBU unmounted container a eac f ed d e cb bc f dce a ce fa aa de DEBU Successfully cleaned up container a eac f ed d e cb bc f dce a ce fa aa de DEBU Container a eac f ed d e cb bc f dce a ce fa aa de storage is already unmounted skipping DEBU graphdriver trying provided driver overlay DEBU cached value indicated that overlay is supported DEBU cached value indicated that metacopy is not being used DEBU backingFsextfs projectQuotaSupportedfalse useNativeDifftrue usingMetacopyfalse Here my images bash sudo podman images REPOSITORY TAG IMAGE ID CREATED SIZE dockeriolibraryalpine latest e a a c c weeks ago MB dockerioweaveworksweavedb latest eac months ago kB dockerioweaveworksweaveexec ac cb ee months ago MB dockerioweaveworksweave d dc f e months ago MB k sgcriopause Here the defined rootful networks bash sudo podman network ls NAME VERSION PLUGINS weave weavenetportmap podman bridgeportmapfirewall Here the content of etccninetd weaveconflist bash cat weaveconflist cniVersion name weave plugins name weave type weavenet hairpinMode true type portmap capabilities portMappings true snat true Here the libpod config file NOTE I changed the container runtime runc with crun bash cat homepodmanconfigcontainerslibpodconf volumepath homepodmanlocalsharecontainersstoragevolumes imagedefaulttransport docker runtime crun runtimesupportsjson crun runtimesupportsnocgroups crun conmonpath usrlibexecpodmanconmon usrlocallibexecpodmanconmon usrlocallibpodmanconmon usrbinconmon usrsbinconmon usrlocalbinconmon usrlocalsbinconmon runcurrentsystemswbinconmon conmonenvvars PATHusrlocalsbinusrlocalbinusrsbinusrbinsbinbin cgroupmanager cgroupfs initpath staticdir homepodmanlocalsharecontainersstoragelibpod tmpdir runuser libpodtmp maxlogsize nopivotroot false cniconfigdir etccninetd cniplugindir usrlibexeccni usrlibcni usrlocallibcni optcnibin infraimage k sgcriopause infracommand pause enableportreservation true label true networkcmdpath numlocks locktype shm eventslogger journald eventslogfilepath detachkeys ctrlpctrlq SDNotify false runtimes crun usrbincrun usrlocalbincrun Should I define a custom bridge called docker This PR is adding an additional field in the IPAM config for Weave ips It allows for specifying an IP address through the CNI plugin similar to weave attach and claim that IP I am not sure if it makes sense to configure also checkAlive or to set it to true at all times currently it is set to false Since the IPAM configuration is specific to each plugin I think this is allowed per the CNI spec I am not sure if the choice for ips type is right though this type is used in the Result but it seemed appropriate for the input values of the IPAM as well What you expected to happen So I have servers lets call them A behind NAT and A has publicly available IP address My goal is to achieve peers compatibility as if the server A had public IP How to reproduce it I setup a script on A which forwards TCP port though ssh connection A ssh R A So that I can reach A from A now A telnet Trying Connected to Escape character is weave Great lets add A server to the A peers cat etcsysconfigweave PEERS Lets see if A sees A as a peer A weave status peers bb eae b A ef a d aA pending ef a d aA bb eae b A pending A weave status connections pending encrypted fastdp ef a d aA encryptedtruemtu So far it seems to be working Lets finally test pings A docker run ti netweave e WEAVECIDR ip h a weavelocal weave dnsargs weaveworksubuntu A docker run ti netweave e WEAVECIDR ip h a weavelocal weave dnsargs weaveworksubuntu A ping a weavelocal PING a weavelocal bytes of data From a weavelocal icmpseq Destination Host Unreachable From a weavelocal icmpseq Destination Host Unreachable From a weavelocal icmpseq Destination Host Unreachable C vice versa A ping a weavelocal PING a weavelocal bytes of data From a weavelocal icmpseq Destination Host Unreachable From a weavelocal icmpseq Destination Host Unreachable C Here are the questions I have What other ports I need to forward for TCP and UDP Weave uses ports TCP UDP for fastdp and TCP UDP for sleeve Im going to forward UDP using this approach but the question stops me I was able to specify a single port in PEERS How can I specify the other forwarded ports I understand that A A ping requires UDP traffic forwarding But why A A ping doesnt work A server has public IP and ports are not restricted Please answer my questions or push me to the right direction Versions weave version weave script docker version uname a Linux mainlinerev SMP Sun Apr UTC x x x GNULinux Logs A logs There are some issues using weave on k s together with shorewall I understand my setup is a playground and the k s shouldnt be installed on a bare metal with a firewall so this is for reference in case someone else stumble on those issues really if the iface extension is installed on the node shorewall uses it but the weave pod doesn have it resulting in Cant find library for match iface weave does a iptables A INPUT i weave j WEAVENPCEGRESS resulting in the rule ending up after the reject from shorewall ie Chain INPUT policy DROP num target prot opt source destination KUBEFIREWALL all anywhere anywhere KUBESERVICES all anywhere anywhere ctstate NEW kubernetes service portals KUBEEXTERNALSERVICES all anywhere anywhere ctstate NEW kubernetes externallyvisible service portals zone related rules ACCEPT all anywhere anywhere Reject all anywhere anywhere LOG all anywhere anywhere LOG level info prefix ShorewallINPUTREJECT reject all anywhere anywhere goto WEAVENPCEGRESS all anywhere anywhere Solutions I ended up removing the extension from my system Shorewall seems fine without it I manually add a iptables I INPUT i weave j WEAVENPCEGRESS to duplicate the rule before the reject Hi thank you for opening an issue Before hitting the button Is this a REQUEST FOR HELP If so please have a look at our FAQ our troubleshooting page our help page to choose the best channel Slack etc to reach out Is this a FEATURE REQUEST If so please search existing feature requests and if you find a similar one upvote it andor add your comments to it instead If you did not find a similar one please describe in details why your usecase specific constraints you may have etc what the featurebehaviourchange you would like to see in Weave Net Do not hesitate when appropriate to share the exact commands or API you would like andor to share a diagram eg asciiflowcom a picture is worth a thousand words Is this a BUG REPORT we are noticing a random issue with weave cni deamons we have a Running a K S cluster on azure VMSSScale sets with following versions we have workers in the cluster and about of them seems to experience similar problem and the pods are in a crashloop state All pods that are in bad state have the following error boltDB Unable to open weavedbweavenetdatadb timeout any idea how to investigate this further or cause of this issue Thank you What you expected to happen What happened Error message actual behaviour etc we are noticing a random issue with weave cni deamons we have a Running a K S cluster on azure VMSSScale sets with following versions we have workers in the cluster and about of them seems to experience similar problem and the pods are in a crashloop state All pods that are in bad state have the following error boltDB Unable to open weavedbweavenetdatadb timeout any idea how to investigate this further or cause of this issue How to reproduce it We have a similar setup and were able to reproduce the issue Anything else we need to know Cloud provider Hardware How did you configure your cluster Kubernetes YAML KOPS etc Versions Please paste in the output of these commands kubectl only if using Kubernetes Kubernetes docker weave Centos Client Version versionInfoMajor Minor GitVersionv GitCommitbb ffb d a bb cec ff eacc c GitTreeStateclean BuildDate T Z GoVersiongo Compilergc Platformlinuxamd Server Version versionInfoMajor Minor GitVersionv GitCommitfc d f e b a f a e f eaead GitTreeStateclean BuildDate T Z GoVersiongo Compilergc Platformlinuxamd Logs docker logs weave or if using Kubernetes kubectl logs n kubesystem weavenetpod weave kubectl logs n kubesystem weavenetmdl r weave boltDB Unable to open weavedbweavenetdatadb timeout kubectl logs n kubesystem weavenetntrjs weave Error from server Get x certificate specifies an incompatible key usage If output is long please consider a Gist Anything interesting or unusual output by the below potentially relevant commands journalctl u dockerservice nopager journalctl u kubelet nopager kubectl get events Network If your problem has anything to do with one network endpoint not being able to contact another please run the following commands ip route ip o addr sudo iptablessave What you expected to happen We use kops and weavenet cni for Kubernetes networking in the production cluster At times we get UnknownHost exceptions for a couple of external urls Eg our database urls which is a RDS url for which we have created an ExternalName service and apps talks through the ExternalName service Our entire cluster runs on AWS We found that Restarting the weavenet pods helped to fix this issue every time we face this issue When we checked we could not find any specific error logs from Weave nor from CoreDNS But observed that the weave pods are restarted couple of times though the Error persist even when the weavenet pods are running but after manual kill and start they have gone The issue seems to be only happening on certain nodes in the cluster at a particular time and remaining nodes works What happened Error message actual behaviour etc How to reproduce it Specific steps as minimally and precisely as possible Anything else we need to know Cloud provider Hardware How did you configure your cluster Kubernetes YAML KOPS etc Versions Please paste in the output of these commands kubectl only if using Kubernetes weave kubectl version Client Version versionInfoMajor Minor GitVersionv GitCommit db a d dbc fa b e GitTreeStateclean BuildDate T Z GoVersiongo Compilergc Platformlinuxamd Server Version versionInfoMajor Minor GitVersionv GitCommit fac cd a dc f d f f a aeface cc GitTreeStateclean BuildDate T Z GoVersiongo Compilergc Platformlinuxamd I couldnt collect any specific logs that show this error yet What you expected to happen Weave should form a fastdp for the new nodes that have the been joined to the cluster What happened Weave falls back to sleeve however other nodes remain connected via fastdp How to reproduce it Issue only appears to be related to the Broadcom BCM NetXtremeE DualMedia G NIC Connecting the same node with the Broadcom BCM NetXtreme Gigabit forms a fastdp network No other changes where made to the node Anything else we need to know NIC details BCM driver bnxten version firmwareversion pkg expansionromversion businfo supportsstatistics yes supportstest yes supportseepromaccess yes supportsregisterdump no supportsprivflags no BCM driver tg version firmwareversion FFV bc v expansionromversion businfo supportsstatistics yes supportstest yes supportseepromaccess yes supportsregisterdump yes supportsprivflags no Versions Please paste in the output of these commands kubectl only if using Kubernetes weave version docker version uname a Linux pmdell generic Ubuntu SMP Tue Nov UTC x x x GNULinux kubectl version v Logs First lines for failing node pmdell weavenet debug log What you expected to happen When adding new nodes into a weave network I expect them to be assigned a unique IP for the weave bridge interface I also expect to be able to perform weave reset from within a weavenet container What happened This is on a kubernetes cluster consisting of nodes control and workers weavenet is installed as the CNI I had a node that already had a weave interface defined and I added it to an existing weave network cluster weave reached quorum and made links successfully between all nodes however it did not notice that two nodes shared the same IP address This meant that routing traffic to any pods living on either of those nodes resulted in failure rate How to reproduce it Create a single node K S cluster node by installing kubernetes and installing weave as the CNI kubeadm init kubeadm apply f deployment file for weave image weaveworksweavekube host network true All pods go to RUNNING state and see the weave interface when you run ifconfig weave Repeat on another node node Note Both nodes default to weave bridge IP Bring node down and clean it kubeadm reset Use the join command on node to join the existing cluster On node kubeadm token create printjoincommand On node use the join command received from the previous step kubectl get nodes will confirm that node has joined the cluster ifconfig weave on both nodes confirms that they both have the same IP address still Log in to the weave container to verify that weavenet connections have been made sudo kubectl exec ti nkubesystem weavenetstfns c weave sh homeweave weave local status Version version available please upgrade Service router Protocol weave Name a a f node Encryption disabled PeerDiscovery enabled Targets Connections established failed Peers with established connections TrustedSubnets none Service ipam Status ready Range DefaultSubnet homeweave weave local status connections established fastdp a acae defnode mtu failed cannot connect to ourself retry never From this point onwards you can validate using something like kuberang that connectivity into pods within the weave network from outside the network eg node or node or any upstream network connected node is unstable and will result in timeoutsfailures Eventually it causes coredns to crash Anything else we need to know Tests have been run on VMWare and AWS EC In both cases this is a Kubernetes cluster We do not install weave binary into the command line of the node It should only run as a container Installing weave and running weave reset from the command line of the node itself is a workaround we shouldnt be using Note I can not seem to find a way of running weave reset from within the weavenet container otherwise I might use that as part of process of decommissioning a node Versions homeweave weave local version weave sudo docker version Client Version API version Go version go Git commit e ff Built Thu Apr OSArch linuxamd Experimental false Server Docker Engine Community Engine Version API version minimum version Go version go Git commit e ff Built Thu Apr OSArch linuxamd Experimental false uname a Linux node el x SMP Wed Mar EDT x x x GNULinux sudo kubectl version Client Version versionInfoMajor Minor GitVersionv GitCommite b b dc fdcd e bcfe f e d a GitTreeStateclean BuildDate T Z GoVersiongo Compilergc Platformlinuxamd Server Version versionInfoMajor Minor GitVersionv GitCommite b b dc fdcd e bcfe f e d a GitTreeStateclean BuildDate T Z GoVersiongo Compilergc Platformlinuxamd Logs sudo kubectl logs n kubesystem weavenetzqd weave DEBU kubepeers Checking peer a acae def against list a a f node Peer not in list removing persisted data INFO Command line options map dockerapi nicknamenode nodnstrue datapathdatapath ipallocrange httpaddr ipallocinitconsensus namea acae def connlimit dbprefixweavedbweavenet metricsaddr port expectnpctrue hostroothost INFO weave INFO failed to create weavetestcommentf c disabling comment support INFO Reexposing on bridge weave INFO Bridge type is bridgedfastdp INFO Communication between peers is unencrypted INFO Our name is a acae defnode INFO Launch detected using supplied peer list INFO Checking for preexisting addresses on weave bridge INFO weave bridge has address INFO allocator a acae def No valid persisted data INFO allocator a acae def Initialising via deferred consensus INFO Sniffing traffic on datapath via ODP INFO attempting connection INFO attempting connection INFO connection accepted INFO a acae defnode connection shutting down due to error cannot connect to ourself INFO a acae defnode connection shutting down due to error cannot connect to ourself INFO a a f node connection ready using protocol version INFO overlayswitch a a f node using fastdp INFO a a f node connection added new peer INFO Listening for HTTP control messages on INFO Listening for metrics requests on INFO a a f node connection fully established ERRO allocator address is owned by other peer a a f node INFO EMSGSIZE on send expecting PMTU update IP packet was bytes payload was bytes INFO sleeve a a f node Effective MTU verified at INFO kubepeers Added myself to peer list a a f node a acae def node DEBU kubepeers Nodes that have disappeared map INFO Weave version is available please update at DEBU registering for updates for node delete events Anything interesting or unusual output by the below potentially relevant commands journalctl u dockerservice nopager grep vi info Logs begin at Thu UTC end at Thu UTC Dec node systemd Starting Docker Application Container Engine Dec node dockerd time T Z levelwarning msgUsing pre kernel for overlay mount failures may require kernel update storagedriveroverlay Dec node systemd Started Docker Application Container Engine Dec node systemd Stopping Docker Application Container Engine Dec node systemd Stopped Docker Application Container Engine Dec node systemd Starting Docker Application Container Engine Dec node dockerd time T Z levelwarning msgUsing pre kernel for overlay mount failures may require kernel update storagedriveroverlay Dec node systemd Started Docker Application Container Engine journalctl u kubelet nopager Last message in journal is just as node is joining and get pods now shows everything as running Dec node kubelet W cnigo Unable to update cni config No networks found in etccninetd Dec node kubelet W watchergo Error while processing event sysfscgroupdeviceslibcontainer systemdtestdefaultslice x INCREATEINISDIR inotifyaddwatch sysfscgroupdeviceslibcontainer systemdtestdefaultslice no such file or directory Dec node kubelet E kubeletgo Container runtime network not ready NetworkReadyfalse reasonNetworkPluginNotReady messagedocker network plugin is not ready cni config uninitialized kubectl get events Nothing unusual m Normal NodeReady nodenode Node node status is now NodeReady date Thu Dec UTC Network node sudo ip route default via dev eth proto static metric dev weave proto kernel scope link src dev eth proto kernel scope link src metric dev docker proto kernel scope link src sudo ip o addr lo inet scope host lo validlft forever preferredlft forever eth inet brd scope global noprefixroute eth validlft forever preferredlft forever docker inet brd scope global docker validlft forever preferredlft forever weave inet brd scope global weave validlft forever preferredlft forever sudo iptablessave Generated by iptablessave v on Thu Dec nat PREROUTING ACCEPT INPUT ACCEPT OUTPUT ACCEPT POSTROUTING ACCEPT DOCKER KUBEMARKDROP KUBEMARKMASQ KUBENODEPORTS KUBEPOSTROUTING KUBESEP DU DE VORVEQVD KUBESEPPNP KAQDYB H R KUBESEPS MK EVI CLHCCS KUBESEPSWLOBIBPXYBP G Z KUBESEPSZZ MOWKTWUFXIJT KUBESEPUJJNLSZU HL F UO KUBESEPZCHNBYOGFZRFKYMA KUBESERVICES KUBESVCERIFXISQEP F OF KUBESVCJD MR NA I DYORP KUBESVCNPX M PTMTKRN Y KUBESVCTCOU JCQXEZGVUNU OUTPUTdirect POSTROUTINGZONES POSTROUTINGZONESSOURCE POSTROUTINGdirect POSTpublic POSTpublicallow POSTpublicdeny POSTpubliclog PREROUTINGZONES PREROUTINGZONESSOURCE PREROUTINGdirect PREpublic PREpublicallow PREpublicdeny PREpubliclog WEAVE A PREROUTING m comment comment kubernetes service portals j KUBESERVICES A PREROUTING m addrtype dsttype LOCAL j DOCKER A OUTPUT m comment comment kubernetes service portals j KUBESERVICES A OUTPUT d m addrtype dsttype LOCAL j DOCKER A POSTROUTING m comment comment kubernetes postrouting rules j KUBEPOSTROUTING A POSTROUTING s o docker j MASQUERADE A POSTROUTING j WEAVE A DOCKER i docker j RETURN A KUBEMARKDROP j MARK setxmark x x A KUBEMARKMASQ j MARK setxmark x x A KUBEPOSTROUTING m comment comment kubernetes service traffic requiring SNAT m mark mark x x j MASQUERADE A KUBESEP DU DE VORVEQVD s j KUBEMARKMASQ A KUBESEP DU DE VORVEQVD p udp m udp j DNAT todestination A KUBESEPPNP KAQDYB H R s j KUBEMARKMASQ A KUBESEPPNP KAQDYB H R p tcp m tcp j DNAT todestination A KUBESEPS MK EVI CLHCCS s j KUBEMARKMASQ A KUBESEPS MK EVI CLHCCS p tcp m tcp j DNAT todestination A KUBESEPSWLOBIBPXYBP G Z s j KUBEMARKMASQ A KUBESEPSWLOBIBPXYBP G Z p tcp m tcp j DNAT todestination A KUBESEPSZZ MOWKTWUFXIJT s j KUBEMARKMASQ A KUBESEPSZZ MOWKTWUFXIJT p udp m udp j DNAT todestination A KUBESEPUJJNLSZU HL F UO s j KUBEMARKMASQ A KUBESEPUJJNLSZU HL F UO p tcp m tcp j DNAT todestination A KUBESEPZCHNBYOGFZRFKYMA s j KUBEMARKMASQ A KUBESEPZCHNBYOGFZRFKYMA p tcp m tcp j DNAT todestination A KUBESERVICES d p udp m comment comment kubesystemkubednsdns cluster IP m udp dport j KUBESVCTCOU JCQXEZGVUNU A KUBESERVICES d p tcp m comment comment kubesystemkubednsdnstcp cluster IP m tcp dport j KUBESVCERIFXISQEP F OF A KUBESERVICES d p tcp m comment comment defaultkuberneteshttps cluster IP m tcp dport j KUBESVCNPX M PTMTKRN Y A KUBESERVICES d p tcp m comment comment kubesystemkubednsmetrics cluster IP m tcp dport j KUBESVCJD MR NA I DYORP A KUBESERVICES m comment comment kubernetes service nodeports NOTE this must be the last rule in this chain m addrtype dsttype LOCAL j KUBENODEPORTS A KUBESVCERIFXISQEP F OF m statistic mode random probability j KUBESEPUJJNLSZU HL F UO A KUBESVCERIFXISQEP F OF j KUBESEPS MK EVI CLHCCS A KUBESVCJD MR NA I DYORP m statistic mode random probability j KUBESEPSWLOBIBPXYBP G Z A KUBESVCJD MR NA I DYORP j KUBESEPZCHNBYOGFZRFKYMA A KUBESVCNPX M PTMTKRN Y j KUBESEPPNP KAQDYB H R A KUBESVCTCOU JCQXEZGVUNU m statistic mode random probability j KUBESEPSZZ MOWKTWUFXIJT A KUBESVCTCOU JCQXEZGVUNU j KUBESEP DU DE VORVEQVD A WEAVE s d j RETURN A WEAVE s d j MASQUERADE A WEAVE s d j MASQUERADE COMMIT Completed on Thu Dec Generated by iptablessave v on Thu Dec mangle PREROUTING ACCEPT INPUT ACCEPT FORWARD ACCEPT OUTPUT ACCEPT POSTROUTING ACCEPT FORWARDdirect INPUTdirect OUTPUTdirect POSTROUTINGdirect PREROUTINGZONES PREROUTINGZONESSOURCE PREROUTINGdirect PREpublic PREpublicallow PREpublicdeny PREpubliclog A PREROUTING j PREROUTINGdirect A PREROUTING j PREROUTINGZONESSOURCE A PREROUTING j PREROUTINGZONES A INPUT j INPUTdirect A FORWARD j FORWARDdirect A OUTPUT j OUTPUTdirect A POSTROUTING j POSTROUTINGdirect A PREROUTINGZONES i eth g PREpublic A PREROUTINGZONES g PREpublic A PREpublic j PREpubliclog A PREpublic j PREpublicdeny A PREpublic j PREpublicallow COMMIT Completed on Thu Dec Generated by iptablessave v on Thu Dec security INPUT ACCEPT FORWARD ACCEPT OUTPUT ACCEPT FORWARDdirect INPUTdirect OUTPUTdirect A INPUT j INPUTdirect A FORWARD j FORWARDdirect A OUTPUT j OUTPUTdirect COMMIT Completed on Thu Dec Generated by iptablessave v on Thu Dec raw PREROUTING ACCEPT OUTPUT ACCEPT OUTPUTdirect PREROUTINGZONES PREROUTINGZONESSOURCE PREROUTINGdirect PREpublic PREpublicallow PREpublicdeny PREpubliclog A PREROUTING j PREROUTINGdirect A PREROUTING j PREROUTINGZONESSOURCE A PREROUTING j PREROUTINGZONES A OUTPUT j OUTPUTdirect A PREROUTINGZONES i eth g PREpublic A PREROUTINGZONES g PREpublic A PREpublic j PREpubliclog A PREpublic j PREpublicdeny A PREpublic j PREpublicallow COMMIT Completed on Thu Dec Generated by iptablessave v on Thu Dec filter INPUT ACCEPT FORWARD DROP OUTPUT ACCEPT DOCKER DOCKERISOLATIONSTAGE DOCKERISOLATIONSTAGE DOCKERUSER FORWARDINZONES FORWARDINZONESSOURCE FORWARDOUTZONES FORWARDOUTZONESSOURCE FORWARDdirect FWDIpublic FWDIpublicallow FWDIpublicdeny FWDIpubliclog FWDOpublic FWDOpublicallow FWDOpublicdeny FWDOpubliclog INPUTZONES INPUTZONESSOURCE INPUTdirect INpublic INpublicallow INpublicdeny INpubliclog KUBEEXTERNALSERVICES KUBEFIREWALL KUBEFORWARD KUBESERVICES OUTPUTdirect WEAVENPC WEAVENPCDEFAULT WEAVENPCEGRESS WEAVENPCEGRESSACCEPT WEAVENPCEGRESSCUSTOM WEAVENPCEGRESSDEFAULT WEAVENPCINGRESS A INPUT m conntrack ctstate NEW m comment comment kubernetes service portals j KUBESERVICES A INPUT m conntrack ctstate NEW m comment comment kubernetes externallyvisible service portals j KUBEEXTERNALSERVICES A INPUT j KUBEFIREWALL A INPUT i weave j WEAVENPCEGRESS A FORWARD i weave m comment comment NOTE this must go before j KUBEFORWARD j WEAVENPCEGRESS A FORWARD o weave m comment comment NOTE this must go before j KUBEFORWARD j WEAVENPC A FORWARD o weave m state state NEW j NFLOG nfloggroup A FORWARD o weave j DROP A FORWARD i weave o weave j ACCEPT A FORWARD o weave m conntrack ctstate RELATEDESTABLISHED j ACCEPT A FORWARD m comment comment kubernetes forwarding rules j KUBEFORWARD A FORWARD m conntrack ctstate NEW m comment comment kubernetes service portals j KUBESERVICES A FORWARD j DOCKERUSER A FORWARD j DOCKERISOLATIONSTAGE A FORWARD o docker m conntrack ctstate RELATEDESTABLISHED j ACCEPT A FORWARD o docker j DOCKER A FORWARD i docker o docker j ACCEPT A FORWARD i docker o docker j ACCEPT A OUTPUT m conntrack ctstate NEW m comment comment kubernetes service portals j KUBESERVICES A OUTPUT j KUBEFIREWALL A DOCKERISOLATIONSTAGE i docker o docker j DOCKERISOLATIONSTAGE A DOCKERISOLATIONSTAGE j RETURN A DOCKERISOLATIONSTAGE o docker j DROP A DOCKERISOLATIONSTAGE j RETURN A DOCKERUSER j RETURN A KUBEFIREWALL m comment comment kubernetes firewall for dropping marked packets m mark mark x x j DROP A KUBEFORWARD m conntrack ctstate INVALID j DROP A KUBEFORWARD m comment comment kubernetes forwarding rules m mark mark x x j ACCEPT A WEAVENPC m state state RELATEDESTABLISHED j ACCEPT A WEAVENPC d j ACCEPT A WEAVENPC m physdev physdevout vethwebridge j ACCEPT A WEAVENPC m state state NEW j WEAVENPCDEFAULT A WEAVENPC m state state NEW j WEAVENPCINGRESS A WEAVENPCDEFAULT m set matchset weavePBZhkAr qXZ tMBA dst m comment comment DefaultAllow ingress isolation for namespace kubesystem j ACCEPT A WEAVENPCDEFAULT m set matchset weaveRzffh JaaJlGXJpGjZ dst m comment comment DefaultAllow ingress isolation for namespace kubepublic j ACCEPT A WEAVENPCDEFAULT m set matchset weave BWtz O G gUol dst m comment comment DefaultAllow ingress isolation for namespace kubenodelease j ACCEPT A WEAVENPCDEFAULT m set matchset weaverGqyMIl HN cfDkiZ N dst m comment comment DefaultAllow ingress isolation for namespace default j ACCEPT A WEAVENPCEGRESS m state state RELATEDESTABLISHED j ACCEPT A WEAVENPCEGRESS m physdev physdevin vethwebridge j RETURN A WEAVENPCEGRESS d j RETURN A WEAVENPCEGRESS m state state NEW j WEAVENPCEGRESSDEFAULT A WEAVENPCEGRESS m state state NEW m mark mark x x j WEAVENPCEGRESSCUSTOM A WEAVENPCEGRESS m state state NEW m mark mark x x j NFLOG nfloggroup A WEAVENPCEGRESS m mark mark x x j DROP A WEAVENPCEGRESSACCEPT j MARK setxmark x x A WEAVENPCEGRESSDEFAULT m set matchset weaveE ney o ojNrLk rOHi MPE src m comment comment DefaultAllow egress isolation for namespace kubesystem j WEAVENPCEGRESSACCEPT A WEAVENPCEGRESSDEFAULT m set matchset weaveE ney o ojNrLk rOHi MPE src m comment comment DefaultAllow egress isolation for namespace kubesystem j RETURN A WEAVENPCEGRESSDEFAULT m set matchset weave s vQ oxWGz a NE src m comment comment DefaultAllow egress isolation for namespace kubepublic j WEAVENPCEGRESSACCEPT A WEAVENPCEGRESSDEFAULT m set matchset weave s vQ oxWGz a NE src m comment comment DefaultAllow egress isolation for namespace kubepublic j RETURN A WEAVENPCEGRESSDEFAULT m set matchset weavesuigZkXoZgITtqpDp src m comment comment DefaultAllow egress isolation for namespace kubenodelease j WEAVENPCEGRESSACCEPT A WEAVENPCEGRESSDEFAULT m set matchset weavesuigZkXoZgITtqpDp src m comment comment DefaultAllow egress isolation for namespace kubenodelease j RETURN A WEAVENPCEGRESSDEFAULT m set matchset weavesChJId UyGWdHTKI src m comment comment DefaultAllow egress isolation for namespace default j WEAVENPCEGRESSACCEPT A WEAVENPCEGRESSDEFAULT m set matchset weavesChJId UyGWdHTKI src m comment comment DefaultAllow egress isolation for namespace default j RETURN COMMIT Completed on Thu Dec Node sudo ip route default via dev eth proto static metric dev weave proto kernel scope link src dev eth proto kernel scope link src metric dev docker proto kernel scope link src sudo ip o addr lo inet scope host lo validlft forever preferredlft forever eth inet brd scope global noprefixroute eth validlft forever preferredlft forever docker inet brd scope global docker validlft forever preferredlft forever weave inet brd scope global weave validlft forever preferredlft forever weave inet brd scope global secondary weave validlft forever preferredlft forever sudo iptablessave Generated by iptablessave v on Thu Dec nat PREROUTING ACCEPT INPUT ACCEPT OUTPUT ACCEPT POSTROUTING ACCEPT DOCKER KUBEMARKDROP KUBEMARKMASQ KUBENODEPORTS KUBEPOSTROUTING KUBESEP DU DE VORVEQVD KUBESEPPNP KAQDYB H R KUBESEPS MK EVI CLHCCS KUBESEPSWLOBIBPXYBP G Z KUBESEPSZZ MOWKTWUFXIJT KUBESEPUJJNLSZU HL F UO KUBESEPZCHNBYOGFZRFKYMA KUBESERVICES KUBESVCERIFXISQEP F OF KUBESVCJD MR NA I DYORP KUBESVCNPX M PTMTKRN Y KUBESVCTCOU JCQXEZGVUNU OUTPUTdirect POSTROUTINGZONES POSTROUTINGZONESSOURCE POSTROUTINGdirect POSTpublic POSTpublicallow POSTpublicdeny POSTpubliclog PREROUTINGZONES PREROUTINGZONESSOURCE PREROUTINGdirect PREpublic PREpublicallow PREpublicdeny PREpubliclog WEAVE A PREROUTING m comment comment kubernetes service portals j KUBESERVICES A PREROUTING m addrtype dsttype LOCAL j DOCKER A OUTPUT m comment comment kubernetes service portals j KUBESERVICES A OUTPUT d m addrtype dsttype LOCAL j DOCKER A POSTROUTING m comment comment kubernetes postrouting rules j KUBEPOSTROUTING A POSTROUTING s o docker j MASQUERADE A POSTROUTING j WEAVE A DOCKER i docker j RETURN A KUBEMARKDROP j MARK setxmark x x A KUBEMARKMASQ j MARK setxmark x x A KUBEPOSTROUTING m comment comment kubernetes service traffic requiring SNAT m mark mark x x j MASQUERADE A KUBESEP DU DE VORVEQVD s j KUBEMARKMASQ A KUBESEP DU DE VORVEQVD p udp m udp j DNAT todestination A KUBESEPPNP KAQDYB H R s j KUBEMARKMASQ A KUBESEPPNP KAQDYB H R p tcp m tcp j DNAT todestination A KUBESEPS MK EVI CLHCCS s j KUBEMARKMASQ A KUBESEPS MK EVI CLHCCS p tcp m tcp j DNAT todestination A KUBESEPSWLOBIBPXYBP G Z s j KUBEMARKMASQ A KUBESEPSWLOBIBPXYBP G Z p tcp m tcp j DNAT todestination A KUBESEPSZZ MOWKTWUFXIJT s j KUBEMARKMASQ A KUBESEPSZZ MOWKTWUFXIJT p udp m udp j DNAT todestination A KUBESEPUJJNLSZU HL F UO s j KUBEMARKMASQ A KUBESEPUJJNLSZU HL F UO p tcp m tcp j DNAT todestination A KUBESEPZCHNBYOGFZRFKYMA s j KUBEMARKMASQ A KUBESEPZCHNBYOGFZRFKYMA p tcp m tcp j DNAT todestination A KUBESERVICES d p udp m comment comment kubesystemkubednsdns cluster IP m udp dport j KUBESVCTCOU JCQXEZGVUNU A KUBESERVICES d p tcp m comment comment kubesystemkubednsdnstcp cluster IP m tcp dport j KUBESVCERIFXISQEP F OF A KUBESERVICES d p tcp m comment comment kubesystemkubednsmetrics cluster IP m tcp dport j KUBESVCJD MR NA I DYORP A KUBESERVICES d p tcp m comment comment defaultkuberneteshttps cluster IP m tcp dport j KUBESVCNPX M PTMTKRN Y A KUBESERVICES m comment comment kubernetes service nodeports NOTE this must be the last rule in this chain m addrtype dsttype LOCAL j KUBENODEPORTS A KUBESVCERIFXISQEP F OF m statistic mode random probability j KUBESEPUJJNLSZU HL F UO A KUBESVCERIFXISQEP F OF j KUBESEPS MK EVI CLHCCS A KUBESVCJD MR NA I DYORP m statistic mode random probability j KUBESEPSWLOBIBPXYBP G Z A KUBESVCJD MR NA I DYORP j KUBESEPZCHNBYOGFZRFKYMA A KUBESVCNPX M PTMTKRN Y j KUBESEPPNP KAQDYB H R A KUBESVCTCOU JCQXEZGVUNU m statistic mode random probability j KUBESEPSZZ MOWKTWUFXIJT A KUBESVCTCOU JCQXEZGVUNU j KUBESEP DU DE VORVEQVD A WEAVE s d j RETURN A WEAVE s d j MASQUERADE A WEAVE s d j MASQUERADE COMMIT Completed on Thu Dec Generated by iptablessave v on Thu Dec mangle PREROUTING ACCEPT INPUT ACCEPT FORWARD ACCEPT OUTPUT ACCEPT POSTROUTING ACCEPT FORWARDdirect INPUTdirect OUTPUTdirect POSTROUTINGdirect PREROUTINGZONES PREROUTINGZONESSOURCE PREROUTINGdirect PREpublic PREpublicallow PREpublicdeny PREpubliclog A PREROUTING j PREROUTINGdirect A PREROUTING j PREROUTINGZONESSOURCE A PREROUTING j PREROUTINGZONES A INPUT j INPUTdirect A FORWARD j FORWARDdirect A OUTPUT j OUTPUTdirect A POSTROUTING j POSTROUTINGdirect A PREROUTINGZONES i eth g PREpublic A PREROUTINGZONES g PREpublic A PREpublic j PREpubliclog A PREpublic j PREpublicdeny A PREpublic j PREpublicallow COMMIT Completed on Thu Dec Generated by iptablessave v on Thu Dec security INPUT ACCEPT FORWARD ACCEPT OUTPUT ACCEPT FORWARDdirect INPUTdirect OUTPUTdirect A INPUT j INPUTdirect A FORWARD j FORWARDdirect A OUTPUT j OUTPUTdirect COMMIT Completed on Thu Dec Generated by iptablessave v on Thu Dec raw PREROUTING ACCEPT OUTPUT ACCEPT OUTPUTdirect PREROUTINGZONES PREROUTINGZONESSOURCE PREROUTINGdirect PREpublic PREpublicallow PREpublicdeny PREpubliclog A PREROUTING j PREROUTINGdirect A PREROUTING j PREROUTINGZONESSOURCE A PREROUTING j PREROUTINGZONES A OUTPUT j OUTPUTdirect A PREROUTINGZONES i eth g PREpublic A PREROUTINGZONES g PREpublic A PREpublic j PREpubliclog A PREpublic j PREpublicdeny A PREpublic j PREpublicallow COMMIT Completed on Thu Dec Generated by iptablessave v on Thu Dec filter INPUT ACCEPT FORWARD DROP OUTPUT ACCEPT DOCKER DOCKERISOLATIONSTAGE DOCKERISOLATIONSTAGE DOCKERUSER FORWARDINZONES FORWARDINZONESSOURCE FORWARDOUTZONES FORWARDOUTZONESSOURCE FORWARDdirect FWDIpublic FWDIpublicallow FWDIpublicdeny FWDIpubliclog FWDOpublic FWDOpublicallow FWDOpublicdeny FWDOpubliclog INPUTZONES INPUTZONESSOURCE INPUTdirect INpublic INpublicallow INpublicdeny INpubliclog KUBEEXTERNALSERVICES KUBEFIREWALL KUBEFORWARD KUBESERVICES OUTPUTdirect WEAVENPC WEAVENPCDEFAULT WEAVENPCEGRESS WEAVENPCEGRESSACCEPT WEAVENPCEGRESSCUSTOM WEAVENPCEGRESSDEFAULT WEAVENPCINGRESS A INPUT m conntrack ctstate NEW m comment comment kubernetes service portals j KUBESERVICES A INPUT m conntrack ctstate NEW m comment comment kubernetes externallyvisible service portals j KUBEEXTERNALSERVICES A INPUT j KUBEFIREWALL A INPUT i weave j WEAVENPCEGRESS A FORWARD i weave m comment comment NOTE this must go before j KUBEFORWARD j WEAVENPCEGRESS A FORWARD o weave m comment comment NOTE this must go before j KUBEFORWARD j WEAVENPC A FORWARD o weave m state state NEW j NFLOG nfloggroup A FORWARD o weave j DROP A FORWARD i weave o weave j ACCEPT A FORWARD o weave m conntrack ctstate RELATEDESTABLISHED j ACCEPT A FORWARD m comment comment kubernetes forwarding rules j KUBEFORWARD A FORWARD m conntrack ctstate NEW m comment comment kubernetes service portals j KUBESERVICES A FORWARD j DOCKERUSER A FORWARD j DOCKERISOLATIONSTAGE A FORWARD o docker m conntrack ctstate RELATEDESTABLISHED j ACCEPT A FORWARD o docker j DOCKER A FORWARD i docker o docker j ACCEPT A FORWARD i docker o docker j ACCEPT A OUTPUT m conntrack ctstate NEW m comment comment kubernetes service portals j KUBESERVICES A OUTPUT j KUBEFIREWALL A DOCKERISOLATIONSTAGE i docker o docker j DOCKERISOLATIONSTAGE A DOCKERISOLATIONSTAGE j RETURN A DOCKERISOLATIONSTAGE o docker j DROP A DOCKERISOLATIONSTAGE j RETURN A DOCKERUSER j RETURN A KUBEFIREWALL m comment comment kubernetes firewall for dropping marked packets m mark mark x x j DROP A KUBEFORWARD m conntrack ctstate INVALID j DROP A KUBEFORWARD m comment comment kubernetes forwarding rules m mark mark x x j ACCEPT A WEAVENPC m state state RELATEDESTABLISHED j ACCEPT A WEAVENPC d j ACCEPT A WEAVENPC m physdev physdevout vethwebridge j ACCEPT A WEAVENPC m state state NEW j WEAVENPCDEFAULT A WEAVENPC m state state NEW j WEAVENPCINGRESS A WEAVENPCDEFAULT m set matchset weavePBZhkAr qXZ tMBA dst m comment comment DefaultAllow ingress isolation for namespace kubesystem j ACCEPT A WEAVENPCDEFAULT m set matchset weaveRzffh JaaJlGXJpGjZ dst m comment comment DefaultAllow ingress isolation for namespace kubepublic j ACCEPT A WEAVENPCDEFAULT m set matchset weave BWtz O G gUol dst m comment comment DefaultAllow ingress isolation for namespace kubenodelease j ACCEPT A WEAVENPCDEFAULT m set matchset weaverGqyMIl HN cfDkiZ N dst m comment comment DefaultAllow ingress isolation for namespace default j ACCEPT A WEAVENPCEGRESS m state state RELATEDESTABLISHED j ACCEPT A WEAVENPCEGRESS m physdev physdevin vethwebridge j RETURN A WEAVENPCEGRESS d j RETURN A WEAVENPCEGRESS m state state NEW j WEAVENPCEGRESSDEFAULT A WEAVENPCEGRESS m state state NEW m mark mark x x j WEAVENPCEGRESSCUSTOM A WEAVENPCEGRESS m state state NEW m mark mark x x j NFLOG nfloggroup A WEAVENPCEGRESS m mark mark x x j DROP A WEAVENPCEGRESSACCEPT j MARK setxmark x x A WEAVENPCEGRESSDEFAULT m set matchset weaveE ney o ojNrLk rOHi MPE src m comment comment DefaultAllow egress isolation for namespace kubesystem j WEAVENPCEGRESSACCEPT A WEAVENPCEGRESSDEFAULT m set matchset weaveE ney o ojNrLk rOHi MPE src m comment comment DefaultAllow egress isolation for namespace kubesystem j RETURN A WEAVENPCEGRESSDEFAULT m set matchset weave s vQ oxWGz a NE src m comment comment DefaultAllow egress isolation for namespace kubepublic j WEAVENPCEGRESSACCEPT A WEAVENPCEGRESSDEFAULT m set matchset weave s vQ oxWGz a NE src m comment comment DefaultAllow egress isolation for namespace kubepublic j RETURN A WEAVENPCEGRESSDEFAULT m set matchset weavesuigZkXoZgITtqpDp src m comment comment DefaultAllow egress isolation for namespace kubenodelease j WEAVENPCEGRESSACCEPT A WEAVENPCEGRESSDEFAULT m set matchset weavesuigZkXoZgITtqpDp src m comment comment DefaultAllow egress isolation for namespace kubenodelease j RETURN A WEAVENPCEGRESSDEFAULT m set matchset weavesChJId UyGWdHTKI src m comment comment DefaultAllow egress isolation for namespace default j WEAVENPCEGRESSACCEPT A WEAVENPCEGRESSDEFAULT m set matchset weavesChJId UyGWdHTKI src m comment comment DefaultAllow egress isolation for namespace default j RETURN COMMIT Completed on Thu Dec What happened weavenpc threw a fatal error and restarted Anything else we need to know TBC Versions Please paste in the output of these commands kubectl only if using Kubernetes weave version docker version uname a Linux ncnw default SMP Mon Oct UTC ef efd x x x GNULinux kubectl version v Log excerpt full log supplied offline INFO EVENT AddNetworkPolicy metadatacreationTimestamp T Zgeneration labelsappcfs b e a c fa c ed b b f cfsessionREDACTEDsessionid b e a c fa c ed b b f namecfs b e a c fa c ed b b f namespaceservicesresourceVersion selfLinkapisnetworkingk siov namespacesservicesnetworkpoliciescfs b e a c fa c ed b b f uid c d f ea b b e b aespecingress from podSelectormatchLabelsjobnamecfs b e a c fa c ed b b f podSelectormatchLabelsappREDACTED podSelectormatchLabelsappcfs b e a c fa c ed b b f policyTypes Ingress INFO creating ipset npcselectorSpeckeyappcfs b e a c fa c ed b b f selectorlabelsinternalSelectorlabelsRequirementkeyapp operator strValues stringcfs b e a c fa c ed b b f policyTypes npcpolicyType x ipsetTypehaship ipsetNameweavevVopipYlkUZcGmRVDB nsNameservices INFO creating ipset npcselectorSpeckeyjobnamecfs b e a c fa c ed b b f selectorlabelsinternalSelectorlabelsRequirementkeyjobname operator strValues stringcfs b e a c fa c ed b b f policyTypes npcpolicyTypenil ipsetTypehaship ipsetNameweavepUZWsLvphba RELzzqTE nsNameservices INFO adding rule m set matchset weavepUZWsLvphba RELzzqTE src m set matchset weavevVopipYlkUZcGmRVDB dst m comment comment pods namespace services selector jobnamecfs b e a c fa c ed b b f pods namespace services selector appcfs b e a c fa c ed b b f ingress j ACCEPT to WEAVENPCINGRESS chain INFO EVENT DeleteNetworkPolicy metadatacreationTimestamp T Zgeneration labelsappcfs b e a c fa c ed b b f cfsessionREDACTEDsessionid b e a c fa c ed b b f namecfs b e a c fa c ed b b f namespaceservicesresourceVersion selfLinkapisnetworkingk siov namespacesservicesnetworkpoliciescfs b e a c fa c ed b b f uid c d f ea b b e b aespecingress from podSelectormatchLabelsjobnamecfs b e a c fa c ed b b f podSelectormatchLabelsappREDACTED podSelectormatchLabelsappcfs b e a c fa c ed b b f policyTypes Ingress INFO deleting rule m set matchset weavepUZWsLvphba RELzzqTE src m set matchset weavevVopipYlkUZcGmRVDB dst m comment comment pods namespace services selector jobnamecfs b e a c fa c ed b b f pods namespace services selector appcfs b e a c fa c ed b b f ingress j ACCEPT from WEAVENPCINGRESS chain FATA delete network policy running sbiniptables t filter D WEAVENPCINGRESS m set matchset weavepUZWsLvphba RELzzqTE src m set matchset weavevVopipYlkUZcGmRVDB dst m comment comment pods namespace services selector jobnamecfs b e a c fa c ed b b f pods namespace services selector appcfs b e a c fa c ed b b f ingress j ACCEPT wait exit status iptables Bad rule does a matching rule exist in that chain From abuehrle We should add a section to the Weave Net docs possibly a FAQ item or even a whole topic about multicasting and Weave Net cluster to cluster multicasting limitations pod to pod whats supported and whats not and caveats ideal situation for multicast maybe encourage PRs from the community to update it from bboreham Our multicast support is a behaviour that falls out of faithfully emulating a layer switch Within the Weave network it just works you d have to make special efforts to stop it However what some people want is to route multicast traffic in and out of the cluster We don t have any special support for that it would need some external bridging technology