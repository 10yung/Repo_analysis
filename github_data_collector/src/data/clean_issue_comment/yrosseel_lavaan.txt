The line referenced below is causing one or two blavaan tests to fail because xcov is NULL I havent isolated the problem have not looked hard but I can remember having previous trouble with the difference between missingml and missingmlx I guess this might be related fwiw I had been trying to stick with missingml because mlx was making my life difficult in various ways I am not expecting any changes in lavaan but any extra info would be helpful for me to solve the problem in blavaan Thanks When trying to estimate a model with latentstructured residuals as follows z x x x lx x lx x lx x z z lx lx lx lx lx lx lavaan with estimatorMML yields Error in DDnu numidx drop FALSE subscript out of bounds while all other estimators work fine Example code librarylavaan setseed z rnorm x rnorm z x rnorm z x rnorm z df dataframex x x lavmodel z x x x lx x lx x lx x z z lx lx lx lx lx lx lavaanlavmodel datadf estimatorML works lavaanlavmodel datadf estimatorWLS works lavaanlavmodel datadf estimatorGLS works lavaanlavmodel datadf estimatorULS works lavaanlavmodel datadf estimatorMML Error in DDnu numidx drop FALSE subscript out of bounds The function mplus lavaanmodelSyntax unexpectedly does not convert syntax for means out bfi BY bfi lab nbfi BY bfi lab nbfi BY bfi lab nbfi BY bfi lab nbfi BY bfi lab n bfi lab nbfi lab mplus lavaanmodelSyntaxout bfi lab start bfi nbfi lab start bfi nbfi lab start bfi nbfi lab start bfi nbfi lab start bfi n lab nbfi lab bfi Just to clarify The unexpected bit is this syntax lab which is not correct syntax for means The functions pcgnorm and pcPHI appear to create a vector with the points Inf and Inf on them but then never use the Inf values I think this is an error mostly because the values for Inf and Inf will doubtless be anyway I think the code should be as below and this will also run a lot faster than the code in your package by avoiding loops pcPHI functionrho thy thy if lengthrho stopNot vectorized for rho nr lengththy L nc lengththy L thy repthy eachnr work out densities phi matrix nr nc tmp dbinormthy thy rho dimtmp cnr nc fill out with some zeros tmp cbind tmp tmp rbind tmp tmp isnatmp if allequaldimtmp cnr nc stopDimension not as expected assumed correct approach phi tmp nr nc tmp nc tmp nr tmp dimphi cnr nc old code fori in seqlennr forj in seqlennc p p p p ifi nr j nc p dbinormTHY i L THY j L rho ifi L j nc p dbinormTHY i L L THY j L rho ifi nr j L p dbinormTHY i L THY j L L rho ifi L j L p dbinormTHY i L L THY j L L rho phi ij p p p p phi pcgnorm functionrho thy thy if lengthrho stopNot vectorized for rho note Olsson A contains an error guv functionu v rho R rhorho uvR rhouu rhouv vv rhoR RR if lengthrho stopNot vectorized for rho nr lengththy L nc lengththy L thy repthy eachnr work out densities phi matrix nr nc tmp dbinormthy thy rho guvthy thy rho dimtmp cnr nc fill out with some zeros tmp cbind tmp tmp rbind tmp tmp isnatmp if allequaldimtmp cnr nc stopDimension not as expected assumed correct approach gnorm tmp nr nc tmp nc tmp nr tmp dimgnorm cnr nc old code fori in seqlennr forj in seqlennc g g g g ifi nr j nc u THY i L v THY j L g dbinormu v rho guvuvrho ifi L j nc u THY i L L v THY j L g dbinormu v rho guvuvrho ifi nr j L u THY i L v THY j L L g dbinormu v rho guvuvrho ifi L j L u THY i L L v THY j L L g dbinormu v rho guvuvrho gnorm ij g g g g gnorm I imported a sav spss dataset using the haven package fit a model using sem and used lavPredict on the fitted model I got an error that says lavaan ERROR unknown type havenlabelled for variable Just bringing this to someones attention because the issue goes away after saving the sav as csv EDIT at end Hi Yrosseel I have been trying out the lavaan package for some CFA an SEM modeling I have run into a very strange issue where R gives me incorrect results only some of the time I have been comparing the output to SPSS AMOS to make sure it is correct The issue I am having is that I get incorrect output based on the number of observations I am using and I have narrowed it down to how the package is utilizing the covariance matrix I have attached two files with covariance matrices The fullCov is from the full sample of observations and gives me incorrect output The subCov is from a subsample of observations and gives me correct output I have tried recreating the covariance matrices in other programs as well to see if it is related to R creating the matrix and I still get the same results This is the model I am testing BNSmodel autonomy BNSW BNSW BNSW BNSW BNSW BNSW BNSW competence BNSW BNSW BNSW BNSW BNSW BNSW relatedness BNSW BNSW BNSW BNSW BNSW BNSW BNSW BNSW The third file I attached has the estimates that I expect to get followed by the estimates I get from R utilizing the full observations Anyway I am not sure how to fix this If I am doing something incorrectly please let me know Oh and I have been testing this using the MimicEQS option as well and still get incorrect results I also considered rounding to be an issue but the results are too far off to just be because of rounding sumphatguy Edit I was able to get the correct values by specifying start simple Can anyone explain why this would change so much estimatesxlsx fullCovxlsx subCovxlsx Thank for your attention The code was pasted below installpackageslavaan installpackagesggplot installpackagesreshape installpackageslavaan grab package from the source installpackagesqpcR grab package from the source librarylavaan load package libraryqpcR load package libraryggplot load package Model comparison Here we simulate data under one model A and fit two competing models A and B We then use model comparison to test which one best fits the data True model samplesize ULCSsimulate The following lines specify the core assumptions of the LCS and should not generally be modified COGT COGT Fixed regression of COGT on COGT dCOG COGT Fixed regression of dCOG on COGT COGT This line constrains the intercept of COGT to COGT COGT This fixes the variance of the COGT to The following five parameters will be estimated in the model Values can be modified manually to examine the effect on the model dCOG This fixes the intercept of the change score to COGT This fixes the intercept of COGT to dCOG dCOG This fixes the variance of the change scores to COGT COGT This fixes the variance of the COGT to dCOG COGT This fixes the selffeedback parameter to simdatULCSsimulateDataULCSsimulatesamplenobs samplesizemeanstructure T Simulate data We first fit the true model ULCSA COGT COGT Fixed regression of COGT on COGT dCOG COGT Fixed regression of dCOG on COGT COGT This line constrains the intercept of COGT to COGT COGT This fixes the variance of the COGT to dCOG This estimates the intercept of the change scores COGT This estimates the intercept of COGT dCOG dCOG This estimates the variance of the change scores COGT COGT This estimates the variance of COGT dCOG COGT This estimates the selffeedback parameter fitULCSA lavaanULCSA datasimdatULCS estimatormlrfixedxFALSEmissingfiml summaryfitULCSA fitmeasuresTRUE standardizedTRUE rsquareTRUE We now fit a competing simpler model that constraints the autoregressive parameter to ULCSB COGT COGT Fixed regression of COGT on COGT dCOG COGT Fixed regression of dCOG on COGT COGT This line constrains the intercept of COGT to COGT COGT This fixes the variance of the COGT to dCOG This estimates the intercept of the change scores COGT This estimates the intercept of COGT dCOG dCOG This estimates the variance of the change scores COGT COGT This estimates the variance of COGT dCOG COGT This estimates the selffeedback parameter fitULCSB lavaanULCSB datasimdatULCS estimatormlrfixedxFALSEmissingfiml summaryfitULCSB fitmeasuresTRUE standardizedTRUE rsquareTRUE Likelihood ratio test anovafitULCSAfitULCSB Hi Yves I noticed some unexpected behavior when using the WLS estimator with missing data The following gives an error for me r librarylavaan librarymvtnorm Some data nVar Rho matrix nVarnVar diagRho Data asdataframermvnorm sigma Rho namesData paste v nVar Simple model mod pasteapplycombncolnamesData functionxpaste x x collapse n Add some missings for i in ncolData Data runif i NA Run model fit cfamod Data estimator WLS missing pairwise Which results in Error in if isfinitefx fx fx missing value where TRUEFALSE needed with traceback traceback estimatorWLSWLSest WLSest g WLSobs lavsamplestatsWLSobs g WLSV WLSV lavmodelobjectivelavmodel lavmodel GLIST GLIST lavsamplestats lavsamplestats lavdata lavdata lavcache lavcache verbose verbose objectivepar nlminbstart startx objective objectivefunction gradient GRADIENT lower lower upper upper control control scale SCALE verbose verbose lavmodelestimatelavmodel lavmodel lavpartable lavpartable lavsamplestats lavsamplestats lavdata lavdata lavoptions lavoptions lavcache lavcache lavaanlavaanmodel mod data Data estimator WLS missing pairwise modeltype cfa intovfree TRUE intlvfree FALSE autofixfirst TRUE autofixsingle TRUE autovar TRUE autocovlvx TRUE autocovy TRUE autoth TRUE autodelta TRUE autoefa TRUE evalmc parentframe evalmc parentframe cfamod Data estimator WLS missing pairwise This came to my attention when you answered this question on the lavaan forum Do the se and acov attributes also need to be created per missingdata pattern dataHolzingerSwineford HolzingerSwineford x NA HSmodel visual x x x textual x x x speed x x x fit cfaHSmodel data HolzingerSwineford missing fiml lavPredictfit no problem lavPredictfit acov TRUE ERROR Im sure this is due to adjusted logic somewhere after adding the new effectcoding argument Hopefully this is straightforward to fix examplecfa updatefit stdlvTRUEOptions cstdlvautofixfirst both true 