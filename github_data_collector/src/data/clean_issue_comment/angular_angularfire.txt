 Thank you for contributing to the Firebase community Please fill out the pull request form below and make note of the following Run the linter and test suite Make sure your changes pass our linter and the tests all pass on your local machine Weve hooked up this repo with continuous integration to double check those things for you Add tests if applicable Most nontrivial changes should include some extra test coverage If you arent sure how to add tests feel free to submit regardless and ask us for some advice Sign our CLA Please sign our Contributor License Agreement before sending PRs We cannot accept code without this Checklist Issue number for this PR Fixes Docs included no Test units included no In a clean directory yarn install yarn test run successfully yes Description canActivate has the ternary of pipename pipe pipe which seems to be intended to tell if the pipe is in either this format pipe or pipe format currently If it in pipe format then the output of pipename seems to be piped however if it is in pipe format the the result of pipename is actually the name of the function which appears to what has been overlooked with the original logic as pipename never seems to be an empty string Adjusting to pipename piped pipe pipe should fix this issue in all situations unless the name of the function is piped which would result in authGuardPipe being set to pipe which in my testing seems to behave has expected still activating the pipe however I am unsure of the exact ramifications of this I have only been playing with this for about an hour or two so if there is something I am missing definitely let me know Since v the CollectionReference for Firestore in firebasejssdk has supported a withConverter method that allows the specification of a converter object that will automatically map DocumentData from firestore into application types I would like to use this feature as I would allow me to write some more generic APIs for data access with firebase Unfortunately the current version of angularfire does not support it for AngularFirestoreCollection Is there any plan to support this feature in angularfire I was thinking about submitting a simple PR but didnt know if this would be possible due to the current firebase js sdk dependencies Thank you for contributing to the Firebase community Please fill out the pull request form below and make note of the following Run the linter and test suite Make sure your changes pass our linter and the tests all pass on your local machine Weve hooked up this repo with continuous integration to double check those things for you Add tests if applicable Most nontrivial changes should include some extra test coverage If you arent sure how to add tests feel free to submit regardless and ask us for some advice Sign our CLA Please sign our Contributor License Agreement before sending PRs We cannot accept code without this Checklist Issue number for this PR nnn required Docs included yesno required for all APIfunctional changes Test units included yesno required In a clean directory yarn install yarn test run successfully yesno required Description Are you fixing a bug Updating our documentation Implementing a new feature Make sure we have the context around your change Link to other relevant issues or pull requests Code sample Proposing an API change Provide code samples showing how the API will be used IMPORTANT YOU MUST FOLLOW THESE INSTRUCTIONS OR YOUR ISSUE WILL BE CLOSED Thank you for contributing to the Angular and Firebase communities Have a usage question We get lots of those and we love helping you but GitHub is not the best place for them and they will be closed Here are some resources to get help Go through the Developers Guide If the official documentation doesnt help try asking through our officially supported channels Firebase Google Group Stack Overflow include the firebase and angularfire tags too Please avoid double posting across multiple channels Think you found a bug Yeah were definitely not perfect Please use the bug report template below and include a minimal repro when opening the issue Have a feature request Great we love hearing how we can improve our products Remove the template below and provide an explanation of your feature request Provide code samples if applicable Try to think about what it will allow you to do that you cant do today How will it make current workarounds straightforward What potential bugs and edge cases does it help to avoid Version info What versions of the following libraries are you using Note that your issue may already be fixed in the latest versions Angular Firebase AngularFire Other eg IonicCordova Node browser operating system NA How to reproduce these conditions Ive captured the issue in a simple project on StackBlitz Provide a failing test unit or create a minimal complete and verifiable example using either Plunker or JSFiddle Steps to set up and reproduce Open the console at the bottom of the StackBlitzrendered browser Click between the Public Protected and Login hyperlinks Debug output Errors in the JavaScript console errorsts ERROR Error Uncaught in promise NullInjectorError StaticInjectorErrorAppModule AngularFireAuthGuard Router StaticInjectorErrorPlatform core AngularFireAuthGuard Router NullInjectorError No provider for Router NullInjectorError StaticInjectorErrorAppModule AngularFireAuthGuard Router StaticInjectorErrorPlatform core AngularFireAuthGuard Router NullInjectorError No provider for Router Output from firebasedatabaseenableLoggingtrue NA No output Expected behavior User should be navigated to the route protected Actual behavior User remains on previous route with the JS error complianing about NullInjectorError as a provider wasnt provided for Router I have demonstrated this on a StackBlitz Project Version info What versions of the following libraries are you using Note that your issue may already be fixed in the latest versions Angular rc Firebase AngularFire rc Feature Im trying to show a files list of a specific user which I store in firebase storage Firebase offers a list method But angularfire doesnt have such method I am aware I can access thisstoragestoragerefmyfolder just wanted to ask for a better servicesolution Version info What versions of the following libraries are you using Note that your issue may already be fixed in the latest versions Angular rc Firebase AngularFire rc Using the AngularFireAuthGuard works but does not support redirect with query parameters When a user isnt authenticated Id like to direct them to login and once they are logged in send them back to where they tried to access ts const redirectUnauthorizedToLogin route ActivatedRouteSnapshot const path routepathFromRootmapv vurlmapsegment segmenttoStringjoinjoin const params Stringnew URLSearchParamsroutequeryParams const url Stringnew URLSearchParamsredirect path params return redirectUnauthorizedTo But I cant redirect to this url as its not a valid segment and redirectUnauthorizedTo doesnt support query parameters I am using Angular with the following packages angularcore angularfire firebase Works really well in development but when I compile for production I get the error TypeError Objectauth is not a function this is where in your code thisauth zonerunOutsideAngular const app firebaseAppFactoryoptions zone nameOrConfig return appauth Ive seen this in other posts but not with these versions which are the latest from this repo Screenshots img width altimage src img width altimage src Expected behavior What is the expected behavior I am running ng add angularfire and it should let me select a project from my firebase projects Actual behavior What is the actual behavior the terminal is saying Server Error certificate has expired After adding angularfire to the project the Angular universal prerender breaks It shows this warnings at first WARNING in nodemodulesgrpcsrcgrpcextensionjs Critical dependency the request of a dependency is an expression WARNING in nodemodulesgrpcnodemodulesnodepregyplibprebindingjs Critical dependency the request of a dependency is an expression WARNING in nodemodulesgrpcnodemodulesnodepregyplibutilversioningjs Critical dependency the request of a dependency is an expression and then it breaks with this error Prerendering routes to Projectsfirebaseissuedistfirebaseissuebrowser node UnhandledPromiseRejectionWarning Error packagejson does not exist at Projectsfirebaseissuedistfirebaseissuepackagejson at ObjectPsoTexportsfind Projectsfirebaseissuedistfirebaseissueservermainjs at ObjectwPNL Projectsfirebaseissuedistfirebaseissueservermainjs at webpackrequire Projectsfirebaseissuedistfirebaseissueservermainjs at ObjectXpdW Projectsfirebaseissuedistfirebaseissueservermainjs at webpackrequire Projectsfirebaseissuedistfirebaseissueservermainjs at Objectg pB Projectsfirebaseissuedistfirebaseissueservermainjs at webpackrequire Projectsfirebaseissuedistfirebaseissueservermainjs at ObjectOu q Projectsfirebaseissuedistfirebaseissueservermainjs at webpackrequire Projectsfirebaseissuedistfirebaseissueservermainjs at ObjectBYZf Projectsfirebaseissuedistfirebaseissueservermainjs node UnhandledPromiseRejectionWarning Unhandled promise rejection This error originated either by throwing inside of an async function without a catch block or by rejecting a promise which was not handled with catch rejection id node DEP DeprecationWarning Unhandled promise rejections are deprecated In the future promise rejections that are not handled will terminate the Nodejs process with a nonzero exit code Jan Version info Angular rc Firebase AngularFire Other eg IonicCordova Node browser operating system nguniversalexpressengine rc angularcli rc nguniversalbuilders rc node v How to reproduce these conditions git clone yarn npm run prerender Version info Angular CLI Node OS darwin x Angular animations common compiler compilercli core forms languageservice platformbrowser platformbrowserdynamic platformserver router serviceworker Package Version angulardevkitarchitect angulardevkitbuildangular angulardevkitbuildoptimizer angulardevkitbuildwebpack angulardevkitcore angulardevkitschematics angularcdk angularcli angularfire angularmaterial angularpwa ngtoolswebpack nguniversalexpressengine nguniversalmodulemapngfactoryloader schematicsangular schematicsupdate rxjs typescript webpack How to reproduce these conditions This is an issue that seems to only occur with SSR Angular Universal As such the steps to reproduce involve cloning a sample repository installing dependencies building and then running the node server locally Steps to set up and reproduce Clone the repository located at Run the npm run build command to build the Angular project server project and webpack Run the npm run servessr command to start the node server Open in your browser or make the request via curl Sample data and security rules NA Debug output Unhandled Promise rejection window is not defined Zone root Task Promisethen Value ReferenceError window is not defined at findGtagScriptOnPage UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseanalyticsdistindexcjsjs at factory UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseanalyticsdistindexcjsjs at ComponentinstanceINTERNALregisterComponentcomponentComponentsetServicePropssettings as instanceFactory UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseanalyticsdistindexcjsjs at ProvidergetOrInitializeService UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebasecomponentdistindexcjsjs at ProvidergetImmediate UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebasecomponentdistindexcjsjs at FirebaseAppImplgetService UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseappdistindexnodecjsjs at FirebaseAppImplfirebaseAppImplanonymous function as analytics UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseappdistindexnodecjsjs at MapSubscribereval as project webpackappnodemodulesangularfireanalyticsanalyticsjs at MapSubscribernext webpackappnodemodulesrxjsesm internaloperatorsmapjs at MapSubscriberSubscribernext webpackappnodemodulesrxjsesm internalSubscriberjs ReferenceError window is not defined at findGtagScriptOnPage UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseanalyticsdistindexcjsjs at factory UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseanalyticsdistindexcjsjs at ComponentinstanceINTERNALregisterComponentcomponentComponentsetServicePropssettings as instanceFactory UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseanalyticsdistindexcjsjs at ProvidergetOrInitializeService UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebasecomponentdistindexcjsjs at ProvidergetImmediate UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebasecomponentdistindexcjsjs at FirebaseAppImplgetService UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseappdistindexnodecjsjs at FirebaseAppImplfirebaseAppImplanonymous function as analytics UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseappdistindexnodecjsjs at MapSubscribereval as project webpackappnodemodulesangularfireanalyticsanalyticsjs at MapSubscribernext webpackappnodemodulesrxjsesm internaloperatorsmapjs at MapSubscriberSubscribernext webpackappnodemodulesrxjsesm internalSubscriberjs Unhandled Promise rejection window is not defined Zone root Task Promisethen Value ReferenceError window is not defined at findGtagScriptOnPage UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseanalyticsdistindexcjsjs at factory UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseanalyticsdistindexcjsjs at ComponentinstanceINTERNALregisterComponentcomponentComponentsetServicePropssettings as instanceFactory UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseanalyticsdistindexcjsjs at ProvidergetOrInitializeService UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebasecomponentdistindexcjsjs at ProvidergetImmediate UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebasecomponentdistindexcjsjs at FirebaseAppImplgetService UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseappdistindexnodecjsjs at FirebaseAppImplfirebaseAppImplanonymous function as analytics UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseappdistindexnodecjsjs at MapSubscribereval as project webpackappnodemodulesangularfireanalyticsanalyticsjs at MapSubscribernext webpackappnodemodulesrxjsesm internaloperatorsmapjs at MapSubscriberSubscribernext webpackappnodemodulesrxjsesm internalSubscriberjs ReferenceError window is not defined at findGtagScriptOnPage UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseanalyticsdistindexcjsjs at factory UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseanalyticsdistindexcjsjs at ComponentinstanceINTERNALregisterComponentcomponentComponentsetServicePropssettings as instanceFactory UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseanalyticsdistindexcjsjs at ProvidergetOrInitializeService UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebasecomponentdistindexcjsjs at ProvidergetImmediate UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebasecomponentdistindexcjsjs at FirebaseAppImplgetService UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseappdistindexnodecjsjs at FirebaseAppImplfirebaseAppImplanonymous function as analytics UsersbloveDesktopangularfireprerenderanalyticsnodemodulesfirebaseappdistindexnodecjsjs at MapSubscribereval as project webpackappnodemodulesangularfireanalyticsanalyticsjs at MapSubscribernext webpackappnodemodulesrxjsesm internaloperatorsmapjs at MapSubscriberSubscribernext webpackappnodemodulesrxjsesm internalSubscriberjs ERROR Error Uncaught in promise Error Cannot match any routes URL Segment indexjsmap Error Cannot match any routes URL Segment indexjsmap at ApplyRedirectsnoMatchError webpackappnodemodulesangularrouterfesm routerjs at CatchSubscribereval as selector webpackappnodemodulesangularrouterfesm routerjs at CatchSubscribererror webpackappnodemodulesrxjsesm internaloperatorscatchErrorjs at MapSubscriberSubscribererror webpackappnodemodulesrxjsesm internalSubscriberjs at MapSubscriberSubscribererror webpackappnodemodulesrxjsesm internalSubscriberjs at MapSubscriberSubscribererror webpackappnodemodulesrxjsesm internalSubscriberjs at MapSubscriberSubscribererror webpackappnodemodulesrxjsesm internalSubscriberjs at MapSubscriberSubscribererror webpackappnodemodulesrxjsesm internalSubscriberjs at MapSubscriberSubscribererror webpackappnodemodulesrxjsesm internalSubscriberjs at TapSubscribererror webpackappnodemodulesrxjsesm internaloperatorstapjs at resolvePromise webpackappnodemoduleszonejsdistzonenodejs at resolvePromise webpackappnodemoduleszonejsdistzonenodejs at eval webpackappnodemoduleszonejsdistzonenodejs at ZoneDelegateinvokeTask webpackappnodemoduleszonejsdistzonenodejs at ObjectonInvokeTask webpackappnodemodulesangularcorefesm corejs at ZoneDelegateinvokeTask webpackappnodemoduleszonejsdistzonenodejs at ZonerunTask webpackappnodemoduleszonejsdistzonenodejs at drainMicroTaskQueue webpackappnodemoduleszonejsdistzonenodejs at ZoneTaskinvokeTask webpackappnodemoduleszonejsdistzonenodejs at ZoneTaskinvoke webpackappnodemoduleszonejsdistzonenodejs Expected behavior The AngularFireAnalyticsModule uses the firebaseanalytics module that determines if the gtag script is already present in the DOM This functionality relies on a global window object in the findGtagScriptOnPage function This function should check if the window object is first available Actual behavior Using SSR locally prerendering locally and running the server in a Firebase cloud function all result in this error Possible Workaround One potential workaround I attempted was to mock the window object using domino javascript const win createWindowtemplate global as any window win global as any document windocument However this results in another error Unhandled Promise rejection IDB requires a browser environment Zone root Task Promisethen Value IDB requires a browser environment undefined ERROR Error Uncaught in promise Error Cannot match any routes URL Segment indexjsmap Error Cannot match any routes URL Segment indexjsmap at ApplyRedirectsnoMatchError webpackappnodemodulesangularrouterfesm routerjs at CatchSubscribereval as selector webpackappnodemodulesangularrouterfesm routerjs at CatchSubscribererror webpackappnodemodulesrxjsesm internaloperatorscatchErrorjs at MapSubscriberSubscribererror webpackappnodemodulesrxjsesm internalSubscriberjs at MapSubscriberSubscribererror webpackappnodemodulesrxjsesm internalSubscriberjs at MapSubscriberSubscribererror webpackappnodemodulesrxjsesm internalSubscriberjs at MapSubscriberSubscribererror webpackappnodemodulesrxjsesm internalSubscriberjs at MapSubscriberSubscribererror webpackappnodemodulesrxjsesm internalSubscriberjs at MapSubscriberSubscribererror webpackappnodemodulesrxjsesm internalSubscriberjs at TapSubscribererror webpackappnodemodulesrxjsesm internaloperatorstapjs at resolvePromise webpackappnodemoduleszonejsdistzonenodejs at resolvePromise webpackappnodemoduleszonejsdistzonenodejs at eval webpackappnodemoduleszonejsdistzonenodejs at ZoneDelegateinvokeTask webpackappnodemoduleszonejsdistzonenodejs at ObjectonInvokeTask webpackappnodemodulesangularcorefesm corejs at ZoneDelegateinvokeTask webpackappnodemoduleszonejsdistzonenodejs at ZonerunTask webpackappnodemoduleszonejsdistzonenodejs at drainMicroTaskQueue webpackappnodemoduleszonejsdistzonenodejs at ZoneTaskinvokeTask webpackappnodemoduleszonejsdistzonenodejs at ZoneTaskinvoke webpackappnodemoduleszonejsdistzonenodejs I pushed an additional branch with this attempted workaround This appears to be related to the following issue 