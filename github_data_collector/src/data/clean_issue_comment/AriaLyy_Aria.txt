 private void parseM u String m u Url String newM u FileName String outputPath LinkedBlockingQueueMapString String sizeDetectQueue LinkedBlockingQueueMapString String downloadQueue throws IOException String m U Content HttpRequestUtilgetResponseStringHttpRequestUtilsendGetRequestm u Url String newM u FileContent int i boolean subFile false for String lineStr m U Contentsplit n if lineStrstartsWith if lineStrstartsWithEXTXKEY Matcher searchKeyUri PatterncompileURI matcherlineStr if searchKeyUrifind throw new IOExceptionEXTXKEY String keyUri searchKeyUrigroup String keyUrl if keyUristartsWith keyUristartsWith keyUrl keyUri else keyUrl new URLnew URLm u Url keyUritrimtoString String uuidStr UUIDUtilgenUUID String keyPath outputPath Fileseparator uuidStr key HashMapString String hashMap new HashMapString String hashMapputurl keyUrl hashMapputdownloadPath keyPath downloadQueueaddhashMap String newLineStr PatterncompileURI matcherlineStrreplaceAllURI uuidStr key lineStr newLineStr if lineStrstartsWithEXTXSTREAMINF subFile true newM u FileContent newM u FileContent lineStr n else String uuidStr UUIDUtilgenUUID int forName i String videoUri lineStrtrim String fileUrl if videoUristartsWith videoUristartsWith fileUrl videoUri else fileUrl new URLnew URLm u Url videoUritoString if subFile subFile false parseM u fileUrl uuidStr m u outputPath sizeDetectQueue downloadQueue newM u FileContent newM u FileContent uuidStr m u n else String videoFilePath outputPath Fileseparator forName ts HashMapString String hashMap new HashMapString String hashMapputurl fileUrl hashMapputdownloadPath videoFilePath sizeDetectQueueaddhashMap downloadQueueaddhashMap newM u FileContent newM u FileContent forName ts n tsArraddnew FilevideoFilePath KLogevideoFilePath videoFilePath FileUtilstringToFilenewM u FileContent outputPath Fileseparator newM u FileName HttpRequestUtiljava public class HttpRequestUtil private static final String TAG HttpRequestUtil public static final String defaultCharset UTF GBK public static final int readTimeout s public static final int connectTimeout s public static final int maxRedirects public static MapString String commonHeaders public final static HostnameVerifier DONOTVERIFY new HostnameVerifier Override public boolean verifyString hostname SSLSession session return true static commonHeaders new HashMapString String commonHeadersputUserAgent Mozilla iPhone CPU iPhone OS like Mac OS X AppleWebKit KHTML like Gecko Version Mobile B Safari private static void trustAllHosts final String TAG trustAllHosts Create a trust manager that does not validate certificate chains TrustManager trustAllCerts new TrustManager new X TrustManager Override public X Certificate getAcceptedIssuers return new X Certificate Override public void checkClientTrustedX Certificate chain String authType throws CertificateException LogiTAG checkClientTrusted Override public void checkServerTrustedX Certificate chain String authType throws CertificateException LogiTAG checkServerTrusted Install the alltrusting trust manager try SSLContext sc SSLContextgetInstanceTLS scinitnull trustAllCerts new javasecuritySecureRandom HttpsURLConnectionsetDefaultSSLSocketFactoryscgetSocketFactory catch Exception e eprintStackTrace public static void mainString args throws Exception HeadRequestResponse headRequestResponse performHeadRequest SystemoutprintlnheadRequestResponsegetRealUrl SystemoutprintlntoJSONStringheadRequestResponsegetHeaderMap public static URLConnection sendGetRequestString url MapString String params MapString String headers throws IOException StringBuilder buf new StringBuilder URL urlObject new URLurl bufappendurlObjectgetProtocolappendappendurlObjectgetHostappendurlObjectgetPort urlObjectgetPort urlObjectgetDefaultPort urlObjectgetPortappendurlObjectgetPath String query urlObjectgetQuery if params null params new HashMapString String boolean isQueryExist false if query null querylength paramssize bufappend isQueryExist true if query null querylength bufappendquery bufappend SetEntryString String entrys paramsentrySet for EntryString String entry entrys bufappendentrygetKeyappend appendURLEncoderencodeentrygetValue defaultCharsetappend if isQueryExist bufdeleteCharAtbuflength Systemoutprintlnbefore url Systemoutprintlnafter buftoString urlObject new URLbuftoString HttpURLConnection conn null try if urlObjectgetProtocoltoUpperCaseequalsHTTPS trustAllHosts HttpsURLConnection https HttpsURLConnection urlObjectopenConnection httpssetHostnameVerifierDONOTVERIFY conn https else conn HttpURLConnection urlObjectopenConnection connsetRequestMethodGET connsetConnectTimeoutconnectTimeout connsetReadTimeoutreadTimeout if headers null entrys headersentrySet for EntryString String entry entrys connsetRequestPropertyentrygetKey entrygetValue conngetResponseCode return conn catch IOException e if conn null conndisconnect throw e public static URLConnection sendGetRequestString url throws IOException return sendGetRequesturl null commonHeaders public static URLConnection sendGetRequestString url MapString String params throws IOException return sendGetRequesturl params commonHeaders public static URLConnection sendPostRequestString url MapString String params MapString String headers throws IOException StringBuilder buf new StringBuilder if params null params new HashMapString String SetEntryString String entrys paramsentrySet for EntryString String entry entrys bufappend appendentrygetKeyappend appendURLEncoderencodeentrygetValue defaultCharset bufdeleteCharAt URL urlObject new URLurl HttpURLConnection conn null try if urlObjectgetProtocoltoUpperCaseequalsHTTPS trustAllHosts HttpsURLConnection https HttpsURLConnection urlObjectopenConnection httpssetHostnameVerifierDONOTVERIFY conn https else conn HttpURLConnection urlObjectopenConnection connsetRequestMethodPOST connsetConnectTimeoutconnectTimeout connsetReadTimeoutreadTimeout if headers null entrys headersentrySet for EntryString String entry entrys connsetRequestPropertyentrygetKey entrygetValue connsetDoOutputtrue OutputStream out conngetOutputStream SystemoutprintlnbuftoStringbuftoString outwritebuftoStringgetBytesdefaultCharset outflush conngetResponseCode return conn catch IOException e if conn null conndisconnect throw e public static URLConnection sendPostRequestString url MapString String params throws IOException try return sendPostRequesturl params commonHeaders catch Exception e eprintStackTrace return null public static URLConnection sendStringPostRequestString url String postDataString MapString String headers throws IOException if postDataString null postDataString SetEntryString String entrys URL urlObject new URLurl HttpURLConnection conn null try if urlObjectgetProtocoltoUpperCaseequalsHTTPS trustAllHosts HttpsURLConnection https HttpsURLConnection urlObjectopenConnection httpssetHostnameVerifierDONOTVERIFY conn https else conn HttpURLConnection urlObjectopenConnection connsetRequestMethodPOST connsetConnectTimeoutconnectTimeout connsetReadTimeoutreadTimeout if headers null entrys headersentrySet for EntryString String entry entrys connsetRequestPropertyentrygetKey entrygetValue connsetDoOutputtrue OutputStream out conngetOutputStream SystemoutprintlnbuftoStringbuftoString outwritepostDataStringgetBytesdefaultCharset outflush conngetResponseCode return conn catch IOException e if conn null conndisconnect throw e public static URLConnection sendStringPostRequestString url String postDataString throws IOException try return sendStringPostRequesturl postDataString commonHeaders catch Exception e eprintStackTrace return null public static String getResponseStringURLConnection urlConnection throws IOException InputStream inputStream null InputStreamReader inputStreamReader null BufferedReader reader null StringBuffer resultBuffer new StringBuffer String tempLine try if HttpURLConnection urlConnectiongetResponseCode throw new IOExceptionHTTP Request is not success Response code is HttpURLConnection urlConnectiongetResponseCode inputStream urlConnectiongetInputStream inputStreamReader new InputStreamReaderinputStream defaultCharset reader new BufferedReaderinputStreamReader while tempLine readerreadLine null resultBufferappendtempLine n return resultBuffertoString finally if reader null readerclose if inputStreamReader null inputStreamReaderclose if inputStream null inputStreamclose HttpURLConnection urlConnectiondisconnect public static void save FileURLConnection urlConnection String saveFilePath throws IOException DataInputStream dis null FileOutputStream fos null try dis new DataInputStreamurlConnectiongetInputStream fos new FileOutputStreamnew FilesaveFilePath byte buffer new byte int length while length disreadbuffer foswritebuffer length finally if dis null disclose if fos null fosclose HttpsURLConnection urlConnectiondisconnect public static HeadRequestResponse performHeadRequestString url throws IOException return performHeadRequesturl commonHeaders public static HeadRequestResponse performHeadRequestString url MapString String headers throws IOException return performHeadRequestForRedirectsurl headers private static HeadRequestResponse performHeadRequestForRedirectsString url MapString String headers int redirectCount throws IOException URL urlObject new URLurl HttpURLConnection conn null try if urlObjectgetProtocoltoUpperCaseequalsHTTPS trustAllHosts HttpsURLConnection https HttpsURLConnection urlObjectopenConnection httpssetHostnameVerifierDONOTVERIFY conn https else conn HttpURLConnection urlObjectopenConnection connsetInstanceFollowRedirectsfalse connsetRequestMethodGET connsetConnectTimeoutconnectTimeout connsetReadTimeoutreadTimeout if headers null SetEntryString String entrySet headersentrySet for EntryString String entry entrySet connsetRequestPropertyentrygetKey entrygetValue MapString ListString headerFields conngetHeaderFields int responseCode conngetResponseCode conndisconnect if responseCode if redirectCount maxRedirects return new HeadRequestResponseurl new HashMapString ListString else String location headerFieldsgetLocationget return performHeadRequestForRedirectslocation headers redirectCount else return new HeadRequestResponseurl headerFields finally if conn null conndisconnect public static class HeadRequestResponse private String realUrl private MapString ListString headerMap public HeadRequestResponse public HeadRequestResponseString realUrl MapString ListString headerMap thisrealUrl realUrl thisheaderMap headerMap public String getRealUrl return realUrl public void setRealUrlString realUrl thisrealUrl realUrl public MapString ListString getHeaderMap return headerMap public void setHeaderMapMapString ListString headerMap thisheaderMap headerMap M U FTP android javalangRuntimeException Only one Looper may be created per thread at androidosLooperprepareLooperjava at androidosLooperprepareLooperjava at comarialyyariacoreloaderAbsNormalLoaderstartFlowAbsNormalLoaderjava at comarialyyariacoreloaderAbsNormalLoaderrunAbsNormalLoaderjava at comarialyyariacoreloaderAbsNormalLoaderUtilstartAbsNormalLoaderUtiljava at comarialyyariacoretaskAbsTaskstartAbsTaskjava at comarialyyariacoretaskAbsTaskstartAbsTaskjava at comarialyyariacorequeueAbsTaskQueuereTryStartAbsTaskQueuejava at comarialyyariacorequeueAbsTaskQueuereTryStartAbsTaskQueuejava at comarialyyariacoreschedulerFailureTaskHandler runFailureTaskHandlerjava at androidosHandlerhandleCallbackHandlerjava at androidosHandlerdispatchMessageHandlerjava at androidosLooperloopLooperjava at androidappActivityThreadmainActivityThreadjava at javalangreflectMethodinvokeNativeNative Method at javalangreflectMethodinvokeMethodjava at comandroidinternalosZygoteInitMethodAndArgsCallerrunZygoteInitjava at comandroidinternalosZygoteInitmainZygoteInitjava at dalviksystemNativeStartmainNative Method websocket Ariadownloadthis loadurl ignoreFilePathOccupy setFilePathsavePath create android javalangIllegalStateException Handler androidosHandler a sending message to a Handler on a dead thread at androidosMessageQueueenqueueMessageMessageQueuejava at androidosHandlerenqueueMessageHandlerjava at androidosHandlersendMessageAtTimeHandlerjava at androidosHandlersendMessageDelayedHandlerjava at androidosHandlersendMessageHandlerjava at androidosMessagesendToTargetMessagejava at comarialyyariacoretaskThreadTasksendRunningStateThreadTaskjava at comarialyyariacoretaskThreadTaskupdateCompleteStateThreadTaskjava at comarialyyariacoretaskAbsThreadTaskAdaptercompleteAbsThreadTaskAdapterjava at comarialyyariam u M U ThreadTaskAdapterhandleCompleteM U ThreadTaskAdapterjava at comarialyyariam u M U ThreadTaskAdapterreadDynamicFileM U ThreadTaskAdapterjava at comarialyyariam u M U ThreadTaskAdapterhandleConnM U ThreadTaskAdapterjava at comarialyyariam u M U ThreadTaskAdapterhandlerThreadTaskM U ThreadTaskAdapterjava at comarialyyariacoretaskAbsThreadTaskAdaptercallAbsThreadTaskAdapterjava at comarialyyariacoretaskThreadTaskcallThreadTaskjava at comarialyyariacoretaskThreadTaskcallThreadTaskjava at javautilconcurrentFutureTaskrunFutureTaskjava at javautilconcurrentThreadPoolExecutorrunWorkerThreadPoolExecutorjava at javautilconcurrentThreadPoolExecutorWorkerrunThreadPoolExecutorjava at javalangThreadrunThreadjava android IVodTsUrlConverter setBandWidthUrlConverter M u InfoThread M U url m u ts m u ts m u m u ts Aria java M U VodOption option new M U VodOption optionsetBandWidth http m u m u Aria java static class BandWidthUrlConverter implements IBandWidthUrlConverter Override public String convertString bandWidthUrl return bandWidthUrl ts m u m u ts m u ts http ts ts java static class VodTsUrlConverter implements IVodTsUrlConverter Override public ListString convertString m u Url ListString tsUrls for String url tsUrls newUrlsadd url return newUrls m u tips m u m u ts android javalangArrayIndexOutOfBoundsException length index at comandroidokhttpokioBufferwriteByteBufferjava at comandroidokhttpinternalPlatformconcatLengthPrefixedPlatformjava at comandroidokhttpinternalPlatformconfigureTlsExtensionsPlatformjava at comandroidokhttpConnectionconnectTlsConnectionjava at comandroidokhttpConnectionconnectSocketConnectionjava at comandroidokhttpConnectionconnectConnectionjava at comandroidokhttpConnectionconnectAndSetOwnerConnectionjava at comandroidokhttpOkHttpClient connectAndSetOwnerOkHttpClientjava at comandroidokhttpinternalhttpHttpEngineconnectHttpEnginejava at comandroidokhttpinternalhttpHttpEnginesendRequestHttpEnginejava at comandroidokhttpinternalhucHttpURLConnectionImplexecuteHttpURLConnectionImpljava at comandroidokhttpinternalhucHttpURLConnectionImplconnectHttpURLConnectionImpljava at comandroidokhttpinternalhucDelegatingHttpsURLConnectionconnectDelegatingHttpsURLConnectionjava at comandroidokhttpinternalhucHttpsURLConnectionImplconnectHttpsURLConnectionImpljava at comarialyyariam u M U InfoThreadrunM U InfoThreadjava at javalangThreadrunThreadjava public void onPeerCompleteString m u Url String peerPath int peerIndex peerpath null log m u ts api ts m u option