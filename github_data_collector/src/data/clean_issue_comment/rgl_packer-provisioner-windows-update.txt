This looks to be the same issue as and possibly On Windows RS TiWorkerexe can remain active even after updates are complete and a reboot is pending Looking at other scripts and tools to install Windows Updates I cant find any other references to waiting for TiWorkerexe to complete before restarting It seems like the wait should be removed or at worst timed out and continuing with a reboot Im happy to make the PR but I wanted to discuss the issue first before proposing a code change If you have any questions please let me know Thanks Packer v Packerprovisionerwindowsupdate v My packer json template builders type vmwareiso vmname user vmname vmdkname user vmname outputdirectory user outputdirectory isourl user isourl isochecksum user isochecksum isochecksumtype user isochecksumtype communicator winrm winrmusername administrator winrmpassword password winrmtimeout h winrmport vncportmin vncportmax shutdowncommand aStartShutdownbat shutdowntimeout m headless user vmWareBuilderheadless guestostype user guestostype disksize keepregistered false skipvalidatecredentials true version floppyfiles extrafileswin autounattendxml extrascriptsbootstrapps extrascriptsStartShutdownbat floppydirs extrafilesvmwareToolsdrivers network user vmWareBuildernetwork cpus memory bootwait s vmxdata scsi virtualDev pvscsi annotation user vmWareBuilderannotation provisioners type windowsupdate filters includeTitle like Servicing Stack Update for Windows type windowsupdate type powershell inline WriteOutput Phase Deprovisioning if TestPath EnvSystemRoot windows system Sysprep unattendxml rm EnvSystemRoot windows system Sysprep unattendxml Force type windowsrestart restarttimeout h pausebefore s restartcheckcommand powershell command WriteOutput restarted I am trying to create a very basic image that is nothing but a base Windows with the most recent patches and nothing else When this runs the first windows update is executed properly as evidenced by the following log packerexe Running the provision hook INFO telemetry Starting provisioner windowsupdate ui m vmwareiso Uploading the Windows update elevated script m packerprovisionerwindowsupdateexe INFO bytes written for uploadData INFO bytes written for uploadData packerexe Uploading file to CWindowsTemppackerwindowsupdateelevatedps packerexe CLIXML packerexe Objs Version xmlns Sprogress RefId TN RefId TSystemManagementAutomationPSCustomObjectTTSystemObjectTTNMSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObjs CLIXML ui m vmwareiso Uploading the Windows update check for reboot required elevated script m packerprovisionerwindowsupdateexe INFO bytes written for uploadData INFO bytes written for uploadData packerexe Objs Version xmlns Sprogress RefId TN RefId TSystemManagementAutomationPSCustomObjectTTSystemObjectTTNMSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObjs Uploading file to CWindowsTemppackerwindowsupdatependingrebootelevatedps packerexe CLIXML packerexe Objs Version xmlns Sprogress RefId TN RefId TSystemManagementAutomationPSCustomObjectTTSystemObjectTTNMSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObjs CLIXML ui m vmwareiso Uploading the Windows update script m packerprovisionerwindowsupdateexe INFO bytes written for uploadData INFO bytes written for uploadData packerexe Objs Version xmlns Sprogress RefId TN RefId TSystemManagementAutomationPSCustomObjectTTSystemObjectTTNMSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObjs Uploading file to CWindowsTemppackerwindowsupdateps packerexe CLIXML packerexe Objs Version xmlns Sprogress RefId TN RefId TSystemManagementAutomationPSCustomObjectTTSystemObjectTTNMSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObjs CLIXML ui m vmwareiso Running Windows update m packerexe Objs Version xmlns Sprogress RefId TN RefId TSystemManagementAutomationPSCustomObjectTTSystemObjectTTNMSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObjs INFO starting remote command PowerShell ExecutionPolicy Bypass OutputFormat Text File CWindowsTemppackerwindowsupdateelevatedps ui m vmwareiso Searching for Windows updates m ui m vmwareiso Waiting for operation to complete system performance cpu memory m ui m vmwareiso Waiting for operation to complete system performance cpu memory m ui m vmwareiso Waiting for operation to complete system performance cpu memory m ui m vmwareiso Skipped filter Windows update MB Cumulative Update for Windows Server for x based Systems KB m ui m vmwareiso Skipped filter Windows update MB Windows Malicious Software Removal Tool x August KB m ui m vmwareiso Found Windows update MB Servicing Stack Update for Windows Server for x based Systems KB m ui m vmwareiso Skipped filter Windows update MB Security Intelligence Update for Windows Defender Antivirus KB Version m ui m vmwareiso Downloading Windows updates updates MB m ui m vmwareiso Waiting for operation to complete system performance cpu memory m ui m vmwareiso Installing Windows updates m ui m vmwareiso Waiting for operation to complete system performance cpu memory m packerexe INFO command PowerShell ExecutionPolicy Bypass OutputFormat Text File CWindowsTemppackerwindowsupdateelevatedps exited with code But the subsequent windows update doesnt seem to do everything its supposed to do It outputs that it is searching but never sends the names of the updates it found or the Downloading Windows updates and Installing Windows updates messages Here is the log for the second windows update attempt INFO telemetry Starting provisioner windowsupdate ui m vmwareiso Uploading the Windows update elevated script m packerprovisionerwindowsupdateexe INFO bytes written for uploadData INFO bytes written for uploadData packerexe Uploading file to CWindowsTemppackerwindowsupdateelevatedps packerexe CLIXML packerexe Objs Version xmlns Sprogress RefId TN RefId TSystemManagementAutomationPSCustomObjectTTSystemObjectTTNMSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObjs CLIXML ui m vmwareiso Uploading the Windows update check for reboot required elevated script m packerprovisionerwindowsupdateexe INFO bytes written for uploadData INFO bytes written for uploadData packerexe Objs Version xmlns Sprogress RefId TN RefId TSystemManagementAutomationPSCustomObjectTTSystemObjectTTNMSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObjs Uploading file to CWindowsTemppackerwindowsupdatependingrebootelevatedps packerexe CLIXML packerexe Objs Version xmlns Sprogress RefId TN RefId TSystemManagementAutomationPSCustomObjectTTSystemObjectTTNMSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObjs CLIXML ui m vmwareiso Uploading the Windows update script m packerprovisionerwindowsupdateexe INFO bytes written for uploadData INFO bytes written for uploadData packerexe Objs Version xmlns Sprogress RefId TN RefId TSystemManagementAutomationPSCustomObjectTTSystemObjectTTNMSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObjs Uploading file to CWindowsTemppackerwindowsupdateps packerexe CLIXML packerexe Objs Version xmlns Sprogress RefId TN RefId TSystemManagementAutomationPSCustomObjectTTSystemObjectTTNMSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObjs CLIXML ui m vmwareiso Running Windows update m packerexe Objs Version xmlns Sprogress RefId TN RefId TSystemManagementAutomationPSCustomObjectTTSystemObjectTTNMSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObjs INFO starting remote command PowerShell ExecutionPolicy Bypass OutputFormat Text File CWindowsTemppackerwindowsupdateelevatedps ui m vmwareiso Searching for Windows updates m ui m vmwareiso Waiting for operation to complete system performance cpu memory m ui m vmwareiso Waiting for operation to complete system performance cpu memory m ui m vmwareiso Waiting for operation to complete system performance cpu memory m ui m vmwareiso Waiting for operation to complete system performance cpu memory m ui m vmwareiso Waiting for operation to complete system performance cpu memory m ui m vmwareiso Waiting for operation to complete system performance cpu memory m ui m vmwareiso Waiting for operation to complete system performance cpu memory m ui m vmwareiso Waiting for operation to complete system performance cpu memory m packerexe INFO command PowerShell ExecutionPolicy Bypass OutputFormat Text File CWindowsTemppackerwindowsupdateelevatedps exited with code After this it exits the provisioner and continues on the packer process as if there was no issue When I bring up the completed VM afterwards I see that the only update applied was the Servicing Stack Update for Windows Server for x based Systems KB and all the other updates are still not done updatesAvailable updateHistory Do I have my packer template incorrectly configured for using this provisioner Add some documentation on how the plugin handles restarts if its possible to ignore restarts to allow further system changes before reboot etc The other PR is a little old at this point and I just made this for an update Version v Packer Version v x seems to have issues with Chocolatey The plugin despite many search attempts Cumulative KB Cumulative Update for Windows Server etc does not select the following result Windows Update on the server wants to apply It does however find the one other update KB without issue Im using the latest version along with Packer Im using the vanilla provisioner type windowsupdate The log output below shows it executed the PowerShell command and got an exit code but no updates happened and the provisioning process moved on In comparing with other outputs posted here I notice the searching for updates is missing After the image completed I created a VM from it and it took quite a while for the new VM to identify updates including the massive May rollupit did not get applied as part of the Packer build I hoped it would do the update Is there a flag or something I should be passing to tell it to wait for the download and install of the updates Im hoping Im just missing something simple vsphereiso Running Windows update packerbuildervsphereisolinux Objs Version xmlns Sprogress RefId TN RefId TSystemManagementAutomationPSCustomObjectTTSystemObjectTTNMSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObjs INFO starting remote command PowerShell ExecutionPolicy Bypass OutputFormat Text File CWindowsTemppackerwindowsupdateelevatedps vsphereiso Waiting for the Windows Modules Installer to exit packerbuildervsphereisolinux INFO command PowerShell ExecutionPolicy Bypass OutputFormat Text File CWindowsTemppackerwindowsupdateelevatedps exited with code INFO bytes written for stdout INFO bytes written for stderr INFO RPC client Communicator ended with INFO RPC endpoint Communicator ended with packerbuildervsphereisolinux INFO RPC endpoint Communicator ended with packerprovisionerwindowsupdate INFO bytes written for stdout packerprovisionerwindowsupdate INFO bytes written for stderr packerprovisionerwindowsupdate INFO RPC client Communicator ended with INFO telemetry ending windowsupdate We have an automated process which runs our packer templates multiple times per week We have consistently received the following error only in the Australia East region unexpected EOF details summaryFull logssummary T Z debug T Z debug Match start index T Z debug Match start index T Z moprodaustralia east win Uploading the Windows update elevated script T Z T Z debug Parsing log line to extract output T Z debug T Z debug moprodaustralia east win Uploading the Windows update elevated script T Z debug T Z debug Match start index T Z debug Match start index T Z moprodaustralia east win Uploading the Windows update check for reboot required elevated script T Z T Z debug Parsing log line to extract output T Z debug T Z debug moprodaustralia east win Uploading the Windows update check for reboot required elevated script T Z debug T Z debug Match start index T Z debug Match start index T Z moprodaustralia east win Uploading the Windows update script T Z T Z debug Parsing log line to extract output T Z debug T Z debug moprodaustralia east win Uploading the Windows update script T Z debug T Z debug Match start index T Z debug Match start index T Z moprodaustralia east win Running Windows update T Z T Z debug Parsing log line to extract output T Z debug T Z debug moprodaustralia east win Running Windows update T Z debug T Z debug Match start index T Z debug Match start index T Z moprodaustralia east win Searching for Windows updates T Z T Z debug Parsing log line to extract output T Z debug T Z debug moprodaustralia east win Searching for Windows updates T Z debug T Z debug Match start index T Z debug Match start index T Z moprodaustralia east win Found Windows update MB Update for Adobe Flash Player for Windows Server for x based Systems KB T Z T Z debug Parsing log line to extract output T Z debug T Z debug moprodaustralia east win Found Windows update MB Update for Adobe Flash Player for Windows Server for x based Systems KB T Z debug T Z debug Match start index T Z debug Match start index T Z moprodaustralia east win Found Windows update MB Cumulative Update for NET Framework and for Windows Server for x KB T Z T Z debug Parsing log line to extract output T Z debug T Z debug moprodaustralia east win Found Windows update MB Cumulative Update for NET Framework and for Windows Server for x KB T Z debug T Z debug Match start index T Z debug Match start index T Z moprodaustralia east win Found Windows update MB Windows Malicious Software Removal Tool x April KB T Z T Z debug Parsing log line to extract output T Z debug T Z debug moprodaustralia east win Found Windows update MB Windows Malicious Software Removal Tool x April KB T Z debug T Z debug Match start index T Z debug Match start index T Z moprodaustralia east win Found Windows update MB Security Update for Adobe Flash Player for Windows Server for x based Systems KB T Z T Z debug Parsing log line to extract output T Z debug T Z debug moprodaustralia east win Found Windows update MB Security Update for Adobe Flash Player for Windows Server for x based Systems KB T Z debug T Z debug Match start index T Z debug Match start index T Z moprodaustralia east win Found Windows update MB Definition Update for Windows Defender Antivirus KB Definition T Z T Z debug Parsing log line to extract output T Z debug T Z debug moprodaustralia east win Found Windows update MB Definition Update for Windows Defender Antivirus KB Definition T Z debug T Z debug Match start index T Z debug Match start index T Z moprodaustralia east win Found Windows update MB Cumulative Update for Windows Server for x based Systems KB T Z T Z debug Parsing log line to extract output T Z debug T Z debug moprodaustralia east win Found Windows update MB Cumulative Update for Windows Server for x based Systems KB T Z debug T Z debug Match start index T Z debug Match start index T Z moprodaustralia east win Downloading Windows updates updates MB T Z T Z debug Parsing log line to extract output T Z debug T Z debug moprodaustralia east win Downloading Windows updates updates MB T Z debug T Z debug Match start index T Z debug Match start index T Z moprodaustralia east win Installing Windows updates T Z T Z debug Parsing log line to extract output T Z debug T Z debug moprodaustralia east win Installing Windows updates T Z debug T Z debug Match start index T Z debug Match start index T Z moprodaustralia east win Waiting for the Windows Modules Installer to exit T Z T Z debug Parsing log line to extract output T Z debug T Z debug moprodaustralia east win Waiting for the Windows Modules Installer to exit T Z debug T Z debug Match start index T Z debug Match start index T Z moprodaustralia east win Waiting for machine to restart T Z T Z debug Parsing log line to extract output T Z debug T Z debug moprodaustralia east win Waiting for machine to restart T Z debug T Z debug Match start index T Z debug Match start index T Z Build moprodaustralia east win errored unexpected EOF T Z T Z debug Parsing log line to extract output T Z debug T Z debug Build moprodaustralia east win errored unexpected EOF T Z debug T Z debug Match start index T Z debug Match start index T Z T Z T Z debug Parsing log line to extract output T Z debug T Z debug T Z debug T Z debug Match start index T Z debug Match start index T Z Some builds didnt complete successfully and had errors T Z T Z debug Parsing log line to extract output T Z debug T Z debug Some builds didnt complete successfully and had errors T Z debug T Z debug Match start index T Z debug Match start index T Z moprodaustralia east win unexpected EOF T Z T Z Builds finished but no artifacts were created T Z T Z debug Parsing log line to extract output T Z debug T Z debug moprodaustralia east win unexpected EOF Builds finished but no artifacts were created T Z debug T Z debug Match start index T Z debug Match start index T Z panic runtime error invalid memory address or nil pointer dereference T Z packerexe signal xc code x addr x pc x bd T Z packerexe T Z packerexe goroutine running T Z packerexe nethttpredirectBehavior x d x x xc x x x T Z packerexe usrlocalCellargo libexecsrcnethttpclientgo x d T Z packerexe nethttpClientdo xc cb xc x x x T Z packerexe usrlocalCellargo libexecsrcnethttpclientgo x T Z packerexe nethttpClientDo xc cb xc x xc fab x T Z packerexe usrlocalCellargo libexecsrcnethttpclientgo x c T Z packerexe githubcomhashicorppackervendorgithubcommasterzenwinrmclientRequestPost x efee xc d xc ac xc bf x x x x T Z packerexe Usersazrgosrcgithubcomhashicorppackervendorgithubcommasterzenwinrmhttpgo x c T Z packerexe githubcomhashicorppackervendorgithubcommasterzenwinrmClientNTLMPost x efee xc d xc ac xc bf xc bf xc cf x b xd T Z packerexe Usersazrgosrcgithubcomhashicorppackervendorgithubcommasterzenwinrmntlmgo x T Z packerexe githubcomhashicorppackervendorgithubcommasterzenwinrmClientsendRequest xc ac xc bf xc bf xc bf x ed x e T Z packerexe Usersazrgosrcgithubcomhashicorppackervendorgithubcommasterzenwinrmclientgo x a T Z packerexe githubcomhashicorppackervendorgithubcommasterzenwinrmClientCreateShell xc ac x x x T Z packerexe Usersazrgosrcgithubcomhashicorppackervendorgithubcommasterzenwinrmclientgo xa T Z packerexe githubcomhashicorppackercommunicatorwinrmCommunicatorStart xc b xc eae xc a x f T Z packerexe Usersazrgosrcgithubcomhashicorppackercommunicatorwinrmcommunicatorgo x a T Z packerexe githubcomhashicorppackerpackerrpcCommunicatorServerStart xc beea xc de xc d d x x T Z packerexe Usersazrgosrcgithubcomhashicorppackerpackerrpccommunicatorgo x f T Z packerexe reflectValuecall xc ea xc x x d x xc f x x xc bb x T Z packerexe usrlocalCellargo libexecsrcreflectvaluego x T Z packerexe reflectValueCall xc ea xc x xc f x x x x x T Z packerexe usrlocalCellargo libexecsrcreflectvaluego xab T Z packerexe netrpcservicecall xc f xc f b xc d xc xc d xc d a x e de xc de x x ebc T Z packerexe usrlocalCellargo libexecsrcnetrpcservergo x T Z packerexe created by netrpcServerServeCodec T Z packerexe usrlocalCellargo libexecsrcnetrpcservergo x T Z INFO bytes written for stdout T Z INFO bytes written for stderr T Z ERR Error decoding response stream EOF T Z INFO telemetry ending azurearm T Z ui error Build moprodaustralia east win errored unexpected EOF T Z Builds completed Waiting on interrupt barrier T Z ERR Error decoding response stream EOF T Z machine readable errorcount string T Z ui error T Z Some builds didnt complete successfully and had errors T Z machine readable moprodaustralia east win error stringunexpected EOF T Z ui error moprodaustralia east win unexpected EOF T Z ui T Z Builds finished but no artifacts were created T Z INFO telemetry Finalizing T Z packerprovisionerwindowsupdateexe INFO bytes written for stdout T Z packerprovisionerwindowsupdateexe INFO bytes written for stderr T Z packerprovisionerwindowsupdateexe Waiting for machine to reboot with timeout h m s T Z packerprovisionerwindowsupdateexe Waiting for machine to become available T Z f agent work temp packer packerexe plugin process exited T Z waiting for all plugin processes to complete T Z f agent work temp packer packerexe plugin process exited T Z f agent work temp packer packerexe plugin process exited T Z f agent work temp packer packerexe plugin process exited T Z f agent work temp packer packerexe plugin process exited T Z f agent work temp packer packerexe plugin process exited T Z f agent work temp packer packerexe plugin process exited T Z f agent work temp packer packerexe plugin process exited T Z INFO telemetry ending windowsupdate T Z f agent work temp packer packerexe plugin process exited T Z f agent work temp packer packerexe plugin process exited T Z f agent work temp packer packerexe plugin process exited T Z f agent work temp packer packerexe plugin process exited T Z f agent work temp packer packerexe plugin process exited T Z f agent work temp packer packerexe plugin process exited T Z f agent work temp packer packerexe plugin process exited T Z f agent work temp packer packerexe plugin process exited T Z f agent work temp packer packerexe plugin process exited T Z f agent work temp packer packerexe plugin process exited T Z f agent work temp packer packerexe plugin process exited T Z f agent work r a packerprovisionerwindowsupdateexe plugin process exited T Z f agent work temp packer packerexe plugin process exited T Z T Z T Z debug Parsing log line to extract output T Z debug T Z debug panic runtime error invalid memory address or nil pointer dereference packerexe signal xc code x addr x pc x bd packerexe packerexe goroutine running packerexe nethttpredirectBehavior x d x x xc x x x packerexe usrlocalCellargo libexecsrcnethttpclientgo x d packerexe nethttpClientdo xc cb xc x x x packerexe usrlocalCellargo libexecsrcnethttpclientgo x packerexe nethttpClientDo xc cb xc x xc fab x packerexe usrlocalCellargo libexecsrcnethttpclientgo x c packerexe githubcomhashicorppackervendorgithubcommasterzenwinrmclientRequestPost x efee xc d xc ac xc bf x x x x packerexe Usersazrgosrcgithubcomhashicorppackervendorgithubcommasterzenwinrmhttpgo x c packerexe githubcomhashicorppackervendorgithubcommasterzenwinrmClientNTLMPost x efee xc d xc ac xc bf xc bf xc cf x b xd packerexe Usersazrgosrcgithubcomhashicorppackervendorgithubcommasterzenwinrmntlmgo x packerexe githubcomhashicorppackervendorgithubcommasterzenwinrmClientsendRequest xc ac xc bf xc bf xc bf x ed x e packerexe Usersazrgosrcgithubcomhashicorppackervendorgithubcommasterzenwinrmclientgo x a packerexe githubcomhashicorppackervendorgithubcommasterzenwinrmClientCreateShell xc ac x x x packerexe Usersazrgosrcgithubcomhashicorppackervendorgithubcommasterzenwinrmclientgo xa packerexe githubcomhashicorppackercommunicatorwinrmCommunicatorStart xc b xc eae xc a x f packerexe Usersazrgosrcgithubcomhashicorppackercommunicatorwinrmcommunicatorgo x a packerexe githubcomhashicorppackerpackerrpcCommunicatorServerStart xc beea xc de xc d d x x packerexe Usersazrgosrcgithubcomhashicorppackerpackerrpccommunicatorgo x f packerexe reflectValuecall xc ea xc x x d x xc f x x xc bb x packerexe usrlocalCellargo libexecsrcreflectvaluego x packerexe reflectValueCall xc ea xc x xc f x x x x x packerexe usrlocalCellargo libexecsrcreflectvaluego xab packerexe netrpcservicecall xc f xc f b xc d xc xc d xc d a x e de xc de x x ebc packerexe usrlocalCellargo libexecsrcnetrpcservergo x packerexe created by netrpcServerServeCodec packerexe usrlocalCellargo libexecsrcnetrpcservergo x INFO bytes written for stdout INFO bytes written for stderr ERR Error decoding response stream EOF INFO telemetry ending azurearm ui error Build moprodaustralia east win errored unexpected EOF Builds completed Waiting on interrupt barrier ERR Error decoding response stream EOF machine readable errorcount string ui error Some builds didnt complete successfully and had errors machine readable moprodaustralia east win error stringunexpected EOF ui error moprodaustralia east win unexpected EOF ui Builds finished but no artifacts were created INFO telemetry Finalizing packerprovisionerwindowsupdateexe INFO bytes written for stdout packerprovisionerwindowsupdateexe INFO bytes written for stderr packerprovisionerwindowsupdateexe Waiting for machine to reboot with timeout h m s packerprovisionerwindowsupdateexe Waiting for machine to become available f agent work temp packer packerexe plugin process exited waiting for all plugin processes to complete f agent work temp packer packerexe plugin process exited f agent work temp packer packerexe plugin process exited f agent work temp packer packerexe plugin process exited f agent work temp packer packerexe plugin process exited f agent work temp packer packerexe plugin process exited f agent work temp packer packerexe plugin process exited f agent work temp packer packerexe plugin process exited INFO telemetry ending windowsupdate f agent work temp packer packerexe plugin process exited f agent work temp packer packerexe plugin process exited f agent work temp packer packerexe plugin process exited f agent work temp packer packerexe plugin process exited f agent work temp packer packerexe plugin process exited f agent work temp packer packerexe plugin process exited f agent work temp packer packerexe plugin process exited f agent work temp packer packerexe plugin process exited f agent work temp packer packerexe plugin process exited f agent work temp packer packerexe plugin process exited f agent work temp packer packerexe plugin process exited f agent work r a packerprovisionerwindowsupdateexe plugin process exited f agent work temp packer packerexe plugin process exited T Z debug T Z debug Match start index T Z debug Match start index T Z T Z T Z PACKER CRASH T Z T Z Packer crashed This is always indicative of a bug within Packer T Z A crash log has been placed at crashlog relative to your current T Z working directory It would be immensely helpful if you could please T Z report the crash with Packer so that we can fix this T Z T Z T Z T Z PACKER CRASH T Z T Z debug Parsing log line to extract output T Z debug T Z debug PACKER CRASH Packer crashed This is always indicative of a bug within Packer A crash log has been placed at crashlog relative to your current working directory It would be immensely helpful if you could please report the crash with Packer so that we can fix this PACKER CRASH details This same exact template works in the other regions we run this in Azure East US North Europe West US This failure has happened every single time over the past weeks Note that we did not use the windowsupdate plug in before that We recently upgraded our images from Windows to Windows and need the plug in because the Azure Marketplace Windows images do not have all the critical updates installed I am reporting this issue to the plug in because the template also worked on Windows Server in Azure Australia East region before the addition of the windowsupdate plug in I have upgraded to the latest version of this plugin v but it has the same error Additionally I have upgraded our Packer version from to and have a different error with Packer that I reported But I have upgraded Packer to version and it has the same EOF error Packer crash log crashlog Having issues building a VHD image as part of a build pipeline in Azure Devops The task starts but then just sits on searching for updates or similar until the hosted agent times out after hours I have had one build which succeeded but then running two further builds failed without any config changes I am installing the provisioner using choco install task prior to the build image task json builders capturecontainername vstsbuildimagetask capturenameprefix user capturenameprefix clientid user clientid clientsecret user clientsecret communicator winrm imageoffer user imageoffer imagepublisher user imagepublisher imagesku user imagesku location user location objectid user objectid ostype Windows resourcegroupname user environmentRG storageaccount user environment lower subscriptionid user subscriptionid tenantid user tenantid type azurearm vmsize StandardD v winrminsecure true winrmtimeout m winrmusessl true winrmusername packer postprocessors provisioners type windowsshell inline cmd c if exist c fileTemp rd s q c fileTemp cmd c mkdir c fileTemp type windowsupdate type file source user packagepath destination c fileTemp user packagename type powershell inline cd C fileTemp C fileTemp user packagename user scriptPath type powershell inline if TestPath EnvSystemRoot windows system Sysprep unattendxml rm EnvSystemRoot windows system Sysprep unattendxml Force EnvSystemRoot System Sysprep Sysprepexe oobe generalize quit quiet variables capturenameprefix clientid clientsecret imageoffer imagepublisher imagesku location objectid packagename packagepath scriptPath subscriptionid tenantid environment The build gets stuck when downloading or installing windows updates at various stages This sits for hours until the hosted agent times out example Log T Z azurearm Uploading the Windows update elevated script T Z T Z azurearm Uploading the Windows update check for reboot required elevated script T Z T Z azurearm Uploading the Windows update script T Z T Z azurearm Running Windows update T Z T Z azurearm Searching for Windows updates First time using this provider but keep hitting a problem during everybuild Any suggestions please Can see it also disscussed here but Ive tried adding a reboot before and after the windows update provisioner Snipet from my build json file Everything before this works fine type windowsrestart type windowsupdate filters excludeTitle like Preview includeTitle like Cumulative Update for Windows includeTitle like Recommended includeAutoSelectOnWebSites type windowsrestart type powershell inline C ProgramData Amazon EC Windows Launch Scripts InitializeDisksps Schedule C ProgramData Amazon EC Windows Launch Scripts InitializeInstanceps Schedule C ProgramData Amazon EC Windows Launch Scripts SysprepInstanceps noshutdown amazonebs Uploading the Windows update elevated script amazonebs Uploading the Windows update script amazonebs Running Windows update amazonebs CLIXML amazonebs Pending Reboot detected Waiting for the Windows Modules Installer to exit amazonebs Rebooting amazonebs Objs Version xmlns Sprogress RefId TN RefId TSystemManagementAutomationPSCustomObjectTTSystemObjectTTNMSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObj Sprogress RefId TNRef RefId MSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObjs amazonebs Waiting for machine to restart amazonebs A system shutdown is in progress amazonebs EC AMAZ TNC L restarted amazonebs CLIXML amazonebs Objs Version xmlns Sprogress RefId TN RefId TSystemManagementAutomationPSCustomObjectTTSystemObjectTTNMSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObjs amazonebs Machine successfully restarted moving on amazonebs Running Windows update amazonebs CLIXML amazonebs Searching for Windows updates amazonebs Found Windows update MB Cumulative Update for Windows Server for x based Systems KB amazonebs Found Windows update MB Definition Update for Windows Defender Antivirus KB Definition amazonebs Downloading Windows updates amazonebs Installing Windows updates amazonebs Pending Reboot detected Waiting for the Windows Modules Installer to exit amazonebs Rebooting amazonebs Objs Version xmlns Sprogress RefId TN RefId TSystemManagementAutomationPSCustomObjectTTSystemObjectTTNMSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObj Sprogress RefId TNRef RefId MSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObjs amazonebs Waiting for machine to restart amazonebs A system shutdown is in progress amazonebs EC AMAZ TNC L restarted amazonebs CLIXML amazonebs Objs Version xmlns Sprogress RefId TN RefId TSystemManagementAutomationPSCustomObjectTTSystemObjectTTNMSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObjs amazonebs Machine successfully restarted moving on amazonebs Running Windows update amazonebs CLIXML amazonebs Searching for Windows updates amazonebs Terminating the source AWS instance amazonebs Cleaning up any extra volumes amazonebs No volumes to clean up skipping amazonebs Deleting temporary security group amazonebs Deleting temporary keypair Build amazonebs errored Windows update script exited with nonzero exit status Some builds didnt complete successfully and had errors amazonebs Windows update script exited with nonzero exit status Builds finished but no artifacts were created vsphereiso Running Windows update vsphereiso CLIXML vsphereiso Searching for Windows updates vsphereiso Skipped filter Windows update MB Microsoft Silverlight KB vsphereiso Found Windows update MB Cumulative Update for Windows Server for x based Systems KB vsphereiso Found Windows update MB Update for Windows Server for x based Systems KB vsphereiso Found Windows update MB Windows Malicious Software Removal Tool x September KB vsphereiso Found Windows update MB Definition Update for Windows Defender Antivirus KB Definition vsphereiso Downloading Windows updates vsphereiso Installing Windows updates vsphereiso Pending Reboot detected Waiting for the Windows Modules Installer to exit vsphereiso Rebooting vsphereiso Objs Version xmlns Sprogress RefId TN RefId TSystemManagementAutomationPSCustomObjectTTSystemObjectTTNMSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObj Sprogress RefId TNRef RefId MSI NSourceId I PR NRecordAVPreparing modules for first useAVAI AINil PI PIPC PCTCompletedTSR SRSD SDPRMSObjObjs vsphereiso Power off VM vsphereiso Destroying VM Build vsphereiso errored Windows update script exited with nonzero exit status Maybe its the progress part at the end If so adding ProgressPreferenceSilentlyContinue internally to your powershell calls could help Or its because Im connecting with ssh instead of winrm into it