tispark extensions sql delta sql spark extensions ParserInterface sql scala case class DeleteTableCommandtable TableIdentifier where Option String extends RunnableCommand override def runsparkSession SparkSession Seq Row Delta Table Delete DeltaUtilsdeltaTableChecksparkSession table DELETE val deltaTable DeltaUtilsgetDeltaTablesparkSession table if whereisEmpty deltaTabledelete else deltaTabledeletewhereget deltaTablegeneratesymlinkformatmanifest Seqempty Row scala delta scala api case class UpdateTableCommandtable TableIdentifier upset Map String String where Option String extends RunnableCommand override def runsparkSession SparkSession Seq Row Delta Table Update DeltaUtilsdeltaTableChecksparkSession table UPDATE val deltaTable DeltaUtilsgetDeltaTablesparkSession table if whereisEmpty deltaTableupdateExprupset else deltaTableupdateExprwhereget upset deltaTablegeneratesymlinkformatmanifest Seqempty Row BAZEL support has not been maintained for a long time also it is no longer documented in README purpose to remove it from this project zhexuany ilovesoup marsishandsome TiDBTiKV used a new row format TiSpark should support it RFC Relating PRs tispark hive tidb spark sql sql tidb hive tidb hive tidb support in pushdown in tispark see chspark Describe the bug scala T Z Write Empty data T Z WARN TaskSetManager Stage contains a task of very large size KB The maximum recommended task size is KB T Z WARN TaskSetManager Stage contains a task of very large size KB The maximum recommended task size is KB T Z WARN TaskSetManager Stage contains a task of very large size KB The maximum recommended task size is KB T Z WARN TaskSetManager Stage contains a task of very large size KB The maximum recommended task size is KB T Z WARN TaskSetManager Stage contains a task of very large size KB The maximum recommended task size is KB T Z WARN TaskSetManager Stage contains a task of very large size KB The maximum recommended task size is KB T Z ERROR DAGIterator Process region tasks failed remain tasks not executed due to T Z compingcaptikvexceptionGrpcException retry is exhausted T Z at compingcaptikvutilConcreteBackOfferdoBackOffConcreteBackOfferjava T Z at compingcaptikvregionRegionStoreClienthandleCopResponseRegionStoreClientjava T Z at compingcaptikvregionRegionStoreClientcoprocessRegionStoreClientjava T Z at compingcaptikvoperationiteratorDAGIteratorprocessDAGIteratorjava T Z at compingcaptikvoperationiteratorDAGIteratorlambdasubmitTasks DAGIteratorjava T Z at javautilconcurrentFutureTaskrunFutureTaskjava T Z at javautilconcurrentExecutorsRunnableAdaptercallExecutorsjava T Z at javautilconcurrentFutureTaskrunFutureTaskjava T Z at javautilconcurrentThreadPoolExecutorrunWorkerThreadPoolExecutorjava T Z at javautilconcurrentThreadPoolExecutorWorkerrunThreadPoolExecutorjava T Z at javalangThreadrunThreadjava T Z Caused by compingcaptikvexceptionLockException T Z more T Z ERROR Executor Exception in task in stage TID T Z compingcaptikvexceptionTiClientInternalException Error reading region T Z at compingcaptikvoperationiteratorDAGIteratordoReadNextRegionChunksDAGIteratorjava T Z at compingcaptikvoperationiteratorDAGIteratorreadNextRegionChunksDAGIteratorjava T Z at compingcaptikvoperationiteratorDAGIteratorhasNextDAGIteratorjava T Z at orgapachesparksqltisparkTiRowRDDanon hasNextTiRowRDDscala T Z at orgapachesparksqlcatalystexpressionsGeneratedClassGeneratedIteratorForCodegenStage coprocessorrddnextBatch Unknown Source T Z at orgapachesparksqlcatalystexpressionsGeneratedClassGeneratedIteratorForCodegenStage processNextUnknown Source T Z at orgapachesparksqlexecutionBufferedRowIteratorhasNextBufferedRowIteratorjava T Z at orgapachesparksqlexecutionWholeStageCodegenExecanonfun anon hasNextWholeStageCodegenExecscala T Z at scalacollectionIteratoranon hasNextIteratorscala T Z at scalacollectionIteratoranon hasNextIteratorscala T Z at orgapachesparkutilrandomSamplingUtilsreservoirSampleAndCountSamplingUtilsscala T Z at orgapachesparkRangePartitioneranonfun applyPartitionerscala T Z at orgapachesparkRangePartitioneranonfun applyPartitionerscala T Z at orgapachesparkrddRDDanonfunmapPartitionsWithIndex anonfunapply applyRDDscala T Z at orgapachesparkrddRDDanonfunmapPartitionsWithIndex anonfunapply applyRDDscala T Z at orgapachesparkrddMapPartitionsRDDcomputeMapPartitionsRDDscala T Z at orgapachesparkrddRDDcomputeOrReadCheckpointRDDscala T Z at orgapachesparkrddRDDiteratorRDDscala T Z at orgapachesparkschedulerResultTaskrunTaskResultTaskscala T Z at orgapachesparkschedulerTaskrunTaskscala T Z at orgapachesparkexecutorExecutorTaskRunneranonfun applyExecutorscala T Z at orgapachesparkutilUtilstryWithSafeFinallyUtilsscala T Z at orgapachesparkexecutorExecutorTaskRunnerrunExecutorscala T Z at javautilconcurrentThreadPoolExecutorrunWorkerThreadPoolExecutorjava T Z at javautilconcurrentThreadPoolExecutorWorkerrunThreadPoolExecutorjava T Z at javalangThreadrunThreadjava T Z Caused by javautilconcurrentExecutionException compingcaptikvexceptionRegionTaskException Handle region task failed T Z at javautilconcurrentFutureTaskreportFutureTaskjava T Z at javautilconcurrentFutureTaskgetFutureTaskjava T Z at compingcaptikvoperationiteratorDAGIteratordoReadNextRegionChunksDAGIteratorjava T Z more T Z Caused by compingcaptikvexceptionRegionTaskException Handle region task failed T Z at compingcaptikvoperationiteratorDAGIteratorprocessDAGIteratorjava T Z at compingcaptikvoperationiteratorDAGIteratorlambdasubmitTasks DAGIteratorjava T Z at javautilconcurrentFutureTaskrunFutureTaskjava T Z at javautilconcurrentExecutorsRunnableAdaptercallExecutorsjava T Z at javautilconcurrentFutureTaskrunFutureTaskjava T Z more T Z Caused by compingcaptikvexceptionGrpcException retry is exhausted T Z at compingcaptikvutilConcreteBackOfferdoBackOffConcreteBackOfferjava T Z at compingcaptikvregionRegionStoreClienthandleCopResponseRegionStoreClientjava T Z at compingcaptikvregionRegionStoreClientcoprocessRegionStoreClientjava T Z at compingcaptikvoperationiteratorDAGIteratorprocessDAGIteratorjava T Z more T Z Caused by compingcaptikvexceptionLockException T Z more T Z WARN TaskSetManager Lost task in stage TID localhost executor driver compingcaptikvexceptionTiClientInternalException Error reading region T Z at compingcaptikvoperationiteratorDAGIteratordoReadNextRegionChunksDAGIteratorjava T Z at compingcaptikvoperationiteratorDAGIteratorreadNextRegionChunksDAGIteratorjava T Z at compingcaptikvoperationiteratorDAGIteratorhasNextDAGIteratorjava T Z at orgapachesparksqltisparkTiRowRDDanon hasNextTiRowRDDscala T Z at orgapachesparksqlcatalystexpressionsGeneratedClassGeneratedIteratorForCodegenStage coprocessorrddnextBatch Unknown Source T Z at orgapachesparksqlcatalystexpressionsGeneratedClassGeneratedIteratorForCodegenStage processNextUnknown Source T Z at orgapachesparksqlexecutionBufferedRowIteratorhasNextBufferedRowIteratorjava T Z at orgapachesparksqlexecutionWholeStageCodegenExecanonfun anon hasNextWholeStageCodegenExecscala T Z at scalacollectionIteratoranon hasNextIteratorscala T Z at scalacollectionIteratoranon hasNextIteratorscala T Z at orgapachesparkutilrandomSamplingUtilsreservoirSampleAndCountSamplingUtilsscala T Z at orgapachesparkRangePartitioneranonfun applyPartitionerscala T Z at orgapachesparkRangePartitioneranonfun applyPartitionerscala T Z at orgapachesparkrddRDDanonfunmapPartitionsWithIndex anonfunapply applyRDDscala T Z at orgapachesparkrddRDDanonfunmapPartitionsWithIndex anonfunapply applyRDDscala T Z at orgapachesparkrddMapPartitionsRDDcomputeMapPartitionsRDDscala T Z at orgapachesparkrddRDDcomputeOrReadCheckpointRDDscala T Z at orgapachesparkrddRDDiteratorRDDscala T Z at orgapachesparkschedulerResultTaskrunTaskResultTaskscala T Z at orgapachesparkschedulerTaskrunTaskscala T Z at orgapachesparkexecutorExecutorTaskRunneranonfun applyExecutorscala T Z at orgapachesparkutilUtilstryWithSafeFinallyUtilsscala T Z at orgapachesparkexecutorExecutorTaskRunnerrunExecutorscala T Z at javautilconcurrentThreadPoolExecutorrunWorkerThreadPoolExecutorjava T Z at javautilconcurrentThreadPoolExecutorWorkerrunThreadPoolExecutorjava T Z at javalangThreadrunThreadjava T Z Caused by javautilconcurrentExecutionException compingcaptikvexceptionRegionTaskException Handle region task failed T Z at javautilconcurrentFutureTaskreportFutureTaskjava T Z at javautilconcurrentFutureTaskgetFutureTaskjava T Z at compingcaptikvoperationiteratorDAGIteratordoReadNextRegionChunksDAGIteratorjava T Z more T Z Caused by compingcaptikvexceptionRegionTaskException Handle region task failed T Z at compingcaptikvoperationiteratorDAGIteratorprocessDAGIteratorjava T Z at compingcaptikvoperationiteratorDAGIteratorlambdasubmitTasks DAGIteratorjava T Z at javautilconcurrentFutureTaskrunFutureTaskjava T Z at javautilconcurrentExecutorsRunnableAdaptercallExecutorsjava T Z at javautilconcurrentFutureTaskrunFutureTaskjava T Z more T Z Caused by compingcaptikvexceptionGrpcException retry is exhausted T Z at compingcaptikvutilConcreteBackOfferdoBackOffConcreteBackOfferjava T Z at compingcaptikvregionRegionStoreClienthandleCopResponseRegionStoreClientjava T Z at compingcaptikvregionRegionStoreClientcoprocessRegionStoreClientjava T Z at compingcaptikvoperationiteratorDAGIteratorprocessDAGIteratorjava T Z more T Z Caused by compingcaptikvexceptionLockException T Z more T Z T Z ERROR TaskSetManager Task in stage failed times aborting job T Z ERROR DAGIterator Process region tasks failed remain tasks not executed due to T Z compingcaptikvexceptionGrpcException retry is exhausted T Z at compingcaptikvutilConcreteBackOfferdoBackOffConcreteBackOfferjava T Z at compingcaptikvregionRegionStoreClienthandleCopResponseRegionStoreClientjava T Z at compingcaptikvregionRegionStoreClientcoprocessRegionStoreClientjava T Z at compingcaptikvoperationiteratorDAGIteratorprocessDAGIteratorjava T Z at compingcaptikvoperationiteratorDAGIteratorlambdasubmitTasks DAGIteratorjava T Z at javautilconcurrentFutureTaskrunFutureTaskjava T Z at javautilconcurrentExecutorsRunnableAdaptercallExecutorsjava T Z at javautilconcurrentFutureTaskrunFutureTaskjava T Z at javautilconcurrentThreadPoolExecutorrunWorkerThreadPoolExecutorjava T Z at javautilconcurrentThreadPoolExecutorWorkerrunThreadPoolExecutorjava T Z at javalangThreadrunThreadjava T Z Caused by compingcaptikvexceptionLockException T Z more T Z WARN TaskSetManager Lost task in stage TID localhost executor driver TaskKilled Stage cancelled T Z Write large amount of data FAILED T Z orgapachesparkSparkException Job aborted due to stage failure Task in stage failed times most recent failure Lost task in stage TID localhost executor driver compingcaptikvexceptionTiClientInternalException Error reading region T Z at compingcaptikvoperationiteratorDAGIteratordoReadNextRegionChunksDAGIteratorjava T Z at compingcaptikvoperationiteratorDAGIteratorreadNextRegionChunksDAGIteratorjava T Z at compingcaptikvoperationiteratorDAGIteratorhasNextDAGIteratorjava T Z at orgapachesparksqltisparkTiRowRDDanon hasNextTiRowRDDscala T Z at orgapachesparksqlcatalystexpressionsGeneratedClassGeneratedIteratorForCodegenStage coprocessorrddnextBatch Unknown Source T Z at orgapachesparksqlcatalystexpressionsGeneratedClassGeneratedIteratorForCodegenStage processNextUnknown Source T Z at orgapachesparksqlexecutionBufferedRowIteratorhasNextBufferedRowIteratorjava T Z at orgapachesparksqlexecutionWholeStageCodegenExecanonfun anon hasNextWholeStageCodegenExecscala T Z at scalacollectionIteratoranon hasNextIteratorscala T Z at scalacollectionIteratoranon hasNextIteratorscala T Z at orgapachesparkutilrandomSamplingUtilsreservoirSampleAndCountSamplingUtilsscala T Z at orgapachesparkRangePartitioneranonfun applyPartitionerscala T Z at orgapachesparkRangePartitioneranonfun applyPartitionerscala T Z at orgapachesparkrddRDDanonfunmapPartitionsWithIndex anonfunapply applyRDDscala T Z at orgapachesparkrddRDDanonfunmapPartitionsWithIndex anonfunapply applyRDDscala T Z at orgapachesparkrddMapPartitionsRDDcomputeMapPartitionsRDDscala T Z at orgapachesparkrddRDDcomputeOrReadCheckpointRDDscala T Z at orgapachesparkrddRDDiteratorRDDscala T Z at orgapachesparkschedulerResultTaskrunTaskResultTaskscala T Z at orgapachesparkschedulerTaskrunTaskscala T Z at orgapachesparkexecutorExecutorTaskRunneranonfun applyExecutorscala T Z at orgapachesparkutilUtilstryWithSafeFinallyUtilsscala T Z at orgapachesparkexecutorExecutorTaskRunnerrunExecutorscala T Z at javautilconcurrentThreadPoolExecutorrunWorkerThreadPoolExecutorjava T Z at javautilconcurrentThreadPoolExecutorWorkerrunThreadPoolExecutorjava T Z at javalangThreadrunThreadjava T Z Caused by javautilconcurrentExecutionException compingcaptikvexceptionRegionTaskException Handle region task failed T Z at javautilconcurrentFutureTaskreportFutureTaskjava T Z at javautilconcurrentFutureTaskgetFutureTaskjava T Z at compingcaptikvoperationiteratorDAGIteratordoReadNextRegionChunksDAGIteratorjava T Z more T Z Caused by compingcaptikvexceptionRegionTaskException Handle region task failed T Z at compingcaptikvoperationiteratorDAGIteratorprocessDAGIteratorjava T Z at compingcaptikvoperationiteratorDAGIteratorlambdasubmitTasks DAGIteratorjava T Z at javautilconcurrentFutureTaskrunFutureTaskjava T Z at javautilconcurrentExecutorsRunnableAdaptercallExecutorsjava T Z at javautilconcurrentFutureTaskrunFutureTaskjava T Z more T Z Caused by compingcaptikvexceptionGrpcException retry is exhausted T Z at compingcaptikvutilConcreteBackOfferdoBackOffConcreteBackOfferjava T Z at compingcaptikvregionRegionStoreClienthandleCopResponseRegionStoreClientjava T Z at compingcaptikvregionRegionStoreClientcoprocessRegionStoreClientjava T Z at compingcaptikvoperationiteratorDAGIteratorprocessDAGIteratorjava T Z more T Z Caused by compingcaptikvexceptionLockException T Z more T Z T Z Driver stacktrace T Z at orgapachesparkschedulerDAGSchedulerorgapachesparkschedulerDAGSchedulerfailJobAndIndependentStagesDAGSchedulerscala T Z at orgapachesparkschedulerDAGScheduleranonfunabortStage applyDAGSchedulerscala T Z at orgapachesparkschedulerDAGScheduleranonfunabortStage applyDAGSchedulerscala T Z at scalacollectionmutableResizableArrayclassforeachResizableArrayscala T Z at scalacollectionmutableArrayBufferforeachArrayBufferscala T Z at orgapachesparkschedulerDAGSchedulerabortStageDAGSchedulerscala T Z at orgapachesparkschedulerDAGScheduleranonfunhandleTaskSetFailed applyDAGSchedulerscala T Z at orgapachesparkschedulerDAGScheduleranonfunhandleTaskSetFailed applyDAGSchedulerscala T Z at scalaOptionforeachOptionscala T Z at orgapachesparkschedulerDAGSchedulerhandleTaskSetFailedDAGSchedulerscala T Z Spark and TiSpark version info What version of Spark and TiSpark are you using Provide Spark version and run sparksql select tiversion showfalse in sparkshell affected versions Master branch release Additional context Add any other context about the problem here You may also provide TiDB version here if it is related to the issue Describe the bug TiSession was cached by distinct value of SparkConf However it is possible that multiple SparkSession share the same SparkConf thus the SparkSession that TiSession points to is not guaranteed to be the same as SparkSessiongetActiveSessionSparkSessiongetDefaultSession Spark and TiSpark version info What version of Spark and TiSpark are you using Provide Spark version and run sparksql select tiversion showfalse in sparkshell master release Additional context Add any other context about the problem here You may also provide TiDB version here if it is related to the issue schedule task close to Data TiKV Github already provided free CICD action This PR enables a simple maven build action and we extend it later support columnar batch execution with spark in this PR or in this branch please use this profile spark scala and uncomment the following code to enable test with spark MVNPROFILESCALA TESTeach MVNTESTPROFILE sh export MAVENOPTSXmx G XXMaxPermSize M XXReservedCodeCacheSize M mvn clean test MVNPROFILE MVNPROFILESCALA MVNTESTPROFILE Dtestmoo mvnStr see 