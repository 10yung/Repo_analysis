Hi I followed the documentation to add nginx lua to an existing server and therefore cannot configure openresty completely on the configuration as it serves an additional purpose I was just looking for a simple lightweight lua module to handle file uploads Ive seen a couple other issues with this but the response always seems to be its required and that is it If it is required why do the docs not reflect that information That being said I followed the docs and installed everything necessary as per the docs and now receive this error nginx alert failed to load the restycore module ensure you are using an OpenResty release from reason module restycore not found no field packagepreload restycore no file usrlocallibluarestycorelua no file restycorelua no file usrlocalshareluajit beta restycorelua no file usrlocalsharelua restycorelua no file usrlocalsharelua restycoreinitlua no file usrlocallibrestycoreso no file restycoreso no file usrlocalliblua restycoreso no file usrlocalliblua loadallso no file usrlocallibrestyso no file restyso no file usrlocalliblua restyso no file usrlocalliblua loadallso in usrlocalnginxconfnginxconf Please let me know how I can fix this without configuring openresty on our server setup Thanks Hello all we think there is some bug in because Shared memory zones are always shared by all the Nginx worker processes in the current Nginx server instance that means that after nginx reload all new workers should have the same access to the same shared dict isnt it we have CentOS release Final nginx ngxlua and we use luashareddict authdata m local authdata ngxsharedauthdata authdatasetstreamsessssid and after service nginx reload new workers dont have the old sessions I see code it in our logs comes from our lua if args ss nil then local key streamsessargs ss local aikey authinfoargs ss local lastkey lastargs ss local ss err authdatagetkey local authinfo err authdatagetaikey if not ss or not authinfo then session not found ngxexit end Jan GET live tsssd HTTP MISS localxxxx remoteyyyy Jan GET live tsssd HTTP MISS localxxxx remoteyyyy there was nginx reload Jan GET live tsssd HTTP localxxxx remoteyyyy Jan GET live tsssd HTTP localxxxx remoteyyyy nginx version nginx built by gcc Red Hat GCC built with OpenSSL efips Feb TLS SNI support enabled configure arguments prefixusrsharenginx withdebug withccoptDNGXLUAUSEASSERT DNGXLUAABORTATPANIC O O g pipe Wall WpDFORTIFYSOURCE fexceptions fstackprotector paramsspbuffersize m mtunegeneric addmodulengxdevelkit rc addmoduleechonginxmodule addmodulexssnginxmodule addmodulengxcoolkit addmodulesetmiscnginxmodule addmoduleforminputnginxmodule addmoduleencryptedsessionnginxmodule addmodulesrcachenginxmodule addmodulengxlua addmodulengxluaupstream addmoduleheadersmorenginxmodule addmodulearrayvarnginxmodule addmodulememcnginxmodule addmoduleredis nginxmodule addmoduleredisnginxmodule addmodulerdsjsonnginxmodule addmodulerdscsvnginxmodule addmodulengxstreamlua addmodulenginxdavextmodule addmodulengxhttpbytesfiltermodule addmodulengxhttpcomposefiltermodule addmodulengxhttpsubstitutionsfiltermodule addmodulengxhttpfilecomposefiltermodule addmodulengxhlscombinedmodule withldoptWlrpathusrsharenginxluajitlib WlE withipv withpcrejit usernginx groupnginx sbinpathusrsbinnginx confpathetcnginxnginxconf errorlogpathvarlognginxerrorlog httplogpathvarlognginxaccesslog httpclientbodytemppathvarlibnginxtmpclientbody httpproxytemppathvarlibnginxtmpproxy httpfastcgitemppathvarlibnginxtmpfastcgi pidpathvarrunnginxpid lockpathvarlocksubsysnginx withhttpsslmodule withhttprealipmodule withhttpadditionmodule withhttpsslmodule withhttprealipmodule withhttpgeoipmodule withhttpadditionmodule withhttpsubmodule withhttpdavmodule withhttpflvmodule withhttpgzipstaticmodule withhttpstubstatusmodule withhttpperlmodule withfileaio withhttpsecurelinkmodule withstream withstreamsslmodule withstreamsslprereadmodule My nginx config like this server accessbyluafile luatestaccesslua location a proxypass location b defaulttype textplain return you visit b When I visit a testaccesslua works while b it does not It means that the access phase is skipped when return is used I hereby granted the copyright of the changes in this pull request to the authors of this luanginxmodule project Implements Hello In some cases initworkerbyluablock cause nginx segfault nginx segfault at ip f a b adb sp ffcbbda error in ngxhttpluamoduleso f a af Nginx core dump Using host libthreaddb library lib libthreaddbso Core was generated by nginx master process usrsbinnginx c Program terminated with signal Segmentation fault x f b fea b in ngxhttpluainitworker cycleoptimized out at luanginxmodulemastersrcngxhttpluainitworkerbyc if ngxmodules i index ngxhttpluamoduleindex gdb bt x f b fea b in ngxhttpluainitworker cycleoptimized out at luanginxmodulemastersrcngxhttpluainitworkerbyc x d e cf in ngxworkerprocessinit cyclecycleentry x d bb workerworkerentry at srcosunixngxprocesscyclec x d e in ngxworkerprocesscycle cyclecycleentry x d bb datadataentry x at srcosunixngxprocesscyclec x d e b in ngxspawnprocess cyclecycleentry x d bb procprocentry x d e ngxworkerprocesscycle datadataentry x namenameentry x d d e worker process respawnrespawnentry at srcosunixngxprocessc x d e in ngxstartworkerprocesses cyclecycleentry x d bb n typetypeentry at srcosunixngxprocesscyclec x d e ba in ngxmasterprocesscycle cyclecycleentry x d bb at srcosunixngxprocesscyclec x d bcd f in main argcoptimized out argvoptimized out at srccorenginxc I can reproduce it on one of our servers which was updated to centos and nginx a day ago But I cant reproduce it on freshly installed VM Software versions CentOS Linux release Core nginx version nginx luanginxmodule from master A minimal and standalone test case that others can easily run on their side and reproduce the issue you are seeing I have added initworkerbyluablock to my nginx configuration empty or not it does not matter After nginx restart I looked at varlogmessages and there are many nginx workers segfaults Also Ive investigated file ngxhttpluainitworkerbyc near line and it seems like a bug on lines modules variable was defined based on nginxversion but later on line you use ngxmodules i index instead of modules variable So I prepared the small patch that fixed issue with nginx segfaults in my case diff diff git asrcngxhttpluainitworkerbyc bsrcngxhttpluainitworkerbyc index b e c db asrcngxhttpluainitworkerbyc bsrcngxhttpluainitworkerbyc ngxhttpluainitworkerngxcyclet cycle return NGXERROR if ngxmodules i index ngxhttpluamoduleindex if modules i index ngxhttpluamoduleindex ngxmemcpycur confctxmainconf ngxhttpluamodulectxindex sizeofngxhttpluamainconft PS Ill make PR if you want Is it a bad idea to append new keys to ngxreqresp For example would the following be considered bad lua if ngxvarrequestmethod POST then ngxreqreadbody ngxreqrawBody ngxreqgetbodydata if ngxheaders contenttype applicationjson then local ok payload pcallcjsondecode ngxreqgetbodydata if ok then ngxreqbody payload end end end So that I can automatically parse the post body in the instantiation of my app and then just pass around ngxreq and ngxresp to all my controllers Were getting these segfault error in our servers dmesg T Sun Nov nginx segfault at ip sp ffe a e error in nginx a Sun Nov nginx segfault at ip sp ffe a ed error in nginx a Sun Nov nginx segfault at ip sp ffe a ed error in nginx a Sun Nov nginx segfault at ip sp ffe a ed error in nginx a Sun Nov nginx segfault at ip sp ffe a ed error in nginx a Sun Nov nginx segfault at ip sp ffe a f error in nginx a Sun Nov nginx segfault at ip sp ffe a ed error in nginx a Sun Nov nginx segfault at ip sp ffe a e error in nginx a Sun Nov nginx segfault at ip sp ffe a ed error in nginx a Sun Nov nginx segfault at ip sp ffe a ed error in nginx a Sun Nov nginx segfault at ip sp ffe a ed error in nginx a Sun Nov nginx segfault at ip sp ffe a ed error in nginx a Sun Nov DCCP Activated CCID TCPlike Sun Nov nginx segfault at ip sp ffe a ed error in nginx a Mon Nov nginx segfault at ip sp ffe a f error in nginx a Mon Nov nginx segfault at ip sp ffe a ed error in nginx a Mon Nov nginx segfault at ip sp ffe a ed error in nginx a Mon Nov nginx segfault at ip sp ffe a ed error in nginx a Mon Nov nginx segfault at ip sp ffe a ed error in nginx a Tue Nov nginx segfault at ip sp ffe a ed error in nginx a Tue Nov nginx segfault at ip sp ffe a ed error in nginx a Tue Nov nginx segfault at ip sp ffe a ed error in nginx a Tue Nov nginx segfault at ip sp ffe a ed error in nginx a which results in nginx worker dying adminserver ps aux grep nginx root Ss Nov nginx master process usrlocalopenrestynginxsbinnginx g daemon off admin pts S grep colorauto nginx wwwdata Rl nginx worker process wwwdata Rl Nov nginx worker process wwwdata Sl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Sl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Sl Nov nginx worker process wwwdata Sl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Sl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Sl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Sl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Sl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Sl Nov nginx worker process wwwdata Sl Nov nginx worker process wwwdata Sl Nov nginx worker process wwwdata Sl Nov nginx worker process wwwdata Sl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata Rl Nov nginx worker process wwwdata S Nov nginx cache manager process wwwdata Rl nginx worker process wwwdata Sl nginx worker process wwwdata Rl nginx worker process This is the output of addr line which points to tmpopenresty buildnginx srceventngxeventopensslc line adminserver addr line e usrlocalopenrestynginxsbinnginx tmpopenresty buildnginx srceventngxeventopensslc Were using the latest version of OpenResty which is with following compile time modules configure withluajit withhttpsecurelinkmodule withhttpstubstatusmodule withhttpv module withhttpslicemodule withthreads addmoduletmpngxhttpgeoip module i want to use ngxreqsetheader to reset request headeruse upstreamaddr variables but i try then not effect please tell me how to do this tks PR to fix I have tried to follow the Installation part in the READMEmarkdown and I found two import modules are not mentioned luarestylrucache and luarestylrucache You cannot do the installation without them So I think its very necessary to add them to the doc 