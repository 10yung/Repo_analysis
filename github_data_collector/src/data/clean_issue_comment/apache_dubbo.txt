 What is the purpose of the change the original code is not concise enough so I refactor it Brief changelog use parameter to hold the expression every times and use it in next round merge the different expression by preprocessing the defaultExtName variable Verifying this change I run all the test under folder testjavaorgapachedubbocommonextensionthe result are all right Follow this checklist to help us incorporate your contribution quickly and easily x Make sure there is a GITHUBissue field for the change usually before you start working on it Trivial changes like typos do not require a GITHUB issue Your pull request should address just this issue without pulling in other changes one PR resolves one issue Format the pull request title like DubboXXX Fix UnknownException when host config not exist XXX Each commit in the pull request should have a meaningful subject line and body Write a pull request description that is detailed enough to understand what the pull request does how and why Write necessary unittest to verify your logic correction more mock a little better when cross module dependency exist If the new feature or significant change is committed please remember to add sample in dubbo samples project Run mvn clean install DskipTestsfalse mvn clean testcompile failsafeintegrationtest to make sure unittest and integrationtest pass If this contribution is large please follow the Software Donation Guide Environment Dubbo version Operating System version win Java version Steps to reproduce this issue RandomLoadBalance Weight provider weight weight provider dubbo Adaptive injectExtension set SpiExtensionFactory SpiExtensionFactory Adaptive AB set catch A B A B fixes dubbo rest server jetty provider threads servertomcat threads What is the purpose of the change alternative impl for PR Brief changelog XXXXX Verifying this change XXXXX Follow this checklist to help us incorporate your contribution quickly and easily x Make sure there is a GITHUBissue field for the change usually before you start working on it Trivial changes like typos do not require a GITHUB issue Your pull request should address just this issue without pulling in other changes one PR resolves one issue Format the pull request title like DubboXXX Fix UnknownException when host config not exist XXX Each commit in the pull request should have a meaningful subject line and body Write a pull request description that is detailed enough to understand what the pull request does how and why Write necessary unittest to verify your logic correction more mock a little better when cross module dependency exist If the new feature or significant change is committed please remember to add sample in dubbo samples project Run mvn clean install DskipTestsfalse mvn clean testcompile failsafeintegrationtest to make sure unittest and integrationtest pass If this contribution is large please follow the Software Donation Guide I have searched the issues of this repository and believe that this is not a duplicate I have checked the FAQ of this repository and believe that this is not a duplicate Environment Dubbo version Operating System version Win Java version JDK Steps to reproduce this issue use dubbo API show provider application ServiceConfigGreetingsService service new ServiceConfig servicesetApplicationnew ApplicationConfigfirstdubboprovider but find this method is annotated by Deprecated If i want to show a demo with dubbo API to my students where can i find a method which with no Deprecated Pls provide GitHub address to reproduce this issue Expected Result What do you expected from the above steps Actual Result What actually happens If there is an exception please attach the exception trace Just put your stack trace here INFO orgapachecuratorframeworkimpsCuratorFrameworkImpl Starting DEBUG orgapachecuratorCuratorZookeeperClient Starting DEBUG orgapachecuratorConnectionState Starting DEBUG orgapachecuratorConnectionState reset INFO orgapachecuratorframeworkstateConnectionStateManager State change CONNECTED INFO orgapachedubboremotingzookeepercuratorCuratorZookeeperClient DUBBO Curator zookeeper client instance initiated successfully session id is fa f dubbo version current host INFO orgapachedubboremotingzookeeperZookeeperTransporter DUBBO No valid zookeeper client found from cache therefore create a new client for url zookeeper ConfigCenterConfigbackup checktrue configfiledubboproperties groupdubbo highestpriorityfalse namespacedubbo timeout dubbo version current host DEBUG orgapachecuratorframeworkimpsCuratorFrameworkImpl Closing DEBUG orgapachecuratorCuratorZookeeperClient Closing DEBUG orgapachecuratorConnectionState Closing DEBUG orgapachecuratorframeworkimpsCuratorFrameworkImpl Closing DEBUG orgapachecuratorframeworkimpsCuratorFrameworkImpl Closing DEBUG orgapachecuratorframeworkimpsCuratorFrameworkImpl Closing DEBUG orgapachecuratorframeworkimpsCuratorFrameworkImpl Closing DEBUG orgapachecuratorframeworkimpsCuratorFrameworkImpl Closing DEBUG orgapachecuratorframeworkimpsCuratorFrameworkImpl Closing ERROR orgspringframeworkwebcontextContextLoader Context initialization failed orgspringframeworkbeansfactoryBeanCreationException Error creating bean with name smsSendController Injection of resource dependencies failed nested exception is orgspringframeworkbeansfactoryBeanCreationException Error creating bean with name smsServiceImpl Injection of resource dependencies failed nested exception is orgspringframeworkbeansfactoryBeanCreationException Error creating bean with name smsRpcService FactoryBean threw exception on object creation nested exception is javalangIllegalStateException Failed to receive INITIALIZED event from zookeeper pls check if url zookeeper ConfigCenterConfigbackup checktrue configfiledubboproperties groupdubbo highestpriorityfalse namespacedubbo timeout is correct at orgspringframeworkcontextannotationCommonAnnotationBeanPostProcessorpostProcessPropertyValuesCommonAnnotationBeanPostProcessorjava at orgspringframeworkbeansfactorysupportAbstractAutowireCapableBeanFactorypopulateBeanAbstractAutowireCapableBeanFactoryjava at orgspringframeworkbeansfactorysupportAbstractAutowireCapableBeanFactorydoCreateBeanAbstractAutowireCapableBeanFactoryjava at orgspringframeworkbeansfactorysupportAbstractAutowireCapableBeanFactorycreateBeanAbstractAutowireCapableBeanFactoryjava at orgspringframeworkbeansfactorysupportAbstractBeanFactory getObjectAbstractBeanFactoryjava at orgspringframeworkbeansfactorysupportDefaultSingletonBeanRegistrygetSingletonDefaultSingletonBeanRegistryjava at orgspringframeworkbeansfactorysupportAbstractBeanFactorydoGetBeanAbstractBeanFactoryjava at orgspringframeworkbeansfactorysupportAbstractBeanFactorygetBeanAbstractBeanFactoryjava at orgspringframeworkbeansfactorysupportDefaultListableBeanFactorypreInstantiateSingletonsDefaultListableBeanFactoryjava at orgspringframeworkcontextsupportAbstractApplicationContextfinishBeanFactoryInitializationAbstractApplicationContextjava at orgspringframeworkcontextsupportAbstractApplicationContextrefreshAbstractApplicationContextjava at orgspringframeworkwebcontextContextLoaderconfigureAndRefreshWebApplicationContextContextLoaderjava at orgspringframeworkwebcontextContextLoaderinitWebApplicationContextContextLoaderjava at orgspringframeworkwebcontextContextLoaderListenercontextInitializedContextLoaderListenerjava at orgeclipsejettyserverhandlerContextHandlercallContextInitializedContextHandlerjava at orgeclipsejettyservletServletContextHandlercallContextInitializedServletContextHandlerjava at orgeclipsejettyserverhandlerContextHandlerstartContextContextHandlerjava at orgeclipsejettyservletServletContextHandlerstartContextServletContextHandlerjava at orgeclipsejettywebappWebAppContextstartContextWebAppContextjava at orgeclipsejettyserverhandlerContextHandlerdoStartContextHandlerjava at orgeclipsejettywebappWebAppContextdoStartWebAppContextjava at orgeclipsejettyutilcomponentAbstractLifeCyclestartAbstractLifeCyclejava at orgeclipsejettyserverhandlerHandlerWrapperdoStartHandlerWrapperjava at orgeclipsejettyserverServerdoStartServerjava at orgeclipsejettyutilcomponentAbstractLifeCyclestartAbstractLifeCyclejava at RunnermainRunnerjava Caused by orgspringframeworkbeansfactoryBeanCreationException Error creating bean with name smsServiceImpl Injection of resource dependencies failed nested exception is orgspringframeworkbeansfactoryBeanCreationException Error creating bean with name smsRpcService FactoryBean threw exception on object creation nested exception is javalangIllegalStateException Failed to receive INITIALIZED event from zookeeper pls check if url zookeeper ConfigCenterConfigbackup checktrue configfiledubboproperties groupdubbo highestpriorityfalse namespacedubbo timeout is correct at orgspringframeworkcontextannotationCommonAnnotationBeanPostProcessorpostProcessPropertyValuesCommonAnnotationBeanPostProcessorjava at orgspringframeworkbeansfactorysupportAbstractAutowireCapableBeanFactorypopulateBeanAbstractAutowireCapableBeanFactoryjava at orgspringframeworkbeansfactorysupportAbstractAutowireCapableBeanFactorydoCreateBeanAbstractAutowireCapableBeanFactoryjava at orgspringframeworkbeansfactorysupportAbstractAutowireCapableBeanFactorycreateBeanAbstractAutowireCapableBeanFactoryjava at orgspringframeworkbeansfactorysupportAbstractBeanFactory getObjectAbstractBeanFactoryjava at orgspringframeworkbeansfactorysupportDefaultSingletonBeanRegistrygetSingletonDefaultSingletonBeanRegistryjava at orgspringframeworkbeansfactorysupportAbstractBeanFactorydoGetBeanAbstractBeanFactoryjava at orgspringframeworkbeansfactorysupportAbstractBeanFactorygetBeanAbstractBeanFactoryjava at orgspringframeworkbeansfactorysupportDefaultListableBeanFactoryfindAutowireCandidatesDefaultListableBeanFactoryjava at orgspringframeworkbeansfactorysupportDefaultListableBeanFactorydoResolveDependencyDefaultListableBeanFactoryjava at orgspringframeworkbeansfactorysupportDefaultListableBeanFactoryresolveDependencyDefaultListableBeanFactoryjava at orgspringframeworkcontextannotationCommonAnnotationBeanPostProcessorautowireResourceCommonAnnotationBeanPostProcessorjava at orgspringframeworkcontextannotationCommonAnnotationBeanPostProcessorgetResourceCommonAnnotationBeanPostProcessorjava at orgspringframeworkcontextannotationCommonAnnotationBeanPostProcessorResourceElementgetResourceToInjectCommonAnnotationBeanPostProcessorjava at orgspringframeworkbeansfactoryannotationInjectionMetadataInjectedElementinjectInjectionMetadatajava at orgspringframeworkbeansfactoryannotationInjectionMetadatainjectInjectionMetadatajava at orgspringframeworkcontextannotationCommonAnnotationBeanPostProcessorpostProcessPropertyValuesCommonAnnotationBeanPostProcessorjava more Caused by orgspringframeworkbeansfactoryBeanCreationException Error creating bean with name smsRpcService FactoryBean threw exception on object creation nested exception is javalangIllegalStateException Failed to receive INITIALIZED event from zookeeper pls check if url zookeeper ConfigCenterConfigbackup checktrue configfiledubboproperties groupdubbo highestpriorityfalse namespacedubbo timeout is correct at orgspringframeworkbeansfactorysupportFactoryBeanRegistrySupportdoGetObjectFromFactoryBeanFactoryBeanRegistrySupportjava at orgspringframeworkbeansfactorysupportFactoryBeanRegistrySupportgetObjectFromFactoryBeanFactoryBeanRegistrySupportjava at orgspringframeworkbeansfactorysupportAbstractBeanFactorygetObjectForBeanInstanceAbstractBeanFactoryjava at orgspringframeworkbeansfactorysupportAbstractBeanFactorydoGetBeanAbstractBeanFactoryjava at orgspringframeworkbeansfactorysupportAbstractBeanFactorygetBeanAbstractBeanFactoryjava at orgspringframeworkcontextannotationCommonAnnotationBeanPostProcessorautowireResourceCommonAnnotationBeanPostProcessorjava at orgspringframeworkcontextannotationCommonAnnotationBeanPostProcessorgetResourceCommonAnnotationBeanPostProcessorjava at orgspringframeworkcontextannotationCommonAnnotationBeanPostProcessorResourceElementgetResourceToInjectCommonAnnotationBeanPostProcessorjava at orgspringframeworkbeansfactoryannotationInjectionMetadataInjectedElementinjectInjectionMetadatajava at orgspringframeworkbeansfactoryannotationInjectionMetadatainjectInjectionMetadatajava at orgspringframeworkcontextannotationCommonAnnotationBeanPostProcessorpostProcessPropertyValuesCommonAnnotationBeanPostProcessorjava more Caused by javalangIllegalStateException Failed to receive INITIALIZED event from zookeeper pls check if url zookeeper ConfigCenterConfigbackup checktrue configfiledubboproperties groupdubbo highestpriorityfalse namespacedubbo timeout is correct at orgapachedubboconfigcentersupportzookeeperZookeeperDynamicConfigurationinitZookeeperDynamicConfigurationjava at orgapachedubboconfigcentersupportzookeeperZookeeperDynamicConfigurationFactorycreateDynamicConfigurationZookeeperDynamicConfigurationFactoryjava at orgapachedubboconfigcenterAbstractDynamicConfigurationFactorygetDynamicConfigurationAbstractDynamicConfigurationFactoryjava at orgapachedubboconfigAbstractInterfaceConfiggetDynamicConfigurationAbstractInterfaceConfigjava at orgapachedubboconfigAbstractInterfaceConfigprepareEnvironmentAbstractInterfaceConfigjava at orgapachedubboconfigAbstractInterfaceConfigstartConfigCenterAbstractInterfaceConfigjava at orgapachedubboconfigAbstractInterfaceConfiglambdanull AbstractInterfaceConfigjava at javautilOptionalorElseGetOptionaljava at orgapachedubboconfigAbstractInterfaceConfiglambdauseRegistryForConfigIfNecessary AbstractInterfaceConfigjava at javautilOptionalifPresentOptionaljava at orgapachedubboconfigAbstractInterfaceConfiguseRegistryForConfigIfNecessaryAbstractInterfaceConfigjava at orgapachedubboconfigAbstractInterfaceConfigcheckRegistryAbstractInterfaceConfigjava at orgapachedubboconfigReferenceConfigcreateProxyReferenceConfigjava at orgapachedubboconfigReferenceConfiginitReferenceConfigjava at orgapachedubboconfigReferenceConfiggetReferenceConfigjava at orgapachedubboconfigspringReferenceBeangetObjectReferenceBeanjava at orgspringframeworkbeansfactorysupportFactoryBeanRegistrySupportdoGetObjectFromFactoryBeanFactoryBeanRegistrySupportjava more What is the purpose of the change For Issue Follow this checklist to help us incorporate your contribution quickly and easily x Make sure there is a GITHUBissue field for the change usually before you start working on it Trivial changes like typos do not require a GITHUB issue Your pull request should address just this issue without pulling in other changes one PR resolves one issue Format the pull request title like DubboXXX Fix UnknownException when host config not exist XXX Each commit in the pull request should have a meaningful subject line and body Write a pull request description that is detailed enough to understand what the pull request does how and why Write necessary unittest to verify your logic correction more mock a little better when cross module dependency exist If the new feature or significant change is committed please remember to add sample in dubbo samples project Run mvn clean install DskipTestsfalse mvn clean testcompile failsafeintegrationtest to make sure unittest and integrationtest pass If this contribution is large please follow the Software Donation Guide x I have searched the issues of this repository and believe that this is not a duplicate x I have checked the FAQ of this repository and believe that this is not a duplicate Environment Dubbo version Operating System version macOs Sierra Java version Jdk Steps to reproduce this issue start two provider A and B start one consumer with lazy connection pull out A provider The old invoker will be destroyed including the connection ReferenceCountExchangeClient will replace a new lazy connection with LAZYCONNECTINITIALSTATEKEYfalse private void replaceWithLazyClient URL lazyUrl URLBuilderfromurl addParameterLAZYCONNECTINITIALSTATEKEY BooleanFALSE addParameterRECONNECTKEY BooleanFALSE addParameterSENDRECONNECTKEY BooleanTRUEtoString addParameterwarning BooleanTRUEtoString addParameterLazyConnectExchangeClientREQUESTWITHWARNINGKEY true addParameterclientmemo referencecounthandlerreplacewithlazyclient build pull in A provider DubboProtocol will get shared clients for A provider And the checkClientCanUse returns available after PR which caused invokers returns not avilable as LAZYCONNECTINITIALSTATEKEY be replaced to FALSE private ListReferenceCountExchangeClient getSharedClientURL url int connectNum String key urlgetAddress ListReferenceCountExchangeClient clients referenceClientMapgetkey if checkClientCanUseclients batchClientRefIncrclients return clients ReferenceConfig createProxy will throw exception as the connection is not available if shouldCheck invokerisAvailable throw new IllegalStateExceptionFailed to check the status of the service Pls provide GitHub address to reproduce this issue Expected Result Replaced connection should be avilable Actual Result Replaced connection is not avilable 