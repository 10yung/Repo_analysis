alirazatariq commented on Fri Jan The existing implementation shows the following error message when inflight limit is exceeded Response b n code BWm N Qemn uMAcZWY JCy PjTAQ A n error Too many concurrent requests in flight count allowed n Few suggestions The message is misleading because the allowed should show the existing actionInvokesConcurrent limit set by the user in this case which got diluted to increase because of more than controller in deployment So either it should mention allowed per controller or simply show the total allowed over all the controllers in this case controllers Also It think it would be better to change the count to something more meaningful like currently running for easy debugging good first issue label Environment details local deployment Mac OS Catalina v Docker desktop v stable Engine Compose kubernates v Notary Credential Helper Machine Steps to reproduce the issue git clone cd openwhiskdevtoolsdockercompose make quickstart Provide the actual results and outputs Unpacking tarball downloading the CLI tool downloading cli for mac Archive wskzip inflating wsk inflating LICENSEtxt inflating READMEmd inflating NOTICEtxt nightly Pulling from openwhiskcontroller fe ade c Pull complete db d Pull complete ed b Pull complete ff bedb Pull complete d dddf b Pull complete e bb ce b Pull complete ef a c c Pull complete dd abe Pull complete f b Pull complete ea b b Pull complete fd f ff Pull complete faadab ae Pull complete e ce e ca Pull complete d bc e df Pull complete a af d e Pull complete f f e df Pull complete Digest sha dea ba d c aa e f e f a c be c Status Downloaded newer image for openwhiskcontrollernightly dockerioopenwhiskcontrollernightly nightly Pulling from openwhisknodejs action a f cb Pull complete c bb Pull complete e eabe eb Pull complete f c Pull complete e adb c Pull complete bda dd Pull complete d f Pull complete a bd d e ea Pull complete fb b e d Pull complete be dbc d Pull complete e e c a Pull complete d ccda Pull complete e b b a Pull complete Digest sha b d f bc bb f f e a c e d a fdd e ec d b d Status Downloaded newer image for openwhisknodejs actionnightly dockerioopenwhisknodejs actionnightly nightly Pulling from openwhiskdockerskeleton e b cf c Pull complete da e bf cc Pull complete ed c b ff Pull complete ff fe Pull complete f f Pull complete f c b Pull complete ea d a Pull complete c ec a Pull complete cf b d Pull complete fddec aeb Pull complete d e a a a Pull complete Digest sha ba cac e b c e f ccfa f d f Status Downloaded newer image for openwhiskdockerskeletonnightly dockerioopenwhiskdockerskeletonnightly pulling the docker images short list nightly Pulling from openwhiskinvoker fe ade c Already exists db d Already exists ed b Already exists ff bedb Already exists d dddf b Already exists e bb ce b Already exists ef a c c Already exists dd abe Already exists f b Already exists a ce afc Pull complete da b Pull complete b e b f Pull complete e df a c Pull complete d dc Pull complete de f Pull complete Digest sha b bb fc f fe b a a da a eba b aae f cff Status Downloaded newer image for openwhiskinvokernightly dockerioopenwhiskinvokernightly host ip address checking required ports OK cat Usersluizlimatmpopenwhisklocalenv No such file or directory cat Usersluizlimatmpopenwhisklocalenv No such file or directory cat Usersluizlimatmpopenwhisklocalenv No such file or directory cat Usersluizlimatmpopenwhisklocalenv No such file or directory cat Usersluizlimatmpopenwhisklocalenv No such file or directory preparing apigateway configuration pinging minio WARNING The DOCKERCOMPOSEHOST variable is not set Defaulting to a blank string Creating network openwhiskdefault with the default driver Pulling minio miniominioRELEASE T Z Creating openwhiskminio done OK WARNING The DOCKERCOMPOSEHOST variable is not set Defaulting to a blank string Pulling apigateway openwhiskapigatewaynightly nightly Pulling from openwhiskapigateway e c db b Pull complete f be f d Pull complete f b ba Pull complete f ac Pull complete d Pull complete ce dc f bfb Pull complete eb dc Pull complete f ddd e Pull complete b df fa Pull complete b Pull complete df dd f eac Pull complete ac Pull complete Digest sha f e d cd edc cbc c aaaf aa b bdb df b f c e Status Downloaded newer image for openwhiskapigatewaynightly dumbinit rclone No such file or directory make setup Error The unicode tests are currently being skipped for the dotnet runtimes There appears to be some sources for dotnet openwhisktestsdatactionsunicodetestssrcdotnet but the test harness isnt finding them systembasicWskUnicodeTests STANDARDOUT test router false Kinds to test ballerina dotnet dotnet go java nodejs nodejs nodejs php php python python ruby swift JUnit version is WARNING did not find text or binary action for kind ballerina skipping it WARNING did not find text or binary action for kind dotnet skipping it WARNING did not find text or binary action for kind dotnet skipping it Sometimes admin may want to reinitalize the runtime config eg nodejs prewarm container number is less lead to cold start in order to handle users request as soon as possible admin may want to reinitalize the runtime configuration to increase the nodejs prewarm containers And admin may want to reinitalize the runtime config on some limited invokers this patch includes below changes x config runtime via controller to all managed invokersor some limited inovkers which included in managed inovkers x config runtime via invoker directly x get runtime info via invoker directly x add documents test cases Provide a concise summary of your changes in the Title Description Provide a detailed description of your changes Include details of what problem you are solving and how your changes are tested Related issue and scope Please include a link to a related issue if there is one I opened an issue to propose and discuss this change My changes affect the following components Select below all system components are affected by your change Enter an x in all applicable boxes API x Controller Message Bus eg Kafka x Loadbalancer x Invoker Intrinsic actions eg sequences conductors Data stores eg CouchDB x Tests Deployment CLI General tooling Documentation Types of changes What types of changes does your code introduce Use x in all the boxes that apply Bug fix generally a nonbreaking change which closes an issue x Enhancement or new feature adds new functionality Breaking change a bug fix or enhancement which changes existing behavior Checklist Please review the points below which help you make sure youve covered all aspects of the change youre making x I signed an Apache CLA I reviewed the style guides and followed the recommendations Travis CI will check I added tests to cover my changes My changes require further changes to the documentation x I updated the documentation where necessary When I run ansibleplaybook i environmentslocal setupyml I got the error about fatal localhost localhost FAILED changed true cmd homezlprojectNoahopenwhiskansiblefilesgensslsh localhost server homezlprojectNoahopenwhiskansiblerolesnginxfiles delta end msg nonzero return code rc start stderr binsh homezlprojectNoahopenwhiskansiblefilesgensslsh Permission denied stderrlines binsh homezlprojectNoahopenwhiskansiblefilesgensslsh Permission denied stdout stdoutlines FAILED homezlprojectNoahopenwhiskansiblefilesgensslsh localhost server homezlprojectNoahopenwhiskansiblerolesnginxfiles nonzero return code binsh homezlprojectNoahopenwhiskansiblefilesgensslsh Permission denied How can I fix them This PR is based on work done as part of to figure out approaches to reduce compilation times It uses a new proposed approach pureconfigpureconfig to switch to non Shapeless based config derivation similar to what we do with sparyjson Description This PR is a work in progress till the new support in Pureconfig is completed With new approach the compilation time for commonscala module reduced from sec to sec on my laptop Related issue and scope Please include a link to a related issue if there is one I opened an issue to propose and discuss this change My changes affect the following components Select below all system components are affected by your change Enter an x in all applicable boxes API Controller Message Bus eg Kafka Loadbalancer Invoker Intrinsic actions eg sequences conductors Data stores eg CouchDB Tests Deployment CLI General tooling Documentation Types of changes What types of changes does your code introduce Use x in all the boxes that apply Bug fix generally a nonbreaking change which closes an issue Enhancement or new feature adds new functionality Breaking change a bug fix or enhancement which changes existing behavior Checklist Please review the points below which help you make sure youve covered all aspects of the change youre making I signed an Apache CLA I reviewed the style guides and followed the recommendations Travis CI will check I added tests to cover my changes My changes require further changes to the documentation I updated the documentation where necessary Error whiskclientgo ERRORWHISKCLIENTINVALIDCONFIG whiskclientgo The authentication key is not configured whiskclientgo The API host is not configured Environment details Mac OS Majove bash java version openjdk OpenJDK Runtime Environment AdoptOpenJDK build OpenJDK Bit Server VM AdoptOpenJDK build mixed mode sharing bash gradle version Gradle Build time UTC Revision fad a c acd daf a c a f Kotlin Groovy Ant Apache AntTM version compiled on September JVM AdoptOpenJDK OS Mac OS X x Steps to reproduce the issue git clone Go to openwhiskcorestandalone gradle init Provide the actual results and outputs FAILURE Build failed with an exception Where Build file HOMEopenwhiskcorestandalonebuildgradle line What went wrong Plugin id orgscoverage was not found in any of the following sources Gradle Core Plugins plugin is not in orggradle namespace Plugin Repositories plugin dependency must include a version number for this source Try Run with stacktrace option to get the stack trace Run with info or debug option to get more log output Run with scan to get full insights Get more help at BUILD FAILED in ms As rabbah mentioned here we have many proposals in OpenWhisk Wiki But we lack the official procedures for them While it is ok for small changes lifecycle management is necessary for large changes We need procedures to discuss proposals evaluate them make a consensus for the direction and finally include or drop some of them etc Many renowned projects have their own procedures K SKEP KafkaKIP Its clear for users to figure out which proposals are active and will be included in and when I will look into their approaches and define our own We use the issue tracker for bugs and feature requests For general questions and discussion please use or instead Do NOT share passwords credentials or other confidential information Before creating a new issue please check if there is one already open that fits the defect you are reporting If you open an issue and realize later it is a duplicate of a preexisting open issue please close yours and add a comment to the other Issues can be created for either defects or enhancement requests If you are a committer than please add the labels bug or feature If you are not a committer please make clear in the comments which one it is so that committers can add these labels later If you are reporting a defect please edit the issue description to include the information shown below If you are reporting an enhancement request please include information on what you are trying to achieve and why that enhancement would help you For more information about reporting issues see Use the commands below to provide key information from your environment You do not have to include this information if this is a feature request Environment details mesos but likely happens in all other multicontroller envs actions that support concurrency Steps to reproduce the issue run a load test not sure how much load is required but this test ran users k rps while test is running restart a single controller Provide the expected results and outputs Some errors are expected related to inflight requests at that controller that was killed Provide the actual results and outputs There is possibly some issue with graceful shutdown of NestedSemaphore or related code See logged errors below Separately when a replacement controller comes back online it becomes used immediately despite having only set invoker states to Offline or Unhealthy resulting in extra errors T Z INFO tidoXbBU OYYp bB CyEhGe jUb KrRpivc BasicHttpService markerhttpget counter T Z INFO tidYaUx tDZOJY aubZq lC GfZQo TvQzw ShardingContainerPoolBalancer received completion ack for a e e a a e e system errorfalse T Z INFO tidYaUx tDZOJY aubZq lC GfZQo TvQzw ShardingContainerPoolBalancer received completion ack for a e e a a e e T Z INFO tidYaUx tDZOJY aubZq lC GfZQo TvQzw ShardingContainerPoolBalancer received result ack for a e e a a e e T Z INFO tidYaUx tDZOJY aubZq lC GfZQo TvQzw WebActionsApi markercontrollerblockingActivationfinish T Z INFO tidYaUx tDZOJY aubZq lC GfZQo TvQzw BasicHttpService markerhttpget counter T Z INFO tidXKy TepK GP tggjfBgpzdjex yahxwE ShardingContainerPoolBalancer received completion ack for e fb da e fb da c system errorfalse T Z INFO tidXKy TepK GP tggjfBgpzdjex yahxwE ShardingContainerPoolBalancer received completion ack for e fb da e fb da c T Z INFO tidXKy TepK GP tggjfBgpzdjex yahxwE ShardingContainerPoolBalancer received result ack for e fb da e fb da c T Z INFO tidXKy TepK GP tggjfBgpzdjex yahxwE WebActionsApi markercontrollerblockingActivationfinish T Z INFO tidXKy TepK GP tggjfBgpzdjex yahxwE BasicHttpService markerhttpget counter T Z INFO Cluster Node akkatcpcontrolleractorsystem Exiting completed T Z INFO Cluster Node akkatcpcontrolleractorsystem Shutting down T Z INFO Cluster Node akkatcpcontrolleractorsystem Successfully shut down T Z INFO tidsidloadbalancer ShardingContainerPoolBalancerState loadbalancer cluster size changed from to active nodes invokers with MB average memory size total invoker memory MB T Z INFO tidsidloadbalancer ShardingContainerPoolBalancerState loadbalancer cluster size changed from to active nodes invokers with MB average memory size total invoker memory MB T Z INFO tidsidloadbalancer ShardingContainerPoolBalancerState loadbalancer cluster size changed from to active nodes invokers with MB average memory size total invoker memory MB T Z INFO tidsidloadbalancer ShardingContainerPoolBalancerState loadbalancer cluster size changed from to active nodes invokers with MB average memory size total invoker memory MB T Z INFO Message akkaclusterGossipEnvelope from Actor akkatcpcontrolleractorsystem systemclustercoredaemon to Actor akkacontrolleractorsystemsystemclustercoredaemon was not delivered dead letters encountered If this is not an expected behavior then Actor akkacontrolleractorsystemsystemclustercoredaemon may have terminated unexpectedly This logging can be turned off or adjusted with configuration settings akkalogdeadletters and akkalogdeadlettersduringshutdown T Z INFO tidsidloadbalancer ShardingContainerPoolBalancerState loadbalancer cluster size changed from to active nodes invokers with MB average memory size total invoker memory MB T Z INFO Message akkaclusterGossipEnvelope from Actor akkatcpcontrolleractorsystem systemclustercoredaemon to Actor akkacontrolleractorsystemsystemclustercoredaemon was not delivered dead letters encountered If this is not an expected behavior then Actor akkacontrolleractorsystemsystemclustercoredaemon may have terminated unexpectedly This logging can be turned off or adjusted with configuration settings akkalogdeadletters and akkalogdeadlettersduringshutdown T Z INFO tidsidunknown Controller Shutting down Kamon with coordinated shutdown T Z INFO Message orgapacheopenwhiskcoreconnectorMessageFeedFillCompleted from Actor akkacontrolleractorsystemusere to Actor akkacontrolleractorsystemusere was not delivered dead letters encountered If this is not an expected behavior then Actor akkacontrolleractorsystemusere may have terminated unexpectedly This logging can be turned off or adjusted with configuration settings akkalogdeadletters and akkalogdeadlettersduringshutdown T Z INFO Shutting down remote daemon T Z INFO Remote daemon shut down proceeding with flushing remote transports T Z INFO Remoting shut down T Z INFO Remoting shut down ERROR controlleractorsystemakkaactordefaultdispatcher akkaactorActorSystemImplcontrolleractorsystem exception while executing timer task javautilNoSuchElementException at scalacollectionconcurrentTrieMapapplyTrieMapscala at orgapacheopenwhiskcommonNestedSemaphorereleaseConcurrentNestedSemaphorescala at orgapacheopenwhiskcoreloadBalancerShardingContainerPoolBalanceranonfunreleaseInvoker ShardingContainerPoolBalancerscala at orgapacheopenwhiskcoreloadBalancerShardingContainerPoolBalanceranonfunreleaseInvoker adaptedShardingContainerPoolBalancerscala at scalaOptionforeachOptionscala at orgapacheopenwhiskcoreloadBalancerShardingContainerPoolBalancerreleaseInvokerShardingContainerPoolBalancerscala at orgapacheopenwhiskcoreloadBalancerCommonLoadBalancerprocessCompletionCommonLoadBalancerscala at orgapacheopenwhiskcoreloadBalancerCommonLoadBalanceranonfunsetupActivation CommonLoadBalancerscala at akkaactorScheduleranon runSchedulerscala at akkaactorLightArrayRevolverSchedulerTaskHolderrunLightArrayRevolverSchedulerscala at akkaactorLightArrayRevolverScheduleranonfunclose LightArrayRevolverSchedulerscala at akkaactorLightArrayRevolverScheduleranonfunclose adaptedLightArrayRevolverSchedulerscala at scalacollectionIteratorforeachIteratorscala at scalacollectionIteratorforeachIteratorscala at scalacollectionAbstractIteratorforeachIteratorscala at scalacollectionIterableLikeforeachIterableLikescala at scalacollectionIterableLikeforeachIterableLikescala at scalacollectionAbstractIterableforeachIterablescala at akkaactorLightArrayRevolverSchedulercloseLightArrayRevolverSchedulerscala at akkaactorActorSystemImplstopSchedulerActorSystemscala at akkaactorActorSystemImplanonfunstart ActorSystemscala at scalaruntimejava JFunction mcVspapplyJFunction mcVspjava at akkaactorActorSystemImplanon runActorSystemscala at akkaactorActorSystemImplTerminationCallbacksanonfunaddRec applyOrElseActorSystemscala at akkaactorActorSystemImplTerminationCallbacksanonfunaddRec applyOrElseActorSystemscala at scalaconcurrentFutureanonfunandThen Futurescala at scalaconcurrentimplPromiseliftedTree Promisescala at scalaconcurrentimplPromiseanonfuntransform Promisescala at scalaconcurrentimplCallbackRunnablerunPromisescala at akkadispatchBatchingExecutorAbstractBatchprocessBatchBatchingExecutorscala at akkadispatchBatchingExecutorBlockableBatchanonfunrun BatchingExecutorscala at scalaruntimejava JFunction mcVspapplyJFunction mcVspjava at scalaconcurrentBlockContextwithBlockContextBlockContextscala at akkadispatchBatchingExecutorBlockableBatchrunBatchingExecutorscala at akkadispatchTaskInvocationrunAbstractDispatcherscala at akkadispatchForkJoinExecutorConfiguratorAkkaForkJoinTaskexecForkJoinExecutorConfiguratorscala at akkadispatchforkjoinForkJoinTaskdoExecForkJoinTaskjava at akkadispatchforkjoinForkJoinPoolWorkQueuerunTaskForkJoinPooljava at akkadispatchforkjoinForkJoinPoolrunWorkerForkJoinPooljava at akkadispatchforkjoinForkJoinWorkerThreadrunForkJoinWorkerThreadjava ERROR controlleractorsystemakkaactordefaultdispatcher akkaactorActorSystemImplcontrolleractorsystem exception while executing timer task javautilNoSuchElementException at scalacollectionconcurrentTrieMapapplyTrieMapscala at orgapacheopenwhiskcommonNestedSemaphorereleaseConcurrentNestedSemaphorescala at orgapacheopenwhiskcoreloadBalancerShardingContainerPoolBalanceranonfunreleaseInvoker ShardingContainerPoolBalancerscala at orgapacheopenwhiskcoreloadBalancerShardingContainerPoolBalanceranonfunreleaseInvoker adaptedShardingContainerPoolBalancerscala at scalaOptionforeachOptionscala at orgapacheopenwhiskcoreloadBalancerShardingContainerPoolBalancerreleaseInvokerShardingContainerPoolBalancerscala at orgapacheopenwhiskcoreloadBalancerCommonLoadBalancerprocessCompletionCommonLoadBalancerscala at orgapacheopenwhiskcoreloadBalancerCommonLoadBalanceranonfunsetupActivation CommonLoadBalancerscala at akkaactorScheduleranon runSchedulerscala at akkaactorLightArrayRevolverSchedulerTaskHolderrunLightArrayRevolverSchedulerscala at akkaactorLightArrayRevolverScheduleranonfunclose LightArrayRevolverSchedulerscala at akkaactorLightArrayRevolverScheduleranonfunclose adaptedLightArrayRevolverSchedulerscala at scalacollectionIteratorforeachIteratorscala at scalacollectionIteratorforeachIteratorscala at scalacollectionAbstractIteratorforeachIteratorscala at scalacollectionIterableLikeforeachIterableLikescala at scalacollectionIterableLikeforeachIterableLikescala at scalacollectionAbstractIterableforeachIterablescala at akkaactorLightArrayRevolverSchedulercloseLightArrayRevolverSchedulerscala at akkaactorActorSystemImplstopSchedulerActorSystemscala at akkaactorActorSystemImplanonfunstart ActorSystemscala at scalaruntimejava JFunction mcVspapplyJFunction mcVspjava at akkaactorActorSystemImplanon runActorSystemscala at akkaactorActorSystemImplTerminationCallbacksanonfunaddRec applyOrElseActorSystemscala at akkaactorActorSystemImplTerminationCallbacksanonfunaddRec applyOrElseActorSystemscala at scalaconcurrentFutureanonfunandThen Futurescala at scalaconcurrentimplPromiseliftedTree Promisescala at scalaconcurrentimplPromiseanonfuntransform Promisescala at scalaconcurrentimplCallbackRunnablerunPromisescala at akkadispatchBatchingExecutorAbstractBatchprocessBatchBatchingExecutorscala at akkadispatchBatchingExecutorBlockableBatchanonfunrun BatchingExecutorscala at scalaruntimejava JFunction mcVspapplyJFunction mcVspjava at scalaconcurrentBlockContextwithBlockContextBlockContextscala at akkadispatchBatchingExecutorBlockableBatchrunBatchingExecutorscala at akkadispatchTaskInvocationrunAbstractDispatcherscala at akkadispatchForkJoinExecutorConfiguratorAkkaForkJoinTaskexecForkJoinExecutorConfiguratorscala at akkadispatchforkjoinForkJoinTaskdoExecForkJoinTaskjava at akkadispatchforkjoinForkJoinPoolWorkQueuerunTaskForkJoinPooljava at akkadispatchforkjoinForkJoinPoolrunWorkerForkJoinPooljava at akkadispatchforkjoinForkJoinWorkerThreadrunForkJoinWorkerThreadjava Additional information you deem important Primary issue here is prematurely making use of controller before some number of invokers are Healthy This may be accomplished via deployment healthchecks but ideally we could expose a configurable health endpoint to indicate that a number of invokers are healthy I know this is available at invokers endpoint but it employs no logic for assigning healthiness in current form 