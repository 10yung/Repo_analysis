Addresses The idea is to enable Danger to be run from a subdirectory within a git repository without it complaining that the current path is not a git repository Instead it should do an educated guess about what we intended to do and look up the top level git directory by calling git To ensure backward compatibility we only do this lookup in the special case that is currently causing Danger to fail when doing the initial diff on but the functionality is exposed in GitRepo so is in principle reusable The two added tests serve to illustrate the new behaviour Id basically like to reopen for the following reason We are trying to set up a build in a mono repo where each project might have its own Dangerfile or even no Dangerfile at all Wed like each Dangerfile to be able to assume that it is in the root of the project so in the following diagram we want to run danger from project rather than from git project Dangerfile project Dangerfile Current behaviour Running danger in a subdirectory of a git repository results in an error like the following pathtorepoproject git path does not exist ArgumentError Desired behaviour Running danger in a subdirectory of a git repository just looks up the root of the git repository itself Suggested fix It seems that the fix suggested in actually does work changing diff def diffforfolderfolder from master to HEAD selffolder folder repo Gitopen selffolder repo Gitopen execrevparse showtoplevel ensurecommitishexistsfrom ensurecommitishexiststo mergebase findmergebaserepo from to commitsinbranchcount commitsinbranchcountfrom to selfdiff repodiffmergebase to selfdiff repodiffmergebase topathfolder selflog repologcommitsinbranchcountbetweenfrom to end in libdangerscmsourcegitreporb seems to do the trick Report What did you do bundle exec danger local verbose What did you expect to happen Just want it to work with no exceptions What happened instead ca p r bld MyWorkspaceMyRepoPR jenkins bundle exec danger local verbose NOTE Inheriting FaradayErrorClientError is deprecated use FaradayClientError instead It will be removed in or after version FaradayErrorClientErrorinherited called from UsersjenkinshopMyRepogemruby gemsoctokit liboctokitmiddlewarefollowredirectsrb Running your Dangerfile against this PR bundler failed to load command danger UsersjenkinshopMyRepogemruby bindanger FaradaySSLError SSLconnect returned errno stateerror certificate verify failed self signed certificate in certificate chain Usersjenkinsrbenvversions libruby netprotocolrb in connectnonblock Usersjenkinsrbenvversions libruby netprotocolrb in sslsocketconnect Usersjenkinsrbenvversions libruby nethttprb in connect Usersjenkinsrbenvversions libruby nethttprb in dostart Usersjenkinsrbenvversions libruby nethttprb in start Usersjenkinsrbenvversions libruby nethttprb in request Usersjenkinsrbenvversions libruby nethttprb in get UsersjenkinshopMyRepogemruby gemsfaraday libfaradayadapternethttprb in performrequest UsersjenkinshopMyRepogemruby gemsfaraday libfaradayadapternethttprb in block in call UsersjenkinshopMyRepogemruby gemsfaraday libfaradayadapternethttprb in withnethttpconnection UsersjenkinshopMyRepogemruby gemsfaraday libfaradayadapternethttprb in call UsersjenkinshopMyRepogemruby gemsfaraday libfaradayresponserb in call UsersjenkinshopMyRepogemruby gemsfaradayhttpcache libfaradayhttpcacherb in fetch UsersjenkinshopMyRepogemruby gemsfaradayhttpcache libfaradayhttpcacherb in process UsersjenkinshopMyRepogemruby gemsfaradayhttpcache libfaradayhttpcacherb in call UsersjenkinshopMyRepogemruby gemsfaradayhttpcache libfaradayhttpcacherb in call UsersjenkinshopMyRepogemruby gemsfaraday libfaradayrackbuilderrb in buildresponse UsersjenkinshopMyRepogemruby gemsfaraday libfaradayconnectionrb in runrequest UsersjenkinshopMyRepogemruby gemsfaraday libfaradayconnectionrb in get UsersjenkinshopMyRepogemruby gemssawyer libsawyeragentrb in call UsersjenkinshopMyRepogemruby gemsoctokit liboctokitconnectionrb in request UsersjenkinshopMyRepogemruby gemsoctokit liboctokitconnectionrb in get UsersjenkinshopMyRepogemruby gemsoctokit liboctokitclientpullrequestsrb in pullrequest UsersjenkinshopMyRepogemruby gemsdanger libdangerrequestsourcesgithubgithubrb in fetchdetails UsersjenkinshopMyRepogemruby gemsdanger libdangercommandslocalhelperslocalsetuprb in setup UsersjenkinshopMyRepogemruby gemsdanger libdangercommandslocalrb in run UsersjenkinshopMyRepogemruby gemsclaide libclaidecommandrb in run UsersjenkinshopMyRepogemruby gemsdanger bindanger in top required UsersjenkinshopMyRepogemruby bindanger in load UsersjenkinshopMyRepogemruby bindanger in top required Your Environment Which CI are you running on Jenkins Are you running the latest version of Danger Yes bundle exec danger version NOTE Inheriting FaradayErrorClientError is deprecated use FaradayClientError instead It will be removed in or after version FaradayErrorClientErrorinherited called from Usersjenkinshopcupertinogemruby gemsoctokit liboctokitmiddlewarefollowredirectsrb What is your Dangerfile I dont think this matter and I revert it back to the orignal default danger file generated by danger init ruby Sometimes its a README fix or something like that which isnt relevant for including in a projects CHANGELOG for example declaredtrivial githubprtitleinclude trivial Make it more obvious that a PR is a work in progress and shouldnt be merged yet warnPR is classed as Work in Progress if githubprtitleinclude WIP Warn when there is a big PR warnBig PR if gitlinesofcode Dont let testing shortcuts get into master by accident failfdescribe left in tests if grep r fdescribe specs length failfit left in tests if grep r fit specs length Report Im using danger on our AppCenter CI for iOS builds with the simple setup described in the website pretty much providing DANGERGITHUBAPITOKEN and running bundle exec danger Everything was always working fine but after updating danger to the latest version the danger command during build started to give an error Just in case I reverted back to the previous version published on rubygems and everything started to work fine again What did you do Run danger on AppCenter CI bundle exec danger What did you expect to happen For build to work properly like it was on version What happened instead Heres the failing log bundler failed to load command danger usrlocallibrubygems bindanger RuntimeError Credentials not available Provide DANGERBITBUCKETCLOUDUSERNAME and DANGERBITBUCKETCLOUDPASSWORD as environment variables usrlocallibrubygems gemsdanger libdangerrequestsourcesbitbucketcloudapirb in fetchjson usrlocallibrubygems gemsdanger libdangerrequestsourcesbitbucketcloudapirb in fetchprfrombranch usrlocallibrubygems gemsdanger libdangerrequestsourcesbitbucketcloudapirb in initialize usrlocallibrubygems gemsdanger libdangerrequestsourcesbitbucketcloudrb in new usrlocallibrubygems gemsdanger libdangerrequestsourcesbitbucketcloudrb in initialize usrlocallibrubygems gemsdanger libdangerdangercoreenvironmentmanagerrb in new usrlocallibrubygems gemsdanger libdangerdangercoreenvironmentmanagerrb in block in initialize usrlocalCellarruby libruby setrb in eachkey usrlocalCellarruby libruby setrb in each usrlocallibrubygems gemsdanger libdangerdangercoreenvironmentmanagerrb in initialize usrlocallibrubygems gemsdanger libdangerdangercoreexecutorrb in new usrlocallibrubygems gemsdanger libdangerdangercoreexecutorrb in run usrlocallibrubygems gemsdanger libdangercommandsrunnerrb in run usrlocallibrubygems gemsclaide libclaidecommandrb in run usrlocallibrubygems gemsdanger bindanger in top required usrlocallibrubygems bindanger in load usrlocallibrubygems bindanger in top required As you can see for some reason it thinks that Im using bitbucket cloud without credentials although we are actually using GitHub All env var are properly set as everything is working fine with version Below Ill post a complete list of env vars set by us and appcenter itself when running the build if it helps in debugging Your Environment detailssummaryApp Center Env Varssummary p SYSTEMTEAMFOUNDATIONCOLLECTIONURI BUILDSOURCEBRANCH SYSTEMTASKDEFINITIONSURI AGENTVERSION SYSTEMJOBATTEMPT DANGERGITHUBAPITOKEN BUILDQUEUEDBY SYSTEMHOSTTYPE SYSTEMCOLLECTIONURI BUILDREPOSITORYGITSUBMODULECHECKOUT SYSTEMJOBPARALLELISMTAG ANDROIDHOME NVMCDFLAGS MDAPPLESDKROOT SHELL MOBILECENTERSOURCEDIRECTORY APPLECERTIFICATEKEYCHAIN BUILDSTAGINGDIRECTORY AGENTMACHINENAME TMPDIR PRCHECKID COMMONTESTRESULTSDIRECTORY APPCENTERBRANCH SYSTEMWORKFOLDER AGENTJOBNAME APPCENTERXCODEPROJECT MSDEPLOYHTTPUSERAGENT FASTLANEPASSWORD XCODE DEVELOPERDIR RCTNOLAUNCHPACKAGER JAVAHOME X MOBILECENTERXCODEPROJECT AGENTOSARCHITECTURE MATCHPASSWORD BUILDREQUESTEDFOREMAIL SONOMAAPISERVER NUNITBASEPATH RUNNERPERFLOG AGENTACCEPTTEEEULA MOBILEPROVISION SYSTEMSTAGEATTEMPT LCALL NUNIT PATH GITTERMINALPROMPT SYSTEMDEFINITIONNAME SYSTEMCULTURE INPUTARGS FASTLANETEAMID JAVAHOME X AGENTTEMPDIRECTORY BUILDREPOSITORYPROVIDER BUILDSOURCEBRANCHNAME MOBILEPROVISIONSECUREFILEID BUILDREPOSITORYCLEAN NVMDIR USER SYSTEMJOBIDENTIFIER USERDEFINEDAWSREGION XCODE DEVELOPERDIR SYSTEMTEAMFOUNDATIONSERVERURI TFBUILD SYSTEMTASKDISPLAYNAME BUILDQUEUEDBYID AZUREHTTPUSERAGENT SYSTEMSTAGENAME SONOMAAPIVERSION APPLECERTIFICATESIGNINGIDENTITY APPCENTERAPITOKEN APPCENTEROUTPUTDIRECTORY APPCENTERXCODESCHEME AGENTDISABLELOGPLUGINTESTRESULTLOGPLUGIN SSHAUTHSOCK APPEXTENSIONPROVISIONSECUREFILES SYSTEMTEAMPROJECTID VSTSPROCESSLOOKUPID AGENTROOTDIRECTORY BUILDSCRIPTSTOOLSET HOMEBREWNOAUTOUPDATE CFUSERTEXTENCODING MOBILECENTERBUILDID SYSTEMTEAMPROJECT AGENTHOMEDIRECTORY AGENTTOOLSDIRECTORY BUILDREPOSITORYID BUILDREPOSITORYLOCALPATH SYSTEMJOBDISPLAYNAME BUILDREASON AGENTBUILDDIRECTORY SYSTEMPIPELINESTARTTIME SYSTEM BUILDSOURCESDIRECTORY SDK AGENTOS PATH SYSTEMPHASEATTEMPT MOBILECENTEROUTPUTDIRECTORY SYSTEMISSCHEDULED SYSTEMDEBUG MOBILECENTERXCODESCHEME MOBILEPROVISIONFILENAME MOBILECENTERBRANCH PERFLOGLOCATIONSETTINGRUNNERPERFLOG BUILDBUILDURI SYSTEMPULLREQUESTISFORK DOTNETROOT PWD CONDA SYSTEMDEFINITIONID JAVAHOME AGENTDISABLELOGPLUGINTESTFILEPUBLISHERPLUGIN SYSTEMSTAGEID AWSSECRETACCESSKEY JAVAHOME X JAVAHOME X LASTCOMMITMESSAGE MOBILECENTERTRIGGER USERDEFINEDFASTLANETEAMID LANG APPCENTERBUILDID SYSTEMTASKINSTANCENAME APPLEPROVPROFILEUUID SYSTEMPHASEDISPLAYNAME AWSREGION SECRETP PASSWORD BUILDREPOSITORYNAME SYSTEMSERVERTYPE XPCFLAGS PIPELINEWORKSPACE BUILDREPOSITORYURI TESTSDK AGENTWORKFOLDER BUILDDEFINITIONNAME SYSTEMJOBNAME BUILDREQUESTEDFOR XPCSERVICENAME SYSTEMTIMELINEID SYSTEMARTIFACTSDIRECTORY AWSACCESSKEYID AGENTID SHLVL HOME VSMOBILECENTERUPLOADCONTINUEIFSYMBOLSNOTFOUND AGENTRETAINDEFAULTENCODING APPCENTERTRIGGER SYSTEMJOBPOSITIONINPHASE BUILDARTIFACTSTAGINGDIRECTORY BUILDBINARIESDIRECTORY BUILDREQUESTEDFORID BUILDBUILDID SYSTEMTASKINSTANCEID P SECUREFILEID SONOMATAGS LOGNAME BUILDSOURCEVERSION LCCTYPE JAVAHOME X PKGCONFIGPATH SYSTEMDEFAULTWORKINGDIRECTORY SYSTEMJOBID ANDROIDNDKHOME SYSTEMTOTALJOBSINPHASE SYSTEMSTAGEDISPLAYNAME AGENTNAME XCODE DEVELOPERDIR SYSTEMPLANID BUILDDEFINITIONVERSION SYSTEMPHASEID TASKDISPLAYNAME SYSTEMCOLLECTIONID AGENTJOBSTATUS ENDPOINTURLSYSTEMVSSCONNECTION APPCENTERSOURCEDIRECTORY BUILDBUILDNUMBER SYSTEMPHASENAME BUILDCONTAINERID GHTOKEN p details Hi there This PR adds support for Bamboo CI to Danger Currently it is only integrated with Bitbucket Server as this is what I could test it against Report Using latest Danger in BitRise with onprem BitBucket Server This never passes always fails with below trace I have set DANGERBITBUCKETSERVERHOST DANGERBITBUCKETSERVERUSERNAME and DANGERBITBUCKETSERVERPASSWORD in the BitRise secrets for the workflow Verified proper workflow Verified script step has access to the secrets dump shows REDACTED Same secrets used elsewhere as well This PoC is NOT using fastlane wrappers yet plan to add that after this works Git clone step works properly on same repo as Danger is pointed to of course How can I debug more Note if I run this from local desktop I see debug output and everything working but no comment actual added to the PR What did you do In a script step I executed this in bash bundle exec danger verbose dangerfilefastlaneDangerfile I added this in the Bash script as well for S Gs no luck export DANGERBITBUCKETSERVERHOSTmy host export DANGERBITBUCKETSERVERPASSWORDmypass export DANGERBITBUCKETSERVERUSERNAME myuser I also added a cURL call in the Bash script just before the Danger call that queries for the PR JSON and it works fine Seems like the environment vars are not available to the Danger scripts not sure if this is a bitrise thing other scripts I have work fine or a Danger thing What did you expect to happen Expecting simple hello world to work What happened instead fails here code indicates branch is not retrieved But no log data even with verbose set Fetching danger Installing danger bundle exec danger verbose dangerfilefastlaneDangerfile bundler failed to load command danger Usersvagrantrbenvversions bindanger NoMethodError undefined method for nilNilClass Usersvagrantrbenvversions librubygems gemsdanger libdangerrequestsourcesbitbucketserverrb in setupdangerbranches Usersvagrantrbenvversions librubygems gemsdanger libdangerdangercoreenvironmentmanagerrb in ensuredangerbranchesaresetup Usersvagrantrbenvversions librubygems gemsdanger libdangerdangercoredangerfilerb in setupforrunning Usersvagrantrbenvversions librubygems gemsdanger libdangerdangercoredangerfilerb in run Usersvagrantrbenvversions librubygems gemsdanger libdangerdangercoreexecutorrb in run Usersvagrantrbenvversions librubygems gemsdanger libdangercommandsrunnerrb in run Usersvagrantrbenvversions librubygems gemsclaide libclaidecommandrb in run Usersvagrantrbenvversions librubygems gemsdanger bindanger in top required Usersvagrantrbenvversions bindanger in load Usersvagrantrbenvversions bindanger in top required Script finished with exit code Your Environment Which CI are you running on BitRise Are you running the latest version of Danger Yes What is your Dangerfile ruby messageHello this worked Report What did you do Tried to use Dangerfile with configuration ruby dangerimportdangerfilegitlab mobileci branch develop path iosDangerfile What did you expect to happen To get running with danger imported from gitlab repo Or at least show any error on fail What happened instead CI ran danger without any messages bundle exec danger Job succeeded And didnt post anything to MR There is a message on start inside remote Dangerfile No message were there Your Environment Which CI are you running on Gitlab CI Are you running the latest version of Danger Yes What is your Dangerfile ruby dangerimportdangerfilegitlab mobileci branch develop path iosDangerfile Gitlab seems to not work with importdangerfile As in said this was unintentional feature to use private token inside query params Now they require to use an api method There are no proper messages on failed import Had to run more than times to test this behaviour Finally this works on my fork with changes added header changed gitlab api url This works with Dangerfile ruby dangerimportdangerfilegitlab branch develop path ios FDangerfile I can use projectid or slug But path has to be url encoded Otherwise it doesnt work Im interested if someone have the same issues on gitlab ci with mrs Latest issue with gitlab I found was on May So I suppose it worked back then Now Im using danger gem from my git apparently its not possible to import Dangerfile from plain http url even looked source code and file only loads local files not urls the actual problem im having that danger is unable to import Dockerfile from private gitlab instance Found similar issues for github and seems these are not resolved either Danger has good codebase to talk to pullrequestmergerequest However I have a great idea to add more messages from other CI jobs via danger library Status message of some custom deployment Perhaps something like superappcli deploy deploymentlog danger report warn Tests were not updated stickyfalse deploymentlog Report What did you do Create a MR on Gitlab containing commit push another commit to the MR squash both commits localy and push f to the MR MR now only contains commit gitcommits contains now at least the last commits maybe even This occures because i have Ensure a clean commits history if gitcommitsany c cmessage Merge branch failPlease rebase to get rid of the merge commits in this PR end in my Dangerfile The warning appears on the MR when the commits were squashed What did you expect to happen Only load the commits which are currently in the MR What happened instead Commits out of the MR are contained in gitcommits Your Environment GitLab selfhosted Jenkins selfhosted latest verison Dangerfile example above Annotations Maybe this issue is connected to 