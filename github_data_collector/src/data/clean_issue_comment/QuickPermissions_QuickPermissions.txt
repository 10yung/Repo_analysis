Configuration for reproduction Android Studio comandroidtoolsbuildgradle gradle Kotlin comgithubQuickPermissionsQuickPermissions When running Android Instrumentation Tests build fails with following error related to the QuickPermissionsTransformkt Build failure log Caused by orggradleapitasksTaskExecutionException Execution failed for task apptransformClassesWithQuickPermissionsForDebugAndroidTest at orggradleapiinternaltasksexecutionExecuteActionsTaskExecuter acceptExecuteActionsTaskExecuterjava at orggradleapiinternaltasksexecutionExecuteActionsTaskExecuter acceptExecuteActionsTaskExecuterjava at orggradleinternalTryFailureifSuccessfulOrElseTryjava at orggradleapiinternaltasksexecutionExecuteActionsTaskExecuterexecuteExecuteActionsTaskExecuterjava at orggradleapiinternaltasksexecutionResolveBeforeExecutionStateTaskExecuterexecuteResolveBeforeExecutionStateTaskExecuterjava at orggradleapiinternaltasksexecutionValidatingTaskExecuterexecuteValidatingTaskExecuterjava at orggradleapiinternaltasksexecutionSkipEmptySourceFilesTaskExecuterexecuteSkipEmptySourceFilesTaskExecuterjava at orggradleapiinternaltasksexecutionResolveBeforeExecutionOutputsTaskExecuterexecuteResolveBeforeExecutionOutputsTaskExecuterjava at orggradleapiinternaltasksexecutionResolveAfterPreviousExecutionStateTaskExecuterexecuteResolveAfterPreviousExecutionStateTaskExecuterjava at orggradleapiinternaltasksexecutionCleanupStaleOutputsExecuterexecuteCleanupStaleOutputsExecuterjava at orggradleapiinternaltasksexecutionFinalizePropertiesTaskExecuterexecuteFinalizePropertiesTaskExecuterjava at orggradleapiinternaltasksexecutionResolveTaskExecutionModeExecuterexecuteResolveTaskExecutionModeExecuterjava at orggradleapiinternaltasksexecutionSkipTaskWithNoActionsExecuterexecuteSkipTaskWithNoActionsExecuterjava at orggradleapiinternaltasksexecutionSkipOnlyIfTaskExecuterexecuteSkipOnlyIfTaskExecuterjava at orggradleapiinternaltasksexecutionCatchExceptionTaskExecuterexecuteCatchExceptionTaskExecuterjava at orggradleapiinternaltasksexecutionEventFiringTaskExecuter executeTaskEventFiringTaskExecuterjava at orggradleapiinternaltasksexecutionEventFiringTaskExecuter callEventFiringTaskExecuterjava at orggradleapiinternaltasksexecutionEventFiringTaskExecuter callEventFiringTaskExecuterjava at orggradleinternaloperationsDefaultBuildOperationExecutorCallableBuildOperationWorkerexecuteDefaultBuildOperationExecutorjava at orggradleinternaloperationsDefaultBuildOperationExecutorCallableBuildOperationWorkerexecuteDefaultBuildOperationExecutorjava at orggradleinternaloperationsDefaultBuildOperationExecutor executeDefaultBuildOperationExecutorjava at orggradleinternaloperationsDefaultBuildOperationExecutorexecuteDefaultBuildOperationExecutorjava at orggradleinternaloperationsDefaultBuildOperationExecutorexecuteDefaultBuildOperationExecutorjava at orggradleinternaloperationsDefaultBuildOperationExecutorcallDefaultBuildOperationExecutorjava at orggradleinternaloperationsDelegatingBuildOperationExecutorcallDelegatingBuildOperationExecutorjava at orggradleapiinternaltasksexecutionEventFiringTaskExecuterexecuteEventFiringTaskExecuterjava at orggradleexecutionplanLocalTaskNodeExecutorexecuteLocalTaskNodeExecutorjava at orggradleexecutiontaskgraphDefaultTaskExecutionGraphInvokeNodeExecutorsActionexecuteDefaultTaskExecutionGraphjava at orggradleexecutiontaskgraphDefaultTaskExecutionGraphInvokeNodeExecutorsActionexecuteDefaultTaskExecutionGraphjava at orggradleexecutiontaskgraphDefaultTaskExecutionGraphBuildOperationAwareExecutionActionexecuteDefaultTaskExecutionGraphjava at orggradleexecutiontaskgraphDefaultTaskExecutionGraphBuildOperationAwareExecutionActionexecuteDefaultTaskExecutionGraphjava at orggradleexecutionplanDefaultPlanExecutorExecutorWorker executeDefaultPlanExecutorjava at orggradleexecutionplanDefaultPlanExecutorExecutorWorker executeDefaultPlanExecutorjava at orggradleexecutionplanDefaultPlanExecutorExecutorWorkerexecuteDefaultPlanExecutorjava at orggradleexecutionplanDefaultPlanExecutorExecutorWorkerexecuteNextNodeDefaultPlanExecutorjava at orggradleexecutionplanDefaultPlanExecutorExecutorWorkerrunDefaultPlanExecutorjava more Caused by orggradleapiGradleException ABORT at comlivinglifetechwayquickpermissionspluginQuickPermissionsTransformtransformQuickPermissionsTransformkt at comandroidbuildgradleinternalpipelineTransformTask callTransformTaskjava at comandroidbuildgradleinternalpipelineTransformTask callTransformTaskjava at comandroidbuilderprofileThreadRecorderrecordThreadRecorderjava at comandroidbuildgradleinternalpipelineTransformTasktransformTransformTaskjava at sunreflectNativeMethodAccessorImplinvoke Native Method at sunreflectNativeMethodAccessorImplinvokeNativeMethodAccessorImpljava at sunreflectDelegatingMethodAccessorImplinvokeDelegatingMethodAccessorImpljava at javalangreflectMethodinvokeMethodjava at orggradleinternalreflectJavaMethodinvokeJavaMethodjava at orggradleapiinternalprojecttaskfactoryIncrementalTaskInputsTaskActiondoExecuteIncrementalTaskInputsTaskActionjava at orggradleapiinternalprojecttaskfactoryStandardTaskActionexecuteStandardTaskActionjava at orggradleapiinternalprojecttaskfactoryAbstractIncrementalTaskActionexecuteAbstractIncrementalTaskActionjava at orggradleapiinternalprojecttaskfactoryStandardTaskActionexecuteStandardTaskActionjava at orggradleapiinternaltasksexecutionExecuteActionsTaskExecuter runExecuteActionsTaskExecuterjava at orggradleinternaloperationsDefaultBuildOperationExecutorRunnableBuildOperationWorkerexecuteDefaultBuildOperationExecutorjava at orggradleinternaloperationsDefaultBuildOperationExecutorRunnableBuildOperationWorkerexecuteDefaultBuildOperationExecutorjava at orggradleinternaloperationsDefaultBuildOperationExecutor executeDefaultBuildOperationExecutorjava at orggradleinternaloperationsDefaultBuildOperationExecutorexecuteDefaultBuildOperationExecutorjava at orggradleinternaloperationsDefaultBuildOperationExecutorexecuteDefaultBuildOperationExecutorjava at orggradleinternaloperationsDefaultBuildOperationExecutorrunDefaultBuildOperationExecutorjava at orggradleinternaloperationsDelegatingBuildOperationExecutorrunDelegatingBuildOperationExecutorjava at orggradleapiinternaltasksexecutionExecuteActionsTaskExecuterexecuteActionExecuteActionsTaskExecuterjava at orggradleapiinternaltasksexecutionExecuteActionsTaskExecuterexecuteActionsExecuteActionsTaskExecuterjava at orggradleapiinternaltasksexecutionExecuteActionsTaskExecuteraccess ExecuteActionsTaskExecuterjava at orggradleapiinternaltasksexecutionExecuteActionsTaskExecuterTaskExecutionexecuteExecuteActionsTaskExecuterjava at orggradleinternalexecutionstepsExecuteSteplambdaexecute ExecuteStepjava Caused by orgaspectjapachebcelclassfileClassFormatException File UsersMaskedProjectNameappbuildintermediatestransformsQuickPermissionsandroidTestdebug moduleinfoclass Invalid byte tag in constant pool at orgaspectjapachebcelclassfileClassParserreadConstantPoolClassParserjava at orgaspectjapachebcelclassfileClassParserparseClassParserjava at orgaspectjweaverbcelUtilitymakeJavaClassUtilityjava at orgaspectjweaverbcelUnwovenClassFilegetJavaClassUnwovenClassFilejava at orgaspectjweaverbcelBcelWeaveraddClassFileBcelWeaverjava at orgaspectjweaverbcelBcelWeaveraddJarFileBcelWeaverjava at orgaspectjajdtinternalcorebuilderAjBuildManagerinitBcelWorldAjBuildManagerjava at orgaspectjajdtinternalcorebuilderAjBuildManagerperformBuildAjBuildManagerjava at orgaspectjajdtinternalcorebuilderAjBuildManagerbatchBuildAjBuildManagerjava at orgaspectjajdtajcAjdtCommanddoCommandAjdtCommandjava at orgaspectjajdtajcAjdtCommandrunCommandAjdtCommandjava at orgaspectjtoolsajcMainrunMainjava at comlivinglifetechwayquickpermissionspluginQuickPermissionsTransformtransformQuickPermissionsTransformkt Anyone has idea where to start Seems that it has to do with orgaspectjapachebcelclassfileClassFormatException but Most probably long term solution is to move to QuickPermissionKotlin but Activities where I am using library for now are in Java and probably there will be others who face this issue after upgrade to Android Studio Im getting the following error when using this library because of this dependency implementation comgoogleandroidgmsplayservicesauthplayServicesVersion apptransformClassesWithQuickPermissionsForDebug javalangIllegalStateException Expecting or but found while unpacking LcomgoogleandroidgmscommonapiApiAbstractClientBuilderLcomgoogleandroidgmsinternalauthapiphonezziLcomgoogleandroidgmscommonapiApiApiOptionsNoOptions at orgaspectjutilGenericSignatureParserparseClassTypeSignatureGenericSignatureParserjava at orgaspectjutilGenericSignatureParserparseFieldTypeSignatureGenericSignatureParserjava at orgaspectjutilGenericSignatureParserparseTypeArgumentGenericSignatureParserjava at orgaspectjutilGenericSignatureParsermaybeParseTypeArgumentsGenericSignatureParserjava at orgaspectjutilGenericSignatureParserparseClassTypeSignatureGenericSignatureParserjava at orgaspectjutilGenericSignatureParserparseAsClassSignatureGenericSignatureParserjava at orgaspectjweaverAbstractReferenceTypeDelegategetGenericClassTypeSignatureAbstractReferenceTypeDelegatejava at orgaspectjweaverbcelBcelObjectTypeensureGenericSignatureUnpackedBcelObjectTypejava at orgaspectjweaverbcelBcelObjectTypegetSuperclassBcelObjectTypejava at orgaspectjweaverReferenceTypegetSuperclassReferenceTypejava at orgaspectjweaverbcelBcelWeaverweaveParentsForBcelWeaverjava at orgaspectjweaverbcelBcelWeaverweaveBcelWeaverjava at orgaspectjajdtinternalcompilerAjPipeliningCompilerAdapterweaveQueuedEntriesAjPipeliningCompilerAdapterjava at orgaspectjajdtinternalcompilerAjPipeliningCompilerAdapterafterCompilingAjPipeliningCompilerAdapterjava at orgaspectjajdtinternalcompilerCompilerAdapterajcafterReturningorgaspectjajdtinternalcompilerCompilerAdapter f cc ca CompilerAdapteraj at orgaspectjorgeclipsejdtinternalcompilerCompilercompileCompilerjava at orgaspectjajdtinternalcorebuilderAjBuildManagerperformCompilationAjBuildManagerjava at orgaspectjajdtinternalcorebuilderAjBuildManagerperformBuildAjBuildManagerjava at orgaspectjajdtinternalcorebuilderAjBuildManagerbatchBuildAjBuildManagerjava at orgaspectjajdtajcAjdtCommanddoCommandAjdtCommandjava at orgaspectjajdtajcAjdtCommandrunCommandAjdtCommandjava at orgaspectjtoolsajcMainrunMainjava at comlivinglifetechwayquickpermissionspluginQuickPermissionsTransformtransformQuickPermissionsTransformkt at comandroidbuildgradleinternalpipelineTransformTask callTransformTaskjava at comandroidbuildgradleinternalpipelineTransformTask callTransformTaskjava at comandroidbuilderprofileThreadRecorderrecordThreadRecorderjava at comandroidbuildgradleinternalpipelineTransformTasktransformTransformTaskjava at sunreflectNativeMethodAccessorImplinvoke Native Method at sunreflectNativeMethodAccessorImplinvokeNativeMethodAccessorImpljava at sunreflectDelegatingMethodAccessorImplinvokeDelegatingMethodAccessorImpljava at javalangreflectMethodinvokeMethodjava at orggradleinternalreflectJavaMethodinvokeJavaMethodjava at orggradleapiinternalprojecttaskfactoryDefaultTaskClassInfoStoreIncrementalTaskActiondoExecuteDefaultTaskClassInfoStorejava at orggradleapiinternalprojecttaskfactoryDefaultTaskClassInfoStoreStandardTaskActionexecuteDefaultTaskClassInfoStorejava at orggradleapiinternalprojecttaskfactoryDefaultTaskClassInfoStoreStandardTaskActionexecuteDefaultTaskClassInfoStorejava at orggradleapiinternaltasksexecutionExecuteActionsTaskExecuter runExecuteActionsTaskExecuterjava at orggradleinternalprogressDefaultBuildOperationExecutorRunnableBuildOperationWorkerexecuteDefaultBuildOperationExecutorjava at orggradleinternalprogressDefaultBuildOperationExecutorRunnableBuildOperationWorkerexecuteDefaultBuildOperationExecutorjava at orggradleinternalprogressDefaultBuildOperationExecutorexecuteDefaultBuildOperationExecutorjava at orggradleinternalprogressDefaultBuildOperationExecutorrunDefaultBuildOperationExecutorjava at orggradleapiinternaltasksexecutionExecuteActionsTaskExecuterexecuteActionExecuteActionsTaskExecuterjava at orggradleapiinternaltasksexecutionExecuteActionsTaskExecuterexecuteActionsExecuteActionsTaskExecuterjava at orggradleapiinternaltasksexecutionExecuteActionsTaskExecuterexecuteExecuteActionsTaskExecuterjava at orggradleapiinternaltasksexecutionSkipUpToDateTaskExecuterexecuteSkipUpToDateTaskExecuterjava at orggradleapiinternaltasksexecutionResolveTaskOutputCachingStateExecuterexecuteResolveTaskOutputCachingStateExecuterjava at orggradleapiinternaltasksexecutionValidatingTaskExecuterexecuteValidatingTaskExecuterjava at orggradleapiinternaltasksexecutionSkipEmptySourceFilesTaskExecuterexecuteSkipEmptySourceFilesTaskExecuterjava at orggradleapiinternaltasksexecutionResolveTaskArtifactStateTaskExecuterexecuteResolveTaskArtifactStateTaskExecuterjava at orggradleapiinternaltasksexecutionSkipTaskWithNoActionsExecuterexecuteSkipTaskWithNoActionsExecuterjava at orggradleapiinternaltasksexecutionSkipOnlyIfTaskExecuterexecuteSkipOnlyIfTaskExecuterjava at orggradleapiinternaltasksexecutionExecuteAtMostOnceTaskExecuterexecuteExecuteAtMostOnceTaskExecuterjava at orggradleapiinternaltasksexecutionCatchExceptionTaskExecuterexecuteCatchExceptionTaskExecuterjava at orggradleexecutiontaskgraphDefaultTaskGraphExecuterEventFiringTaskWorker runDefaultTaskGraphExecuterjava at orggradleinternalprogressDefaultBuildOperationExecutorRunnableBuildOperationWorkerexecuteDefaultBuildOperationExecutorjava at orggradleinternalprogressDefaultBuildOperationExecutorRunnableBuildOperationWorkerexecuteDefaultBuildOperationExecutorjava at orggradleinternalprogressDefaultBuildOperationExecutorexecuteDefaultBuildOperationExecutorjava at orggradleinternalprogressDefaultBuildOperationExecutorrunDefaultBuildOperationExecutorjava at orggradleexecutiontaskgraphDefaultTaskGraphExecuterEventFiringTaskWorkerexecuteDefaultTaskGraphExecuterjava at orggradleexecutiontaskgraphDefaultTaskGraphExecuterEventFiringTaskWorkerexecuteDefaultTaskGraphExecuterjava at orggradleexecutiontaskgraphDefaultTaskPlanExecutorTaskExecutorWorkerprocessTaskDefaultTaskPlanExecutorjava at orggradleexecutiontaskgraphDefaultTaskPlanExecutorTaskExecutorWorkeraccess DefaultTaskPlanExecutorjava at orggradleexecutiontaskgraphDefaultTaskPlanExecutorTaskExecutorWorker executeDefaultTaskPlanExecutorjava at orggradleexecutiontaskgraphDefaultTaskPlanExecutorTaskExecutorWorker executeDefaultTaskPlanExecutorjava at orggradleexecutiontaskgraphDefaultTaskExecutionPlanexecuteDefaultTaskExecutionPlanjava at orggradleexecutiontaskgraphDefaultTaskExecutionPlanexecuteWithTaskDefaultTaskExecutionPlanjava at orggradleexecutiontaskgraphDefaultTaskPlanExecutorTaskExecutorWorkerrunDefaultTaskPlanExecutorjava at orggradleinternalconcurrentExecutorPolicyCatchAndRecordFailuresonExecuteExecutorPolicyjava at orggradleinternalconcurrentManagedExecutorImpl runManagedExecutorImpljava at javautilconcurrentThreadPoolExecutorrunWorkerThreadPoolExecutorjava at javautilconcurrentThreadPoolExecutorWorkerrunThreadPoolExecutorjava at orggradleinternalconcurrentThreadFactoryImplManagedThreadRunnablerunThreadFactoryImpljava at javalangThreadrunThreadjava ABORT So I realized when I first deny the permission then click Try again in my custom rationale and then grant the permission the method annotated with WithPermissions and the OnPermissionsDenied method both get executed after the permission is granted