 Background I had a channel that was stuck as pending but it did forward payments in that state Dont be alarmed the payment was forwarded only after the channel opening TX had enough confirmations per my config The channel was initiated by the remote party and was in private mode it seems that the connection wasnt stable and kept being reestablished possibly a mobile client Days after the payments were forwarded I noticed the issue the channel was only showing up on the pending channels After I restarted the channel was moved to the activated channels A short part of the sanitized logs during the opening of the channel See lower for fuller logs Block channel opening initiated INF FNDG Waiting for funding tx INF NTFN Historical spend dispatch finishedfor request Block INF NTFN New block height DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f new block height examining active HTLCs DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f new block height examining active HTLCs Block DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f checking chain actions at height DBG FNDG Received FundingLocked for ChannelID f d f fc e f f f c ae ad b a d from peer deadbeefbadbabedec def d INF FNDG Already handling fundingLocked for ChannelID f d f fc e f f f c ae ad b a d ignoring Block confirmations here chan should become active INF NTFN New block height sha c faeb b e a e a ccacbc d ad b b INF NTFN Dispatching confirmation notification for txid ecd ed fa eb deb a f bb fe d d b db f DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f new block height examining active HTLCs INF HSWC Garbage collected shared secret hashes at height could be irrelevant INF FNDG ChannelPoint ecd ed fa eb deb a f bb fe d d b db f is now active ChannelID a fe d f cba b b d dbeff daf d a d e f d c f a cbcfb eca ccbaa ebf a cee DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f checking chain actions at height DBG FNDG ChannelID f d f fc e f f f c ae ad b a d is now fully confirmed shortChanID INF NTFN Cancelling epoch notification epochid ERR LTND Unable to lookup witness no witnesses ERR LTND Unable to lookup witness no witnesses ERR LTND Unable to lookup witness no witnesses INF HSWC ChannelLink Updating to shortchanid for chanid f d f fc e f f f c ae ad b a d INF HSWC Updated shortchanid for ChannelLink f d f fc e f f f c ae ad b a d old new INF CNCT Attempting to update ContractSignals for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f DBG FNDG Channel f d f fc e f f f c ae ad b a d with ShortChanID has opening state INF FNDG Peer deadbeefbadbabedec def d is online sending FundingLocked for ChannelID f d f fc e f f f c ae ad b a d DBG FNDG Channel f d f fc e f f f c ae ad b a d with ShortChanID successfully sent FundingLocked DBG FNDG Channel f d f fc e f f f c ae ad b a d with ShortChanID has opening state TRC FNDG Closing chan barrier for ChanID f d f fc e f f f c ae ad b a d DBG FNDG Channel f d f fc e f f f c ae ad b a d with ShortChanID successfully added to router graph DBG FNDG Channel f d f fc e f f f c ae ad b a d with ShortChanID has opening state DBG FNDG Will not announce private channel DBG FNDG Sending our NodeAnnouncement for ChannelID f d f fc e f f f c ae ad b a d to deadbeefbadbabedec def d DBG FNDG Channel f d f fc e f f f c ae ad b a d with ShortChanID successfully announced DBG FNDG ChannlPoint ecd ed fa eb deb a f bb fe d d b db f with chanID not found in opening database assuming already announced to the network Note Im attaching below sanitized the relevant parts from the logs if you want fullerunsanitized logs I can provided in encrypted form or mail you Your environment version of lnd which operating system uname a on Nix Ubuntu LTS version of btcd bitcoind or other backend bitcoind any other relevant environment details popular node s of channels beefy machine solid connection Tor enabled Steps to reproduce Not sure how to reproduce It seems the case was an unstable remote party initiating a private channel maybe some extreme edge case Below are logs one from the initial opening of the channel and the second from the restart of lnd and the full activation of the channel lnd logs during the initial opening problematic full activation of the channel INF SRVR New inbound connection from THEIRIP INF SRVR Finalizing connection to deadbeefbadbabedec def dTHEIRIP inboundtrue INF SRVR Negotiated chan series queries with deadbeefbadbabedec def d INF DISC Creating new GossipSyncer for peer deadbeefbadbabedec def d INF CRTR Processed channels updates nodes in last m s INF FNDG Recvd fundingRequestamt BTC push mSAT delay pendingId e cc defb e caa c ff f b da fa fe d ecdd e from peer deadbeefbadbabedec def d INF FNDG Requiring confirmations for pendingChan e cc defb e caa c ff f b da fa fe d ecdd e amt BTC pushamt mSAT tweaklessfalse INF FNDG Sending fundingResp for pendingID e cc defb e caa c ff f b da fa fe d ecdd e DBG FNDG Remote party accepted commitment constraints channeldbChannelConstraints DustLimit btcutilAmount BTC ChanReserve btcutilAmount BTC MaxPendingAmount lnwireMilliSatoshi mSAT MinHTLC lnwireMilliSatoshi mSAT MaxAcceptedHtlcs uint CsvDelay uint INF FNDG completing pendingID e cc defb e caa c ff f b da fa fe d ecdd e with ChannelPoint ecd ed fa eb deb a f bb fe d d b db f DBG FNDG Creating chan barrier for ChanID f d f fc e f f f c ae ad b a d INF FNDG sending FundingSigned for pendingID e cc defb e caa c ff f b da fa fe d ecdd e over ChannelPoint ecd ed fa eb deb a f bb fe d d b db f INF CNCT Creating new ChannelArbitrator for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f DBG CNCT New ChainEventSubscriptionid for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f INF NTFN New block epoch subscription DBG CNCT Starting ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f htlcsetmap contractcourtHtlcSetKey contractcourthtlcSet len contractcourtHtlcSetKey LocalHtlcSet contractcourthtlcSet incomingHTLCs map uint channeldbHTLC outgoingHTLCs map uint channeldbHTLC contractcourtHtlcSetKey RemoteHtlcSet contractcourthtlcSet incomingHTLCs map uint channeldbHTLC outgoingHTLCs map uint channeldbHTLC INF CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f starting stateStateDefault DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f new block height examining active HTLCs DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f checking chain actions at height DBG CNCT Starting chain watcher for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f new block height examining active HTLCs DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f checking chain actions at height INF NTFN New spend subscription spendid outpoint ecd ed fa eb deb a f bb fe d d b db f script e dbe fcc d a ac b ac aa ad bf a be ecbda efc aa heighthint INF NTFN Dispatching historical spend rescan for outpoint ecd ed fa eb deb a f bb fe d d b db f script e dbe fcc d a ac b ac aa ad bf a be ecbda efc aa start end INF NTFN New block epoch subscription INF CNCT Close observer for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f active INF NTFN New confirmation subscription confid txid ecd ed fa eb deb a f bb fe d d b db f numconfs heighthint INF FNDG Waiting for funding tx ecd ed fa eb deb a f bb fe d d b db f to reach confirmations INF NTFN Historical spend dispatch finishedfor request outpoint ecd ed fa eb deb a f bb fe d d b db f script e dbe fcc d a ac b ac aa ad bf a be ecbda efc aa start end with details nil INF CRTR Pruning channel graph using block d f e f b ef c d b f b height INF CRTR Block d f e f b ef c d b f b height closed channels INF NTFN New block height sha d f e f b ef c d b f b DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f new block height examining active HTLCs DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f checking chain actions at height DBG FNDG Received FundingLocked for ChannelID f d f fc e f f f c ae ad b a d from peer deadbeefbadbabedec def d INF CRTR Pruning channel graph using block ee a b a bc bdba dabc f height INF CRTR Block ee a b a bc bdba dabc f height closed channels INF NTFN New block height sha ee a b a bc bdba dabc f DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f new block height examining active HTLCs DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f checking chain actions at height INF PEER unable to read message from deadbeefbadbabedec def dTHEIRIP EOF INF PEER Disconnecting deadbeefbadbabedec def dTHEIRIP reason read handler closed DBG FNDG Cancelling all reservations for peer deadbeefbadbabedec def d DBG FNDG No active reservations for node deadbeefbadbabedec def d INF DISC Removing GossipSyncer for peer deadbeefbadbabedec def d ERR SRVR Unable to retrieve advertised address for node deadbeefbadbabedec def d unable to find node ERR BTCN Cant accept connection unable to accept connection from THEIRIP read tcp MYIP THEIRIP io timeout INF CRTR Processed channels updates nodes in last s INF SRVR New inbound connection from THEIRIP INF SRVR Finalizing connection to deadbeefbadbabedec def dTHEIRIP inboundtrue INF PEER NodeKey deadbeefbadbabedec def d loading ChannelPoint ecd ed fa eb deb a f bb fe d d b db f WRN PEER Unable to find our forwarding policy for channel ecd ed fa eb deb a f bb fe d d b db f using default values DBG CNCT New ChainEventSubscriptionid for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f INF HSWC Removing channel link with ChannelID f d f fc e f f f c ae ad b a d INF HSWC ChannelLink ecd ed fa eb deb a f bb fe d d b db f is starting INF HSWC Adding pending link chanid f d f fc e f f f c ae ad b a d shortchanid INF SRVR Negotiated chan series queries with deadbeefbadbabedec def d INF DISC Creating new GossipSyncer for peer deadbeefbadbabedec def d INF HSWC HTLC manager for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f started bandwidth mSAT INF HSWC Attempting to reresynchronize ChannelPoint ecd ed fa eb deb a f bb fe d d b db f INF HSWC Received reestablishment message from remote side for channel ecd ed fa eb deb a f bb fe d d b db f DBG FNDG Received FundingLocked for ChannelID f d f fc e f f f c ae ad b a d from peer deadbeefbadbabedec def d INF FNDG Already handling fundingLocked for ChannelID f d f fc e f f f c ae ad b a d ignoring INF CRTR Block c faeb b e a e a ccacbc d ad b b height closed channels INF NTFN New block height sha c faeb b e a e a ccacbc d ad b b INF NTFN Dispatching confirmation notification for txid ecd ed fa eb deb a f bb fe d d b db f DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f new block height examining active HTLCs INF HSWC Garbage collected shared secret hashes at height INF FNDG ChannelPoint ecd ed fa eb deb a f bb fe d d b db f is now active ChannelID a fe d f cba b b d dbeff daf d a d e f d c f a cbcfb eca ccbaa ebf a cee DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f checking chain actions at height DBG FNDG ChannelID f d f fc e f f f c ae ad b a d is now fully confirmed shortChanID INF NTFN Cancelling epoch notification epochid ERR LTND Unable to lookup witness no witnesses ERR LTND Unable to lookup witness no witnesses ERR LTND Unable to lookup witness no witnesses INF HSWC ChannelLink Updating to shortchanid for chanid f d f fc e f f f c ae ad b a d INF HSWC Updated shortchanid for ChannelLink f d f fc e f f f c ae ad b a d old new INF CNCT Attempting to update ContractSignals for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f DBG FNDG Channel f d f fc e f f f c ae ad b a d with ShortChanID has opening state INF FNDG Peer deadbeefbadbabedec def d is online sending FundingLocked for ChannelID f d f fc e f f f c ae ad b a d DBG FNDG Channel f d f fc e f f f c ae ad b a d with ShortChanID successfully sent FundingLocked DBG FNDG Channel f d f fc e f f f c ae ad b a d with ShortChanID has opening state INF CHBU Updating ondisk multi SCB backup numoldchans numnewchans INF CHBU Updating backup file at lnddatachainbitcoinmainnetchannelbackup INF CHBU Swapping old multi backup file from lnddatachainbitcoinmainnettempdontusebackup to lnddatachainbitcoinmainnetchannelbackup INF CHBU Updating backup file at lnddatachainbitcoinmainnetchannelbackup INF CHBU Swapping old multi backup file from lnddatachainbitcoinmainnettempdontusebackup to lnddatachainbitcoinmainnetchannelbackup TRC FNDG Closing chan barrier for ChanID f d f fc e f f f c ae ad b a d DBG FNDG Channel f d f fc e f f f c ae ad b a d with ShortChanID successfully added to router graph DBG FNDG Channel f d f fc e f f f c ae ad b a d with ShortChanID has opening state DBG FNDG Will not announce private channel DBG FNDG Sending our NodeAnnouncement for ChannelID f d f fc e f f f c ae ad b a d to deadbeefbadbabedec def d DBG FNDG Channel f d f fc e f f f c ae ad b a d with ShortChanID successfully announced DBG FNDG ChannlPoint ecd ed fa eb deb a f bb fe d d b db f with chanID not found in opening database assuming already announced to the network INF PEER unable to read message from deadbeefbadbabedec def dTHEIRIP EOF INF PEER Disconnecting deadbeefbadbabedec def dTHEIRIP reason read handler closed DBG FNDG Cancelling all reservations for peer deadbeefbadbabedec def d DBG FNDG No active reservations for node deadbeefbadbabedec def d INF DISC Removing GossipSyncer for peer deadbeefbadbabedec def d INF HSWC Removing channel link with ChannelID f d f fc e f f f c ae ad b a d INF HSWC ChannelLink ecd ed fa eb deb a f bb fe d d b db f is stopping INF HSWC ChannelLink ecd ed fa eb deb a f bb fe d d b db f has exited ERR SRVR Unable to retrieve advertised address for node deadbeefbadbabedec def d no advertised addresses found INF SRVR New inbound connection from THEIRIP INF SRVR Finalizing connection to deadbeefbadbabedec def dTHEIRIP inboundtrue INF PEER NodeKey deadbeefbadbabedec def d loading ChannelPoint ecd ed fa eb deb a f bb fe d d b db f DBG CNCT New ChainEventSubscriptionid for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f INF HSWC Removing channel link with ChannelID f d f fc e f f f c ae ad b a d INF HSWC ChannelLink ecd ed fa eb deb a f bb fe d d b db f is starting INF HSWC Trimming open circuits for chanid starthtlcid INF HSWC Adding live link chanid f d f fc e f f f c ae ad b a d shortchanid INF CNCT Attempting to update ContractSignals for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f INF HSWC HTLC manager for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f started bandwidth mSAT INF HSWC Attempting to reresynchronize ChannelPoint ecd ed fa eb deb a f bb fe d d b db f INF SRVR Negotiated chan series queries with deadbeefbadbabedec def d INF DISC Creating new GossipSyncer for peer deadbeefbadbabedec def d INF HSWC Received reestablishment message from remote side for channel ecd ed fa eb deb a f bb fe d d b db f seconds later payment going through INF NTFN New block height sha f c e e ce fc ea cd b fe e bbb DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f new block height examining active HTLCs DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f checking chain actions at height INF CRTR Processed channels updates nodes in last s INF PEER unable to read message from deadbeefbadbabedec def dTHEIRIP read tcp MYIP THEIRIP read connection reset by peer INF PEER Disconnecting deadbeefbadbabedec def dTHEIRIP reason read handler closed DBG FNDG Cancelling all reservations for peer deadbeefbadbabedec def d DBG FNDG No active reservations for node deadbeefbadbabedec def d INF DISC Removing GossipSyncer for peer deadbeefbadbabedec def d INF HSWC Removing channel link with ChannelID f d f fc e f f f c ae ad b a d INF HSWC ChannelLink ecd ed fa eb deb a f bb fe d d b db f is stopping INF HSWC ChannelLink ecd ed fa eb deb a f bb fe d d b db f has exited ERR SRVR Unable to retrieve advertised address for node deadbeefbadbabedec def d no advertised addresses found INF SRVR New inbound connection from THEIRIP INF SRVR Finalizing connection to deadbeefbadbabedec def dTHEIRIP inboundtrue INF PEER NodeKey deadbeefbadbabedec def d loading ChannelPoint ecd ed fa eb deb a f bb fe d d b db f DBG CNCT New ChainEventSubscriptionid for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f INF HSWC Removing channel link with ChannelID f d f fc e f f f c ae ad b a d INF HSWC ChannelLink ecd ed fa eb deb a f bb fe d d b db f is starting INF HSWC Trimming open circuits for chanid starthtlcid INF HSWC Adding live link chanid f d f fc e f f f c ae ad b a d shortchanid INF SRVR Negotiated chan series queries with deadbeefbadbabedec def d INF DISC Creating new GossipSyncer for peer deadbeefbadbabedec def d INF HSWC HTLC manager for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f started bandwidth mSAT INF HSWC Attempting to reresynchronize ChannelPoint ecd ed fa eb deb a f bb fe d d b db f INF CNCT Attempting to update ContractSignals for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f INF HSWC Received reestablishment message from remote side for channel ecd ed fa eb deb a f bb fe d d b db f INF PEER unable to read message from deadbeefbadbabedec def dTHEIRIP EOF INF PEER Disconnecting deadbeefbadbabedec def dTHEIRIP reason read handler closed DBG FNDG Cancelling all reservations for peer deadbeefbadbabedec def d DBG FNDG No active reservations for node deadbeefbadbabedec def d INF DISC Removing GossipSyncer for peer deadbeefbadbabedec def d INF HSWC Removing channel link with ChannelID f d f fc e f f f c ae ad b a d INF HSWC ChannelLink ecd ed fa eb deb a f bb fe d d b db f is stopping INF HSWC ChannelLink ecd ed fa eb deb a f bb fe d d b db f has exited ERR SRVR Unable to retrieve advertised address for node deadbeefbadbabedec def d no advertised addresses found INF SRVR New inbound connection from THEIRIP INF SRVR Finalizing connection to deadbeefbadbabedec def dTHEIRIP inboundtrue INF PEER NodeKey deadbeefbadbabedec def d loading ChannelPoint ecd ed fa eb deb a f bb fe d d b db f DBG CNCT New ChainEventSubscriptionid for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f INF HSWC Removing channel link with ChannelID f d f fc e f f f c ae ad b a d INF HSWC ChannelLink ecd ed fa eb deb a f bb fe d d b db f is starting INF HSWC Trimming open circuits for chanid starthtlcid INF HSWC Adding live link chanid f d f fc e f f f c ae ad b a d shortchanid INF CNCT Attempting to update ContractSignals for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f INF HSWC HTLC manager for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f started bandwidth mSAT INF HSWC Attempting to reresynchronize ChannelPoint ecd ed fa eb deb a f bb fe d d b db f INF SRVR Negotiated chan series queries with deadbeefbadbabedec def d INF DISC Creating new GossipSyncer for peer deadbeefbadbabedec def d INF HSWC Received reestablishment message from remote side for channel ecd ed fa eb deb a f bb fe d d b db f INF PEER unable to read message from deadbeefbadbabedec def dTHEIRIP EOF INF PEER Disconnecting deadbeefbadbabedec def dTHEIRIP reason read handler closed DBG FNDG Cancelling all reservations for peer deadbeefbadbabedec def d DBG FNDG No active reservations for node deadbeefbadbabedec def d INF DISC Removing GossipSyncer for peer deadbeefbadbabedec def d INF HSWC Removing channel link with ChannelID f d f fc e f f f c ae ad b a d INF HSWC ChannelLink ecd ed fa eb deb a f bb fe d d b db f is stopping INF HSWC ChannelLink ecd ed fa eb deb a f bb fe d d b db f has exited ERR SRVR Unable to retrieve advertised address for node deadbeefbadbabedec def d no advertised addresses found INF SRVR New inbound connection from THEIRIP INF SRVR Finalizing connection to deadbeefbadbabedec def dTHEIRIP inboundtrue INF PEER NodeKey deadbeefbadbabedec def d loading ChannelPoint ecd ed fa eb deb a f bb fe d d b db f DBG CNCT New ChainEventSubscriptionid for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f INF HSWC Removing channel link with ChannelID f d f fc e f f f c ae ad b a d INF HSWC ChannelLink ecd ed fa eb deb a f bb fe d d b db f is starting lnd logs after the restart INF LTND Active chain Bitcoin networkmainnet INF CHDB Checking for schema update latestversion dbversion INF RPCS password RPC server listening on INF RPCS password gRPC proxy started at INF LTND Waiting for wallet encryption password Use lncli create to create a wallet lncli unlock to unlock an existing wallet or lncli changepassword to change the password of an existing wallet and unlock it INF LNWL Opened wallet INF LTND Primary chain is set to bitcoin INF LTND Initializing bitcoind backed fee estimator INF LNWL Started listening for bitcoind transaction notifications via ZMQ on INF LNWL Started listening for bitcoind block notifications via ZMQ on INF LNWL The wallet has been unlocked without a time limit INF LTND LightningWallet opened INF HSWC Restoring inmemory circuit state from disk INF HSWC Payment circuits loaded numpending numopen DBG CNCT New ChainEventSubscriptionid for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f INF NTFN New block epoch subscription DBG CNCT Starting chain watcher for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f INF NTFN New spend subscription spendid outpoint ecd ed fa eb deb a f bb fe d d b db f script e dbe fcc d a ac b ac aa ad bf a be ecbda efc aa heighthint INF NTFN Dispatching historical spend rescan for outpoint ecd ed fa eb deb a f bb fe d d b db f script e dbe fcc d a ac b ac aa ad bf a be ecbda efc aa start end INF CNCT Close observer for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f active DBG CNCT Starting ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f htlcsetmap contractcourtHtlcSetKey contractcourthtlcSet len contractcourtHtlcSetKey LocalHtlcSet contractcourthtlcSet incomingHTLCs map uint channeldbHTLC outgoingHTLCs map uint channeldbHTLC contractcourtHtlcSetKey RemoteHtlcSet contractcourthtlcSet incomingHTLCs map uint channeldbHTLC outgoingHTLCs map uint channeldbHTLC INF CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f starting stateStateDefault DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f new block height examining active HTLCs DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f checking chain actions at height DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f new block height examining active HTLCs DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f checking chain actions at height contractcourtHtlcSetKey LocalHtlcSet contractcourthtlcSet incomingHTLCs map uint channeldbHTLC outgoingHTLCs map uint channeldbHTLC contractcourtHtlcSetKey RemoteHtlcSet contractcourthtlcSet incomingHTLCs map uint channeldbHTLC outgoingHTLCs map uint channeldbHTLC INF DISC Authenticated Gossiper is starting INF BRAR Starting contract observer watching for breaches INF NTFN New block epoch subscription INF CRTR FilteredChainView starting INF CRTR Filtering chain using channels active INF CRTR Prune tip for Channel Graph height hash fa ababba bd de d e f bdfb bb e INF CRTR Syncing channel graph from height hash fa ababba bd de d e f bdfb bb e to height hash ae b e de e f c b f ae INF CRTR Graph pruning complete channels were closed since height TRC FNDG Funding manager running INF DISC Retransmitting outgoing channels TRC FNDG Loading pending ChannelPoint ecd ed fa eb deb a f bb fe d d b db f creating chan barrier INF NTFN New block epoch subscription INF NTFN New confirmation subscription confid txid ecd ed fa eb deb a f bb fe d d b db f numconfs heighthint INF FNDG Waiting for funding tx ecd ed fa eb deb a f bb fe d d b db f to reach confirmations INF NTFN Dispatching confirmation notification for txid ecd ed fa eb deb a f bb fe d d b db f INF FNDG ChannelPoint ecd ed fa eb deb a f bb fe d d b db f is now active ChannelID a fe d f cba b b d dbeff daf d a d e f d c f a cbcfb eca ccbaa ebf a cee DBG FNDG ChannelID f d f fc e f f f c ae ad b a d is now fully confirmed shortChanID INF NTFN Cancelling epoch notification epochid ERR FNDG unable to report short chan id link f d f fc e f f f c ae ad b a d not found DBG FNDG Channel f d f fc e f f f c ae ad b a d with ShortChanID has opening state INF CHBU Starting chanbackupSubSwapper INF BTCN Server listening on INF SRVR New inbound connection from THEIRIP INF SRVR Finalizing connection to deadbeefbadbabedec def dTHEIRIP inboundtrue INF PEER NodeKey deadbeefbadbabedec def d loading ChannelPoint ecd ed fa eb deb a f bb fe d d b db f DBG CNCT New ChainEventSubscriptionid for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f INF HSWC Removing channel link with ChannelID f d f fc e f f f c ae ad b a d INF HSWC ChannelLink ecd ed fa eb deb a f bb fe d d b db f is starting INF HSWC Trimming open circuits for chanid starthtlcid INF CNCT Attempting to update ContractSignals for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f INF HSWC Adding live link chanid f d f fc e f f f c ae ad b a d shortchanid INF HSWC ChannelLink e ae b bc bea db a c d fe bd beda e f is starting INF FNDG Peer deadbeefbadbabedec def d is online sending FundingLocked for ChannelID f d f fc e f f f c ae ad b a d INF HSWC HTLC manager for ChannelPoint ecd ed fa eb deb a f bb fe d d b db f started bandwidth mSAT INF HSWC Attempting to reresynchronize ChannelPoint ecd ed fa eb deb a f bb fe d d b db f INF SRVR Negotiated chan series queries with deadbeefbadbabedec def d INF DISC Creating new GossipSyncer for peer deadbeefbadbabedec def d DBG FNDG Channel f d f fc e f f f c ae ad b a d with ShortChanID successfully sent FundingLocked DBG FNDG Channel f d f fc e f f f c ae ad b a d with ShortChanID has opening state INF HSWC Received reestablishment message from remote side for channel ecd ed fa eb deb a f bb fe d d b db f DBG FNDG Channel f d f fc e f f f c ae ad b a d with ShortChanID successfully added to router graph DBG FNDG Channel f d f fc e f f f c ae ad b a d with ShortChanID has opening state DBG FNDG Will not announce private channel DBG FNDG Sending our NodeAnnouncement for ChannelID f d f fc e f f f c ae ad b a d to deadbeefbadbabedec def d DBG FNDG Channel f d f fc e f f f c ae ad b a d with ShortChanID successfully announced DBG FNDG ChannlPoint ecd ed fa eb deb a f bb fe d d b db f with chanID not found in opening database assuming already announced to the network DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f new block height examining active HTLCs DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f checking chain actions at height DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f new block height examining active HTLCs DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f checking chain actions at height DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f new block height examining active HTLCs DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f checking chain actions at height INF PEER unable to read message from deadbeefbadbabedec def dTHEIRIP read tcp MYIP THEIRIP read connection reset by peer INF PEER Disconnecting deadbeefbadbabedec def dTHEIRIP reason read handler closed DBG FNDG Cancelling all reservations for peer deadbeefbadbabedec def d DBG FNDG No active reservations for node deadbeefbadbabedec def d INF DISC Removing GossipSyncer for peer deadbeefbadbabedec def d INF HSWC Removing channel link with ChannelID f d f fc e f f f c ae ad b a d INF HSWC ChannelLink ecd ed fa eb deb a f bb fe d d b db f is stopping INF HSWC ChannelLink ecd ed fa eb deb a f bb fe d d b db f has exited INF CRTR Pruning channel graph using block c d fb c c d a b ae c height INF CRTR Block c d fb c c d a b ae c height closed channels INF NTFN New block height sha c d fb c c d a b ae c DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f new block height examining active HTLCs DBG CNCT ChannelArbitrator ecd ed fa eb deb a f bb fe d d b db f checking chain actions at height Expected behaviour Channel should have been marked as active and shown on the listchannels command Actual behaviour Channel wasnt marked as active It wasnt showing on the listchannels Yet it forwarded payments while in seemingly pending state The QueryRoutesRequest parameter lasthoppubkey introduced in does not match the name pattern used for other parameters pubkey and sourcepubkey If possible rename to lasthoppubkey Long term wed like to support use cases such as that allow more secure signing within lnd itself As is today we have the interfaces in the keychain package as well as the Signer which already abstract away things like key derivation and signing However in several areas we use this method to obtain a raw private key for direct manipulation This is clearly incompatible with something like a hardware wallet which aims to protect against all types of key exfiltration Therefore to support more secure signing we need to remove all usages of that method reducing the number of total method in the SecretKeyRing interface to one For more details wrt our longterm plan to support more secure signing please see this post on the lnddev mailing list Well need to remove raw private key handling from the following areas Steps To Completion The brontide handshake Currently we pass the entire private key into the brontide state machine However it can get by with simply being able to perform an ECDH against our longtern static identity key From there on it can carry out the remainder of the handshake using this resulting state as well as the ephemeral key it generates for the handshake The current SecretKeyChain interface already has a ScalarMult method which is meant to be used for ECDH so we have that base covered already The watch towers brontide handshake Same thing as the above just uses a distinct key for any created watch towers SCB blob encryptiondecryption When creating the SCB format we didnt want to require that some future external singing abstraction had to be aware of the encryption scheme we used As a result we ended up obtaining the raw private key and using that directly for encryptiondecryption Instead we can start to use the ECDH method from the SecretKeyRing interface to obtain a new shared secret which is then used directly We can bump the SCB version the Multi specifically to handle the transition from the old to the new format Since we started to phase out our usage of the GossipTimestamp field propagation of new channel updates and especially node announcements has suffered Before the change a node upon connection would receive all the prior updates within the last hours or so When nodes connect now they only typically receive updates of channels and node announcements related to new channels created since they were offline Theres an extension to the current extended gossip query feature planned to addresses this namely being able to query for node announcement s independent of any channels However we can implement something much simpler thatll address the core issue until that has been widely rolled out in the network At a high level this issue proposes that we keep a cache of any sort of announcements that we recently generated and send all new connected peers that cache independent of any other items that we queried This serves to ensure that we send all nodes our current updates for propagation without overhelhimg them with all the other updates not related to our node Steps to Completion Everytime we send the gossiper a new set of ChannelUpdates to query for we should add the updates to a new set that never shrinks Similarly we should also had a set of any new NodeAnnouncements as well Upon start up when we update our on disk node announcement with the latest details pulled from the configuration we should also send this to the gossiper to add to its cache Each time a new peer connections we should send it all the items in the cache Fixes With this PR we crank down the scrypt options used by the btcwallet to speed up unit tests especially when running with the race detector Results on my machine before the change run with go clean testcache go test keychain race go test walletunlocker race ok githubcomlightningnetworklndkeychain s ok githubcomlightningnetworklndwalletunlocker s After the change ok githubcomlightningnetworklndkeychain s ok githubcomlightningnetworklndwalletunlocker s If the provided ChainHash in a QueryChannelRange message does not match that of our current chain then we should send a blank response rather than reply with channels for the wrong chain Fixes This PR modifies the aezeed macaroons and lnwalletbtcwallet packages to use fast scrypt options when compiled with the itest build tag to speed up the node creationstartup in the integration tests Background I opened two channels a few days ago then I closed them normally via the cli using closechannel Both of them are stuck in pendingforceclosingchannels but I did not force close them Unfortunately now all my btc is stuck This is for mainnet pendingforceclosingchannels channel remotenodepub e a babec abdc c afbe e e d b c fd ff e fdb b channelpoint dd b fee d e cba b d c d cf capacity localbalance remotebalance localchanreservesat remotechanreservesat closingtxid d b fbd a d f da a dfccb cb a b cd dd limbobalance maturityheight blockstilmaturity recoveredbalance pendinghtlcs channel remotenodepub ad fb d dc e bcedefadf f a ae dc f c b c c f b a b channelpoint d d d e cab e c dcc b c e cfcf fe a capacity localbalance remotebalance localchanreservesat remotechanreservesat closingtxid e de e eb f a d f be b aae ecbc bcb c e limbobalance maturityheight blockstilmaturity recoveredbalance pendinghtlcs incoming false amount outpoint e f ce b af d e be ace c b e ab d maturityheight blockstilmaturity stage Your environment lnd version Version beta commitv betarc buildproduction loggingdefault OSLinux el x SMP Tue May UTC x x x GNULinux CentOS bitcoind Steps to reproduce Open a channel Run closechannel Expected behaviour Channel should close normally Actual behaviour Channels got stuck in this pendingforceclosingchannels state Log files Here is the log file when I start the lnd node with debuglevelLNWLtraceCNCTtraceFNDGtraceUTXNtrace lndlog Background If you send a QueryChannelRange message to an LND node with an incorrect or arbitrary chainhash the LND reply does not appear to respect the requested chainhash resulting in invalid data in the reply The ReplyChannelRange message includes shortchannelid information that belongs to the chain that the LND node is executing under instead of one requested in the query message It also sends a completion flag of x that indicates that the message was correctly handled and all information has been sent The specification states that it should return a completion flag of x when the chainhash is not supported by the existing node This is not an issue with replies to QueryShortChannelIds It looks like the GossipSyncer code found in replyShortChanIDs has a chainhash guard I would expect a similar guard to be in the the replyChanRangeQuery method Your environment lnd version beta commitqueuev g f c fadbc a c cb a macOS Steps to reproduce This was part of testing for a project Im working on that was sending gossip traffic to lightning nodes Im not sure of the best way to sendreceive raw message using the LND code base Probably easiest with a unit test on GossipSyncer The message traffic looked like querychannelrange sent to LND df e type arbitrary chainhash df firstblocknum e numberofblocks replychannelrange received from LND df e e c type arbitrary chainhash df firstblocknum e numberofblocks completed true bytes encoding raw e c shortchannelid x x Expected behaviour Expected a reply with x completion flag and no shortchannelids Actual behaviour Message above with invalid data from data from Bitcoin testnet instead of the arbitrary chainhash 