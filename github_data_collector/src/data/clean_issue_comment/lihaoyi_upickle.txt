I have a Visitor that prevents further writes after a single value eg okay but not okay In this case writing the to the root visitor instead of the array visitor prematurely triggers a close on the underlying resource The encoding for Left is regardless since the ctxvisitValue call is correct but the EitherWriter was sending the visitFloat StringParts to the wrong place which causes problems if visiting the root prevents further calls Found during I found a cornercase correctness issue when feeding mutable CharSequences into the generated macros Input of s as b type upickleHierarchyC fails in this scenario Macro ends up with values of StrupickleHierarchyC for s and s Freezing Str to CharSequencetoString resolves the issue Wed also need StringVisitor to freeze to a String since its used by the macro for parsing the value of type AFAIK the ujson parsers only emit javalangString anyway so I expect the cost should be negligible As long as thats true its only an issue for extensibility outside the library This is not exactly a bug it is kind of a feature request If I create an alias of a type and proceed to create a ReadWriter to the alias the program compiles but fails on with scalaMatchError on runtime while serializing an object of the aliased type In my use case it the problematic type was used in a case class with an default value so it would only fail in the rare cases where the default value was not used Bellow is the simplest reproduction of the problem I could manage to create import upickledefaultReadWriter Writer macroRW write import scalautilTry object Example type Problem List Int final case class Ax Problem List extends AnyVal implicit val ARw ReadWriter A macroRW implicit val XRw ReadWriter Problem macroRW Not needed and if commented out solves the MatchError def mainargs Array String def serialize T data Timplicit writer Writer T String writedata printlnA OK printlnAList OK printlnTryserializeAList scalaMatchError printlnTryserializeList asInstanceOf Problem scalaMatchError Using comlihaoyi ujson val json ujsonreadfoo yields javalangNumberFormatException at ujsonutilUtilparseLongUtilscala at ujsonutilUtilparseIntegralNumUtilscala at ujsonJsvisitNumJsscala at ujsonJsvisitNumJsscala at ujsonParserparseNumParserscala at ujsonParserrparseParserscala at ujsonParserparseParserscala at ujsonParserparseParserscala at ujsonSyncParserparseSyncParserscala at ujsonStringParsertransformStringParserscala at ujsonStringParsertransformStringParserscala at ujsonTransformablefromTransformertransformTransformablescala at ujsonpackagetransformpackagescala at ujsonpackagereadpackagescala 