I notices in ngxhttpupsynceventinit detele event will delay NGXDELAYDELETE msec In addtion add some tcp connection check logic but not every tcp connection was checked so it may cause some tcp connects still use old peer info this while loop will be cause nginx crash ngxeventconnectpeer pcpcentry x fcc ff b at srceventngxeventconnectc warning Source file is more recent than executable s ngxsocketpcsockaddrsafamily type gdb bt ngxeventconnectpeer pcpcentry x fcc ff b at srceventngxeventconnectc x fc ab fb in ngxhttpupstreamconnect r x fcb f u x fcc ff a at srchttpngxhttpupstreamc x fc ab ec in ngxhttpupstreaminitrequest r x fcb f at srchttpngxhttpupstreamc x fc aa a in ngxhttpreadclientrequestbody rrentry x fcb f posthandler x fc ab ngxhttpupstreaminit at srchttpngxhttprequestbodyc x fc aea in ngxhttpproxyhandler r x fcb f at srchttpmodulesngxhttpproxymodulec x fc a c in ngxhttpcorecontentphase r x fcb f phoptimized out at srchttpngxhttpcoremodulec x fc a cd in ngxhttpcorerunphases r x fcb f at srchttpngxhttpcoremodulec x fc a d in ngxhttprunpostedrequests c x ff beff f at srchttpngxhttprequestc x fc a b c in ngxepollprocessevents cycle x fc dc timeroptimized out flagsoptimized out at srceventmodulesngxepollmodulec x fc a b a in ngxprocesseventsandtimers cyclecycleentry x fc dc at srceventngxeventc x fc a in ngxworkerprocesscycle cyclecycleentry x fc dc datadataentry x at srcosunixngxprocesscyclec x fc a ed f in ngxspawnprocess cyclecycleentry x fc dc procprocentry x fc a ngxworkerprocesscycle datadataentry x namenameentry x fc b b worker process respawnrespawnentry at srcosunixngxprocessc x fc a in ngxstartworkerprocesses cyclecycleentry x fc dc n typetypeentry at srcosunixngxprocesscyclec x fc a in ngxmasterprocesscycle cycle x fc dc at srcosunixngxprocesscyclec x fc a in main argcoptimized out argvoptimized out at srccorenginxc openresty etcd upstream ip openresty ip upstream ip ip ip ip ip HTTP OK Server openresty Date Thu Dec GMT ContentType textplain ContentLength Connection keepalive Upstream name exam Backend server count server weight maxfails failtimeout s Upstream name idmservice Backend server count Upstream name idrservice Backend server count server weight maxfails failtimeout s Upstream name demo Backend server count server weight maxfails failtimeout s server weight maxfails failtimeout s Upstream name questionnaire Backend server count server weight maxfails failtimeout s server weight maxfails failtimeout s Upstream name training Backend server count server weight maxfails failtimeout s Upstream name upmservice Backend server count server weight maxfails failtimeout s upstream consul key strongdependencyoff nginx reload upstreamshow nginx reload upstreamshow server nginx reload nginx reload server server upstream idmservice server upsync consuldev haohrcom v kvupstreamsidmservice upsynctimeout m upsyncinterval ms upsynctypeconsul strongdependencyoff upsyncdumppath etcnginxupstreamsdumpidmserviceconf include etcnginxupstreamsdumpidmserviceconf nginx s reload x a in ngxwritefd n buf x ffc c d fderror reading variable Cannot access memory at address x at srcosunixngxfilesh ngxlogerrorcore level log x fd erroptimized out fmtoptimized out at srccorengxlogc x e in ngxeventdeltimer evoptimized out at srceventngxeventtimerh ngxhttpupsyncclearallevents cycle x ffc c d at homeyuanqingopenrestyopenresty bundlenginxupsyncmodulesrcngxhttpupsyncmodulec x a in ngxhttpupsyncneedexit at homeyuanqingopenrestyopenresty bundlenginxupsyncmodulesrcngxhttpupsyncmodulec x b in ngxhttpupsyncrecvhandler event x at homeyuanqingopenrestyopenresty bundlenginxupsyncmodulesrcngxhttpupsyncmodulec x d in ngxcloseidleconnections cyclecycleentry x cac at srccorengxconnectionc x b in ngxworkerprocesscycle cyclecycleentry x cac datadataentry x at srcosunixngxprocesscyclec x e in ngxspawnprocess cyclecycleentry x cac procprocentry x b ngxworkerprocesscycle datadataentry x namenameentry x cbd worker process respawnrespawnentry at srcosunixngxprocessc x b in ngxstartworkerprocesses cycle x cac n type at srcosunixngxprocesscyclec x c in ngxmasterprocesscycle cycle x cac at srcosunixngxprocesscyclec x in main argcoptimized out argvoptimized out at srccorenginxc centos openresty openresty nginxupstreamcheckmodule check patch check patch check patch cd openresty bundlenginx patch p nginxupstreamcheckmodulecheck patch configure withhttpsslmodule withhttprealipmodule withhttpadditionmodule withhttpsubmodule withhttpgzipstaticmodule withhttprandomindexmodule withhttpsecurelinkmodule withhttpstubstatusmodule withldoptLusrlocallib withccoptLusrlocalinclude addmodulenginxmodulevts addmodulenginxupstreamcheckmodule addmodulenginxupsyncmodule nginx nginx nginx nginx upstream iphash upstream backendxxxxxx upsync xxxxxxetcdxxxxxxorg v keysxxxxxxxxxconfigupstreambackendxxxxxx upsynctimeout m upsyncinterval ms upsynctypeetcd strongdependencyoff upsyncdumppath optxxxxxxupsyncupstreambackendxxxxxxconf upsynclb iphash include optxxxxxxupsyncupstreambackendxxxxxxconf error WARN upsynctimeout timed out reading upsyncserver error WARN upsynctimeout timed out reading upsyncserver error WARN upsynctimeout timed out reading upsyncserver error WARN upsynctimeout timed out reading upsyncserver nginx proxyconnecttimeout s proxysendtimeout s proxyreadtimeout s upstream upsync v kvupstreamsgkidbackendstage upsynctimeout m upsyncinterval ms upsynctypeconsul strongdependencyoff NGINX timeout v upsync consulservices rootalybjfsystestv curl X PUT d id nametestnginxaddress port tags weight maxfails rootalybjfsystestv curl Upstream name testnginx Backend server count server weight maxfails failtimeout s weightabc rootalybjfsystestv curl X PUT d id nametestnginxaddress port tags weightabc error fix Tengine version Tengine nginx built by gcc Red Hat GCC built with OpenSSL g Nov nginxupsyncmodule master segfault error gdb GNU gdb GDB Red Hat Enterprise Linux el Copyright C Free Software Foundation Inc License GPLv GNU GPL version or later This is free software you are free to change and redistribute it There is NO WARRANTY to the extent permitted by law Type show copying and show warranty for details This GDB was configured as x redhatlinuxgnu For bug reporting instructions please see Reading symbols from usrsbinnginxReading symbols from usrlibdebugusrsbinnginxdebugdone done New LWP New LWP Thread debugging using libthreaddb enabled Using host libthreaddb library lib libthreaddbso Core was generated by nginx worker pr Program terminated with signal Segmentation fault ngxhttpupstreamgetpeer rrp x c d b c at srchttpngxhttpupstreamroundrobinc if peerdown Missing separate debuginfos use debuginfoinstall glibc el x jemalloc el x libgcc el x nsssoftoknfreebl el x pcre el x sssdclient el x zlib el x gdb list if rrptried n m continue if peerdown continue if NGXHTTPUPSTREAMCHECK gdb bt ngxhttpupstreamgetpeer rrp x c d b c at srchttpngxhttpupstreamroundrobinc ngxhttpupstreamgetroundrobinpeer pc x c db e data x c d b c at srchttpngxhttpupstreamroundrobinc x ee ca in ngxhttpupstreamgetkeepalivepeer pc x c db e data x c d b at srchttpmodulesngxhttpupstreamkeepalivemodulec x in ngxeventconnectpeer pcpcentry x c db e at srceventngxeventconnectc x ab a in ngxhttpupstreamconnect rrentry x c dbc uuentry x c db d at srchttpngxhttpupstreamc x acb in ngxhttpupstreaminitrequest rrentry x c dbc at srchttpngxhttpupstreamc x ad d in ngxhttpupstreaminit rrentry x c dbc at srchttpngxhttpupstreamc x ff in ngxhttpreadclientrequestbody rrentry x c dbc posthandler x ad ngxhttpupstreaminit at srchttpngxhttprequestbodyc x db in ngxhttpproxyhandler r x c dbc at srchttpmodulesngxhttpproxymodulec x bb in ngxhttpcorecontentphase r x c dbc phoptimized out at srchttpngxhttpcoremodulec x e b in ngxhttpcorerunphases rrentry x c dbc at srchttpngxhttpcoremodulec x e c in ngxhttphandler rrentry x c dbc at srchttpngxhttpcoremodulec x d in ngxhttpprocessrequest rrentry x c dbc at srchttpngxhttprequestc x c b in ngxhttpv runrequest r x c dbc at srchttpv ngxhttpv c x c c in ngxhttpv stateheadercomplete h ch centry x c d a posposentry x c dc f cf Ke t mDF endendentry x c dc f cf Ke t mDF at srchttpv ngxhttpv c x c f e in ngxhttpv stateprocessheader h ch centry x c d a pos x c dc f cf Ke t mDF endendentry x c dc f cf Ke t mDF at srchttpv ngxhttpv c x c cd in ngxhttpv stateheaderblock h c x c d a pos x c dc f cf Ke t mDF end x c dc f cf Ke t mDF at srchttpv ngxhttpv c x c f in ngxhttpv readhandler revreventry x c e d at srchttpv ngxhttpv c x c b c in ngxhttpv idlehandler rev x c e d at srchttpv ngxhttpv c x ff in ngxepollprocessevents cycleoptimized out timeroptimized out flagsoptimized out at srceventmodulesngxepollmodulec x ee in ngxprocesseventsandtimers cyclecycleentry x c bcae at srceventngxeventc x ee in ngxworkerprocesscycle cycle x c bcae dataoptimized out at srcosunixngxprocesscyclec x c bb in ngxspawnprocess cyclecycleentry x c bcae procprocentry x d ngxworkerprocesscycle datadataentry xb namenameentry x b e worker process respawnrespawnentry at srcosunixngxprocessc x f b in ngxstartworkerprocesses cyclecycleentry x c bcae n typetypeentry at srcosunixngxprocesscyclec x ee in ngxmasterprocesscycle cyclecycleentry x c bcae at srcosunixngxprocesscyclec x ae in main argcoptimized out argvoptimized out at srccorenginxc gdb print peer ngxhttpupstreamrrpeert x 