In the training phase the number of predicted RoIs scores is determined by hyperparameters like POSTNMSROISTRAINING Caffe inits layers to or and then they are resized to match the number of predictions eg and This is done in custom layers and I dont have a problem with that At the same time in order to get the loss layers like clsscore bboxpred fc are also resized to match the size while keeping the number of weights the same I dont see how Caffe does it out of the box but I cant find the wrapper for that Could anyone help hello when I compile caffe I get this error srccaffelayersroialignlayercpp error expected initializer before token void ROIAlignLayerDtypeLayerSetUpconst vectorBlobDtype bottom srccaffelayersroialignlayercpp error expected initializer before token void ROIAlignLayerDtypeReshapeconst vectorBlobDtype bottom srccaffelayersroialignlayercpp error expected initializer before token void ROIAlignLayerDtypeForwardcpuconst vectorBlobDtype bottom srccaffelayersroialignlayercpp error expected initializer before token void ROIAlignLayerDtypeBackwardcpuconst vectorBlobDtype top In file included from includecaffeblobhpp from srccaffelayersroialignlayercpp srccaffelayersroialignlayercpp error ROIAlignLayer is not a class template INSTANTIATECLASSROIAlignLayer how to fix it can you give some advises thank you very much Hi I was trying to read the source code of ROIAlignLayercpp and had some difficulties understanding the bilinear interpolation part in your implementation as following for int hidx floorhstart hidx ceilhend hidx height hidx for int widx floorwstart widx ceilwend widx width widx if counter bindex counter nchannels c height hidx width widx bindexcurr counter hidxwidth widx Normalize hidx and widx hidxn staticcastDtype staticcastDtypehidx roistarth roiendh roistarth widxn staticcastDtype staticcastDtypewidx roistartw roiendw roistartw hidxn minmaxhidxn staticcastDtype one widxn minmaxwidxn staticcastDtype one multiplier counter maxzerostaticcastDtype fabsxsmpn widxn maxzerostaticcastDtype fabsysmpn hidxn bisampled smp batchdata bindexcurr counter multiplier counter counter else goto stop widx hidx Suppose if a ROI bins width ranges from to and height ranges from to Then the hstart hend wstart wend And suppose smp Then the loop starts with hidx floor widx floor bisampled is added with the feature map value at multiplying a weight count In the second loop hidx widx bisampled is added with the feature map value at multiplying a bilinear interpolation weight count In the third loop hidx widx bisampled is added with the feature map value at multiplying a bilinear interpolation weight count In the fourth loop hidx widx bisampled is added with the feature map value at multiplying a bilinear interpolation weight count then it goes to stop function My question is to get the bisampled isnt it to sum up the bilinear interpolation weighted feature map value at and since the upperleft corner of the ROI bin is at Or is there anything I misunderstood Hope you can answer my question Thanks can not find ROIAlignLayer head file Can anyone give a clarification on the intuition of using nolossmask As far as I can tell crossentropy loss expects target jasjeetIM Thanks for your code Do you have any trained models now I would really appreciate it if you can share one trained caffe model Thank you Hi Thanks for your code I readed your roialignlayercpp I am not sure if this code will work when the ROI bin size is larger than x In your code it looked like that you only calculate one valueas maxvalue in each ROI bin I think we should use VALID normalizer for the mask loss so that the objective can be correctly scaled Whats your experience about this jasjeetIM Hi jasjeetIM After adding the roi align layer I replace the roi pooling layer in the trainvalprototxt like the following top conv layer name roialign type ROIAlign bottom conv bottom rois top pool roialignparam pooledw pooledh spatialscale layer name fc Did it right If so did you compare the roi align layer and roi pooling layer in object detection Could it increase the mAP Thanks in advance Hi jasjeetIM I took your ROIAlign layers and integrated them with my pyFasterRCNN to replace ROIPool layers in my code base But I am getting bounding box loss as NAN for all the iterations so far while training FastRCNN stage in alternate training optimization Did you also face any such problem while training Please let me know I shall dig deeper and get back if I find anything worth sharing Following are my sample logs of the loss for your reference I solvercpp Iteration loss nan I solvercpp Train net output lossbbox nan nan loss I solvercpp Train net output losscls loss Thanks