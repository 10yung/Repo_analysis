Reverted simply because it was a mistake in understanding how rdpNla rdpTls instances are managed After digging I found that it is allocated in transportconnectnla and freed by freerdpdisconnect Furthermore I found that the output from ASAN that pointed to this leak was actually caused because the proxy itself didnt close all active connections gracefully And I found a real leak in nlafree it didnt free nlanegoToken in serverc a message is malloced and posted to the queue but if wont be processed a leak will occur when MessageQueueFree will be called new versions of freerdp does not forward smartcard old versions were working fine after remmina update uses libs freerdp and remmina stopped forwarding smart cards currently using daily problem still persists Ubuntu LTS windows xfreerdp uUser vIP smartcard ERROR comwinprtimezone Unable to get current timezone rule INFO comfreerdpgdi Local framebuffer format PIXELFORMATBGRX INFO comfreerdpgdi Remote framebuffer format PIXELFORMATRGB INFO comwinprclipboard initialized POSIX local file subsystem INFO comfreerdpchannelsrdpsndclient Loaded fake backend for rdpsnd INFO comfreerdpchannelsrdpdrclient Loading device service smartcard static INFO comfreerdpchannelsrdpdrclient registered device SCARD type id INFO comfreerdpcore rdpseterrorinfofreerdpsetlasterrorex resetting error state INFO comfreerdpchannelsrdpdrclient registered device SCARD type id INFO comfreerdpchannelsrdpdrclient registered device SCARD type id WARN comfreerdpchannelssmartcardclient IRP was not fully parsed SCardReleaseStartedEvent x Actual Expected Difference WARN comfreerdpchannelssmartcardclient cc cc cc cc WARN comfreerdpchannelssmartcardclient WARN comfreerdpchannelssmartcardclient de e e nI WARN comfreerdpchannelssmartcardclient e f d e b OMNIKE WARN comfreerdpchannelssmartcardclient Y AG Car WARN comfreerdpchannelssmartcardclient d e dMan WARN comfreerdpchannelssmartcardclient WARN comfreerdpchannelssmartcardclient length WARN comfreerdpchannelscliprdrcommon cliprdrpacketformatlistnew called with invalid type pcscscan PCSC device scanner V c Ludovic Rousseau ludovicrousseaufreefr Compiled with PCSC lite version Using reader plugn play mechanism Scanning present readers OMNIKEY AG CardMan Mon Jan Reader OMNIKEY AG CardMan Card state Card inserted ATR B F FE B B A A ATR B F FE B B A A TS B Direct Convention T F Y K historical bytes TA Fi Di cyclesETU bitss at MHz fMax for Fi MHz bitss TD Yi Protocol T TD Yi Protocol T TA FE IFSC TB Block Waiting Integer Character Waiting Integer Historical bytes B B A Category indicator byte compact TLV data object Tag len preissuing data Data B Tag len card service data byte Card service data byte Application selection by full DF name EFDIR and EFATR access services by GET RECORDs command Card with MF Tag len card capabilities Selection methods B DF selection by full DF name DF selection by path DF selection by file identifier Record number supported Record identifier supported Data coding byte A EF of TLV structure supported Behaviour of write functions proprietary Value FF for the first byte of BERTLV tag fields invalid Data unit in quartets Command chaining length fields and logical channels Command chaining Logical channel number assignment No logical channel Maximum number of logical channels TCK A correct checksum Possibly identified card using usrsharepcscsmartcardlisttxt B F FE B B A A AKiS v on infineon chip Implements missing functions for newer smartcard channel behaviour Adds command line option to set client build number When I have a FreeRDP session in focus in xmonad and xscreensaver locks my screen after unlocking the screen my keyboard no longer works neither in the remote session nor locally until I use the mouse to disconnect from the remote session When the FreeRDP window is out of focus and xscreensaver locks the screen this is not a problem OS NixOS xmonad FreeRDP rc xscreensaver xmobar I have been trying unsuccessfully for a few days to get FreeRDP to connect to a Win VM I can get a connection via Rdesktop and Windows remote desktop tool however FreeRDP continues to give the following output ERROR comfreerdpcoretransport BIOshouldretry returned a system error Broken pipe ERROR comfreerdpcorenego Protocol Security Negotiation Failure ERROR comfreerdpcore freerdpsetlasterror ERRCONNECTSECURITYNEGOCONNECTFAILED x C ERROR comfreerdpcoreconnection Error protocol security negotiation or connection failure Our setup Host Ubuntu Server LTS running VirtualBox VMs guest system Windows Pro Client Zero clients using OpenThinClient os pxe booted from Ubuntu server FreeRDP dev aa b as included in OpenThinClient server package On the VM side VirtualBox VMs set up with individual ports for rdp Each instance has static ip being enforced by router to VMs MAC address Windows Pro configured for RDP with admin user and secondary remote login user profile Windows firewall currently disabled during testing RDP connection is over LAN no external access Troubleshooting steps Attempted FreeRDP connection with auto negotiated security as well as manually setting TLS nla and RDP Have disabled nla requirement on windows VM In VirtualBox tried both null and guest options for RDP security Connection attempts have all been made using ip and port no host name Tried connecting with secnla arguments Just to reiterate I can connect with no issues from a windows machine using default RDP client and from OpenThinClient os Rdesktop client Server and VMs are all fresh os installs setup new in the last month I have been using FreeRDP xfreerdp version to authenticatetest an RDP session absolutely fine but with the introduction of TLS it means that I need an updated version of xfreerdp I have installed rc centos from repos and also tried to build other v versions from source all exhibit the same issue The authenticate only option does not work purely on the command line ie no GUI If I run xfreerdp version I get errors about the DISPLAY variable but it shouldnt be trying to open a window just display the version on the command line This would be the same as authonly it shouldnt try to open up a window just open a session to the remote computer login with the supplied credentials then exit out with a goodbad status all on the command line There is also some confusion about the option to use the man page says authonly but I have tried various combinations none of which work Am I doing something wrong or is this a bug Environment cat etccentosrelease CentOS Linux release Core xfreerdp version This is FreeRDP version rc na Command to launch xfreerdp uUser vwinmachine gdnetworks pPassword The new window is launching properly When I try to get a full screen of the window using CtrlAltEnter then the user in the system gets logged off and redirected to the CentOS login page as a new boot All running applications were killed Describe the bug Smartcard redirection doesnt work with Windows for some of our customers and No valid certificates were found on this smart card Please try another smart card or contact your administrator is shown on the server when trying to login using the smartcard It works nicely with Windows This seems to be because of the Smart Card Service start and stop behavior However smartcard redirection works nicely with the official client so there must be something that freerdp does wrongly Ive tried to set REDIRECTEDSMARTCARD flag which is not set by freerdp currently but it seems that it doesnt help unfortunately The freerdp output doesnt contain any errors Any idea what needs to be done to fix this To Reproduce Steps to reproduce the behavior Connect to Windows using nonla plugin rdpsnd plugin rdpdr data scard options They use an old syntax for some reason but it seems that it is correctly translated to nonla and smartcard options Try to use smartcard when logging No valid certificates were found on this smart card Please try another smart card or contact your administrator is shown Application details Tested with rc on RHEL including and It has been tried with several other smartcard fixes from master but without any success Additional context As a workaround net start SCardSvr server task can be called each minute or on some concrete events See Describe the bug Smartcard redirection seems to work properly with however one of our customers see ERROR comfreerdpchannelssmartcardclient SCardListReadersW failed with error in the log every ms anyway when connecting to Windows Any idea what is wrong To Reproduce Steps to reproduce the behavior Connect to Windows using nonla plugin rdpsnd plugin rdpdr data scard options They use an old syntax for some reason but it seems that it is correctly translated to nonla and smartcard options SCardListReadersW failed with error is printed every ms Application details It has been tested on RHEL with rc including It has been tried with several other smartcard fixes from master but without any success