HTTPS serves autoencrypt certificates and so should GRPC Fixes openssl sclient connect localhost CONNECTED depth CN c agntdummytrconsul verify errornum unable to get local issuer certificate verify return depth CN c agntdummytrconsul verify errornum unable to verify the first certificate verify return Certificate chain sCNc agntdummytrconsul iCNprid baiugconsulca b e consul Server certificate BEGIN CERTIFICATE MIICGzCCAcGgAwIBAgIBCTAKBggqhkjOPQQDAjAwMS wLAYDVQQDEyVwcmktZDFi YWl Zy jb zdWwuY EuOTViOGU OTIuY uc VsMB XDTIwMDExNzIyMTc OVoX DTIwMDEyMDIyMTc OVowIjEgMB GA UEAxMXYzEuYWdudC kdW teS ci jb z dWwwWTATBgcqhkjOPQIBBggqhkjOPQMBBwNCAATIyBEoTU LGaJ BC xNyyyYR Na MRfknExzh A HZVIPmG mhjSh IK dtkZFDDJsgaqfc Qx yzNXizBYo HZ MIHWMA GA UdDwEBwQEAwIDuDAdBgNVHSUEFjAUBggrBgEFBQcDAgYIKwYBBQUH AwEwDAYDVR TAQHBAIwADApBgNVHQ EIgQg gFBtgnK NuVwKdAhHNUdcS vTJ jIkBkywaQfJrxEwKwYDVR jBCQwIoAg gFBtgnK NuVwKdAhHNUdcS vTJjIk BkywaQfJrxEwPwYDVR RBDgwNoY c BpZmZlOi vZHVtbXkudHJ c Rkb haW v YWdlbnQvY xpZW L RjL RjMS pZC jMTAKBggqhkjOPQQDAgNIADBFAiBVdHD XYvBNpolk rE wxcfwLQ OtV nLxsPddEqIwIhAPerRVvuWZc TX CgQnj Dyw azs ymmYhTigJ oghhPY Failed locally during an unrelated test run Passed on a subsequent run Failing logs below RUN TestAgentConnectCALeafCertaclDefaultDeny PAUSE TestAgentConnectCALeafCertaclDefaultDeny CONT TestAgentConnectCALeafCertaclDefaultDeny FAIL TestAgentConnectCALeafCertaclDefaultDeny s loggo TestAgentConnectCALeafCertaclDefaultDeny WARN The acldatacenter field is deprecated Use the primarydatacenter field instead loggo TestAgentConnectCALeafCertaclDefaultDeny WARN bootstrap true do not enable unless necessary loggo TestAgentConnectCALeafCertaclDefaultDeny DEBUG tlsutil Update with version loggo TestAgentConnectCALeafCertaclDefaultDeny DEBUG tlsutil OutgoingRPCWrapper with version writergo INFO raft Initial configuration index SuffrageVoter ID a cffc e dca d c a Address writergo INFO raft Node at Follower entering Follower state Leader loggo TestAgentConnectCALeafCertaclDefaultDeny INFO serf EventMemberJoin Node a cffc e dca d c adc writergo WARN raft Heartbeat timeout from reached starting election writergo INFO raft Node at Candidate entering Candidate state in term loggo TestAgentConnectCALeafCertaclDefaultDeny INFO serf EventMemberJoin Node a cffc e dca d c a loggo TestAgentConnectCALeafCertaclDefaultDeny INFO consul Handled memberjoin event for server Node a cffc e dca d c adc in area wan loggo TestAgentConnectCALeafCertaclDefaultDeny INFO consul Adding LAN server Node a cffc e dca d c a Addr tcp DC dc loggo TestAgentConnectCALeafCertaclDefaultDeny INFO agent Started DNS server tcp loggo TestAgentConnectCALeafCertaclDefaultDeny INFO agent Started DNS server udp loggo TestAgentConnectCALeafCertaclDefaultDeny INFO agent Started HTTP server on tcp loggo TestAgentConnectCALeafCertaclDefaultDeny INFO agent started state syncer writergo INFO raft Election won Tally writergo INFO raft Node at Leader entering Leader state loggo TestAgentConnectCALeafCertaclDefaultDeny INFO consul cluster leadership acquired loggo TestAgentConnectCALeafCertaclDefaultDeny INFO consul New leader elected Node a cffc e dca d c a loggo TestAgentConnectCALeafCertaclDefaultDeny INFO acl initializing acls loggo TestAgentConnectCALeafCertaclDefaultDeny INFO acl initializing acls loggo TestAgentConnectCALeafCertaclDefaultDeny INFO consul Created ACL globalmanagement policy loggo TestAgentConnectCALeafCertaclDefaultDeny WARN consul Configuring a nonUUID master token is deprecated loggo TestAgentConnectCALeafCertaclDefaultDeny INFO consul Created ACL globalmanagement policy loggo TestAgentConnectCALeafCertaclDefaultDeny WARN consul Configuring a nonUUID master token is deprecated loggo TestAgentConnectCALeafCertaclDefaultDeny INFO consul Bootstrapped ACL master token from configuration loggo TestAgentConnectCALeafCertaclDefaultDeny INFO consul Bootstrapped ACL master token from configuration loggo TestAgentConnectCALeafCertaclDefaultDeny INFO consul Created ACL anonymous token from configuration loggo TestAgentConnectCALeafCertaclDefaultDeny INFO leader started legacy ACL token upgrade routine loggo TestAgentConnectCALeafCertaclDefaultDeny INFO leader started acl token reaping routine loggo TestAgentConnectCALeafCertaclDefaultDeny DEBUG acl transitioning out of legacy ACL mode loggo TestAgentConnectCALeafCertaclDefaultDeny INFO serf EventMemberUpdate Node a cffc e dca d c a loggo TestAgentConnectCALeafCertaclDefaultDeny INFO serf EventMemberUpdate Node a cffc e dca d c adc loggo TestAgentConnectCALeafCertaclDefaultDeny INFO consul Created ACL anonymous token from configuration loggo TestAgentConnectCALeafCertaclDefaultDeny INFO serf EventMemberUpdate Node a cffc e dca d c a loggo TestAgentConnectCALeafCertaclDefaultDeny INFO serf EventMemberUpdate Node a cffc e dca d c adc loggo TestAgentConnectCALeafCertaclDefaultDeny INFO agent Synced node info loggo TestAgentConnectCALeafCertaclDefaultDeny DEBUG agent Node info in sync loggo TestAgentConnectCALeafCertaclDefaultDeny DEBUG consul dropping node Node a cffc e dca d c a from result due to ACLs loggo TestAgentConnectCALeafCertaclDefaultDeny DEBUG consul CA provider configured ID c def f cb d c d c c f c f cf aa c aa ae IsPrimarytrue loggo TestAgentConnectCALeafCertaclDefaultDeny INFO agent Synced service testid loggo TestAgentConnectCALeafCertaclDefaultDeny DEBUG agent Check servicetestid in sync loggo TestAgentConnectCALeafCertaclDefaultDeny DEBUG agent Node info in sync requirego Error Trace agentendpointtestgo Error Should be true Test TestAgentConnectCALeafCertaclDefaultDeny loggo TestAgentConnectCALeafCertaclDefaultDeny INFO agent Requesting shutdown loggo TestAgentConnectCALeafCertaclDefaultDeny INFO consul shutting down server loggo TestAgentConnectCALeafCertaclDefaultDeny DEBUG leader stopping legacy ACL token upgrade routine loggo TestAgentConnectCALeafCertaclDefaultDeny DEBUG leader stopping acl token reaping routine loggo TestAgentConnectCALeafCertaclDefaultDeny WARN serf Shutdown without a Leave loggo TestAgentConnectCALeafCertaclDefaultDeny DEBUG leader stopped legacy ACL token upgrade routine loggo TestAgentConnectCALeafCertaclDefaultDeny DEBUG leader stopped acl token reaping routine loggo TestAgentConnectCALeafCertaclDefaultDeny WARN serf Shutdown without a Leave loggo TestAgentConnectCALeafCertaclDefaultDeny INFO connect initialized primary datacenter CA with provider consul loggo TestAgentConnectCALeafCertaclDefaultDeny INFO leader started CA root pruning routine loggo TestAgentConnectCALeafCertaclDefaultDeny DEBUG consul Skipping self join check for Node a cffc e dca d c a since the cluster is too small loggo TestAgentConnectCALeafCertaclDefaultDeny INFO consul member Node a cffc e dca d c a joined marking health alive loggo TestAgentConnectCALeafCertaclDefaultDeny INFO manager shutting down loggo TestAgentConnectCALeafCertaclDefaultDeny ERR consul failed to reconcile member Node a cffc e dca d c a map acls bootstrap build beta dcdc id a cffc e dca d c a port raftvsn roleconsul segment vsn vsnmax vsnmin wanjoinport alive leadership lost while committing log loggo TestAgentConnectCALeafCertaclDefaultDeny DEBUG leader stopping CA root pruning routine loggo TestAgentConnectCALeafCertaclDefaultDeny DEBUG leader stopped CA root pruning routine loggo TestAgentConnectCALeafCertaclDefaultDeny INFO agent consul server down loggo TestAgentConnectCALeafCertaclDefaultDeny INFO agent shutdown complete loggo TestAgentConnectCALeafCertaclDefaultDeny INFO agent Stopping DNS server tcp loggo TestAgentConnectCALeafCertaclDefaultDeny INFO agent Stopping DNS server udp loggo TestAgentConnectCALeafCertaclDefaultDeny INFO agent Stopping HTTP server tcp loggo TestAgentConnectCALeafCertaclDefaultDeny INFO agent Waiting for endpoints to shut down loggo TestAgentConnectCALeafCertaclDefaultDeny INFO agent Endpoints down FAIL agentTestAgentConnectCALeafCertaclDefaultDeny s Ran into an errant failure today stubbing this out with logs related RUN TestAutopilotCleanupDeadServer PAUSE TestAutopilotCleanupDeadServer CONT TestAutopilotCleanupDeadServer FAIL TestAutopilotCleanupDeadServer s loggo TestAutopilotCleanupDeadServernode DEBUG tlsutil Update with version loggo TestAutopilotCleanupDeadServernode DEBUG tlsutil OutgoingRPCWrapper with version writergo INFO raft Initial configuration index writergo INFO raft Node at Follower entering Follower state Leader loggo TestAutopilotCleanupDeadServernode INFO serf EventMemberJoin TestAutopilotCleanupDeadServernode dc loggo TestAutopilotCleanupDeadServernode INFO serf EventMemberJoin TestAutopilotCleanupDeadServernode loggo TestAutopilotCleanupDeadServernode INFO consul Adding LAN server TestAutopilotCleanupDeadServernode Addr tcp DC dc loggo TestAutopilotCleanupDeadServernode INFO consul Handled memberjoin event for server TestAutopilotCleanupDeadServernode dc in area wan loggo TestAutopilotCleanupDeadServernode DEBUG tlsutil Update with version loggo TestAutopilotCleanupDeadServernode DEBUG tlsutil OutgoingRPCWrapper with version writergo INFO raft Initial configuration index writergo INFO raft Node at Follower entering Follower state Leader loggo TestAutopilotCleanupDeadServernode INFO serf EventMemberJoin TestAutopilotCleanupDeadServernode dc loggo TestAutopilotCleanupDeadServernode INFO serf EventMemberJoin TestAutopilotCleanupDeadServernode loggo TestAutopilotCleanupDeadServernode INFO consul Handled memberjoin event for server TestAutopilotCleanupDeadServernode dc in area wan loggo TestAutopilotCleanupDeadServernode INFO consul Adding LAN server TestAutopilotCleanupDeadServernode Addr tcp DC dc loggo TestAutopilotCleanupDeadServernode DEBUG tlsutil Update with version loggo TestAutopilotCleanupDeadServernode DEBUG tlsutil OutgoingRPCWrapper with version writergo WARN raft no known peers aborting election writergo INFO raft Initial configuration index writergo INFO raft Node at Follower entering Follower state Leader loggo TestAutopilotCleanupDeadServernode INFO serf EventMemberJoin TestAutopilotCleanupDeadServernode dc writergo WARN raft no known peers aborting election loggo TestAutopilotCleanupDeadServernode INFO serf EventMemberJoin TestAutopilotCleanupDeadServernode loggo TestAutopilotCleanupDeadServernode INFO consul Handled memberjoin event for server TestAutopilotCleanupDeadServernode dc in area wan loggo TestAutopilotCleanupDeadServernode INFO consul Adding LAN server TestAutopilotCleanupDeadServernode Addr tcp DC dc loggo TestAutopilotCleanupDeadServernode DEBUG tlsutil Update with version loggo TestAutopilotCleanupDeadServernode DEBUG tlsutil OutgoingRPCWrapper with version writergo INFO raft Initial configuration index writergo INFO raft Node at Follower entering Follower state Leader loggo TestAutopilotCleanupDeadServernode INFO serf EventMemberJoin TestAutopilotCleanupDeadServernode dc loggo TestAutopilotCleanupDeadServernode INFO serf EventMemberJoin TestAutopilotCleanupDeadServernode loggo TestAutopilotCleanupDeadServernode INFO consul Adding LAN server TestAutopilotCleanupDeadServernode Addr tcp DC dc loggo TestAutopilotCleanupDeadServernode INFO consul Handled memberjoin event for server TestAutopilotCleanupDeadServernode dc in area wan loggo TestAutopilotCleanupDeadServernode DEBUG tlsutil Update with version loggo TestAutopilotCleanupDeadServernode DEBUG tlsutil OutgoingRPCWrapper with version writergo WARN raft no known peers aborting election writergo INFO raft Initial configuration index writergo INFO raft Node at Follower entering Follower state Leader loggo TestAutopilotCleanupDeadServernode INFO serf EventMemberJoin TestAutopilotCleanupDeadServernode dc loggo TestAutopilotCleanupDeadServernode INFO serf EventMemberJoin TestAutopilotCleanupDeadServernode loggo TestAutopilotCleanupDeadServernode INFO consul Adding LAN server TestAutopilotCleanupDeadServernode Addr tcp DC dc loggo TestAutopilotCleanupDeadServernode INFO consul Handled memberjoin event for server TestAutopilotCleanupDeadServernode dc in area wan loggo TestAutopilotCleanupDeadServernode DEBUG memberlist Initiating pushpull sync with loggo TestAutopilotCleanupDeadServernode DEBUG memberlist Stream connection from loggo TestAutopilotCleanupDeadServernode INFO serf EventMemberJoin TestAutopilotCleanupDeadServernode loggo TestAutopilotCleanupDeadServernode INFO consul Adding LAN server TestAutopilotCleanupDeadServernode Addr tcp DC dc loggo TestAutopilotCleanupDeadServernode INFO serf EventMemberJoin TestAutopilotCleanupDeadServernode loggo TestAutopilotCleanupDeadServernode INFO consul Adding LAN server TestAutopilotCleanupDeadServernode Addr tcp DC dc loggo TestAutopilotCleanupDeadServernode DEBUG memberlist Initiating pushpull sync with loggo TestAutopilotCleanupDeadServernode ERR memberlist Error accepting TCP connection accept tcp accept too many open files loggo TestAutopilotCleanupDeadServernode ERR memberlist Error accepting TCP connection accept tcp accept too many open files loggo TestAutopilotCleanupDeadServernode DEBUG memberlist Initiating pushpull sync with loggo TestAutopilotCleanupDeadServernode DEBUG memberlist Stream connection from loggo TestAutopilotCleanupDeadServernode DEBUG memberlist Initiating pushpull sync with loggo TestAutopilotCleanupDeadServernode DEBUG memberlist Failed to join EOF helpertestgo error occurred Failed to join EOF loggo TestAutopilotCleanupDeadServernode INFO consul shutting down server loggo TestAutopilotCleanupDeadServernode DEBUG memberlist Failed to join read tcp read connection reset by peer loggo TestAutopilotCleanupDeadServernode DEBUG consul Failed to floodjoin TestAutopilotCleanupDeadServernode at error occurred Failed to join read tcp read connection reset by peer loggo TestAutopilotCleanupDeadServernode WARN serf Shutdown without a Leave loggo TestAutopilotCleanupDeadServernode INFO serf EventMemberJoin TestAutopilotCleanupDeadServernode dc loggo TestAutopilotCleanupDeadServernode INFO consul Handled memberjoin event for server TestAutopilotCleanupDeadServernode dc in area wan loggo TestAutopilotCleanupDeadServernode INFO serf EventMemberJoin TestAutopilotCleanupDeadServernode dc loggo TestAutopilotCleanupDeadServernode INFO consul Handled memberjoin event for server TestAutopilotCleanupDeadServernode dc in area wan loggo TestAutopilotCleanupDeadServernode DEBUG consul Successfully performed floodjoin for TestAutopilotCleanupDeadServernode at writergo WARN raft no known peers aborting election loggo TestAutopilotCleanupDeadServernode WARN serf Shutdown without a Leave loggo TestAutopilotCleanupDeadServernode DEBUG serf messageJoinType TestAutopilotCleanupDeadServernode dc loggo TestAutopilotCleanupDeadServernode DEBUG serf messageJoinType TestAutopilotCleanupDeadServernode dc loggo TestAutopilotCleanupDeadServernode INFO manager shutting down loggo TestAutopilotCleanupDeadServernode DEBUG serf messageJoinType TestAutopilotCleanupDeadServernode dc loggo TestAutopilotCleanupDeadServernode DEBUG serf messageJoinType TestAutopilotCleanupDeadServernode loggo TestAutopilotCleanupDeadServernode DEBUG serf messageJoinType TestAutopilotCleanupDeadServernode loggo TestAutopilotCleanupDeadServernode DEBUG serf messageJoinType TestAutopilotCleanupDeadServernode dc loggo TestAutopilotCleanupDeadServernode DEBUG serf messageJoinType TestAutopilotCleanupDeadServernode dc loggo TestAutopilotCleanupDeadServernode DEBUG serf messageJoinType TestAutopilotCleanupDeadServernode loggo TestAutopilotCleanupDeadServernode DEBUG serf messageJoinType TestAutopilotCleanupDeadServernode loggo TestAutopilotCleanupDeadServernode DEBUG serf messageJoinType TestAutopilotCleanupDeadServernode loggo TestAutopilotCleanupDeadServernode DEBUG serf messageJoinType TestAutopilotCleanupDeadServernode dc loggo TestAutopilotCleanupDeadServernode DEBUG serf messageJoinType TestAutopilotCleanupDeadServernode loggo TestAutopilotCleanupDeadServernode DEBUG serf messageJoinType TestAutopilotCleanupDeadServernode dc loggo TestAutopilotCleanupDeadServernode DEBUG serf messageJoinType TestAutopilotCleanupDeadServernode loggo TestAutopilotCleanupDeadServernode INFO consul shutting down server loggo TestAutopilotCleanupDeadServernode WARN serf Shutdown without a Leave loggo TestAutopilotCleanupDeadServernode DEBUG serf messageJoinType TestAutopilotCleanupDeadServernode dc loggo TestAutopilotCleanupDeadServernode DEBUG serf messageJoinType TestAutopilotCleanupDeadServernode loggo TestAutopilotCleanupDeadServernode WARN serf Shutdown without a Leave loggo TestAutopilotCleanupDeadServernode INFO manager shutting down loggo TestAutopilotCleanupDeadServernode INFO consul shutting down server loggo TestAutopilotCleanupDeadServernode WARN serf Shutdown without a Leave loggo TestAutopilotCleanupDeadServernode WARN serf Shutdown without a Leave loggo TestAutopilotCleanupDeadServernode INFO manager shutting down loggo TestAutopilotCleanupDeadServernode INFO consul shutting down server loggo TestAutopilotCleanupDeadServernode WARN serf Shutdown without a Leave loggo TestAutopilotCleanupDeadServernode WARN serf Shutdown without a Leave loggo TestAutopilotCleanupDeadServernode DEBUG memberlist Failed ping TestAutopilotCleanupDeadServernode timeout reached loggo TestAutopilotCleanupDeadServernode INFO manager shutting down loggo TestAutopilotCleanupDeadServernode INFO memberlist Suspect TestAutopilotCleanupDeadServernode has failed no acks received loggo TestAutopilotCleanupDeadServernode DEBUG memberlist Failed ping TestAutopilotCleanupDeadServernode dc timeout reached loggo TestAutopilotCleanupDeadServernode INFO memberlist Suspect TestAutopilotCleanupDeadServernode dc has failed no acks received loggo TestAutopilotCleanupDeadServernode INFO consul shutting down server loggo TestAutopilotCleanupDeadServernode WARN serf Shutdown without a Leave loggo TestAutopilotCleanupDeadServernode DEBUG memberlist Failed ping TestAutopilotCleanupDeadServernode dc timeout reached loggo TestAutopilotCleanupDeadServernode DEBUG memberlist Failed ping TestAutopilotCleanupDeadServernode timeout reached loggo TestAutopilotCleanupDeadServernode WARN serf Shutdown without a Leave loggo TestAutopilotCleanupDeadServernode INFO memberlist Marking TestAutopilotCleanupDeadServernode as failed suspect timeout reached peer confirmations loggo TestAutopilotCleanupDeadServernode INFO serf EventMemberFailed TestAutopilotCleanupDeadServernode loggo TestAutopilotCleanupDeadServernode INFO manager shutting down loggo TestAutopilotCleanupDeadServernode INFO memberlist Marking TestAutopilotCleanupDeadServernode dc as failed suspect timeout reached peer confirmations loggo TestAutopilotCleanupDeadServernode INFO memberlist Suspect TestAutopilotCleanupDeadServernode dc has failed no acks received loggo TestAutopilotCleanupDeadServernode INFO serf EventMemberFailed TestAutopilotCleanupDeadServernode dc loggo TestAutopilotCleanupDeadServernode INFO memberlist Suspect TestAutopilotCleanupDeadServernode has failed no acks received FAIL agentconsulTestAutopilotCleanupDeadServer s RUN TestAutopilotCleanupDeadServerPeriodic PAUSE TestAutopilotCleanupDeadServerPeriodic CONT TestAutopilotCleanupDeadServerPeriodic FAIL TestAutopilotCleanupDeadServerPeriodic s loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG tlsutil Update with version loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG tlsutil OutgoingRPCWrapper with version writergo INFO raft Initial configuration index SuffrageVoter IDb cec d b b fd c Address writergo INFO raft Node at Follower entering Follower state Leader loggo TestAutopilotCleanupDeadServerPeriodicnode INFO serf EventMemberJoin TestAutopilotCleanupDeadServerPeriodicnode dc loggo TestAutopilotCleanupDeadServerPeriodicnode INFO serf EventMemberJoin TestAutopilotCleanupDeadServerPeriodicnode loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul Handled memberjoin event for server TestAutopilotCleanupDeadServerPeriodicnode dc in area wan loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul Adding LAN server TestAutopilotCleanupDeadServerPeriodicnode Addr tcp DC dc loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG tlsutil Update with version loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG tlsutil OutgoingRPCWrapper with version writergo INFO raft Initial configuration index writergo INFO raft Node at Follower entering Follower state Leader loggo TestAutopilotCleanupDeadServerPeriodicnode INFO serf EventMemberJoin TestAutopilotCleanupDeadServerPeriodicnode dc loggo TestAutopilotCleanupDeadServerPeriodicnode INFO serf EventMemberJoin TestAutopilotCleanupDeadServerPeriodicnode loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul Adding LAN server TestAutopilotCleanupDeadServerPeriodicnode Addr tcp DC dc loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul Handled memberjoin event for server TestAutopilotCleanupDeadServerPeriodicnode dc in area wan loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG tlsutil Update with version loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG tlsutil OutgoingRPCWrapper with version writergo WARN raft Heartbeat timeout from reached starting election writergo INFO raft Node at Candidate entering Candidate state in term writergo INFO raft Election won Tally writergo INFO raft Node at Leader entering Leader state loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul cluster leadership acquired loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul New leader elected TestAutopilotCleanupDeadServerPeriodicnode writergo WARN raft no known peers aborting election writergo INFO raft Initial configuration index writergo INFO raft Node at Follower entering Follower state Leader loggo TestAutopilotCleanupDeadServerPeriodicnode INFO serf EventMemberJoin TestAutopilotCleanupDeadServerPeriodicnode dc loggo TestAutopilotCleanupDeadServerPeriodicnode INFO serf EventMemberJoin TestAutopilotCleanupDeadServerPeriodicnode loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul Adding LAN server TestAutopilotCleanupDeadServerPeriodicnode Addr tcp DC dc loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul Handled memberjoin event for server TestAutopilotCleanupDeadServerPeriodicnode dc in area wan loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG tlsutil Update with version loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG tlsutil OutgoingRPCWrapper with version loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG tlsutil OutgoingRPCWrapper with version loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG consul CA provider configured ID c def f cb d c d c c f c f cf aa c aa ae IsPrimarytrue loggo TestAutopilotCleanupDeadServerPeriodicnode WARN consul error getting server health from TestAutopilotCleanupDeadServerPeriodicnode context deadline exceeded loggo TestAutopilotCleanupDeadServerPeriodicnode INFO connect initialized primary datacenter CA with provider consul loggo TestAutopilotCleanupDeadServerPeriodicnode INFO leader started CA root pruning routine loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG consul Skipping self join check for TestAutopilotCleanupDeadServerPeriodicnode since the cluster is too small loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul member TestAutopilotCleanupDeadServerPeriodicnode joined marking health alive writergo WARN raft no known peers aborting election loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG consul Skipping self join check for TestAutopilotCleanupDeadServerPeriodicnode since the cluster is too small writergo INFO raft Initial configuration index writergo INFO raft Node at Follower entering Follower state Leader loggo TestAutopilotCleanupDeadServerPeriodicnode INFO serf EventMemberJoin TestAutopilotCleanupDeadServerPeriodicnode dc loggo TestAutopilotCleanupDeadServerPeriodicnode INFO serf EventMemberJoin TestAutopilotCleanupDeadServerPeriodicnode loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul Adding LAN server TestAutopilotCleanupDeadServerPeriodicnode Addr tcp DC dc loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul Handled memberjoin event for server TestAutopilotCleanupDeadServerPeriodicnode dc in area wan loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG tlsutil Update with version loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG tlsutil OutgoingRPCWrapper with version writergo WARN raft no known peers aborting election writergo INFO raft Initial configuration index loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG consul Skipping self join check for TestAutopilotCleanupDeadServerPeriodicnode since the cluster is too small writergo INFO raft Node at Follower entering Follower state Leader loggo TestAutopilotCleanupDeadServerPeriodicnode INFO serf EventMemberJoin TestAutopilotCleanupDeadServerPeriodicnode dc loggo TestAutopilotCleanupDeadServerPeriodicnode INFO serf EventMemberJoin TestAutopilotCleanupDeadServerPeriodicnode loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul Adding LAN server TestAutopilotCleanupDeadServerPeriodicnode Addr tcp DC dc loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul Handled memberjoin event for server TestAutopilotCleanupDeadServerPeriodicnode dc in area wan loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG memberlist Initiating pushpull sync with loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG memberlist Stream connection from loggo TestAutopilotCleanupDeadServerPeriodicnode INFO serf EventMemberJoin TestAutopilotCleanupDeadServerPeriodicnode loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul Adding LAN server TestAutopilotCleanupDeadServerPeriodicnode Addr tcp DC dc loggo TestAutopilotCleanupDeadServerPeriodicnode INFO serf EventMemberJoin TestAutopilotCleanupDeadServerPeriodicnode writergo INFO raft Updating configuration with AddNonvoter cd e f a d e to SuffrageVoter IDb cec d b b fd c Address SuffrageNonvoter ID cd e f a d e Address loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul Adding LAN server TestAutopilotCleanupDeadServerPeriodicnode Addr tcp DC dc loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG memberlist Initiating pushpull sync with loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG memberlist Initiating pushpull sync with loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG memberlist Stream connection from loggo TestAutopilotCleanupDeadServerPeriodicnode ERR memberlist Error accepting TCP connection accept tcp accept too many open files loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG memberlist Stream connection from loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG memberlist Failed to join EOF helpertestgo error occurred Failed to join EOF loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul shutting down server loggo TestAutopilotCleanupDeadServerPeriodicnode WARN serf Shutdown without a Leave loggo TestAutopilotCleanupDeadServerPeriodicnode INFO serf EventMemberJoin TestAutopilotCleanupDeadServerPeriodicnode dc loggo TestAutopilotCleanupDeadServerPeriodicnode INFO serf EventMemberJoin TestAutopilotCleanupDeadServerPeriodicnode dc loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul Handled memberjoin event for server TestAutopilotCleanupDeadServerPeriodicnode dc in area wan loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG consul Successfully performed floodjoin for TestAutopilotCleanupDeadServerPeriodicnode at loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul Handled memberjoin event for server TestAutopilotCleanupDeadServerPeriodicnode dc in area wan loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG memberlist Initiating pushpull sync with loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG consul Successfully performed floodjoin for TestAutopilotCleanupDeadServerPeriodicnode at loggo TestAutopilotCleanupDeadServerPeriodicnode WARN serf Shutdown without a Leave writergo INFO raft Added peer cd e f a d e starting replication loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG tlsutil OutgoingRPCWrapper with version loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul member TestAutopilotCleanupDeadServerPeriodicnode joined marking health alive loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG raftnet accepted connection from loggo TestAutopilotCleanupDeadServerPeriodicnode INFO manager shutting down loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode dc loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode dc loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode dc loggo TestAutopilotCleanupDeadServerPeriodicnode WARN consul error getting server health from TestAutopilotCleanupDeadServerPeriodicnode context deadline exceeded loggo TestAutopilotCleanupDeadServerPeriodicnode WARN consul error getting server health from TestAutopilotCleanupDeadServerPeriodicnode context deadline exceeded loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG raftnet accepted connection from loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageUserEventType consulnewleader loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode dc loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode dc loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode dc loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode dc loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode dc writergo WARN raft Failed to get previous log log not found last writergo WARN raft AppendEntries to Nonvoter cd e f a d e rejected sending older logs next loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageUserEventType consulnewleader loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageUserEventType consulnewleader loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode loggo TestAutopilotCleanupDeadServerPeriodicnode WARN consul error getting server health from TestAutopilotCleanupDeadServerPeriodicnode context deadline exceeded loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode dc loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode dc loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode dc loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageUserEventType consulnewleader loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul shutting down server loggo TestAutopilotCleanupDeadServerPeriodicnode WARN serf Shutdown without a Leave loggo TestAutopilotCleanupDeadServerPeriodicnode WARN consul error getting server health from TestAutopilotCleanupDeadServerPeriodicnode context deadline exceeded loggo TestAutopilotCleanupDeadServerPeriodicnode WARN serf Shutdown without a Leave loggo TestAutopilotCleanupDeadServerPeriodicnode WARN consul error getting server health from TestAutopilotCleanupDeadServerPeriodicnode context deadline exceeded loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode dc loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG serf messageJoinType TestAutopilotCleanupDeadServerPeriodicnode loggo TestAutopilotCleanupDeadServerPeriodicnode INFO manager shutting down writergo INFO raft pipelining replication to peer Nonvoter cd e f a d e loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG consul Skipping self join check for TestAutopilotCleanupDeadServerPeriodicnode since the cluster is too small loggo TestAutopilotCleanupDeadServerPeriodicnode WARN consul error getting server health from TestAutopilotCleanupDeadServerPeriodicnode context deadline exceeded loggo TestAutopilotCleanupDeadServerPeriodicnode WARN consul error getting server health from TestAutopilotCleanupDeadServerPeriodicnode context deadline exceeded loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul shutting down server loggo TestAutopilotCleanupDeadServerPeriodicnode WARN serf Shutdown without a Leave loggo TestAutopilotCleanupDeadServerPeriodicnode WARN serf Shutdown without a Leave loggo TestAutopilotCleanupDeadServerPeriodicnode INFO manager shutting down loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG consul Skipping self join check for TestAutopilotCleanupDeadServerPeriodicnode since the cluster is too small loggo TestAutopilotCleanupDeadServerPeriodicnode INFO autopilot Promoting Server ID cd e f a d e Address to voter writergo INFO raft Updating configuration with AddStaging cd e f a d e to SuffrageVoter IDb cec d b b fd c Address SuffrageVoter ID cd e f a d e Address loggo TestAutopilotCleanupDeadServerPeriodicnode WARN consul error getting server health from TestAutopilotCleanupDeadServerPeriodicnode context deadline exceeded loggo TestAutopilotCleanupDeadServerPeriodicnode WARN consul error getting server health from TestAutopilotCleanupDeadServerPeriodicnode context deadline exceeded loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul shutting down server loggo TestAutopilotCleanupDeadServerPeriodicnode WARN serf Shutdown without a Leave loggo TestAutopilotCleanupDeadServerPeriodicnode WARN serf Shutdown without a Leave loggo TestAutopilotCleanupDeadServerPeriodicnode WARN consul error getting server health from TestAutopilotCleanupDeadServerPeriodicnode context deadline exceeded loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG memberlist Failed ping TestAutopilotCleanupDeadServerPeriodicnode timeout reached loggo TestAutopilotCleanupDeadServerPeriodicnode INFO manager shutting down loggo TestAutopilotCleanupDeadServerPeriodicnode ERR raftnet Failed to decode incoming command transport shutdown writergo INFO raft aborting pipeline replication to peer Nonvoter cd e f a d e loggo TestAutopilotCleanupDeadServerPeriodicnode WARN consul error getting server health from TestAutopilotCleanupDeadServerPeriodicnode context deadline exceeded loggo TestAutopilotCleanupDeadServerPeriodicnode ERR raftnet Failed to decode incoming command transport shutdown writergo ERROR raft Failed to heartbeat to EOF writergo WARN raft could not get configuration for Stats raft is already shutdown loggo TestAutopilotCleanupDeadServerPeriodicnode INFO memberlist Suspect TestAutopilotCleanupDeadServerPeriodicnode has failed no acks received writergo ERROR raft Failed to AppendEntries to Nonvoter cd e f a d e dial tcp nil connect connection refused loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG memberlist Failed ping TestAutopilotCleanupDeadServerPeriodicnode dc timeout reached loggo TestAutopilotCleanupDeadServerPeriodicnode WARN consul error getting server health from TestAutopilotCleanupDeadServerPeriodicnode rpc error making call EOF writergo WARN raft Failed to contact cd e f a d e in ms writergo WARN raft Failed to contact quorum of nodes stepping down writergo INFO raft Node at Follower entering Follower state Leader loggo TestAutopilotCleanupDeadServerPeriodicnode ERR consul failed to wait for barrier leadership lost while committing log loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG consul shutting down leader loop loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG leader stopping CA root pruning routine loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG leader stopped CA root pruning routine loggo TestAutopilotCleanupDeadServerPeriodicnode WARN consul error getting server health from TestAutopilotCleanupDeadServerPeriodicnode context deadline exceeded loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul cluster leadership lost loggo TestAutopilotCleanupDeadServerPeriodicnode INFO memberlist Suspect TestAutopilotCleanupDeadServerPeriodicnode dc has failed no acks received loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG memberlist Failed ping TestAutopilotCleanupDeadServerPeriodicnode timeout reached loggo TestAutopilotCleanupDeadServerPeriodicnode INFO memberlist Marking TestAutopilotCleanupDeadServerPeriodicnode as failed suspect timeout reached peer confirmations loggo TestAutopilotCleanupDeadServerPeriodicnode INFO serf EventMemberFailed TestAutopilotCleanupDeadServerPeriodicnode loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul Removing LAN server TestAutopilotCleanupDeadServerPeriodicnode Addr tcp DC dc loggo TestAutopilotCleanupDeadServerPeriodicnode INFO consul shutting down server loggo TestAutopilotCleanupDeadServerPeriodicnode WARN serf Shutdown without a Leave loggo TestAutopilotCleanupDeadServerPeriodicnode DEBUG memberlist Failed ping TestAutopilotCleanupDeadServerPeriodicnode dc timeout reached writergo ERROR raft Failed to heartbeat to read tcp read connection reset by peer loggo TestAutopilotCleanupDeadServerPeriodicnode WARN serf Shutdown without a Leave loggo TestAutopilotCleanupDeadServerPeriodicnode INFO memberlist Marking TestAutopilotCleanupDeadServerPeriodicnode dc as failed suspect timeout reached peer confirmations loggo TestAutopilotCleanupDeadServerPeriodicnode INFO serf EventMemberFailed TestAutopilotCleanupDeadServerPeriodicnode dc loggo TestAutopilotCleanupDeadServerPeriodicnode INFO memberlist Suspect TestAutopilotCleanupDeadServerPeriodicnode has failed no acks received writergo WARN raft Heartbeat timeout from reached starting election writergo INFO raft Node at Candidate entering Candidate state in term loggo TestAutopilotCleanupDeadServerPeriodicnode INFO manager shutting down loggo TestAutopilotCleanupDeadServerPeriodicnode INFO memberlist Suspect TestAutopilotCleanupDeadServerPeriodicnode dc has failed no acks received loggo TestAutopilotCleanupDeadServerPeriodicnode WARN raft Unable to get address for server id cd e f a d e using fallback address Could not find address for server id cd e f a d e writergo ERROR raft Failed to make RequestVote RPC to Voter cd e f a d e dial tcp nil connect connection refused FAIL agentconsulTestAutopilotCleanupDeadServerPeriodic s Locally this would fail pretty consistently for me as it was running too fast for the server to have completed CA bootstrap Ive seen it fail this way in CI at least once however this is not one of the tracked frequent failers The error when it does fail is Unexpected response code no cluster ca config setup so we can be pretty sure the root cause is not waiting for CA to complete bootstrapping In we reused our new popovermenu component for the actiongroups that we use for our row deleteuse etc confirmations We also included the new style of confirmation dialogs there This PR mainly repeats this throughout the UI the referenced PR only implemented this for intentions to provide an example One unforeseen problem that we also addressed here was being able to have multiple subpanels in the popover menu in this case required for multiple confirmations in the menu specifically for ACLs and ACL tokens The solution here isnt my favourite yet it works well whilst sticking to using CSSthe browser for controlling the popovermenu state I have further ideas for this in future partly based on work we were doing in the discoverychain work and partly based on a potential usage of contextual components here Right now the solution here works fine so we are happy to PR this and revisit the innards of this at a later date That pulls in the latest raft release and finally fixes Fixes clarification issue requested in add CheckDefinition to HealthCheck Overview of the Issue If using autoencrypt with grpc enabled on client agents clients continue expecting unencrypted traffic on the gRPC port I think its because the gRPC listener is not provided with certs bootstrapped by autoencrypt and continues to use the cert and the key from the config Reproduction Steps Steps to reproduce this issue Setup a server with autoencrypt enabled Setup a client with autoencrypt and gRPC enabled Try to connect to the client over gRPC openssl sclient connect localhost CONNECTED error BSSL routinesCONNECTCRSRVRHELLOwrong version numberBuildRootLibraryCachescomapplexbsSourceslibressllibressl libressl ssl sslpktc no peer certificate available No client certificate CA names sent SSL handshake has read bytes and written bytes New NONE Cipher is NONE Secure Renegotiation IS NOT supported Compression NONE Expansion NONE No ALPN negotiated SSLSession Protocol TLSv Cipher SessionID SessionIDctx MasterKey Start Time Timeout sec Verify return code ok Consul info for both Client and Server details summaryClient infosummary consul info agent checkmonitors checkttls checks services build prerelease revision f e version consul acl disabled knownservers server false runtime arch amd cpucount goroutines maxprocs os linux version go serflan coordinateresets encrypted true eventqueue eventtime failed healthscore intentqueue left membertime members queryqueue querytime details details summaryServer infosummary consul info agent checkmonitors checkttls checks services build prerelease revision f e version consul acl disabled bootstrap false knowndatacenters leader true leaderaddr server true raft appliedindex commitindex fsmpending lastcontact lastlogindex lastlogterm lastsnapshotindex lastsnapshotterm latestconfiguration SuffrageVoter ID dcf ad f e f e cfe Address SuffrageVoter ID a eb c f c ad b ea Address SuffrageVoter ID a fb e d affdfadecab f Address latestconfigurationindex numpeers protocolversion protocolversionmax protocolversionmin snapshotversionmax snapshotversionmin state Leader term runtime arch amd cpucount goroutines maxprocs os linux version go serflan coordinateresets encrypted true eventqueue eventtime failed healthscore intentqueue left membertime members queryqueue querytime serfwan coordinateresets encrypted true eventqueue eventtime failed healthscore intentqueue left membertime members queryqueue querytime details Operating system and Environment details The server was deployed on Azure and the clients on AKS with the Consul Helm chart modified to support autoencrypt This patch includes a refactor of the current Install docs to highlight that Consul can be installed on Kubernetes Open to feedback as it refactors some of the layout of the previous install page