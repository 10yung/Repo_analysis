 What changes were proposed in this pull request In LivyClientBuilder a ServiceLoader is used to load configured LivyClientFactory providers there is only one RSCClientFactory Correct behavior of RSCClientFactory implicitly depends on there being a single instance of it in the Livy server Instead of instantiating a new ServiceLoader every time the build method is called on a LivyClientBuilder keep a single ServiceLoader in a static field The ServiceLoader will lazily load the LivyClientFactory RSCClientFactory and cache it ServiceLoader instances are not safe for use by multiple concurrent threads so call the ServiceLoaders iterator in a synchronized block How was this patch tested Tested by having clients connect to the Livy Thrift server simultaneously Before the change the behavior described in was encountered With the change the problem is not encountered What changes were proposed in this pull request When generate unique session id with multipleactive HA mode First get the distributed lock Second get the session id from filesystem or zookeeper Third increase the session id and save it in the filesystem or zookeeper Forth release the distributed lock ZooKeeperManager provides the distributed lock to generate the distributed session id LocalSessionIdGenerator used when only one livy work and DistributedSessionIdGenerator used when serveral livy work at the same time such as in multiactive HA mode Maybe the name Local of LocalSessionIdGenerator is confused because it also use hdfs or zookeeper But I do not have a better name maybe rename LocalSessionIdGenerator to StandaloneSessionIdGenerator How was this patch tested Existed UT and IT What changes were proposed in this pull request support using hadoop native methods while choosing local file system to store sessionMetadata and session nextId using native methods prevent to create new process which costs time and may lead to nextId method retain object lock of sessionManager for long time and may cause throughput decreased or createdelete thread hanged and also a param is suggested to set in livyenvsh export LDLIBRARYPATHusrlocalhadoopcurrentlibnative How was this patch tested manual tests and debug Bumps jettyversion from v to v Updates jettyhttp from v to v details summaryCommitssummary d f Updating to version v ba fe Merge pull request from eclipsejetty ximproveerrorhandleroutput cf df e Issue Improve testing of ErrorHandler behavior cba d Fixing typo in stalebot message eefa Fixes Aligning default in ini to XML default e fc Issue Improve testing of ErrorHandler behavior dc Merge branch release into jetty x cff bb Issue test the decoding of OpenId Credentials d a Issue Improve handling of HttpOutputclose for pending writes ab a we do not need those repositories now Additional commits viewable in compare view details br Updates jettycontinuation from v to v details summaryCommitssummary d f Updating to version v ba fe Merge pull request from eclipsejetty ximproveerrorhandleroutput cf df e Issue Improve testing of ErrorHandler behavior cba d Fixing typo in stalebot message eefa Fixes Aligning default in ini to XML default e fc Issue Improve testing of ErrorHandler behavior dc Merge branch release into jetty x cff bb Issue test the decoding of OpenId Credentials d a Issue Improve handling of HttpOutputclose for pending writes ab a we do not need those repositories now Additional commits viewable in compare view details br Updates jettyservlet from v to v details summaryCommitssummary d f Updating to version v ba fe Merge pull request from eclipsejetty ximproveerrorhandleroutput cf df e Issue Improve testing of ErrorHandler behavior cba d Fixing typo in stalebot message eefa Fixes Aligning default in ini to XML default e fc Issue Improve testing of ErrorHandler behavior dc Merge branch release into jetty x cff bb Issue test the decoding of OpenId Credentials d a Issue Improve handling of HttpOutputclose for pending writes ab a we do not need those repositories now Additional commits viewable in compare view details br Updates jettyserver from v to v details summaryCommitssummary d f Updating to version v ba fe Merge pull request from eclipsejetty ximproveerrorhandleroutput cf df e Issue Improve testing of ErrorHandler behavior cba d Fixing typo in stalebot message eefa Fixes Aligning default in ini to XML default e fc Issue Improve testing of ErrorHandler behavior dc Merge branch release into jetty x cff bb Issue test the decoding of OpenId Credentials d a Issue Improve handling of HttpOutputclose for pending writes ab a we do not need those repositories now Additional commits viewable in compare view details br Updates jettyutil from v to v details summaryCommitssummary d f Updating to version v ba fe Merge pull request from eclipsejetty ximproveerrorhandleroutput cf df e Issue Improve testing of ErrorHandler behavior cba d Fixing typo in stalebot message eefa Fixes Aligning default in ini to XML default e fc Issue Improve testing of ErrorHandler behavior dc Merge branch release into jetty x cff bb Issue test the decoding of OpenId Credentials d a Issue Improve handling of HttpOutputclose for pending writes ab a we do not need those repositories now Additional commits viewable in compare view details br Updates jettyplus from v to v details summaryCommitssummary d f Updating to version v ba fe Merge pull request from eclipsejetty ximproveerrorhandleroutput cf df e Issue Improve testing of ErrorHandler behavior cba d Fixing typo in stalebot message eefa Fixes Aligning default in ini to XML default e fc Issue Improve testing of ErrorHandler behavior dc Merge branch release into jetty x cff bb Issue test the decoding of OpenId Credentials d a Issue Improve handling of HttpOutputclose for pending writes ab a we do not need those repositories now Additional commits viewable in compare view details br Updates jettysecurity from v to v details summaryCommitssummary d f Updating to version v ba fe Merge pull request from eclipsejetty ximproveerrorhandleroutput cf df e Issue Improve testing of ErrorHandler behavior cba d Fixing typo in stalebot message eefa Fixes Aligning default in ini to XML default e fc Issue Improve testing of ErrorHandler behavior dc Merge branch release into jetty x cff bb Issue test the decoding of OpenId Credentials d a Issue Improve handling of HttpOutputclose for pending writes ab a we do not need those repositories now Additional commits viewable in compare view details br Updates jettyrunner from v to v details summaryCommitssummary d f Updating to version v ba fe Merge pull request from eclipsejetty ximproveerrorhandleroutput cf df e Issue Improve testing of ErrorHandler behavior cba d Fixing typo in stalebot message eefa Fixes Aligning default in ini to XML default e fc Issue Improve testing of ErrorHandler behavior dc Merge branch release into jetty x cff bb Issue test the decoding of OpenId Credentials d a Issue Improve handling of HttpOutputclose for pending writes ab a we do not need those repositories now Additional commits viewable in compare view details br Dependabot will resolve any conflicts with this PR as long as you dont alter it yourself You can also trigger a rebase manually by commenting dependabot rebase dependabotautomergestart dependabotautomergeend details summaryDependabot commands and optionssummary br You can trigger Dependabot actions by commenting on this PR dependabot rebase will rebase this PR dependabot recreate will recreate this PR overwriting any edits that have been made to it dependabot merge will merge this PR after your CI passes on it dependabot squash and merge will squash and merge this PR after your CI passes on it dependabot cancel merge will cancel a previously requested merge and block automerging dependabot reopen will reopen this PR if it is closed dependabot ignore this patchminormajor version will close this PR and stop Dependabot creating any more for this minormajor version unless you reopen the PR or upgrade to it yourself dependabot ignore this dependency will close this PR and stop Dependabot creating any more for this dependency unless you reopen the PR or upgrade to it yourself dependabot use these labels will set the current labels as the default for future PRs for this repo and language dependabot use these reviewers will set the current reviewers as the default for future PRs for this repo and language dependabot use these assignees will set the current assignees as the default for future PRs for this repo and language dependabot use this milestone will set the current milestone as the default for future PRs for this repo and language You can disable automated security fix PRs for this repo from the Security Alerts page details Bumps jacksonversion from to Updates jacksonannotations from to details summaryCommitssummary See full diff in compare view details br Updates jacksoncore from to details summaryCommitssummary fc mavenreleaseplugin prepare release jacksoncore a d a prepare for ce d e revert now unnecessary sonatype deploy plugin adf fd Add Sonatype deploy plugin to simplify releases ca ec array index out of bounds in hex lookup da e Fix nonblocking path still had potential problem but changed method i db f fadc Fix df b Additional commits viewable in compare view details br Updates jacksondatabind from to details summaryCommitssummary See full diff in compare view details br Updates jacksonmodulescala from to details summaryCommitssummary abae d Setting version to f jackson ac make test more robust by not relying on order of json elements d add basic test for try f set version to SNAPSHOT deb back to SNAPSHOT builds a c d c use scalatest in guava test bdfdb prepare release c test with jackson SNAPSHOT f publish SNAPSHOT Additional commits viewable in compare view details br Dependabot will resolve any conflicts with this PR as long as you dont alter it yourself You can also trigger a rebase manually by commenting dependabot rebase dependabotautomergestart dependabotautomergeend details summaryDependabot commands and optionssummary br You can trigger Dependabot actions by commenting on this PR dependabot rebase will rebase this PR dependabot recreate will recreate this PR overwriting any edits that have been made to it dependabot merge will merge this PR after your CI passes on it dependabot squash and merge will squash and merge this PR after your CI passes on it dependabot cancel merge will cancel a previously requested merge and block automerging dependabot reopen will reopen this PR if it is closed dependabot ignore this patchminormajor version will close this PR and stop Dependabot creating any more for this minormajor version unless you reopen the PR or upgrade to it yourself dependabot ignore this dependency will close this PR and stop Dependabot creating any more for this dependency unless you reopen the PR or upgrade to it yourself dependabot use these labels will set the current labels as the default for future PRs for this repo and language dependabot use these reviewers will set the current reviewers as the default for future PRs for this repo and language dependabot use these assignees will set the current assignees as the default for future PRs for this repo and language dependabot use this milestone will set the current milestone as the default for future PRs for this repo and language You can disable automated security fix PRs for this repo from the Security Alerts page details What changes were proposed in this pull request If we type Ctrl c to interrupt a query from beeline it does not cancel itself the job still can be seen running from spark historyServer How was this patch tested Tested in my own environment What changes were proposed in this pull request Jira This PR is one of the PRs in the series related to the splitting of the PR to multiple PRs to ease and speed up review and merge processes This PR targets branch of the base PR and should be merged after it This PR implements a way to build Spark UI links on Livy UI when running on Kubernetes This patch is required to unlock further integrations with Kubernetes Ingress resources ref Refer to compare changes How was this patch tested Unit tests Manual testing with Kubernetes on Docker Desktop for Mac v Environment Helm charts clusterbase with customvaluesyaml yaml nginxingress controller service loadBalancerIP myclusterexamplecom IP address from etchosts loadBalancerSourceRanges clusterautoscaler enabled false oauth proxy enabled false sparkcluster with customvaluesyaml yaml livy image pullPolicy Never tag incubatingspark hadoop dev ingress enabled true annotations kubernetesioingressclass nginx kubernetesiotlsacme true nginxingresskubernetesiorewritetarget path livy hosts myclusterexamplecom tls secretName sparkclustertls hosts myclusterexamplecom persistence enabled true env LIVYLIVYUIBASE PATH value livy LIVYSPARKKUBERNETESCONTAINERIMAGEPULL POLICY value Never LIVYSPARKKUBERNETESCONTAINERIMAGE value sasnouskikhlivyspark incubatingspark hadoop dev LIVYLIVYSERVERSESSIONSTATE RETAINSEC value s LIVYLIVYSERVERKUBERNETESALLOWED NAMESPACES value defaulttest LIVYLIVYUIKUBERNETESSPARKUIENABLED value true LIVYLIVYUIKUBERNETESSPARKUILINK FORMAT value sparkuis historyserver enabled false jupyterhub enabled true ingress enabled true annotations kubernetesioingressclass nginx kubernetesiotlsacme true hosts myclusterexamplecom pathSuffix tls secretName sparkclustertls hosts myclusterexamplecom hub baseUrl jupyterhub publicURL activeServerLimit openssl rand hex cookieSecret b e f b cc b a f d acca e eeb c e c d eb pdb enabled true minAvailable proxy openssl rand hex secretToken cc e a a b e c c b ebe f edb b bf b b de pdb enabled true minAvailable cull enabled false timeout every Interactive sessions Jupyter notebook on JupyterHub with Sparkmagic Batch sessions SparkPi bash curl k H ContentType applicationjson X POST d name SparkPi className orgapachesparkexamplesSparkPi numExecutors file localoptsparkexamplesjarssparkexamples jar args conf sparkkubernetesnamespace namespace Bumps nokogiri from to details summaryRelease notessummary Sourced from nokogiris releases Security Address CVE A command injection vulnerability in Nokogiri v and earlier allows commands to be executed in a subprocess by Rubys Kernelopen method Processes are vulnerable only if the undocumented method NokogiriCSSTokenizerloadfile is being passed untrusted user input This vulnerability appears in code generated by the Rexical gem versions v and earlier Rexical is used by Nokogiri to generate lexical scanner code for parsing CSS queries The underlying vulnerability was addressed in Rexical v and Nokogiri upgraded to this version of Rexical in Nokogiri v This CVEs public notice is sparklemotionnokogiri Security Notes MRI Pulled in upstream patch from libxslt that addresses CVE Full details are available in Note that this patch is not yet as of in an upstream release of libxslt Security MRI Remove support from vendored libxml for future script macros MRI Remove support from vendored libxml for serverside includes within attributes Bug fixes JRuby Fix node ownership in duplicated documents JRuby Rethrow exceptions caught by Java SAX handler Thanks adjam Features MRI During installation handle Xcode s new library pathOS Thanks mlj and deepj Avoid unnecessary creation of Procs in many methods Thanks chopraanmol Bug fixes CSS selector has now correctly matches against any descendant Previously this selector matched against only direct children Thanks Phrogz NodeSetattr now returns nil if its empty Previously this raised a NoMethodError MRI XPath errors are no longer suppressed during XSLTStylesheettransform Previously these errors were suppressed which led to silent failures and a subsequent segfault trtable truncated details details summaryChangelogsummary Sourced from nokogiris changelog Security Address CVE A command injection vulnerability in Nokogiri v and earlier allows commands to be executed in a subprocess by Rubys Kernelopen method Processes are vulnerable only if the undocumented method NokogiriCSSTokenizerloadfile is being passed untrusted user input This vulnerability appears in code generated by the Rexical gem versions v and earlier Rexical is used by Nokogiri to generate lexical scanner code for parsing CSS queries The underlying vulnerability was addressed in Rexical v and Nokogiri upgraded to this version of Rexical in Nokogiri v This CVEs public notice is sparklemotionnokogiri Security Notes MRI Pulled in upstream patch from libxslt that addresses CVE Full details are available in Note that this patch is not yet as of in an upstream release of libxslt Security MRI Remove support from vendored libxml for future script macros MRI Remove support from vendored libxml for serverside includes within attributes Bug fixes JRuby Fix node ownership in duplicated documents JRuby Rethrow exceptions caught by Java SAX handler Thanks adjam Features MRI During installation handle Xcode s new library path Thanks mlj and deepj Avoid unnecessary creation of Procs in many methods Thanks chopraanmol Bug fixes CSS selector has now correctly matches against any descendant Previously this selector matched against only direct children Thanks Phrogz NodeSetattr now returns nil if its empty Previously this raised a NoMethodError MRI XPath errors are no longer suppressed during XSLTStylesheettransform Previously these errors were suppressed which led to silent failures and a subsequent segfault trtable truncated details details summaryCommitssummary beb e version bump to v d Merge branch csstokenizerloadfilevulnerabilityv x into v x c b fc update CHANGELOG fe f regenerate lexical scanner using rexical eliminate eval from Builderinitialize a bc rufo formatting ecb rubocop security scan is run as part of the test rake target d cd add rubocop as a dev dependency ee b adding a temporary pipeline for v x e af version bump to v Additional commits viewable in compare view details br Dependabot compatibility score Dependabot will resolve any conflicts with this PR as long as you dont alter it yourself You can also trigger a rebase manually by commenting dependabot rebase dependabotautomergestart dependabotautomergeend details summaryDependabot commands and optionssummary br You can trigger Dependabot actions by commenting on this PR dependabot rebase will rebase this PR dependabot recreate will recreate this PR overwriting any edits that have been made to it dependabot merge will merge this PR after your CI passes on it dependabot squash and merge will squash and merge this PR after your CI passes on it dependabot cancel merge will cancel a previously requested merge and block automerging dependabot reopen will reopen this PR if it is closed dependabot ignore this patchminormajor version will close this PR and stop Dependabot creating any more for this minormajor version unless you reopen the PR or upgrade to it yourself dependabot ignore this dependency will close this PR and stop Dependabot creating any more for this dependency unless you reopen the PR or upgrade to it yourself dependabot use these labels will set the current labels as the default for future PRs for this repo and language dependabot use these reviewers will set the current reviewers as the default for future PRs for this repo and language dependabot use these assignees will set the current assignees as the default for future PRs for this repo and language dependabot use this milestone will set the current milestone as the default for future PRs for this repo and language You can disable automated security fix PRs for this repo from the Security Alerts page details What changes were proposed in this pull request Jira This PR is one of the PRs in the series related to the splitting of the base PR to multiple PRs to ease and speed up review and merge processes This PR proposes a way to submit Spark apps to Kubernetes cluster Points covered Submit batch sessions Submit interactive sessions Monitor sessions collect logs and diagnostics information Restore sessions monitoring after restarts GC created Kubernetes resources Restrict the set of allowed Kubernetes namespaces How was this patch tested Unit tests Manual testing with Kubernetes on Docker Desktop for Mac v Environment Helm charts clusterbase with customvaluesyaml yaml nginxingress controller service loadBalancerIP myclusterexamplecom IP address from etchosts loadBalancerSourceRanges clusterautoscaler enabled false oauth proxy enabled false sparkcluster with customvaluesyaml yaml livy image pullPolicy Never tag incubatingspark hadoop dev ingress enabled true annotations kubernetesioingressclass nginx kubernetesiotlsacme true nginxingresskubernetesiorewritetarget path livy hosts myclusterexamplecom tls secretName sparkclustertls hosts myclusterexamplecom persistence enabled true env LIVYLIVYUIBASE PATH value livy LIVYSPARKKUBERNETESCONTAINERIMAGEPULL POLICY value Never LIVYSPARKKUBERNETESCONTAINERIMAGE value sasnouskikhlivyspark incubatingspark hadoop dev LIVYLIVYSERVERSESSIONSTATE RETAINSEC value s LIVYLIVYSERVERKUBERNETESALLOWED NAMESPACES value defaulttest historyserver enabled false jupyterhub enabled true ingress enabled true annotations kubernetesioingressclass nginx kubernetesiotlsacme true hosts myclusterexamplecom pathSuffix tls secretName sparkclustertls hosts myclusterexamplecom hub baseUrl jupyterhub publicURL activeServerLimit openssl rand hex cookieSecret b e f b cc b a f d acca e eeb c e c d eb pdb enabled true minAvailable proxy openssl rand hex secretToken cc e a a b e c c b ebe f edb b bf b b de pdb enabled true minAvailable cull enabled false timeout every Interactive sessions Jupyter notebook on JupyterHub with Sparkmagic Batch sessions SparkPi bash curl k H ContentType applicationjson X POST d name SparkPi className orgapachesparkexamplesSparkPi numExecutors file localoptsparkexamplesjarssparkexamples jar args conf sparkkubernetesnamespace namespace What changes were proposed in this pull request Upgrade Jetty to v to fix CVEs How was this patch tested Existing UTs 